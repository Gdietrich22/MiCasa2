[{"id":"50119c6e.6ff584","type":"tab","label":"Temperaturas","disabled":false,"info":""},{"id":"e6e33852.2495f8","type":"tab","label":"Medidor internet","disabled":true,"info":""},{"id":"a89e305a.c50bb","type":"tab","label":"Iluminacion Living","disabled":false,"info":""},{"id":"1b403a13.0ec8c6","type":"tab","label":"Termo Solar","disabled":false,"info":""},{"id":"3ce5b54a.127d6a","type":"tab","label":"Baterias/Alarma","disabled":false,"info":""},{"id":"e364a467.07a6a8","type":"tab","label":"Dolar","disabled":false,"info":""},{"id":"f682d492.22a758","type":"tab","label":"BackUp","disabled":false,"info":""},{"id":"7ac92c99.66ea94","type":"tab","label":"Google Now","disabled":false,"info":""},{"id":"deff4396.4722a","type":"tab","label":"Cope","disabled":false,"info":""},{"id":"b86d561e.834378","type":"serial-port","z":"","serialport":"/dev/ttyUSB0","serialbaud":"115200","databits":"8","parity":"none","stopbits":"1","newline":"\\n","bin":"false","out":"char","addchar":false},{"id":"ff2252ef.d12aa","type":"ui_group","z":"","name":"Default","tab":"d1041da5.a5788","order":2,"disp":true,"width":"8","collapse":false},{"id":"d1041da5.a5788","type":"ui_tab","z":"","name":"Home","icon":"dashboard"},{"id":"e779f8d6.7bc2c8","type":"mqtt-broker","z":"","name":"","broker":"127.0.0.1","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"c339edbf.39572","type":"mqtt-broker","z":"","name":"","broker":"127.0.0.1","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"177e0064.22348","type":"ui_group","z":"","name":"Temperaturas Baterias","tab":"d1041da5.a5788","order":4,"disp":false,"width":"16","collapse":false},{"id":"637ff0bd.3c84b","type":"mqtt-broker","z":"","name":"","broker":"127.0.0.1","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"43555c62.30ed34","type":"mqtt-broker","z":"","name":"","broker":"127.0.0.1","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"900627dc.76e6a8","type":"mqtt-broker","z":"","name":"","broker":"127.0.0.1","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"2c18e412.5f5cbc","type":"blynk-ws-client","z":"","name":"wss://127.0.0.1:9443/websockets","path":"wss://127.0.0.1:9443/websockets","key":"bdd6cc84a9c94dd8be574aa5d91bfa6b","dbg_all":false,"dbg_read":false,"dbg_write":false,"dbg_notify":false,"dbg_mail":false,"dbg_prop":false,"dbg_sync":false,"dbg_bridge":false,"dbg_low":false,"dbg_pins":"","multi_cmd":false,"proxy_type":"no","proxy_url":""},{"id":"6b36e4a.1d30b1c","type":"mqtt-broker","z":"","name":"","broker":"127.0.0.1","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"3fe9d635.ec409a","type":"mqtt-broker","z":"","name":"","broker":"127.0.0.1","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"1cdea439.a354ec","type":"blynk-ws-client","z":"","name":"wss://127.0.0.1:9443/websockets","path":"wss://127.0.0.1:9443/websockets","key":"bdd6cc84a9c94dd8be574aa5d91bfa6b","dbg_all":false,"dbg_read":false,"dbg_write":false,"dbg_notify":false,"dbg_mail":false,"dbg_prop":false,"dbg_sync":false,"dbg_bridge":false,"dbg_low":false,"dbg_pins":"","multi_cmd":false,"proxy_type":"no","proxy_url":""},{"id":"af08803a.808f4","type":"mqtt-broker","z":"","name":"","broker":"127.0.0.1","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"a3354950.2556c8","type":"mqtt out","z":"3ce5b54a.127d6a","name":"","topic":"","qos":"","retain":"","broker":"c339edbf.39572","x":3235.8094577789307,"y":196.59525680541992,"wires":[]},{"id":"4244f3d0.dcc0fc","type":"ui_gauge","z":"3ce5b54a.127d6a","name":"","group":"ff2252ef.d12aa","order":5,"width":"2","height":"2","gtype":"gage","title":"Temp Bat1","label":"units","format":"{{value}}","min":"0","max":"50","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":2760,"y":920,"wires":[]},{"id":"4bb5fb58.83db84","type":"debug","z":"e6e33852.2495f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":580.7777404785156,"y":69,"wires":[]},{"id":"4d605608.32c4f8","type":"debug","z":"3ce5b54a.127d6a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1030,"y":820,"wires":[]},{"id":"4a88ff94.6b429","type":"mqtt in","z":"1b403a13.0ec8c6","name":"","topic":"ESP/TermoSolar/Debug","qos":"2","broker":"900627dc.76e6a8","x":880,"y":30,"wires":[["4925f5fb.a7fa3c","504fa5d9.30bf1c"]]},{"id":"cee645be.dba0b8","type":"function","z":"a89e305a.c50bb","name":"","func":" var timerLuces = 12000;\nif (global.get(\"estLiving\") === undefined)global.set(\"estLiving\", 0);\nif (global.get(\"estIsla\") === undefined)global.set(\"estIsla\", 0);\nif (global.get(\"estCielorrazo\") === undefined)global.set(\"estCielorrazo\", 0);\nif (global.get(\"potLiving\") === undefined)global.set(\"potLiving\", 0);\nif (global.get(\"estIslaRGB\") === undefined)global.set(\"estIslaRGB\", 0);\nif (global.get(\"potIsla\") === undefined)global.set(\"potIsla\", 128);\nif (global.get(\"potCielorrazo\") === undefined)global.set(\"potCielorrazo\", 128);\nif (global.get(\"IslaR\") === undefined)global.set(\"IslaR\", 0);\nif (global.get(\"IslaG\") === undefined)global.set(\"IslaG\", 0);\nif (global.get(\"IslaB\") === undefined)global.set(\"IslaB\", 255);\nif (global.get(\"dimmerLeds\") === undefined)global.set(\"dimmerLeds\", 200);\nif (global.get(\"minTeclas\") === undefined)global.set(\"minTeclas\", 15);\nif (global.get(\"maxTeclas\") === undefined)global.set(\"maxTeclas\", 600);\nif (global.get(\"doblePuls\") === undefined)global.set(\"doblePuls\", 1);\nif (global.get(\"fallasLivingIluminacion\") === undefined)global.set(\"fallasLivingIluminacion\", 0);\ncontext.item = context.item || 0;\n\nvar topic = msg.topic;\nvar payload = msg.payload;\nvar dato;\nif (global.get(\"Dia\") === 1)global.set(\"dimmerLeds\", 200);\nif (global.get(\"Dia\") === 0)global.set(\"dimmerLeds\", 50);\n\nif (topic == \"Pedido/Living/Iluminacion\"){\t\n\tvar fallasLivingIluminacion = global.get(\"fallasLivingIluminacion\") + 1;\n\tglobal.set(\"fallasLivingIluminacion\", fallasLivingIluminacion);\n\tglobal.set(\"tipoFallaIlLiving\", msg.payload); msg = {topic: \"fallas_MQTT\", payload: 1}, node.send([msg, null]);\n\tenviarMQTT();\n// \tmsg = {topic: \"minTeclas\", payload: global.get(\"minTeclas\")}; node.send(msg);\n//     msg = {topic: \"maxTeclas\", payload: global.get(\"maxTeclas\")}; node.send(msg);\n\treturn;\n}\n\nif (topic == \"aviso/Alarma\"){\n\tif (global.get(\"estadoAlarma\") == \"0\" && global.get(\"Dia\") == \"0\"){\n\tglobal.set(\"estLiving\", 1); \n\tglobal.set(\"estIslaRGB\", 1);\n\tenviarMQTT();\n\treturn;\n\t}\n\tif (global.get(\"estadoAlarma\") == \"1\"){setTimeout(apagadoLuces, timerLuces);}\n\t}\n\n\n// if (topic == \"aviso/Iluminacion\" && global.get(\"Dia\") === 1) apagadoLuces();\n\n\nfunction apagadoLuces(){\n\t// if (global.get(\"estadoAlarma\") === 1 || global.get(\"Dia\") === 1){\n\t// \t// global.set(\"estLiving\", 0); \n\t// \t// global.set(\"estIsla\", 0); \n\t// \t// global.set(\"estCielorrazo\", 0);\n\t// \t// global.set(\"estIslaRGB\", 0);\n\t// }\n\tglobal.set(\"estLiving\", 0);\n\tmsg.topic = \"apagadoAuto\";\n\tenviarMQTT();\n}\n\nif (topic == \"google/Living\") {enviarMQTT(); return;}\n\nif (topic == \"ESP/living/Iluminacion/Envio\"){\n\tdato = payload.split(\"#\");\n\tglobal.set(\"estIsla\", dato[0]); \n\tglobal.set(\"estCielorrazo\", dato[1]); \n\tglobal.set(\"estIslaRGB\", dato[2]); \n\tenviarMQTT();\n\treturn;\n}\n\nif (topic == \"Blink/potItem\"){\n\tcontext.item = parseInt(msg.payload);\n\tswitch(parseInt(msg.payload)){\n\t\tcase 1:\n\t\t\tmsg = {pin: 19, label: \"Living\", payload: global.get(\"potLiving\")};\n\t\tbreak;\n\t\tcase 2:\n\t\t\tmsg = {pin: 19, label: \"Isla\", payload: global.get(\"potIsla\")};\n\t\tbreak;\n\t\tcase 3:\n\t\t\tmsg = {pin: 19, label: \"Cielorrazo\", payload: global.get(\"potCielorrazo\")};\n\t\tbreak;\n\t}\n\tnode.send([null, msg]);\n}\n\nif (topic == \"Blink/potencia\"){\n\tvar valor = parseInt(msg.payload);\n\tswitch(context.item){\n\t\tcase 1:\n\t\t\tif (global.get(\"estLiving\") === 0)return;\n\t\t\tglobal.set(\"potLiving\", valor);\n\t\t\tglobal.set(\"potIsla\", valor);\n\t\t\tglobal.set(\"potCielorrazo\", valor);\n\t\tbreak;\n\t\tcase 2:\n\t\t\tif (global.get(\"estIsla\") === 0)return;\n\t\t\tglobal.set(\"potIsla\", valor);\n\t\tbreak;\n\t\tcase 3:\n\t\t\tif (global.get(\"estCielorrazo\") === 0)return;\n\t\t\tglobal.set(\"potCielorrazo\", valor);\n\t\tbreak;\n\t}\n\tenviarMQTT();\n}\n\nif (topic == \"Blink/estLiving\"){\n\tglobal.set(\"estLiving\", parseInt(msg.payload));  \n\t// global.set(\"estIsla\", parseInt(msg.payload)); \n\t// global.set(\"estCielorrazo\", parseInt(msg.payload));\n\tif (msg.payload == \"1\") global.set(\"estIslaRGB\", 1);\n\t// global.set(\"estIslaRGB\", parseInt(msg.payload));\n\t// if (msg.payload == \"0\") global.set(\"estIslaRGB\", parseInt(msg.payload));\n\tenviarMQTT();}\n\nif (topic == \"Blink/estIsla\"){\n\tglobal.set(\"estIsla\", parseInt(msg.payload));\n\tenviarMQTT();}\n\nif (topic == \"Blink/estCielorrazo\"){\n\tglobal.set(\"estCielorrazo\", parseInt(msg.payload)); \n\tenviarMQTT();}\n\nif (topic == \"Blink/estRGB\"){global.set(\"estIslaRGB\", parseInt(msg.payload)); enviarMQTT();}\n\nif (topic == \"Blink/colorRGB\"){\n\tglobal.set(\"IslaR\", msg.arrayOfValues[0]);\n\tglobal.set(\"IslaG\", msg.arrayOfValues[1]);\n\tglobal.set(\"IslaB\", msg.arrayOfValues[2]);\n\tmsg = {pin: 32, payload: \"12\"}; node.send([null, msg]);\n\tglobal.set(\"estIslaRGB\", 1);\n\tenviarMQTT();\n}\n\nfunction enviarMQTT(){\n\t// if (global.get(\"estIsla\") == \"0\" && global.get(\"estCielorrazo\") == \"0\" && global.get(\"estIslaRGB\") == \"0\")global.set(\"estLiving\", 0);\n\tif (global.get(\"estIsla\") == \"1\" || global.get(\"estCielorrazo\") == \"1\"){\n\t\tif(topic != \"Blink/estLiving\")global.set(\"estLiving\", 1);\n\t\t}\t\n\tif (msg.topic == \"apagadoAuto\") global.set(\"estLiving\", 0);\t\t\n\tmsg = {pin: 14, payload: global.get(\"estLiving\")}; node.send([null, msg]);\n\tmsg = {pin: 16, payload: global.get(\"estIsla\")}; node.send([null, msg]);\n\tmsg = {pin: 17, payload: global.get(\"estCielorrazo\")}; node.send([null, msg]);\n\tmsg = {pin: 29, payload: global.get(\"estIslaRGB\")}; node.send([null, msg]);\n\tif(topic == \"ESP/living/Iluminacion/Envio\")return;\n\n\tif (global.get(\"estLiving\") == \"0\") {msg = {pin: 14, payload: 0}; node.send([null, msg]);}\n\n\tif (global.get(\"estLiving\") == \"0\") {\n\t\tmsg = {pin: 16, payload: 0}; node.send([null, msg]);\n\t\tdato = \"0,\";\n\t} \n\telse{dato = global.get(\"estIsla\") + \",\";}\n\tdato += global.get(\"potIsla\") + \"#\";\n\n\tif (global.get(\"estLiving\") == \"0\") {\n\t\tmsg = {pin: 17, payload: 0}; node.send([null, msg]);\n\t\tdato += \"0,\";\n\t} \n\telse{dato += global.get(\"estCielorrazo\") + \",\";}\n\tdato += global.get(\"potCielorrazo\") + \"#\";\t\n\n\tif (global.get(\"estLiving\") == \"0\") {\n\t\tmsg = {pin: 29, payload: 0}; node.send([null, msg]);\n\t\tdato += \"0,\";\n\t} \n\telse{dato += global.get(\"estIslaRGB\") + \",\";}\n\tdato += global.get(\"IslaR\") + \",\";\n\tdato += global.get(\"IslaG\") + \",\";\t\t\n\tdato += global.get(\"IslaB\") + \"#\";\n\tdato += global.get(\"dimmerLeds\") + \"#\";\n\tdato += global.get(\"minTeclas\") + \"#\";\n\tdato += global.get(\"maxTeclas\") + \"#\";\n\tdato += global.get(\"doblePuls\");\n\tmsg = {topic: \"ESP/living/Iluminacion/Recibo\", payload: dato};\n\tnode.send([msg, null]);\t\t\n}\n\n","outputs":2,"noerr":0,"x":590,"y":355.75,"wires":[[],[]]},{"id":"2ef0894a.4f29a6","type":"mqtt out","z":"1b403a13.0ec8c6","name":"","topic":"","qos":"2","retain":"","broker":"900627dc.76e6a8","x":670,"y":100,"wires":[]},{"id":"6bd3ae3f.85f67","type":"blynk-ws-in-write","z":"a89e305a.c50bb","name":"","pin":"16","pin_all":false,"client":"2c18e412.5f5cbc","x":175.80953216552734,"y":247.31744384765625,"wires":[["28a7bb8d.a92714"]]},{"id":"af10f8a0.316f08","type":"function","z":"a89e305a.c50bb","name":"","func":"global.set(\"minTeclas\", msg.payload);\nnode.status({text: \"min: \" + global.get(\"minTeclas\")});\nreturn msg;","outputs":1,"noerr":0,"x":1298.4125900268555,"y":83.3491907119751,"wires":[["9d06702c.8ed15"]]},{"id":"3f7e2463.eeaefc","type":"blynk-ws-out-write","z":"a89e305a.c50bb","name":"","pin":"33","pinmode":"0","client":"2c18e412.5f5cbc","x":1488.9881896972656,"y":254.49999523162842,"wires":[]},{"id":"c5a740fa.2a75d","type":"mqtt in","z":"a89e305a.c50bb","name":"","topic":"ESP/living/Iluminacion/Envio","qos":"2","broker":"6b36e4a.1d30b1c","x":125,"y":1063.2500190734863,"wires":[["fd96f1f7.18fdf"]]},{"id":"167e15ac.40532a","type":"blynk-ws-in-write","z":"3ce5b54a.127d6a","name":"marcha Bomba","pin":"2","pin_all":false,"client":"2c18e412.5f5cbc","x":2572.2980575561523,"y":121.17853736877441,"wires":[["be0dfdbd.fac73"]]},{"id":"aac6683a.0edb98","type":"blynk-ws-in-write","z":"3ce5b54a.127d6a","name":"Blynk","pin":"1","client":"2c18e412.5f5cbc","x":2440,"y":650,"wires":[["893a6b3c.fdb088","b5b11857.bbf368"]]},{"id":"7f41c912.6882e8","type":"function","z":"1b403a13.0ec8c6","name":"val. in. termo","func":"var dato = msg.payload.split(\"#\");\nglobal.set(\"autoBomba\", dato[0]);\nglobal.set(\"autoResistencia\", dato[1]);\nglobal.set(\"autoToldo\", dato[2]);\nglobal.set(\"pedBomba\", dato[3]);\nglobal.set(\"pedResistencia\", dato[4]);\nglobal.set(\"pedToldo\", dato[5]);\nglobal.set(\"tempMaximaTermo\", dato[6]);\nglobal.set(\"tempMaxResistencia\", dato[7]);\nglobal.set(\"tempMaxResistenciaManual\", dato[8]);\nglobal.set(\"tempMinimaResistencia\", dato[9]);\nglobal.set(\"valorDia\", dato[10]);\nglobal.set(\"valorNoche\", dato[11]);\nglobal.set(\"segundosMarchaBomba\", dato[12]);\nglobal.set(\"offsetDia\", dato[13]);\nglobal.set(\"offsetNoche\", dato[14]);\n\nglobal.set(\"estBomba\", 0);\nglobal.set(\"estResistencia\", 0);\nglobal.set(\"estToldo\", 0);\nglobal.set(\"tempTermoFin\", 0);\nglobal.set(\"tempExteriorFin\", 0);\nglobal.set(\"sensorCrep\", 0);\nglobal.set(\"comienzoLlenado\", 0);\nglobal.set(\"tiempoLlenado\", 0);\nmsg = {topic: \"ESP/TermoSolar/pedido\", payload: 1}; node.send(msg);//ESP/TermoSolar/Recibo\n\n","outputs":1,"noerr":0,"x":1530,"y":500,"wires":[["9ac4a3ca.adf2f"]]},{"id":"ad32e63d.c5d998","type":"inject","z":"3ce5b54a.127d6a","name":"Reset Fallas","topic":"Reset","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1456.3845138549805,"y":1003.1432180404663,"wires":[["eb85b399.7743b","3fde9ea6.1be982","d2f7959d.e7cee8","19a026a2.d6c979"]]},{"id":"c2a0d286.2ba8f","type":"mqtt out","z":"a89e305a.c50bb","name":"","topic":"","qos":"2","retain":"","broker":"6b36e4a.1d30b1c","x":780,"y":260,"wires":[]},{"id":"dcfa603b.9ecfe","type":"function","z":"a89e305a.c50bb","name":"","func":"global.set(\"maxTeclas\", msg.payload);\nnode.status({text: \"max: \" + global.get(\"maxTeclas\")});\nreturn msg;","outputs":1,"noerr":0,"x":1286.3492050170898,"y":142.5555534362793,"wires":[["8a7dbff4.6ce81"]]},{"id":"91de3003.b9dff","type":"inject","z":"7ac92c99.66ea94","name":"","topic":"","payload":"luces del living","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":163.01184177398682,"y":363.07139825820923,"wires":[["d18e6794.44d0b8"]]},{"id":"448117e8.f264f8","type":"debug","z":"7ac92c99.66ea94","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":699.2618417739868,"y":255.39282989501953,"wires":[]},{"id":"fe41774b.fab598","type":"debug","z":"a89e305a.c50bb","name":"iluminacionLiving - aviso/alarma","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":670,"y":40,"wires":[]},{"id":"999f0fa5.c486a","type":"inject","z":"50119c6e.6ff584","name":"","topic":"","payload":" ","payloadType":"str","repeat":"1","crontab":"","once":false,"onceDelay":0.1,"x":680,"y":280,"wires":[["73985425.8391fc"]]},{"id":"fd96f1f7.18fdf","type":"delay","z":"a89e305a.c50bb","name":"","pauseType":"delay","timeout":"100","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":320,"y":1060.7500171661377,"wires":[["c971c023.98bae"]]},{"id":"95918cd1.4e44e","type":"inject","z":"3ce5b54a.127d6a","name":"Info","topic":"","payload":"{\"topic\":\"Baterias/Est/Pedido\",\"payload\":1}","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":330,"y":890,"wires":[["42bf6e98.eba1a"]]},{"id":"70fa10a1.366bb","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"configNano","qos":"2","broker":"c339edbf.39572","x":2758.726531982422,"y":241.23807048797607,"wires":[["1401f851.1605b8","db4a5c94.37525"]]},{"id":"228a0974.4bf346","type":"mqtt in","z":"a89e305a.c50bb","name":"","topic":"ESP/living/Iluminacion/Envio","qos":"2","broker":"6b36e4a.1d30b1c","x":309.88092041015625,"y":551.8413162231445,"wires":[["4f93da66.796464","e4201820.2ea728","cce091cd.a69e5","e17205ac.325498"]]},{"id":"13d24f97.6f3b5","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg = {topic: \"tempBat1\", payload: global.get(\"tempBat1\")}; node.send(msg);\n","outputs":1,"noerr":0,"x":2533.5951919555664,"y":925.4523634229388,"wires":[["4244f3d0.dcc0fc"]]},{"id":"4f310b0e.f40b74","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"[]","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":2530.3808822631836,"y":811.1666733878,"wires":[["35b5038b.76c79c"]]},{"id":"f73609e2.4ce548","type":"debug","z":"a89e305a.c50bb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":856.3096160888672,"y":785.2142362594604,"wires":[]},{"id":"a14c5529.801d68","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"resetAutos","qos":"2","broker":"c339edbf.39572","x":1606.0243949890137,"y":315.58325931004117,"wires":[[]]},{"id":"b251bc31.c6c1a","type":"debug","z":"3ce5b54a.127d6a","name":"salida blynk","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":2972.6666717529297,"y":586,"wires":[]},{"id":"292a597f.5f6ce6","type":"debug","z":"3ce5b54a.127d6a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":574.1666717529297,"y":682.75,"wires":[]},{"id":"4a51d0e8.24515","type":"debug","z":"3ce5b54a.127d6a","name":"Blynk display","active":false,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","x":696.3571853637695,"y":292.47617408207486,"wires":[]},{"id":"ada34632.0efde8","type":"function","z":"a89e305a.c50bb","name":"borrar","func":"if (msg.payload == \"0\")return;\nmsg.topic = \"borrar\";\nreturn msg;","outputs":1,"noerr":0,"x":515.0000381469727,"y":1128.250018119812,"wires":[["ea323d6b.c8d47","2e64d84.7903128"]]},{"id":"dc6474be.3fcdc8","type":"blynk-ws-out-write","z":"a89e305a.c50bb","name":"","pin":0,"pinmode":"1","client":"2c18e412.5f5cbc","x":886.2500114440918,"y":1127.0000171661377,"wires":[]},{"id":"30b5d105.4413ee","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"google/Tanque","qos":"2","broker":"c339edbf.39572","x":2767.202362060547,"y":163.0357141494751,"wires":[["1401f851.1605b8","f0ebdc.ed0bc428"]]},{"id":"527bfce.c926404","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"Pedido/Living/Iluminacion","qos":"2","broker":"c339edbf.39572","x":3001.666488647461,"y":946.8571758270264,"wires":[["37b274f1.b85e5c"]]},{"id":"e9640668.b315e8","type":"function","z":"e364a467.07a6a8","name":"","func":"msg.payload = msg.payload.replace(\",\", \".\");\nglobal.set(\"MaximoVender\", parseFloat(msg.payload).toFixed(2));\nnode.status({text: \"MaximoVender:\" + global.get(\"MaximoVender\")});\nreturn msg;","outputs":1,"noerr":0,"x":451.7777557373047,"y":224.24999809265137,"wires":[[]]},{"id":"a5a5e9c9.c35e08","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg= {topic: \"SensPasillo\", payload: global.get(\"tipoFallaPasillo\")}; \nreturn msg","outputs":1,"noerr":0,"x":3344.523635864258,"y":901.1428813934326,"wires":[["64665ba0.e14754"]]},{"id":"a3832c3f.01897","type":"blynk-ws-out-write","z":"a89e305a.c50bb","name":"","pin":0,"pinmode":"1","client":"2c18e412.5f5cbc","x":951.8810272216797,"y":347.7499885559082,"wires":[]},{"id":"a63faef1.a5598","type":"mqtt out","z":"a89e305a.c50bb","name":"","topic":"","qos":"2","retain":"","broker":"6b36e4a.1d30b1c","x":815.2380218505859,"y":94.77776527404785,"wires":[]},{"id":"d6c2fdea.31e4e","type":"blynk-ws-out-set-property","z":"a89e305a.c50bb","name":"","pin":0,"pinmode":"1","prop":"bycode","client":"2c18e412.5f5cbc","x":870,"y":310,"wires":[]},{"id":"9e25b334.c4563","type":"file","z":"f682d492.22a758","name":"","filename":"","appendNewline":false,"createDir":false,"overwriteFile":"true","x":741.3333740234375,"y":120.99999046325684,"wires":[[]]},{"id":"cfad27b3.b25498","type":"debug","z":"3ce5b54a.127d6a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":3237.178680419922,"y":159.5118579864502,"wires":[]},{"id":"32579c36.c90564","type":"inject","z":"3ce5b54a.127d6a","name":"Seleccionar todo","topic":"SELECT * FROM `toldo` WHERE 1","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1839.1193885803223,"y":294.54768344334195,"wires":[["237f4d2a.446662"]]},{"id":"d93912ae.10887","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":504.1666793823242,"y":384.17857715061734,"wires":[["2428a89d.746c48"]]},{"id":"28e99f08.c73f1","type":"function","z":"a89e305a.c50bb","name":"","func":"msg = {topic: \"Blynk\", payload: 1};\nreturn msg","outputs":1,"noerr":0,"x":375.38092041015625,"y":635.7857666015625,"wires":[["e4201820.2ea728","6df38ac8.30d6a4"]]},{"id":"ae138e5d.50e71","type":"file in","z":"f682d492.22a758","name":"flows_vps_cred.json","filename":"/home/gaston/.node-red/projects/Node-Red-Mi-Casa/flow_cred.json","format":"utf8","sendError":true,"x":383,"y":126,"wires":[["5fae0180.0724f"]]},{"id":"13adbc11.4ab694","type":"ui_chart","z":"3ce5b54a.127d6a","name":"","group":"177e0064.22348","order":1,"width":"16","height":"10","label":"Tanque","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"140","ymax":"620","removeOlder":"3","removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":true,"x":2749.8810119628906,"y":848.285699571882,"wires":[[],[]]},{"id":"c8be9ca.b68de6","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg = {topic: \"Blynk/mostrar/infos\", payload: msg.payload};\nreturn msg;","outputs":1,"noerr":0,"x":1608.6072158813477,"y":804.0356712341309,"wires":[["29c9ac88.41f9b4","37d15e3c.0a1382"]]},{"id":"46a348b2.be9438","type":"function","z":"3ce5b54a.127d6a","name":"","func":"if (msg.payload == \"1\"){\n    msg = {topic: \"Reset\"};\n    return msg;\n}\n","outputs":1,"noerr":0,"x":1486.2500038146973,"y":1041.7777528762817,"wires":[["3fde9ea6.1be982","eb85b399.7743b","d2f7959d.e7cee8","19a026a2.d6c979"]]},{"id":"7b8f8d35.3a0bc4","type":"delay","z":"3ce5b54a.127d6a","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2964.3800048828125,"y":679.5000540869577,"wires":[["7d2e1271.afd57c"]]},{"id":"748c0ad2.0b8444","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"3","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1407.1789283752441,"y":815.4643115997314,"wires":[["c8be9ca.b68de6"]]},{"id":"7035a7c7.4ce788","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"1","payloadType":"num","repeat":"1.7","crontab":"","once":false,"onceDelay":0.1,"x":1485.670280456543,"y":968.4405221939087,"wires":[["eb85b399.7743b","3fde9ea6.1be982","d2f7959d.e7cee8","19a026a2.d6c979"]]},{"id":"6f98672c.6c0c68","type":"inject","z":"a89e305a.c50bb","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":213.75001525878906,"y":962.0000133514404,"wires":[["610597ee.3b4568","b9762c5c.53da"]]},{"id":"c971c023.98bae","type":"function","z":"a89e305a.c50bb","name":"consulta","func":"if (msg.payload ==\"0\")return;\nmsg.topic = \"consulta\";\nreturn msg;","outputs":1,"noerr":0,"x":513.7500381469727,"y":1079.500015258789,"wires":[["ea323d6b.c8d47","2e64d84.7903128"]]},{"id":"f80091fc.1ea","type":"function","z":"7ac92c99.66ea94","name":"","func":"msg.estado = 1;\nreturn msg;","outputs":1,"noerr":0,"x":294.6190309524536,"y":101.9999828338623,"wires":[["771db2a8.1bf0fc","97534816.4d4508"]]},{"id":"d25feaf0.aac288","type":"mqtt in","z":"1b403a13.0ec8c6","name":"","topic":"ESP/TermoSolar/Envio","qos":"2","broker":"900627dc.76e6a8","x":570,"y":225,"wires":[["2aaab111.aa444e"]]},{"id":"ccab347c.a6ebe8","type":"inject","z":"1b403a13.0ec8c6","name":"bomba auto","topic":"","payload":"1","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":230,"wires":[["d63b04d.1a1ddf8"]]},{"id":"58cd06ab.bd05c8","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"USBin/Baterias","qos":"2","broker":"c339edbf.39572","x":269.8810577392578,"y":243.8095147269113,"wires":[["f1697d45.0cc3b","47d18bfc.1896e4"]]},{"id":"73837d68.7c6a34","type":"blynk-ws-out-write","z":"3ce5b54a.127d6a","name":"","pin":0,"pinmode":"1","client":"2c18e412.5f5cbc","x":2150,"y":810,"wires":[]},{"id":"eef57e3.f227e8","type":"mqtt out","z":"f682d492.22a758","name":"","topic":"USBout","qos":"","retain":"","broker":"3fe9d635.ec409a","x":883.5476036071777,"y":211.33333587646484,"wires":[]},{"id":"b241dea3.0cc9f","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"1","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1819.773998260498,"y":702.5595386368888,"wires":[["c628fd83.f544d"]]},{"id":"db53bed6.d24d9","type":"function","z":"3ce5b54a.127d6a","name":"","func":"global.set(\"tiempoEspera\", 0);\nnode.status({text: global.get(\"tiempoEspera\")});//estadoCargador","outputs":1,"noerr":0,"x":805.5952565329417,"y":609.7142857142858,"wires":[[]]},{"id":"743118bd.7d5b08","type":"ui_gauge","z":"3ce5b54a.127d6a","name":"","group":"ff2252ef.d12aa","order":9,"width":"2","height":"2","gtype":"gage","title":"Temp Bat5","label":"units","format":"{{value}}","min":"20","max":"70","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":2762.166603088379,"y":1099.7380842481343,"wires":[]},{"id":"23547dec.5e1192","type":"debug","z":"a89e305a.c50bb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":733.3333333333334,"y":1226.4444444444443,"wires":[]},{"id":"cb934c1f.8b54a","type":"inject","z":"3ce5b54a.127d6a","name":"Borrar Crepuscular","topic":"borrarCrep","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":247.4524383544922,"y":366.5952355521066,"wires":[["f1697d45.0cc3b"]]},{"id":"7385d352.01625c","type":"function","z":"3ce5b54a.127d6a","name":"llenado tanque","func":"msg = {topic: \"blynk/llenarTanque\", payload: parseInt(msg.payload)};\nreturn msg;\n\n\n// global.set(\"valvulaTanque\", parseInt(msg.payload));\n// msg = {topic: \"ESP/Lavadero/Bombas/Estado/Rele0\", payload: global.get(\"valvulaTanque\")}; node.send(msg);\n// msg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"most\\\",\\\"payload\\\":\" + msg.payload + \"}\"}; node.send(msg);\n// return ","outputs":1,"noerr":0,"x":2773.606414794922,"y":333.6190242767334,"wires":[["1401f851.1605b8"]]},{"id":"fccb22de.242ec","type":"blynk-ws-out-write","z":"a89e305a.c50bb","name":"","pin":0,"pinmode":"1","client":"2c18e412.5f5cbc","x":836.2500152587891,"y":1039.5000162124634,"wires":[]},{"id":"e1096abc.ea93c8","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":688.4523860386439,"y":501.1428571428571,"wires":[["b331a173.04cab"]]},{"id":"f0ebdc.ed0bc428","type":"debug","z":"3ce5b54a.127d6a","name":"google/tanque","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":3028.6666717529297,"y":38,"wires":[]},{"id":"8cb8672f.9c0e68","type":"file","z":"a89e305a.c50bb","name":"","filename":"","appendNewline":true,"createDir":false,"overwriteFile":"false","x":581.2500076293945,"y":955.7500143051147,"wires":[[]]},{"id":"6d3158ca.fee558","type":"mqtt out","z":"a89e305a.c50bb","name":"","topic":"ESP/living/Iluminacion/Envio","qos":"","retain":"","broker":"6b36e4a.1d30b1c","x":1081.4523391723633,"y":606.0714712142944,"wires":[]},{"id":"1e65b381.b1ab5c","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":2608.3210067749023,"y":376.2262020111084,"wires":[["7385d352.01625c"]]},{"id":"482c04ab.16181c","type":"inject","z":"a89e305a.c50bb","name":"","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1219.5237350463867,"y":684.142834186554,"wires":[["8a747565.3d6dd8","2981ce96.3bf072"]]},{"id":"b620bf47.41d6f","type":"inject","z":"3ce5b54a.127d6a","name":"Consulta Crepuscular","topic":"consultaCrep","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":237.45242309570312,"y":328.02381106785367,"wires":[["f1697d45.0cc3b"]]},{"id":"e1819fa7.ce1f7","type":"function","z":"a89e305a.c50bb","name":"","func":"global.set(\"doblePuls\", msg.payload);\nnode.status({text: \"estado: \" + global.get(\"doblePuls\")});\nreturn msg;","outputs":1,"noerr":0,"x":1328.9881019592285,"y":220.74999237060547,"wires":[["8eae8835.51cb08","3f7e2463.eeaefc"]]},{"id":"1405c24c.94e40e","type":"debug","z":"3ce5b54a.127d6a","name":"Serial In","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":361.9762763977051,"y":657.0714795248849,"wires":[]},{"id":"bc4544ad.0996f8","type":"inject","z":"a89e305a.c50bb","name":"","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1219.5237464904785,"y":575.5713982582092,"wires":[["34cc6743.777428"]]},{"id":"863e9c2e.a3087","type":"inject","z":"a89e305a.c50bb","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":168.74999618530273,"y":1250.7500200271606,"wires":[["95ec8bcd.b09a48"]]},{"id":"6e949be8.c70644","type":"thingspeak42","z":"e6e33852.2495f8","name":"BDX88EB6QMF2IKY0","delay":"5","topic1":"DescargaFast","topic2":"SubidaFast","topic3":"DescargaFiber","topic4":"SubidaFiber","topic5":"","topic6":"","topic7":"","topic8":"","endpoint":"https://thingspeak.com","x":884.6666564941406,"y":425.66665029525757,"wires":[]},{"id":"288336d4.991aaa","type":"debug","z":"3ce5b54a.127d6a","name":"salida2 lcd blynk","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1970,"y":930,"wires":[]},{"id":"60f559a8.7ea438","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"estadoFallas","qos":"2","broker":"c339edbf.39572","x":1399.8809547424316,"y":1262.5714468955994,"wires":[["1583c20e.1315ee"]]},{"id":"1749d978.33e787","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"comprobarConexionLiving","qos":"2","broker":"c339edbf.39572","x":1421.8054809570312,"y":1086.2223482131958,"wires":[["3fde9ea6.1be982"]]},{"id":"21296bc1.2ea0d4","type":"mqtt out","z":"50119c6e.6ff584","name":"","topic":"","qos":"2","retain":"","broker":"e779f8d6.7bc2c8","x":457.857084274292,"y":104.28573513031012,"wires":[]},{"id":"d4c01dc9.1020d","type":"debug","z":"7ac92c99.66ea94","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":361.3809595108032,"y":562.8571248054504,"wires":[]},{"id":"817c4eab.44409","type":"function","z":"7ac92c99.66ea94","name":"Penreder (Nuevo)","func":"var payload = msg.payload;\nvar estado = msg.estado;\n\n// if (!payload.includes(\"living\")) return;\nif (payload.includes(\"luces\") || payload.includes(\"luz\")){\n\tif (payload.includes(\"living\")){\n\t\tif (payload.includes(\"isla\")){\n\t\t\tglobal.set(\"estIsla\", estado);\n\t\t\tmsg = {topic: \"google/Living\", payload: \"estIsla= \" + global.get(\"estIsla\")};\n\t\t\treturn msg;\n\t\t}\n\t\tif (payload.includes(\"cielo raso\")){\n\t\t\tglobal.set(\"estCielorrazo\", estado);\n\t\t\tmsg = {topic: \"google/Living\", payload: \"estCielorrazo= \" + global.get(\"estCielorrazo\")};\n\t\t\treturn msg;\n\t\t}\n\t\tif (payload.includes(\"rgb\")){\n\t\t\tglobal.set(\"estIslaRGB\", estado);\n\t\t\tmsg = {topic: \"google/Living\", payload: \"estIslaRGB= \" + global.get(\"estIslaRGB\")};\n\t\t\treturn msg;\n\t\t}\n\t}\n\t\tglobal.set(\"estLiving\", estado); \n\t\tglobal.set(\"estIsla\", estado);\n\t\tglobal.set(\"estCielorrazo\", estado);\n\t\tglobal.set(\"estIslaRGB\", estado);\n\t\tmsg = {topic: \"google/Living\", payload: \"estLiving= \" + global.get(\"estLiving\")};\n\t\treturn msg;}\n\nif (payload.includes(\"bomba\") && payload.includes(\"centrifuga\") || payload.includes(\"centrÃ­fuga\")){\n\tglobal.set(\"bombaPozo\", msg.estado);\n\tmsg = {topic: \"google/Tanque\", payload: msg.estado};\n    return msg;\t\n}","outputs":1,"noerr":0,"x":517.4761095046997,"y":309.14285612106323,"wires":[["a110d805.3e0758","448117e8.f264f8","ddd8882e.f587d8"]]},{"id":"41887e33.4312e","type":"function","z":"50119c6e.6ff584","name":"tempPatioLuz","func":"var temp = parseFloat(msg.payload) + 0;\nglobal.set(\"tempPatioLuz\", temp.toFixed(1));\nmsg= {topic: \"tempPatioLuz\", payload: global.get(\"tempPatioLuz\")}; node.send(msg);\nnode.status({text: \"temp: \" + global.get(\"tempPatioLuz\") + \" -- \" + global.get(\"hsCpu\")});","outputs":1,"noerr":0,"x":485.714262008667,"y":410.31750679016113,"wires":[["3fde6b72.65b1a4","e7016801.01fa68"]]},{"id":"6a9e13c8.88f12c","type":"inject","z":"e364a467.07a6a8","name":"","topic":"","payload":"Prueba node-red","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":422.6944007873535,"y":284.4285914301872,"wires":[["a2ae1c14.e354a"]]},{"id":"9600b95a.280848","type":"debug","z":"7ac92c99.66ea94","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":534.9523668289185,"y":691.25,"wires":[]},{"id":"bf1f52aa.5c9ae","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1466.5480003356934,"y":452.7261893408639,"wires":[["ae746686.8cad28"]]},{"id":"f0069ce0.a32ee","type":"exec","z":"e6e33852.2495f8","command":" speedtest --share --server 10748","addpay":false,"append":"","useSpawn":"true","timer":"","oldrc":true,"name":"Server FastNet","x":341.8888931274414,"y":126.77777767181396,"wires":[["40cbd7ce.d528d8","4bb5fb58.83db84"],[],[]]},{"id":"b4b09a6e.a09678","type":"blynk-ws-in-write","z":"a89e305a.c50bb","name":"","pin":"19","pin_all":false,"client":"2c18e412.5f5cbc","x":172.88891220092773,"y":439.1825351715088,"wires":[["154aa712.21f669"]]},{"id":"393719e5.4bc726","type":"function","z":"e364a467.07a6a8","name":"","func":"msg.payload = msg.payload.replace(\",\", \".\");\nglobal.set(\"MinimoVender\", parseFloat(msg.payload).toFixed(2));\nnode.status({text: \"MinimoVender:\" + global.get(\"MinimoVender\")});\nreturn msg;","outputs":1,"noerr":0,"x":451.77772521972656,"y":174.24999904632568,"wires":[[]]},{"id":"19a026a2.d6c979","type":"function","z":"3ce5b54a.127d6a","name":"falla lavadero","func":"// context.contadorLavadero = context.contadorLavadero || 0;\n// context.fallasLavadero = context.fallasLavadero || 0;\n// // var status;\n\n// context.contadorLavadero++;\nnode.status({text: \"Fall il Liv: \" + parseInt(global.get(\"fallasLivingIluminacion\"))});\n\nif (msg.topic === \"Reset\"){global.set(\"fallasLivingIluminacion\", 0);}// return;}\n\n// if (msg.topic === \"comprobarConexionLavadero\"){context.contadorLavadero = 0; return;}\n\n// if (context.contadorLavadero >= 5){\n//     context.contadorLavadero = 0;\n//     context.fallasLavadero++;\n//     global.set(\"fallasLavadero\", context.fallasLavadero);\n// }\n\n\n\n","outputs":1,"noerr":0,"x":1689.166732788086,"y":1134.1785685675486,"wires":[[]]},{"id":"2ff411a2.ce3fce","type":"ui_gauge","z":"3ce5b54a.127d6a","name":"","group":"ff2252ef.d12aa","order":1,"width":"2","height":"2","gtype":"gage","title":"Voltaje Bat.","label":"units","format":"{{value}}","min":"9","max":"16","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":2767.880958557129,"y":1222.5952598026824,"wires":[]},{"id":"be7730f2.1d5f3","type":"blynk-ws-in-write","z":"3ce5b54a.127d6a","name":"","pin":"3","client":"2c18e412.5f5cbc","x":1386.4051513671875,"y":335.53574344090055,"wires":[["ae746686.8cad28"]]},{"id":"6373c135.7182d","type":"function","z":"3ce5b54a.127d6a","name":"v1.1","func":"var topic = msg.topic;\nvar payload = parseInt(msg.payload);\ncontext.estadoToldo = context.estadoToldo || 0;  // estToldo:  0= parado, 1= abriendo, 2= abierto, 3= cerrando, 4= cerrado\ncontext.estAnt = context.estAnt || 0; // =0 parado, =1 abriendo, = 2 cerrando\nvar tiempoAbrir = 175 * 1000 * 1.5;\nvar tiempoCerrar = 175 * 1000 * 2;\nvar date = new Date();\nvar hh = date.getHours();\nvar mm = date.getMinutes();\nvar ss = date.getSeconds();\nvar dia = date.getDate();\nvar mes = date.getMonth();\nvar ano = date.getFullYear();\ncontext.tiempoToldo = context.tiempoToldo || date.getTime();\ncontext.datoAmanecer = context.datoAmanecer || date.getTime()+5000;\ncontext.CerrarToldoAuto = context.CerrarToldoAuto || 0;\ncontext.AbrirToldoAuto = context.AbrirToldoAuto || 0;\ncontext.hsAnterior =context.hsAnterior || hh-1;\n\ncontext.avisoAuto = context.avisoAuto || 0;\ncontext.avisoRociador = context.avisoRociador || 0;\ncontext.condicionEstadoToldo = context.condicionEstadoToldo || 0;\ncontext.aperturaAmanecer = context.aperturaAmanecer || 0;\nvar tiempoMojando = 3;\n\nvar dato = JSON.parse(msg.payload);\n\nvar tiempo = hh + \":\" + mm + \":\" + ss;\nnode.status({text: tiempo + \"  \" + context.CerrarToldoAuto + \" -- \" + hh});\n\n\nif (global.get(\"Dia\") === 0){context.aperturaAmanecer = 0; context.datoAmanecer = date.getTime() + 5000;}\n\tglobal.set(\"datoAmanecer\", context.datoAmanecer);\n\nif (topic === \"resetAutos\"){\n\tcontext.CerrarToldoAuto = 0;\n\tcontext.AbrirToldoAuto = 0;\t\n\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\treturn;\n}\n\nif (topic === \"toldoBlynk\"){\n\tglobal.set(\"estadoToldo\", \"Error Borrado\");\n\tif (payload === 1 && context.estAnt === 0){\n\t\tcontext.condicionEstadoToldo = 0;\n\t\tcontext.CerrarToldoAuto = 0;\n\t\tglobal.set(\"estadoToldoLCD\", \"Abriendo toldo modo manual (Blynk)\");\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Abriendo Toldo Manual Blynk\\\")\"};\n\t\tnode.send([null, null, null, null, msg]);\t\t\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\";\n\t\tnode.send([null, null, msg, null, null]); \n\t\t// msg = {payload: \"Es de Dia Abriendo Toldo\"}; node.send([null, null, null, msg]);\n\t\t}\n\tif (payload === 1 && context.estAnt === 1){\n\t\tcontext.condicionEstadoToldo = 0;\n\t\tcontext.AbrirToldoAuto = 0;\n\t\tglobal.set(\"estadoToldoLCD\", \"Cerrando toldo modo manual (Blynk)\");\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Cerrando Toldo Manual Blynk\\\")\"};\n\t\tnode.send([null, null, null, null, msg]);\t\t\t\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\";\n\t\tnode.send([null, null, msg, null, null]);}\n\n\tif (payload === 0 && context.estadoToldo === 2){\n\t\tcontext.condicionEstadoToldo = 0;\n\t\tglobal.set(\"estadoToldoLCD\", \"Cerrando toldo modo manual (Blynk)\");\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Cerrando Toldo Manual Blynk\\\")\"};\n\t\tnode.send([null, null, null, null, msg]);\t\t\t\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\";\n\t\tnode.send([null, null, msg, null, null]);}\n\tif (payload === 0){\n\t\tglobal.set(\"estadoToldoLCD\", \"Toldo Parado\");\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\";\n\t\tnode.send([null, null, msg, null, null]);}\n\t}\n\nif ((global.get(\"tempPatioLuz\") > 24 && global.get(\"Dia\") === 1) || global.get(\"tempPatioLuz\") < 15){\n\tif (context.CerrarToldoAuto === 0){\n\t\tcontext.CerrarToldoAuto = 1;\n\t\tcontext.AbrirToldoAuto = 0;\t\t\n\t\tcontext.condicionEstadoToldo = 1;\n\t\tvar datoMsg = \"Cerrando toldo modo automatico por temperatura de patio de luz= \" + global.get(\"tempPatioLuz\") + \" rango 24<(\" + global.get(\"tempPatioLuz\") + \")<15\";\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \")\"};\n\t\tnode.send([null, null, null, null, msg]);\t\t\t\n\t\tmsg = {payload: datoMsg};  global.set(\"estadoToldoLCD\", msg.payload); node.send([null, null, null, msg]);\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\";\n\t\tnode.send([null, null, msg, null, null]); \n\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\t\treturn;}\t\t\t\n\t}\t\n\nif (topic === \"crepMQTT\" && payload === 0 && global.get(\"tempPatioLuz\") < 23 && global.get(\"tempPatioLuz\") > 18){\n\tcontext.CerrarToldoAuto = 0;\n\tcontext.condicionEstadoToldo = 2;\n\tvar datoMsg = \"Abriendo toldo por hacerse de noche\";\n\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"Abriendo toldo por oscurecer\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + global.get(\"hsAnochecer\") + \"\\\")\"};\n\tnode.send([null, null, null, null, msg]);\t\t\t\n\tmsg = {payload: datoMsg}; global.set(\"estadoToldoLCD\", msg.payload); node.send([null, null, null, msg]);\n\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\";\t\t\n\tnode.send([null, null, msg, null, null]); \n\t\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n}\t\t\n\nif (global.get(\"tempPatioLuz\") < 21 && global.get(\"tempPatioLuz\") > 18 && context.AbrirToldoAuto === 0){\n\tif (global.get(\"tempPatioLuz\") > 19)context.CerrarToldoAuto = 0;\n\tcontext.condicionEstadoToldo = 1;\n\tvar datoMsg = \"Abriendo toldo modo automatico por temperatura, \" + \"rango 21<(\" + global.get(\"tempPatioLuz\") + \")>18\";\n\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n\tnode.send([null, null, null, null, msg]);\t\t\t\n\tmsg = {payload: datoMsg}; global.set(\"estadoToldoLCD\", msg.payload); node.send([null, null, null, msg]);\n\tcontext.AbrirToldoAuto = 1;\n\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\";\n\tnode.send([null, null, msg, null, null]); \n\t\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\treturn;\t\n}\n\n// if (msg.topic === \"ponele\"){\n// \tvar datoAmanecer = global.get(\"hsAmanecer\"); \n// \tif (datoAmanecer === undefined)datoAmanecer = null;\n// \tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"Abrir Auto por Hora, hs= \" + hh + \":\" + mm + \":\" + ss + \"\\\", \\\"null\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n// \tnode.send([null, null, null, null, msg]);\t\t\t\n// \t// msg = {payload: \"Abriendo toldo modo automatico por tiempo, hs hsAmanecer= \" + global.get(\"hsAmanecer\") + \"  hs apertura= \" + hh + \":\" + mm + \":\" + ss}; context.condicionEstadoToldo = 4; global.set(\"estadoToldoLCD\", msg.payload); node.send([null, null, null, msg]);\n// }\n//60 * 60 * 1.5\nif ((date.getTime() > (context.datoAmanecer + (1000 * 60 * 60 * 1.5))) && global.get(\"tempPatioLuz\") < 23){   //Abrir Auto por Hora, hs= 23:15:25\n\tif (global.get(\"tempPatioLuz\") > 19)context.CerrarToldoAuto = 0;\n\tif(context.AbrirToldoAuto === 0  && context.aperturaAmanecer === 0){\n\t\tcontext.condicionEstadoToldo = 3;\n\t\tcontext.aperturaAmanecer = 1;\n\t\tcontext.AbrirToldoAuto = 1;\t\t\n\t\tvar datoAmanecer = global.get(\"hsAmanecer\"); if (datoAmanecer === undefined)datoAmanecer = null;\n\t\tvar datoMsg = \"Abriendo toldo modo automatico por Amanecer, hs amanecer: \" + global.get(\"hsAmanecer\") + \"  hs apertura: \" + hh + \":\" + mm + \":\" + ss;\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n\t\tnode.send([null, null, null, null, msg]);\t\t\t\n\t\tmsg = {payload: datoMsg}; context.condicionEstadoToldo = 1; global.set(\"estadoToldoLCD\", msg.payload); node.send([null, null, null, msg]);\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\";\n\t\tnode.send([null, null, msg, null, null]); \n\t\t\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\t\treturn;}\t\n}\n\nif (context.estadoToldo === 1){\n\tif(date.getTime() - context.tiempoToldo > tiempoAbrir){\n\tcontext.estadoToldo = 0;\n\tglobal.set(\"estadoToldo\", \"Error Toldo\");\n\tmsg = {payload: 1, color: \"#D3435C\", onlabel: \"Error\", pin: 3}; node.send([null, msg, null, null, null]);\n\tmsg = {payload: \"Error al cerrar toldo\"}; node.send([null, null, null, msg, null]);\n\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\";\n\tnode.send([null, null, msg, null, null]);\n\treturn;\t\n\t}//error al abrir//error al abrir\n}\nif (context.estadoToldo === 3){\n\tif(date.getTime() - context.tiempoToldo > tiempoCerrar){\n\tcontext.estadoToldo = 0;\n\tglobal.set(\"estadoToldo\", \"Error Toldo\");\n\tmsg = {payload: 1, color: \"#D3435C\", onlabel: \"Error\", pin: 3}; node.send([null, msg, null, null, null]);\n\tmsg = {payload: \"Error al abrir toldo\"}; node.send([null, null, null, msg, null]);\n\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\";\n\tnode.send([null, null, msg, null, null]);\n\treturn;\t\n\t}//error al cerrar\n}\t\n\nif (msg.topic === \"enfriarToldoBlynk\"){global.set(\"enfriarToldo\", msg.apyload);}\n\nif (global.get(\"tempPatioLuz\") >= 25 && global.get(\"estadoToldo\") === \"Cerrado\"  && global.get(\"enfriarToldo\") === 0){\n\t\tvar datoEnfriador = \"Enfriador habilitado\";//, hs= \" + tiempo + \" temp= \" + global.get(\"tempPatioLuz\");\n\t\tglobal.set(\"enfriadorToldo\", datoEnfriador);\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + datoEnfriador + \"\\\")\"}; node.send([null, null, null, null, msg]); \n\t\tmsg = {payload: datoEnfriador}; node.send([null, null, null, msg]);\n\t\tglobal.set(\"enfriarToldo\", 1);}\n\nif (global.get(\"tempPatioLuz\") < 22 && global.get(\"enfriarToldo\") === 1 || global.get(\"estadoToldo\") !== \"Cerrado\" && global.get(\"enfriarToldo\") === 1){\n\t\tvar datoEnfriador = \"Enfriador deshabilitado\";\n\t\tglobal.set(\"enfriadorToldo\", datoEnfriador);\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + datoEnfriador + \"\\\")\"}; node.send([null, null, null, null, msg]);\n\t\tglobal.set(\"enfriarToldo\", 0);}\n\nif (global.get(\"enfriarToldo\") === 1){\n\tcontext.avisoRociador = 1;\n\tif (context.hsAnterior !== hh && mm === 0 && ss === 1 && global.get(\"mojandoToldo\") === 0){\n\t\tglobal.set(\"mojandoToldo\", 1);\n\t\tcontext.hsAnterior = hh;\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 1}\"; node.send([null, null, msg, null, null]);\n\n\t\tmsg.payload = \"Enfriando toldo, hs= \" + tiempo; node.send([null, null, null, msg, null]);\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + msg.payload + \"\\\")\"}; \n\t\tnode.send([null, null, null, null, msg]);\t\t\n\t}\n\tif (global.get(\"mojandoToldo\") === 1 && mm === tiempoMojando && ss === 1){\t\n\t\tglobal.set(\"mojandoToldo\", 0);\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 0}\"; node.send([null, null, msg, null, null]);\t\t\n\n\t\tmsg.payload = \"Termino de enfriar toldo, hs= \" + tiempo; node.send([null, null, null, msg, null]);\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + msg.payload + \"\\\")\"}; \n\t\tnode.send([null, null, null, null, msg]);\t\t\n\t\t}\n\t}\nif (global.get(\"enfriarToldo\") === 0 && context.avisoRociador === 1){\t\t\n\tmsg.payload = \"Enfriador deshabilitado\"; node.send([null, null, null, msg, null]);\n\n\tcontext.avisoRociador = 0;\t\t\n\tglobal.set(\"mojandoToldo\" , 0);\n\tmsg.payload = \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 0}\"; \n\tnode.send([null, null, msg, null, null]);\n}\n\nif (dato.topic === \"toldo\"){\n\t// if (global.get(\"estadoToldo\") === \"Error Toldo\") return;\n\tswitch (dato.payload){\n\t\tcase 0:\n\t\t\t// if (context.estadoToldo === 0)return;\n\t\t\tglobal.set(\"estadoToldo\", \"Parado\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\")});\t\t\n\t\t\tcontext.estadoToldo = 0;\t\n\t\t\tglobal.set(\"estadoToldoLCD\", \"Toldo parado de forma manual (Blynk)\");\n\t\t\tif (context.estAnt === 0){context.estAnt = 0; msg = {payload: 0, color: \"#ffbc26\", offlabel: \"Abrir\", pin: 3}; node.send([null, msg, null, null, null]); return;}\n\t\t\tif (context.estAnt === 1){context.estAnt = 1;msg = {payload: 0, color: \"#ffbc26\", offlabel: \"Cerrar\", pin: 3}; node.send([null, msg, null, null, null]); return;}\n\t\tbreak;\n\t\tcase 1:\t\n\t\t\tif (global.get(\"estadoToldo\") === \"Abierto\") return;\n\t\t\tcontext.tiempoToldo = new Date().getTime();\n\t\t\tmsg = {payload: 1, color: \"#ffbc26\", onlabel: \"Abriendo\", pin: 3}; node.send([null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Abriendo Toldo\"}; node.send([null, null, null, msg]);\n\t\t\tcontext.estadoToldo = 1;\n\t\t\tcontext.estAnt = 1;\n\t\t\tglobal.set(\"estadoToldo\", \"Abriendo\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\") + \" \" + context.tiempoToldo});\n\t\tbreak;\n\t\tcase 2:\n\t\t\tif (context.condicionEstadoToldo === 0)global.set(\"estadoToldoLCD\", \"Toldo Abierto de forma manual (Blynk  \" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \")\");\n\t\t\tif (context.condicionEstadoToldo === 1)global.set(\"estadoToldoLCD\", \"Toldo Abierto (\" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \")\" + global.get(\"estadoToldoLCD\").substring(30));\n\t\t\tif (context.condicionEstadoToldo === 2)global.set(\"estadoToldoLCD\", \"Toldo Abierto (\" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \") por Oscurecer\");\n\t\t\tif (context.condicionEstadoToldo === 3)global.set(\"estadoToldoLCD\", \"Toldo Abierto (\" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \") por Amanecer\");\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + global.get(\"estadoToldoLCD\") + \"\\\",\" + ((date.getTime() - context.tiempoToldo) / 1000) + \",\" + global.get(\"tempPatioLuz\") + \")\"};\n\t\t\tnode.send([null, null, null, null, msg]);\n\t\t\tmsg = {pin: 3, payload: 1, color: \"#23C48E\", onlabel: \"Cerrar\"}; node.send([null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Toldo Abierto, tiempo de apertura= \" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \"\\\"\"}; node.send([null, null, null, msg]);\n\t\t\tcontext.estadoToldo = 2;\n\t\t\tcontext.estAnt = 1;\n\t\t\tglobal.set(\"estadoToldo\", \"Abierto\");\n\t\t\treturn;\n\t\tcase 3:\n\t\t\tif (global.get(\"estadoToldo\") === \"Cerrado\") return;\t\t\t\n\t\t\tcontext.tiempoToldo = new Date().getTime();\n\t\t\tmsg = {payload: 1, color: \"#ffbc26\", onlabel: \"Cerrando\", pin: 3}; node.send([null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Cerrando Toldo\"}; node.send([null, null, null, msg]);\n\t\t\tcontext.estadoToldo = 3;\n\t\t\tcontext.estAnt = 0;\n\t\t\tglobal.set(\"estadoToldo\", \"Cerrando\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\") + \" \" + context.tiempoToldo});\n\t\tbreak;\n\t\tcase 4:\n\t\t\t// if (global.get(\"estadoToldo\") === \"Cerrado\")\n\t\t\tif (context.condicionEstadoToldo === 0)global.set(\"estadoToldoLCD\", \"Toldo Cerrado de forma manual (Blynk \" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \")\");\n\t\t\tif (context.condicionEstadoToldo === 1)global.set(\"estadoToldoLCD\", \"Toldo Cerrado (\" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \")\" + global.get(\"estadoToldoLCD\").substring(30));\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + global.get(\"estadoToldoLCD\") + \"\\\",\" + ((date.getTime() - context.tiempoToldo) / 1000) + \",\" + global.get(\"tempPatioLuz\") + \")\"};\n\t\t\tnode.send([null, null, null, null, msg]);\n\t\t\tmsg = {pin: 3, payload: 0, color: \"#23C48E\", offlabel: \"Abrir\"}; node.send([null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Toldo Cerrado, tiempo de cerrado= \" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \"\\\"\"}; node.send([null, null, null, msg]);\t\t\n\t\t\tcontext.estadoToldo = 4;\t\t\n\t\t\tcontext.estAnt = 0;\n\t\t\tglobal.set(\"estadoToldo\", \"Cerrado\");\n\t\t\treturn;\n\t}\n\tmsg = {topic: \"Blynk/actualizar/toldo\", payload: 1}; node.send([msg, null, null, null, null]);\n}\n","outputs":5,"noerr":0,"x":1688.167007446289,"y":390.8213898794992,"wires":[[],[],[],[],[]]},{"id":"290cd25a.fc6afe","type":"function","z":"e364a467.07a6a8","name":"Patagonia","func":"var dolarCompra;\nvar dolarVenta;\nvar payload = msg.payload;\nvar compra;\nvar venta;\n\npayload = payload.substring(payload.indexOf(\"nbsp\")+5); compra = payload.substring(0, payload.indexOf(\"</td>\"));\npayload = payload.substring(payload.indexOf(\"nbsp\")+5); venta = payload.substring(0, payload.indexOf(\"</td>\"));\n\ncompra = compra.replace(\",\", \".\");\nventa = venta.replace(\",\", \".\");\n\ncompra = parseFloat(compra).toFixed(2);\nventa = parseFloat(venta).toFixed(2);\n\nmsg = {pin:65, payload: \"$ \"+compra + \"  --  \" + \"$ \" + venta};\nreturn msg","outputs":1,"noerr":0,"x":365.9444274902344,"y":530.3611297607422,"wires":[["3368b0c3.9c168","aad01191.7f05d"]]},{"id":"3fde6b72.65b1a4","type":"thingspeak42","z":"50119c6e.6ff584","name":"DPO83R5G06KFD4UD","delay":"15","topic1":"tempPasillo","topic2":"tempLiving","topic3":"tempLavadero","topic4":"tempExterior","topic5":"tempPatioLuz","topic6":"humLiving","topic7":"Crep","topic8":"","endpoint":"https://thingspeak.com","x":763.761890411377,"y":447.47623348236084,"wires":[]},{"id":"33f85d17.3511d2","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"USBin","qos":"2","broker":"c339edbf.39572","x":152.6905460357666,"y":562.785774912153,"wires":[["cee63a6d.8910d8","bc158034.05b6","1c00a8ed.d8b847"]]},{"id":"43519e36.7141d","type":"debug","z":"7ac92c99.66ea94","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":417.45236682891846,"y":412.5,"wires":[]},{"id":"ff9cc2e.2b61c4","type":"mqtt out","z":"3ce5b54a.127d6a","name":"","topic":"USBout","qos":"","retain":"","broker":"c339edbf.39572","x":2074.754337310791,"y":510.325268472944,"wires":[]},{"id":"97534816.4d4508","type":"debug","z":"7ac92c99.66ea94","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":646.9523668289185,"y":80,"wires":[]},{"id":"f78b60b2.43ccc","type":"debug","z":"50119c6e.6ff584","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":493.3332977294922,"y":287.9365119934082,"wires":[]},{"id":"bbe7b8a0.2017a8","type":"function","z":"3ce5b54a.127d6a","name":"","func":"global.set(\"estadoCargador\", 0);\nnode.status({text: global.get(\"estadoCargador\")});//estadoCargador","outputs":1,"noerr":0,"x":819.8809795379639,"y":552.5713936941964,"wires":[[]]},{"id":"b05e16fa.df7e78","type":"function","z":"a89e305a.c50bb","name":"","func":"node.status({text: \"estado: \" + global.get(\"doblePuls\")});","outputs":1,"noerr":0,"x":1460.2379875183105,"y":456.999990940094,"wires":[[]]},{"id":"16e65734.21f3a9","type":"function","z":"3ce5b54a.127d6a","name":"v1.2","func":"var topic = msg.topic;\nvar payload = parseInt(msg.payload);\ncontext.estadoToldo = context.estadoToldo || 0;  // estToldo:  0= parado, 1= abriendo, 2= abierto, 3= cerrando, 4= cerrado\ncontext.estAnt = context.estAnt || 0; // =0 parado, =1 abriendo, = 2 cerrando\nvar tiempoAbrir = 175 * 1000 * 1.6;\nvar tiempoCerrar = 175 * 1000 * 2;\nvar date = new Date();\nvar hh = date.getHours();\nvar mm = date.getMinutes();\nvar ss = date.getSeconds();\nvar dia = date.getDate();\nvar mes = date.getMonth();\nvar ano = date.getFullYear();\ncontext.tiempoToldo = context.tiempoToldo || date.getTime();\ncontext.datoAmanecer = context.datoAmanecer || date.getTime()+5000;\ncontext.CerrarToldoAuto = context.CerrarToldoAuto || 0;\ncontext.AbrirToldoAuto = context.AbrirToldoAuto || 0;\ncontext.hsAnterior =context.hsAnterior || hh-1;\n\ncontext.avisoAuto = context.avisoAuto || 0;\ncontext.avisoRociador = context.avisoRociador || 0;\ncontext.condicionEstadoToldo = context.condicionEstadoToldo || 0;\ncontext.aperturaAmanecer = context.aperturaAmanecer || 0;\nvar tiempoMojando = 3;\nif (global.get(\"tiempoMoviendo\") === undefined)global.set(\"tiempoMoviendo\", 0);\n\nvar dato = JSON.parse(msg.payload);\n\nvar tiempo = hh + \":\" + mm + \":\" + ss;\nnode.status({text: tiempo + \"  \" + context.CerrarToldoAuto + \" -- \" + hh});\n\nif (global.get(\"estadoToldo\") === \"Abriendo\" || global.get(\"estadoToldo\") === \"Cerrando\"){\n\tvar estadoToldo; var ssRest;\n\tvar tiempo = new Date (global.get(\"tiempoMoviendo\") - date.getTime());\n\tif (global.get(\"estadoToldo\") === \"Abriendo\") {estadoToldo = \" Abriendo Toldo \"}else{estadoToldo = \" Cerrando Toldo \"}\n\tmsg = {pin: 4, payload: estadoToldo}; //Abriendo Toldo\n\tnode.send([null, msg, null, null, null]); \n\tif (tiempo.getSeconds() < 10){ssRest = \"0\" + tiempo.getSeconds()}else{ssRest = tiempo.getSeconds()}\n\tmsg = {pin: 5, payload: \" Restan: -\" + tiempo.getMinutes() + \":\" + ssRest + \"\\\"\"} // \" Restan= -1:15\" \"\n\tnode.send([null, msg, null, null, null]);\n}\n\n\nif (global.get(\"Dia\") === 0){context.aperturaAmanecer = 0; context.datoAmanecer = date.getTime() + 5000;}\n\tglobal.set(\"datoAmanecer\", context.datoAmanecer);\n\nif (topic === \"resetAutos\"){\n\tcontext.CerrarToldoAuto = 0;\n\tcontext.AbrirToldoAuto = 0;\t\n\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\treturn;\n}\n\nif (topic === \"toldoBlynk\"){\n\tglobal.set(\"estadoToldo\", \"Error Borrado\");\n\tif (payload === 1 && context.estAnt === 1){\n\t\tcontext.condicionEstadoToldo = 0;\n\t\tcontext.CerrarToldoAuto = 0;\n\t\tglobal.set(\"estadoToldoLCD\", \"Abriendo toldo modo manual (Blynk)\");\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Abriendo Toldo Manual Blynk\\\")\"};\n\t\tnode.send([null, null, null, null, msg]);\t\t\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\";\n\t\tnode.send([null, null, msg, null, null]); \n\t\treturn;}\n\n\tif (payload === 1 && context.estAnt === 0){\n\t\tcontext.condicionEstadoToldo = 0;\n\t\tcontext.AbrirToldoAuto = 0;\n\t\tglobal.set(\"estadoToldoLCD\", \"Cerrando toldo modo manual (Blynk)\");\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Cerrando Toldo Manual Blynk\\\")\"};\n\t\tnode.send([null, null, null, null, msg]);\t\t\t\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\";\n\t\tnode.send([null, null, msg, null, null]);\n\t\treturn;}\n\n\tif (payload === 0 && context.estadoToldo === 2){\n\t\tcontext.condicionEstadoToldo = 0;\n\t\tglobal.set(\"estadoToldoLCD\", \"Cerrando toldo modo manual (Blynk)\");\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Cerrando Toldo Manual Blynk\\\")\"};\n\t\tnode.send([null, null, null, null, msg]);\t\t\t\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\";\n\t\tnode.send([null, null, msg, null, null]);\n\t\treturn;}\n\n\tif (payload === 0){\n\t\tglobal.set(\"estadoToldoLCD\", \"Toldo Parado\");\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\";\n\t\tnode.send([null, null, msg, null, null]);\n\t\treturn;}\n\t}\n\nif ((global.get(\"tempPatioLuz\") > 24 && global.get(\"Dia\") === 1) || global.get(\"tempPatioLuz\") < 15){\n\tif (context.CerrarToldoAuto === 0 && global.get(\"estadoToldo\") !== \"Cerrado\"){\n\t\tcontext.CerrarToldoAuto = 1;\n\t\tcontext.AbrirToldoAuto = 0;\t\t\n\t\tcontext.condicionEstadoToldo = 1;\n\t\tvar datoMsg = \"Cerrando toldo modo automatico por temperatura de patio de luz= \" + global.get(\"tempPatioLuz\") + \" rango 24<(\" + global.get(\"tempPatioLuz\") + \")<15\";\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \")\"};\n\t\tnode.send([null, null, null, null, msg]);\t\t\t\n\t\tmsg = {payload: datoMsg};  global.set(\"estadoToldoLCD\", msg.payload); node.send([null, null, null, msg]);\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\";\n\t\tnode.send([null, null, msg, null, null]); \n\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\t\treturn;}\t\t\t\n\t}\t\n\nif (topic === \"crepMQTT\" && payload === 0 && global.get(\"tempPatioLuz\") < 23 && global.get(\"tempPatioLuz\") > 15 && global.get(\"estadoToldo\") !== \"Abierto\"){\n\tcontext.CerrarToldoAuto = 0;\n\tcontext.condicionEstadoToldo = 2;\n\tvar datoMsg = \"Abriendo toldo por hacerse de noche\";\n\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"Abriendo toldo por oscurecer\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + global.get(\"hsAnochecer\") + \"\\\")\"};\n\tnode.send([null, null, null, null, msg]);\t\t\t\n\tmsg = {payload: datoMsg}; global.set(\"estadoToldoLCD\", msg.payload); node.send([null, null, null, msg]);\n\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\";\t\t\n\tnode.send([null, null, msg, null, null]); \n\t\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n}\t\t\n\nif (global.get(\"tempPatioLuz\") < 21 && global.get(\"tempPatioLuz\") > 18 && context.AbrirToldoAuto === 0 && global.get(\"estadoToldo\") !== \"Abierto\"){\n\tif (global.get(\"tempPatioLuz\") > 19)context.CerrarToldoAuto = 0;\n\tcontext.condicionEstadoToldo = 1;\n\tvar datoMsg = \"Abriendo toldo modo automatico por temperatura, \" + \"rango 21<(\" + global.get(\"tempPatioLuz\") + \")>18\";\n\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n\tnode.send([null, null, null, null, msg]);\t\t\t\n\tmsg = {payload: datoMsg}; global.set(\"estadoToldoLCD\", msg.payload); node.send([null, null, null, msg]);\n\tcontext.AbrirToldoAuto = 1;\n\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\";\n\tnode.send([null, null, msg, null, null]); \n\t\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\treturn;\t\n}\n\n// if (msg.topic === \"ponele\"){\n// \tvar datoAmanecer = global.get(\"hsAmanecer\"); \n// \tif (datoAmanecer === undefined)datoAmanecer = null;\n// \tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"Abrir Auto por Hora, hs= \" + hh + \":\" + mm + \":\" + ss + \"\\\", \\\"null\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n// \tnode.send([null, null, null, null, msg]);\t\t\t\n// \t// msg = {payload: \"Abriendo toldo modo automatico por tiempo, hs hsAmanecer= \" + global.get(\"hsAmanecer\") + \"  hs apertura= \" + hh + \":\" + mm + \":\" + ss}; context.condicionEstadoToldo = 4; global.set(\"estadoToldoLCD\", msg.payload); node.send([null, null, null, msg]);\n// }\n//60 * 60 * 1.5\nif ((date.getTime() > (context.datoAmanecer + (1000 * 60 * 60 * 1.5))) && global.get(\"tempPatioLuz\") < 23 && global.get(\"estadoToldo\") !== \"Abierto\"){   //Abrir Auto por Hora, hs= 23:15:25\n\tif (global.get(\"tempPatioLuz\") > 19)context.CerrarToldoAuto = 0;\n\tif(context.AbrirToldoAuto === 0  && context.aperturaAmanecer === 0){\n\t\tcontext.condicionEstadoToldo = 3;\n\t\tcontext.aperturaAmanecer = 1;\n\t\tcontext.AbrirToldoAuto = 1;\t\t\n\t\tvar datoAmanecer = global.get(\"hsAmanecer\"); if (datoAmanecer === undefined)datoAmanecer = null;\n\t\tvar datoMsg = \"Abriendo toldo modo automatico por Amanecer, hs amanecer: \" + global.get(\"hsAmanecer\") + \"  hs apertura: \" + hh + \":\" + mm + \":\" + ss;\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n\t\tnode.send([null, null, null, null, msg]);\t\t\t\n\t\tmsg = {payload: datoMsg}; context.condicionEstadoToldo = 1; global.set(\"estadoToldoLCD\", msg.payload); node.send([null, null, null, msg]);\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\";\n\t\tnode.send([null, null, msg, null, null]); \n\t\t\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\t\treturn;}\t\n}\n\nif (context.estadoToldo === 1){\n\tif(date.getTime() - context.tiempoToldo > tiempoAbrir){\n\tcontext.estadoToldo = 0;\n\tglobal.set(\"estadoToldo\", \"Error Toldo\");\n\tmsg = {payload: 1, color: \"#D3435C\", onlabel: \"Error\", pin: 3}; node.send([null, msg, null, null, null]);\n\tmsg = {payload: \"Error al cerrar toldo\"}; node.send([null, null, null, msg, null]);\n\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\";\n\tnode.send([null, null, msg, null, null]);\n\treturn;\t\n\t}//error al abrir//error al abrir\n}\nif (context.estadoToldo === 3){\n\tif(date.getTime() - context.tiempoToldo > tiempoCerrar){\n\tcontext.estadoToldo = 0;\n\tglobal.set(\"estadoToldo\", \"Error Toldo\");\n\tmsg = {payload: 1, color: \"#D3435C\", onlabel: \"Error\", pin: 3}; node.send([null, msg, null, null, null]);\n\tmsg = {payload: \"Error al abrir toldo\"}; node.send([null, null, null, msg, null]);\n\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\";\n\tnode.send([null, null, msg, null, null]);\n\treturn;\t\n\t}//error al cerrar\n}\t\n\nif (msg.topic === \"enfriarToldoBlynk\"){global.set(\"enfriarToldo\", msg.apyload);}\n\nif (global.get(\"tempPatioLuz\") >= 25 && global.get(\"estadoToldo\") === \"Cerrado\"  && global.get(\"enfriarToldo\") === 0){\n\t\tvar datoEnfriador = \"Enfriador habilitado\";//, hs= \" + tiempo + \" temp= \" + global.get(\"tempPatioLuz\");\n\t\tglobal.set(\"enfriadorToldo\", datoEnfriador);\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + datoEnfriador + \"\\\")\"}; node.send([null, null, null, null, msg]); \n\t\tmsg = {payload: datoEnfriador}; node.send([null, null, null, msg]);\n\t\tglobal.set(\"enfriarToldo\", 1);}\n\nif (global.get(\"tempPatioLuz\") < 22 && global.get(\"enfriarToldo\") === 1 || global.get(\"estadoToldo\") !== \"Cerrado\" && global.get(\"enfriarToldo\") === 1){\n\t\tvar datoEnfriador = \"Enfriador deshabilitado\";\n\t\tglobal.set(\"enfriadorToldo\", datoEnfriador);\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + datoEnfriador + \"\\\")\"}; node.send([null, null, null, null, msg]);\n\t\tglobal.set(\"enfriarToldo\", 0);}\n\nif (global.get(\"enfriarToldo\") === 1){\n\tcontext.avisoRociador = 1;\n\tif (context.hsAnterior !== hh && mm === 0 && ss === 1 && global.get(\"mojandoToldo\") === 0){\n\t\tglobal.set(\"mojandoToldo\", 1);\n\t\tcontext.hsAnterior = hh;\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 1}\"; node.send([null, null, msg, null, null]);\n\n\t\tmsg.payload = \"Enfriando toldo, hs= \" + tiempo; node.send([null, null, null, msg, null]);\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + msg.payload + \"\\\")\"}; \n\t\tnode.send([null, null, null, null, msg]);\t\t\n\t}\n\tif (global.get(\"mojandoToldo\") === 1 && mm === tiempoMojando && ss === 1){\t\n\t\tglobal.set(\"mojandoToldo\", 0);\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 0}\"; node.send([null, null, msg, null, null]);\t\t\n\n\t\tmsg.payload = \"Termino de enfriar toldo, hs= \" + tiempo; node.send([null, null, null, msg, null]);\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + msg.payload + \"\\\")\"}; \n\t\tnode.send([null, null, null, null, msg]);\t\t\n\t\t}\n\t}\nif (global.get(\"enfriarToldo\") === 0 && context.avisoRociador === 1){\t\t\n\tmsg.payload = \"Enfriador deshabilitado\"; node.send([null, null, null, msg, null]);\n\n\tcontext.avisoRociador = 0;\t\t\n\tglobal.set(\"mojandoToldo\" , 0);\n\tmsg.payload = \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 0}\"; \n\tnode.send([null, null, msg, null, null]);\n}\n\nif (dato.topic === \"toldo\"){\n\t// if (global.get(\"estadoToldo\") === \"Error Toldo\") return;\n\tswitch (dato.payload){\n\t\tcase 0:\n\t\t\t// if (context.estadoToldo === 0)return;\n\t\t\tvar restan = global.get(\"tiempoMoviendo\") - (date.getTime());\n\t\t\tglobal.set(\"tiempoMoviendo\", restan);\n\t\t\tglobal.set(\"estadoToldo\", \"Parado\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\")});\t\t\n\t\t\tcontext.estadoToldo = 0;\t\n\t\t\tglobal.set(\"estadoToldoLCD\", \"Toldo parado de forma manual (Blynk)\");\n\t\t\tif (context.estAnt === 0){context.estAnt = 0; msg = {payload: 0, color: \"#ffbc26\", label: \"Toldo Parado\", offlabel: \"Abrir\", pin: 3}; node.send([null, msg, null, null, null]); return;}\n\t\t\tif (context.estAnt === 1){context.estAnt = 1;msg = {payload: 0, color: \"#ffbc26\", label: \"Toldo Parado\", offlabel: \"Cerrar\", pin: 3}; node.send([null, msg, null, null, null]); return;}\n\t\tbreak;\n\t\tcase 1:\t\n\t\t\t// if (global.get(\"estadoToldo\") === \"Abierto\") return;\n\t\t\tcontext.tiempoToldo = new Date().getTime();\n\t\t\tif (global.get(\"estadoToldo\") === \"Cerrado\")global.set(\"tiempoMoviendo\", new Date().getTime() + (175*1000));\n\t\t\tif (global.get(\"estadoToldo\") === \"Cerrando\"){\n\t\t\t\tvar restan = global.get(\"tiempoMoviendo\") - (date.getTime());\n\t\t\t\tglobal.set(\"tiempoMoviendo\", new Date().getTime() +  (175000 - restan));\n\t\t\t}\n\t\t\tif (global.get(\"estadoToldo\") === \"Parado\"){\n\t\t\t\tvar restan = global.get(\"tiempoMoviendo\");\n\t\t\t\tglobal.set(\"tiempoMoviendo\", new Date().getTime() + restan);}\n\t\t\tmsg = {payload: 1, color: \"#ffbc26\", label: \"Tol. Abriendo\", onlabel: \"Parar\", pin: 3}; node.send([null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Abriendo Toldo\"}; node.send([null, null, null, msg]);\n\t\t\tcontext.estadoToldo = 1;\n\t\t\tcontext.estAnt = 1;\n\t\t\tglobal.set(\"estadoToldo\", \"Abriendo\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\") + \" \" + context.tiempoToldo});//toldo abierto\n\t\tbreak;\n\t\tcase 2:\n\t\t\tif (context.condicionEstadoToldo === 0)global.set(\"estadoToldoLCD\", \"Toldo Abierto de forma manual (Blynk  \" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \")\");\n\t\t\tif (context.condicionEstadoToldo === 1)global.set(\"estadoToldoLCD\", \"Toldo Abierto (\" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \")\" + global.get(\"estadoToldoLCD\").substring(30));\n\t\t\tif (context.condicionEstadoToldo === 2)global.set(\"estadoToldoLCD\", \"Toldo Abierto (\" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \") por Oscurecer\");\n\t\t\tif (context.condicionEstadoToldo === 3)global.set(\"estadoToldoLCD\", \"Toldo Abierto (\" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \") por Amanecer\");\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + global.get(\"estadoToldoLCD\") + \"\\\",\" + ((date.getTime() - context.tiempoToldo) / 1000) + \",\" + global.get(\"tempPatioLuz\") + \")\"};\n\t\t\tnode.send([null, null, null, null, msg]);\n\t\t\tmsg = {pin: 3, payload: 1, color: \"#23C48E\", label: \"Toldo Abierto\", onlabel: \"Cerrar\"}; node.send([null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Toldo Abierto, tiempo de apertura= \" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \"\\\"\"}; node.send([null, null, null, msg]);\n\t\t\tcontext.estadoToldo = 2;\n\t\t\tcontext.estAnt = 1;\n\t\t\tglobal.set(\"estadoToldo\", \"Abierto\");\n\t\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; node.send([msg, null, null, null, null]);\n\t\t\treturn;\n\t\tcase 3:\n\t\t\tif (global.get(\"estadoToldo\") === \"Cerrado\") return;\t\t\t\n\t\t\tcontext.tiempoToldo = new Date().getTime();\n\n\t\t\tif (global.get(\"estadoToldo\") === \"Abierto\")global.set(\"tiempoMoviendo\", new Date().getTime() + (175*1000));\n\t\t\tif (global.get(\"estadoToldo\") === \"Abriendo\"){\n\t\t\t\tvar restan = global.get(\"tiempoMoviendo\") - (date.getTime());\n\t\t\t\tglobal.set(\"tiempoMoviendo\", new Date().getTime() + (175000 - restan));\n\t\t\t}\t\t\t\n\t\t\tif (global.get(\"estadoToldo\") === \"Parado\"){\n\t\t\t\tvar restan = global.get(\"tiempoMoviendo\");\n\t\t\t\tglobal.set(\"tiempoMoviendo\", new Date().getTime() + restan);}\n\n\t\t\tmsg = {payload: 1, color: \"#ffbc26\", label: \"Tol. Cerrando\", onlabel: \"Parar\", pin: 3}; node.send([null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Cerrando Toldo\"}; node.send([null, null, null, msg]);\n\t\t\tcontext.estadoToldo = 3;\n\t\t\tcontext.estAnt = 0;\n\t\t\tglobal.set(\"estadoToldo\", \"Cerrando\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\") + \" \" + context.tiempoToldo});\n\t\tbreak;\n\t\tcase 4:\n\t\t\t// if (global.get(\"estadoToldo\") === \"Cerrado\")\n\t\t\tif (context.condicionEstadoToldo === 0)global.set(\"estadoToldoLCD\", \"Toldo Cerrado de forma manual (Blynk \" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \")\");\n\t\t\tif (context.condicionEstadoToldo === 1)global.set(\"estadoToldoLCD\", \"Toldo Cerrado (\" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \")\" + global.get(\"estadoToldoLCD\").substring(30));\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + global.get(\"estadoToldoLCD\") + \"\\\",\" + ((date.getTime() - context.tiempoToldo) / 1000) + \",\" + global.get(\"tempPatioLuz\") + \")\"};\n\t\t\tnode.send([null, null, null, null, msg]);\n\t\t\tmsg = {pin: 3, payload: 0, color: \"#23C48E\", label: \"Toldo Cerrado\", offlabel: \"Abrir\"}; node.send([null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Toldo Cerrado, tiempo de cerrado= \" + parseInt((date.getTime() - context.tiempoToldo) / 1000) + \"\\\"\"}; node.send([null, null, null, msg]);\t\t\n\t\t\tcontext.estadoToldo = 4;\t\t\n\t\t\tcontext.estAnt = 0;\n\t\t\tglobal.set(\"estadoToldo\", \"Cerrado\");\n\t\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; node.send([msg, null, null, null, null]);\n\t\t\treturn;\n\t}\n\tmsg = {topic: \"Blynk/actualizar/toldo\", payload: 1}; node.send([msg, null, null, null, null]);\n}\n","outputs":5,"noerr":0,"x":1822.1553039550781,"y":390.9762055533273,"wires":[[],[],[],[],[]]},{"id":"c4c78de.b08867","type":"mqtt in","z":"a89e305a.c50bb","name":"","topic":"Pedido/Living/Iluminacion","qos":"2","broker":"6b36e4a.1d30b1c","x":309.1666564941406,"y":130.7499942779541,"wires":[["cce091cd.a69e5","4f93da66.796464","2f08d081.e78bf"]]},{"id":"90a598cd.e88248","type":"comment","z":"f682d492.22a758","name":"PID Control For CPU Temperature of Raspberry PI","info":"","x":230,"y":160,"wires":[]},{"id":"2d3e91f2.95823e","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"1","payloadType":"num","repeat":"1","crontab":"","once":true,"onceDelay":0.1,"x":530,"y":90,"wires":[["5ffca406.112c7c"]]},{"id":"bee46b2f.c45e38","type":"blynk-ws-in-write","z":"a89e305a.c50bb","name":"","pin":"28","pin_all":false,"client":"2c18e412.5f5cbc","x":180.38092422485352,"y":635.7857675552368,"wires":[["28e99f08.c73f1"]]},{"id":"8a7dbff4.6ce81","type":"mqtt out","z":"a89e305a.c50bb","name":"","topic":"maxTeclas","qos":"","retain":"","broker":"6b36e4a.1d30b1c","x":1435.015739440918,"y":139.44443225860596,"wires":[]},{"id":"64665ba0.e14754","type":"thingspeak42","z":"3ce5b54a.127d6a","name":"","delay":"15","topic1":"IluminacionLiving","topic2":"SensPasillo","topic3":"SensLavadero","topic4":"SensLiving","topic5":"","topic6":"","topic7":"","topic8":"","endpoint":"https://thingspeak.com","x":3517.381057739258,"y":871.1428852081299,"wires":[]},{"id":"ef327ef2.6c0f6","type":"debug","z":"50119c6e.6ff584","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":702.8570671081543,"y":321.4285640716553,"wires":[]},{"id":"df0fdba0.2a4e58","type":"file","z":"e6e33852.2495f8","name":"","filename":"/home/gaston/BackUp-Node-Red/FastNet.txt","appendNewline":true,"createDir":true,"overwriteFile":"false","x":777.444465637207,"y":107.88889694213867,"wires":[[]]},{"id":"c4069bb3.95f608","type":"http in","z":"7ac92c99.66ea94","name":"prender luces","url":"/prender","method":"post","upload":false,"swaggerDoc":"","x":176.142804145813,"y":283.92854928970337,"wires":[["e06c23ee.4ad0f"]]},{"id":"4cc51e6c.2ddc7","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"1","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1402.8931732177734,"y":748.3214740753174,"wires":[["c8be9ca.b68de6"]]},{"id":"ab59ea94.49c4f8","type":"function","z":"e364a467.07a6a8","name":"Dolar","func":"var dolarCompra;\nvar dolarVenta;\nvar payload = msg.payload;\nvar compra;\nvar venta;\ncontext.minimo = context.minimo || 0;\ncontext.maximo = context.maximo || 0;\ncontext.inicio = context.inicio || 0;\nvar date = new Date();\nvar frecuencia = 15;\nvar dia = date.getDay();\nvar hh = date.getHours();\nvar mm = date.getMinutes();\nvar ss = date.getSeconds();\nif (hh===0 && mm===0 && ss===0){\n    context.minimo = 100;\n    context.maximo = 0;\n    context.inicio = 0;\n}\n\npayload = payload.substring(payload.indexOf(\"$\")+2); compra = payload.substring(0, payload.indexOf(\"</t\"));\npayload = payload.substring(payload.indexOf(\"<td>$\")+5); venta = payload.substring(0, payload.indexOf(\"</t\"));\n\nif (parseFloat(compra) === 0 || compra === undefined) return;\nif (parseFloat(venta) === 0 || venta === undefined) return;\n\ncompra = compra.replace(\",\", \".\");\nventa = venta.replace(\",\", \".\");\n\ncompra = parseFloat(compra).toFixed(2);\nventa = parseFloat(venta).toFixed(2);\n\nglobal.set(\"DolarOff\", compra);\n\nmsg = {pin:55, payload: \"$ \"+compra + \"  --  \" + \"$ \" + venta}; node.send([null, null, null, msg]);\nmsg = {pin:53, payload: compra}; node.send([null, null, null, msg]);\nmsg = {pin:54, payload: venta}; node.send([null, null, null, msg]);\n\n\nmsg = {topic: \"DolarVenta\", payload: venta}; node.send([msg, null, null, null]);\nmsg = {topic: \"DolarCompra\", payload: compra}; node.send([msg, null, null, null]);\n\nif (parseFloat(global.get(\"MinimoVender\")) > parseFloat(compra) || parseFloat(global.get(\"MaximoVender\")) < parseFloat(compra)){    //diferenciaCompraVenta\n    context.minimo = compra;\n    var datos = \"Dolar Alto opcion a Vender, valor: \" + compra;//Dolar Bajo opcion a Comprar, valor: \n    msg = {payload: datos}; node.send([null, msg, null, null]);\n    msg = {topic: \"notifyBlynk\", payload: datos}; node.send([null, null, msg, null]);\n}\n// if (hh > 9 && hh < 17 && parseFloat(dato.libre) < parseFloat(context.maximo)){\n// if (parseFloat(global.get(\"compreA\")) + parseFloat(global.get(\"diferenciaCompraVenta\") < parseFloat(compra)){    // compre a 39.04\nif (parseFloat(global.get(\"MinimoComprar\")) > parseFloat(venta)){    // compre a 39.04    \n    context.maximo = venta;\n    var datos = \"Dolar Bajo opcion a Comprar, valor: \" + venta;\n    msg = {payload: datos}; node.send([null, msg, null, null]);\n    msg = {topic: \"notifyBlynk\", payload: datos}; node.send([null, null, msg, null]);\n}\n","outputs":4,"noerr":0,"x":558.6467437744141,"y":367.09527081251144,"wires":[["a9f3050a.052758","43870af5.baac94"],["a2ae1c14.e354a","338fa6cc.48bf2a"],["be4bba1b.4d9d28","840836b7.f5aab8"],["169a443b.7a749c","3c3e448b.d778bc"]]},{"id":"ba2ee176.ff725","type":"http in","z":"7ac92c99.66ea94","name":"apagar luces","url":"/apagar","method":"post","upload":false,"swaggerDoc":"","x":174.0594835281372,"y":325.71435499191284,"wires":[["d18e6794.44d0b8"]]},{"id":"1a6a98b.6db1067","type":"inject","z":"3ce5b54a.127d6a","name":"most si","topic":"","payload":"1","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":137.69057846069336,"y":822.7856684185211,"wires":[["66a6f4e9.4fa68c"]]},{"id":"3a763a46.3166e6","type":"http in","z":"7ac92c99.66ea94","name":"cambiar color luces","url":"/colorluces","method":"post","upload":false,"swaggerDoc":"","x":140.6666955947876,"y":469.9403977394104,"wires":[["b8f71abc.973838","43519e36.7141d"]]},{"id":"9d06702c.8ed15","type":"mqtt out","z":"a89e305a.c50bb","name":"","topic":"minTeclas","qos":"","retain":"","broker":"6b36e4a.1d30b1c","x":1434.9681091308594,"y":79.6825180053711,"wires":[]},{"id":"651c6da5.a31dd4","type":"mqtt out","z":"7ac92c99.66ea94","name":"","topic":"","qos":"","retain":"","broker":"43555c62.30ed34","x":734.3809022903442,"y":452.00004959106445,"wires":[]},{"id":"2428a89d.746c48","type":"e-mail","z":"3ce5b54a.127d6a","server":"smtp.mail.yahoo.com","port":"465","secure":true,"name":"gdietrich22@yahoo.com.ar","dname":"gd28722563","x":713.3571624755859,"y":405.7619826453073,"wires":[]},{"id":"cfe7da5b.0b0058","type":"delay","z":"3ce5b54a.127d6a","name":"","pauseType":"delay","timeout":"100","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":702.2143859863281,"y":258.85712691715787,"wires":[["bd6b96af.2bd918"]]},{"id":"db4a5c94.37525","type":"debug","z":"3ce5b54a.127d6a","name":"config nano","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":3016.6666717529297,"y":108,"wires":[]},{"id":"153b74dd.94c7bb","type":"inject","z":"a89e305a.c50bb","name":"","topic":"Pedido/Living/Iluminacion","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":369.043643951416,"y":517.8214178085327,"wires":[["cce091cd.a69e5"]]},{"id":"5975772b.bee358","type":"function","z":"7ac92c99.66ea94","name":"","func":"msg.estado = 0;\nreturn msg;","outputs":1,"noerr":0,"x":298.9047632217407,"y":146.28571796417236,"wires":[["771db2a8.1bf0fc","97534816.4d4508","4d17c91.04f5338"]]},{"id":"ecefab7c.aed6a8","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"comprobarConexionPasillo","qos":"2","broker":"c339edbf.39572","x":1423.234146118164,"y":1128.5438203811646,"wires":[["eb85b399.7743b"]]},{"id":"8d0c20c6.485a6","type":"mqtt in","z":"50119c6e.6ff584","name":"","topic":"ESP/PatioLuz/Sens/Temp/Resp","qos":"2","broker":"e779f8d6.7bc2c8","x":238.5713596343994,"y":410.000009059906,"wires":[["41887e33.4312e","d9b317db.4f9568"]]},{"id":"2db2797c.372886","type":"debug","z":"3ce5b54a.127d6a","name":"notify blynk","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":2271.738269805908,"y":406.59523173740934,"wires":[]},{"id":"ded2eb3f.7be2b8","type":"blynk-ws-in-write","z":"7ac92c99.66ea94","name":"","pin":"32","pin_all":false,"client":"2c18e412.5f5cbc","x":134.95239734649658,"y":540.0000047683716,"wires":[["d4c01dc9.1020d","bc4d7dba.786f4"]]},{"id":"706e29bd.d389e8","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"{\"topic\":\"cerradoOK\",\"payload\":1}","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":347.73814392089844,"y":930.8809814453125,"wires":[[]]},{"id":"43870af5.baac94","type":"debug","z":"e364a467.07a6a8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":725.7895431518555,"y":354.2381092905998,"wires":[]},{"id":"3f220851.238a18","type":"mqtt in","z":"1b403a13.0ec8c6","name":"","topic":"ESP/TermoSolar/Envio","qos":"2","broker":"900627dc.76e6a8","x":120,"y":180,"wires":[["6553e305.a06fac","7b9c509e.eef1d"]]},{"id":"61e09e5d.a5996","type":"ui_text_input","z":"3ce5b54a.127d6a","name":"","label":"Serial Arduino Nano","group":"ff2252ef.d12aa","order":12,"width":0,"height":0,"passthru":true,"mode":"text","delay":"0","topic":"","x":298.1190643310547,"y":782.9047686713083,"wires":[["22061400.194d3c","42bf6e98.eba1a"]]},{"id":"42479228.e1d82c","type":"mqtt in","z":"a89e305a.c50bb","name":"","topic":"google/Living","qos":"2","broker":"6b36e4a.1d30b1c","x":355.9880676269531,"y":589.607177734375,"wires":[["cce091cd.a69e5","336ec26f.b3718e"]]},{"id":"9b492d23.49c49","type":"function","z":"a89e305a.c50bb","name":"","func":"global.set(\"estadoAlarma\", msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":867.5000152587891,"y":458.2500057220459,"wires":[["9711e57b.764b18"]]},{"id":"b0881f8d.2af13","type":"function","z":"a89e305a.c50bb","name":"RGB/Estado","func":"msg = {topic: \"Blink/estRGB\", payload: msg.payload};\nreturn msg;","outputs":1,"noerr":0,"x":361.27777099609375,"y":335.4841299057007,"wires":[["cce091cd.a69e5","4f93da66.796464"]]},{"id":"cfe8aa20.5a0e18","type":"blynk-ws-out-write","z":"e6e33852.2495f8","name":"","pin":0,"pinmode":"1","client":"2c18e412.5f5cbc","x":876.3332977294922,"y":474.5555667877197,"wires":[]},{"id":"c628fd83.f544d","type":"mqtt out","z":"3ce5b54a.127d6a","name":"","topic":"pedidoActualizacion","qos":"","retain":"","broker":"c339edbf.39572","x":1975.7502365112305,"y":754.0357065200806,"wires":[]},{"id":"537e1855.9a3098","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":652.7381003243581,"y":551.1428571428571,"wires":[["bbe7b8a0.2017a8"]]},{"id":"cb31f3a4.970fa","type":"function","z":"3ce5b54a.127d6a","name":"toldo andando","func":"var topic = msg.topic;\nvar payload = parseInt(msg.payload);\ncontext.estadoToldo = context.estadoToldo || 0;  // estToldo:  0= parado, 1= abriendo, 2= abierto, 3= cerrando, 4= cerrado\ncontext.estAnt = context.estAnt || 0; // =0 parado, =1 abriendo, = 2 cerrando\nvar tiempoMover = 180;\nvar date = new Date();\nvar hh = global.get(\"hh\");\nvar mm = global.get(\"mm\");\nvar ss = global.get(\"ss\");\n// context.tiempoToldo = context.tiempoToldo || date.getTime();\ncontext.datoAmanecer = context.datoAmanecer || date.getTime()+5000;\ncontext.CerrarToldoAuto = context.CerrarToldoAuto || 0;\ncontext.AbrirToldoAuto = context.AbrirToldoAuto || 0;\ncontext.hsAnterior =context.hsAnterior || hh-1;\ncontext.ssAnterior = context.ssAnterior || 0;\n\ncontext.avisoAuto = context.avisoAuto || 0;\ncontext.avisoRociador = context.avisoRociador || 0;\ncontext.condicionEstadoToldo = context.condicionEstadoToldo || 0;\ncontext.aperturaAmanecer = context.aperturaAmanecer || 0;\ncontext.cerradoManual = context.cerradoManual || 0;\nvar tiempoMojando = 3;\n\nif (global.get(\"tiempoMoviendo\") === undefined)global.set(\"tiempoMoviendo\", 0);\nif (global.get(\"enfriarToldo\") === undefined)global.set(\"enfriarToldo\", 0);\nif (global.get(\"mojandoToldo\") === undefined)global.set(\"mojandoToldo\", 0);\nif (global.get(\"estadoToldo\") === undefined)global.set(\"estadoToldo\", \"nulo\");\nif (global.get(\"Dia\") === undefined)global.set(\"Dia\", 0);\nif (global.get(\"datoAmanecer\") === undefined)global.set(\"datoAmanecer\", \"nulo\");\nif (global.get(\"tempPatioLuz\") === undefined)global.set(\"tempPatioLuz\", 0);\nif (global.get(\"hsAmanecer\") === undefined)global.set(\"hsAmanecer\", \"nulo\");\nif (global.get(\"hsAnochecer\") === undefined)global.set(\"hsAnochecer\", \"nulo\");\n\nvar dato = JSON.parse(msg.payload);\n\nvar tiempo = hh + \":\" + mm + \":\" + ss;\nif (global.get(\"estadoToldo\") !== \"Abriendo\" && global.get(\"estadoToldo\") !== \"Cerrando\")node.status({text: tiempo + \"  \" + context.CerrarToldoAuto + \" -- \" + hh});\t\t\n\nif (global.get(\"Dia\") === 0){context.aperturaAmanecer = 0; context.datoAmanecer = date.getTime() + 5000;}\n\tglobal.set(\"datoAmanecer\", context.datoAmanecer);\n\nif (hh === 0 && mm === 0 && ss === 0)context.cerradoManual = 0;\n\nif (topic === \"resetAutos\"){\n\tcontext.CerrarToldoAuto = 0;\n\tcontext.AbrirToldoAuto = 0;\t\n\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\treturn;\n}\n\nif (topic === \"toldoBlynk\"){\n\tglobal.set(\"estadoToldo\", \"Error Borrado\");\n\tif (payload === 1 && context.estAnt === 0){\n\t\tcontext.cerradoManual = 0;\n\t\tcontext.condicionEstadoToldo = 0;\n\t\tcontext.CerrarToldoAuto = 0;\n\t\tglobal.set(\"estadoToldoLCD\", \"Abriendo toldo modo manual (Blynk)\");\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Abriendo Toldo Manual Blynk\\\")\"};\n\t\tnode.send([null, null, msg]);\t\t\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\"};\n\t\tnode.send([msg, null, null]); \n\t\treturn;}\n\n\tif (payload === 1 && context.estAnt === 1){\n\t\tcontext.cerradoManual = 1;\n\t\tcontext.condicionEstadoToldo = 0;\n\t\tcontext.AbrirToldoAuto = 0;\n\t\tglobal.set(\"estadoToldoLCD\", \"Cerrando toldo modo manual (Blynk)\");\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Cerrando Toldo Manual Blynk\\\")\"};\n\t\tnode.send([null, null, msg]);\t\t\t\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\"};\n\t\tnode.send([msg, null, null]); \n\t\treturn;}\n\n\tif (payload === 0 && context.estadoToldo === 2){\n\t\tcontext.cerradoManual = 1;\n\t\tcontext.condicionEstadoToldo = 0;\n\t\tglobal.set(\"estadoToldoLCD\", \"Cerrando toldo modo manual (Blynk)\");\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Cerrando Toldo Manual Blynk\\\")\"};\n\t\tnode.send([null, null, msg]);\t\t\t\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\"};\n\t\tnode.send([msg, null, null]); \n\t\treturn;}\n\n\tif (payload === 0){\n\t\tglobal.set(\"estadoToldoLCD\", \"Toldo Parado\");\n\t\tcontext.cerradoManual = 0;\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\"};\n\t\tnode.send([msg, null, null]); \n\t\tglobal.set(\"estadoToldoLCD\", \"Toldo parado de forma manual (Blynk)\");\n\t\treturn;}\n\t}\n\nif (global.get(\"tempPatioLuz\") > 19 && global.get(\"estadoToldo\") === \"Abierto\")context.CerrarToldoAuto = 0;\n\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\nif (global.get(\"tempPatioLuz\") > 24 && global.get(\"Dia\") === 1 || global.get(\"tempPatioLuz\") < 12){\n\tif (context.CerrarToldoAuto === 0 && global.get(\"estadoToldo\") !== \"Cerrado\"){\n\t\tcontext.CerrarToldoAuto = 1;\n\t\tcontext.AbrirToldoAuto = 0;\t\t\n\t\tcontext.cerradoManual = 0;\n\t\tcontext.condicionEstadoToldo = 1;\n\t\tglobal.set(\"estadoToldo\", \"Cerrando\");\n\t\tvar datoMsg = \"Cerrando toldo modo automatico por temperatura de patio de luz (24<\" + global.get(\"tempPatioLuz\") + \"<12)\";\n\t\tglobal.set(\"estadoToldoLCD\", datoMsg);\n\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \")\"};\n\t\tnode.send([null, null, msg]);\t\t\n\n\t\tmsg = {topic: \"notifyBlynk\", payload: datoMsg}; node.send([msg, null, null]);\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\"};\n\t\tnode.send([msg, null, null]);  \n\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\t\treturn;}\t\t\t\n\t}\t\n\nif (topic === \"crepMQTT\" && payload === 0 && global.get(\"tempPatioLuz\") < 23 && global.get(\"tempPatioLuz\") >= 15 && global.get(\"estadoToldo\") !== \"Abierto\" && context.cerradoManual === 0){\n\tcontext.CerrarToldoAuto = 0;\n\tcontext.AbrirToldoAuto = 1;\n\tcontext.condicionEstadoToldo = 2;\n\tvar datoMsg = \"Abriendo toldo por hacerse de noche\";\n\tglobal.set(\"estadoToldoLCD\", datoMsg);\n\n\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"Abriendo toldo por oscurecer\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + global.get(\"hsAnochecer\") + \"\\\")\"};\n\tnode.send([null, null, msg]);\n\n\tmsg = {topic: \"notifyBlynk\", payload: datoMsg}; node.send([msg, null, null]);\n\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\"};\n\tnode.send([msg, null, null]);  \n\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n}\t\t\n\nif (global.get(\"tempPatioLuz\") < 20 && global.get(\"tempPatioLuz\") > 18 && context.AbrirToldoAuto === 0 && global.get(\"estadoToldo\") !== \"Abierto\" && context.cerradoManual === 0){\n\tcontext.condicionEstadoToldo = 1;\n\tcontext.AbrirToldoAuto = 1;\n\tvar datoMsg = \"Abriendo toldo modo automatico por temperatura de patio de luz, \" + \"(20<\" + global.get(\"tempPatioLuz\") + \">18)\";\n\tglobal.set(\"estadoToldoLCD\", datoMsg); \n\n\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n\tnode.send([null, null, msg]);\t\n\n\tmsg = {topic: \"notifyBlynk\", payload: datoMsg}; node.send([msg, null, null]);\n\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\"}; node.send([msg, null, null]); \n\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\treturn;\t\n}\n\n// if (msg.topic === \"ponele\"){\n// \tvar datoAmanecer = global.get(\"hsAmanecer\"); \n// \tif (datoAmanecer === undefined)datoAmanecer = null;\n// \tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"Abrir Auto por Hora, hs= \" + hh + \":\" + mm + \":\" + ss + \"\\\", \\\"null\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n// \tnode.send([null, null, null, null, msg]);\t\t\t\n// \t// msg = {payload: \"Abriendo toldo modo automatico por tiempo, hs hsAmanecer= \" + global.get(\"hsAmanecer\") + \"  hs apertura= \" + hh + \":\" + mm + \":\" + ss}; context.condicionEstadoToldo = 4; global.set(\"estadoToldoLCD\", msg.payload); node.send([null, null, msg]);\n// }\n//60 * 60 * 1.5\nif ((date.getTime() > (context.datoAmanecer + (1000 * 60 * 60 * 1.5))) && global.get(\"tempPatioLuz\") < 23 ){   //Abrir Auto por Hora, hs= 23:15:25\n\tif(context.AbrirToldoAuto === 0  && context.aperturaAmanecer === 0 && global.get(\"estadoToldo\") !== \"Abierto\"){\n\t\tcontext.condicionEstadoToldo = 3;\n\t\tcontext.aperturaAmanecer = 1;\n\t\tcontext.AbrirToldoAuto = 1;\t\t\n\t\tvar datoAmanecer = global.get(\"hsAmanecer\"); if (datoAmanecer === undefined)datoAmanecer = null;\n\t\tvar datoMsg = \"Abriendo toldo modo automatico por Amanecer, hs amanecer: \" + global.get(\"hsAmanecer\");\n\t\tglobal.set(\"estadoToldoLCD\", datoMsg);\n\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n\t\tnode.send([null, null, msg]);\n\n\t\tcontext.condicionEstadoToldo = 1;\n\t\tmsg = {topic: \"notifyBlynk\", payload: datoMsg}; node.send([msg, null, null]);\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\"}; node.send([msg, null, null]); \n\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\t\treturn;}\t\n}\n\nif (msg.topic === \"enfriarToldoBlynk\"){global.set(\"enfriarToldo\", msg.apyload);}\n\nif (global.get(\"tempPatioLuz\") >= 25 && global.get(\"estadoToldo\") === \"Cerrado\"  && global.get(\"enfriarToldo\") === 0){\n\t\tvar datoEnfriador = \"Enfriador habilitado, \" + hh + \":\" + mm + \":\" + ss + \" temp: \" + global.get(\"tempPatioLuz\");\n\t\tmsg = {pin: 9, payload: 1}; node.send([null,msg, null]);\n\t\tglobal.set(\"enfriadorToldo\", datoEnfriador);\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + datoEnfriador + \"\\\")\"}; node.send([null, null, msg]);\t\n\t\tmsg = {topic: \"notifyBlynk\", payload: datoEnfriador}; node.send([msg, null, null]);\n\t\tglobal.set(\"enfriarToldo\", 1);}\n\nif (global.get(\"tempPatioLuz\") < 21 && global.get(\"enfriarToldo\") === 1 || global.get(\"estadoToldo\") !== \"Cerrado\" && global.get(\"enfriarToldo\") === 1){\n\t\tvar datoEnfriador = \"Enfriador deshabilitado, \" + hh + \":\" + mm + \":\" + ss + \" temp: \" + global.get(\"tempPatioLuz\");\n\t\tmsg = {pin: 9, payload: 0}; node.send([null,msg], null);\n\t\tglobal.set(\"enfriadorToldo\", datoEnfriador);\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + datoEnfriador + \"\\\")\"}; node.send([null, null, msg]);\t\n\t\tglobal.set(\"enfriarToldo\", 0);}\n\nif (global.get(\"enfriarToldo\") === 1){\n\tcontext.avisoRociador = 1;\n\tif (context.hsAnterior !== hh && mm === 0 && ss === 1 && global.get(\"mojandoToldo\") === 0){\n\t\tglobal.set(\"mojandoToldo\", 1);\n\t\tcontext.hsAnterior = hh;\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 1}\"};\t\n\t\tnode.send([msg, null, null]); \n\n\t\tmsg = {topic: \"notifyBlynk\", payload: \"Enfriando toldo, hs= \" + tiempo}; node.send([msg, null, null]);\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + msg.payload + \"\\\")\"}; \n\t\tnode.send([null, null, msg]);\t\t\t\n\t}\n\tif (global.get(\"mojandoToldo\") === 1 && mm === tiempoMojando && ss === 1){\t\n\t\tglobal.set(\"mojandoToldo\", 0);\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 0}\"};\t\n\t\tnode.send([msg, null, null]);\t\n\n\t\tmsg = {topic: \"notifyBlynk\", payload: \"Termino de enfriar toldo, hs= \" + tiempo}; node.send([msg, null, null]);\t\t\t\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + msg.payload + \"\\\")\"}; \n\t\tnode.send([null, null, msg]);\t\t\t\n\t\t}\n\t}\nif (global.get(\"enfriarToldo\") === 0 && context.avisoRociador === 1){\t\t\n\tmsg = {topic: \"notifyBlynk\", payload: \"Enfriador deshabilitado\"}; node.send([msg, null, null]);\n\tcontext.avisoRociador = 0;\t\t\n\tglobal.set(\"mojandoToldo\" , 0);\n\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 0}\"};\t\n\tnode.send([msg, null, null]);\t\n}\n\nif (dato.topic === \"Toldo\"){\n\t// if (global.get(\"estadoToldo\") === \"Error Toldo\") return;\n\tswitch (dato.payload){\n\t\tcase 0:\n\t\t\tglobal.set(\"estadoToldo\", \"Parado\");\t\t\n\t\t\tcontext.estadoToldo = 0;\t\n\t\t\tglobal.set(\"estadoToldoLCD\", \"Toldo parado de forma manual (Blynk)\");\n\t\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; node.send([msg, null, null]);\n\t\t\tif (context.estAnt === 0){msg = {payload: 0, color: \"#ffbc26\", label: \"Toldo Parado\", offlabel: \"Abrir\", pin: 3}; node.send([null, msg, null]); return;}\n\t\t\tif (context.estAnt === 1){msg = {payload: 0, color: \"#ffbc26\", label: \"Toldo Parado\", offlabel: \"Cerrar\", pin: 3}; node.send([null, msg, null]); return;}\n\t\tbreak;\n\t\tcase 1:\t\n\t\t    if (global.get(\"estadoToldo\") === \"Abierto\") return;\n\t\t\tif (global.get(\"estadoToldo\") === \"Cerrado\")global.set(\"tiempoMoviendo\", 0);\n\t\t\tmsg = {payload: 1, color: \"#ffbc26\", label: \"Tol. Abriendo\", onlabel: \"Parar\", pin: 3}; node.send([null, msg, null]);\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: \"Abriendo Toldo\"}; node.send([msg, null, null]);\n\t\t\tcontext.estadoToldo = 1;\n\t\t\tcontext.estAnt = 1;\n\t\t\tglobal.set(\"estadoToldo\", \"Abriendo\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\") + \" \" + context.tiempoToldo});//toldo abierto\n\t\tbreak;\n\t\tcase 2:\n\t\t\tglobal.set(\"estadoToldo\", \"Abierto\");\t\t\n\t\t\tif (context.condicionEstadoToldo === 0)global.set(\"estadoToldoLCD\", \"Toldo Abierto de forma manual (Blynk)\" + hh+\":\"+mm+\":\"+ss);\n\t\t\tif (context.condicionEstadoToldo === 1)global.set(\"estadoToldoLCD\", \"Toldo Abierto (\"  + hh+\":\"+mm+\":\"+ss + \")\" + global.get(\"estadoToldoLCD\").substring(30));\n\t\t\tif (context.condicionEstadoToldo === 2)global.set(\"estadoToldoLCD\", \"Toldo Abierto por Oscurecer(\"  + hh+\":\"+mm+\":\"+ss + \")\");\n\t\t\tif (context.condicionEstadoToldo === 3)global.set(\"estadoToldoLCD\", \"Toldo Abierto por Amanecer(\"  + hh+\":\"+mm+\":\"+ss + \") por Amanecer\");\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + global.get(\"estadoToldoLCD\") + \"\\\",\" + global.get(\"tiempoMoviendo\") + \",\" + global.get(\"tempPatioLuz\") + \")\"};\n\t\t\tnode.send([null, null, msg]);\t\n\t\t\tmsg = {pin: 3, payload: 1, color: \"#23C48E\", label: \"Toldo Abierto\", onlabel: \"Cerrar\"}; node.send([null, msg, null]);\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: \"Toldo Abierto\"}; node.send([msg, null, null]);\n\t\t\tcontext.estadoToldo = 2;\n\t\t\tcontext.estAnt = 1;\n\t\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; node.send([msg, null, null]);\n\t\t\treturn;\n\t\tcase 3:\n\t\t\t// if (global.get(\"estadoToldo\") === \"Cerrado\") return;\t\t\t\n\t\t\tglobal.set(\"tiempoMoviendo\", 0);\n\t\t\tmsg = {payload: 1, color: \"#ffbc26\", label: \"Tol. Cerrando\", onlabel: \"Parar\", pin: 3}; node.send([null, msg, null]);\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: \"Cerrando Toldo\"}; node.send([msg, null, null]);\n\t\t\tcontext.estadoToldo = 3;\n\t\t\tcontext.estAnt = 0;\n\t\t\tglobal.set(\"estadoToldo\", \"Cerrando\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\") + \" \" + context.tiempoToldo});\n\t\tbreak;\n\t\tcase 4:\n\t\t\tglobal.set(\"estadoToldo\", \"Cerrado\");\n\t\t\tif (context.condicionEstadoToldo === 0)global.set(\"estadoToldoLCD\", \"Toldo Cerrado de forma manual (Blynk \" + hh+\":\"+mm+\":\"+ss + \")\");\n\t\t\tif (context.condicionEstadoToldo === 1)global.set(\"estadoToldoLCD\", \"Toldo Cerrado (\" + hh+\":\"+mm+\":\"+ss + \")\" + global.get(\"estadoToldoLCD\").substring(30));\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + global.get(\"estadoToldoLCD\") + \"\\\",\" + global.get(\"tiempoMoviendo\") + \",\" + global.get(\"tempPatioLuz\") + \")\"};\n\t\t\tnode.send([null, null, msg]);\n\t\t\tmsg = {pin: 3, payload: 0, color: \"#23C48E\", label: \"Toldo Cerrado\", offlabel: \"Abrir\"}; node.send([null, msg, null]);\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: \"Toldo Cerrado\"}; node.send([msg, null, null]);\t\n\t\t\tcontext.estadoToldo = 4;\t\t\n\t\t\tcontext.estAnt = 0;\n\t\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; node.send([msg, null, null]);\n\t\t\treturn;\n\t}\n\tmsg = {topic: \"Blynk/actualizar/toldo\", payload: 1}; node.send([msg, null, null]);\n}\n\nif (context.ssAnterior !== ss){\n\tcontext.ssAnterior = ss;\n\tif (global.get(\"estadoToldo\") === \"Cerrando\" || global.get(\"estadoToldo\") === \"Abriendo\"){\n\tvar porcentaje;\n\tif (global.get(\"estadoToldo\") === \"Abriendo\"){\n\t\tmsg = {pin: 4, payload: \" Abriendo Toldo \"};\n\t\ttiempoMoviendo = global.get(\"tiempoMoviendo\") - 1; \n\t\tglobal.set(\"tiempoMoviendo\", tiempoMoviendo);}\n\n\tif (global.get(\"estadoToldo\") === \"Cerrando\"){\n\t\tmsg = {pin: 4, payload: \" Cerrando Toldo \"};\n\t\ttiempoMoviendo = global.get(\"tiempoMoviendo\") + 1; \n\t\tglobal.set(\"tiempoMoviendo\", tiempoMoviendo);}\n\tnode.send([null, msg, null]);\n\n\tporcentaje = Math.abs(((parseFloat((tiempoMoviendo * 100)/tiempoMover))).toFixed(1));\n\tif (porcentaje < 10)porcentaje = \"  \" + porcentaje;\n\tif (porcentaje < 100 && porcentaje >= 10)porcentaje = \" \" + porcentaje;\t\n\n\tmsg = {pin: 5, payload: \" Avance= \" + porcentaje + \"% \"};// Avance= 100.1%\n\tnode.send([null, msg, null]); \n\tnode.status({text: tiempoMoviendo + \"  Avance: \" + porcentaje+ \"%\"});\n\t}\n}\n\n// if (global.get(\"estadoToldo\") === \"Abriendo\"){\n// \tif(Math.abs(global.get(\"tiempoMoviendo\")) > tiempoMover * 1.1){\n// \tcontext.estadoToldo = 0;\n// \tglobal.set(\"estadoToldo\", \"Error Toldo\");\n// \tmsg = {payload: 1, color: \"#D3435C\", onlabel: \"Error\", pin: 3}; node.send([null, msg, null, null, null]);\n// \tmsg = {payload: \"Error al abrir toldo\"}; node.send([null, null, null, msg, null]);\n// \tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\";\n// \tnode.send([null, null, msg, null, null]);\n// \tglobal.set(\"estadoToldoLCD\", \"Error al abrir toldo\");\n// \treturn;\t\n// \t}//error al abrir//error al abrir\n// }\n// if (global.get(\"estadoToldo\") === \"Cerrando\"){\n// \tif(Math.abs(global.get(\"tiempoMoviendo\")) > tiempoMover * 1.1){\n// \tcontext.estadoToldo = 0;\n// \tglobal.set(\"estadoToldo\", \"Error Toldo\");\n// \tmsg = {payload: 1, color: \"#D3435C\", onlabel: \"Error\", pin: 3}; node.send([null, msg, null, null, null]);\n// \tmsg = {payload: \"Error al cerrar toldo\"}; node.send([null, null, null, msg, null]);\n// \tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\";\n// \tnode.send([null, null, msg, null, null]);\n// \tglobal.set(\"estadoToldoLCD\", \"Error al cerrar toldo\");\n// \treturn;\t\n// \t}//error al cerrar\n// }([null, null, ])","outputs":3,"noerr":0,"x":2353.1666717529297,"y":162.30952426365445,"wires":[[],[],[]]},{"id":"23173868.aecf38","type":"inject","z":"a89e305a.c50bb","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":326.25000762939453,"y":1199.5000171661377,"wires":[["7afba1dc.2c28"]]},{"id":"8ac2932b.0cf64","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg = {topic: \"tempExterior\", payload: global.get(\"tempExterior\")}; node.send(msg);\nmsg = {topic: \"tempPatioLuz\", payload: global.get(\"tempPatioLuz\")}; node.send(msg);\nmsg = {topic: \"tempLiving\", payload: global.get(\"tempLiving\")}; node.send(msg);\nmsg = {topic: \"tempPasillo\", payload: global.get(\"tempPasillo\")}; node.send(msg);\nmsg = {topic: \"tempLavadero\", payload: global.get(\"tempLavadero\")}; node.send(msg);\nmsg = {topic: \"tempBat6\", payload: global.get(\"tempBat6\")}; node.send(msg);\nmsg = {topic: \"tempAmbiente\", payload: global.get(\"tempAmbienteBat\")}; node.send(msg);\nmsg = {topic: \"voltajeBaterias\", payload: global.get(\"voltajeBaterias\")}; node.send(msg);\nmsg = {topic: \"voltajeBaterias\", payload: global.get(\"voltajeBaterias\")}; node.send(msg);\nmsg = {topic: \"tempCPU\", payload: global.get(\"tempCPU\")}; node.send(msg);\nreturn;","outputs":1,"noerr":0,"x":2529.309543609619,"y":885.4523481641497,"wires":[["35b5038b.76c79c"]]},{"id":"d4c4a735.abe688","type":"debug","z":"3ce5b54a.127d6a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":846.7381210327148,"y":355.9999959128244,"wires":[]},{"id":"ea88b81d.851bb8","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"{\"topic\":\"most\",\"payload\":\"0\"}","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":55,"y":529.5555419921875,"wires":[["9641fbd0.64c858"]]},{"id":"ea67b4dc.a11d38","type":"mqtt out","z":"3ce5b54a.127d6a","name":"","topic":"Pedido/Lavadero/Bombas","qos":"","retain":"","broker":"c339edbf.39572","x":3163.8888626098633,"y":371.77777576446533,"wires":[]},{"id":"30b18e6c.811f92","type":"debug","z":"3ce5b54a.127d6a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1594.027782864041,"y":852.7897028393215,"wires":[]},{"id":"d18e6794.44d0b8","type":"function","z":"7ac92c99.66ea94","name":"","func":"msg.estado = 0;\nreturn msg;","outputs":1,"noerr":0,"x":313.82140827178955,"y":324.88095903396606,"wires":[["817c4eab.44409","ddd8882e.f587d8"]]},{"id":"bc935311.bac35","type":"debug","z":"50119c6e.6ff584","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":718.3928108215332,"y":695.4762029647827,"wires":[]},{"id":"b9762c5c.53da","type":"delay","z":"a89e305a.c50bb","name":"15mS","pauseType":"delay","timeout":"15","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":370.00000381469727,"y":999.5000143051147,"wires":[["813dc6d4.867e68","7140c1c9.bedec"]]},{"id":"b0fa95e2.45b538","type":"inject","z":"f682d492.22a758","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":"16","x":164.54757690429688,"y":265.41667556762695,"wires":[["164c686f.fee268","3b30e656.644aca","37becc30.948424"]]},{"id":"29c810f2.f893f","type":"function","z":"f682d492.22a758","name":"","func":"msg.filename = \"/home/gaston/BackUp-Node-Red/flow.json\";\nreturn msg;\n","outputs":1,"noerr":0,"x":593,"y":66,"wires":[["a295c51.e493e38"]]},{"id":"bbcc7f70.46ebd","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg = {topic: \"tempBat3\", payload: global.get(\"tempBat3\")}; node.send(msg);\n","outputs":1,"noerr":0,"x":2539.3095474243164,"y":1012.595233644758,"wires":[["3508a681.35fb2a"]]},{"id":"4b708dd9.817a44","type":"blynk-ws-in-write","z":"3ce5b54a.127d6a","name":"","pin":"12","client":"2c18e412.5f5cbc","x":1379.1430969238281,"y":865.503981590271,"wires":[["c8be9ca.b68de6","30b18e6c.811f92"]]},{"id":"5775349e.11009c","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1708.9999918256485,"y":539.0951559203012,"wires":[["7dcbb7b3.a73cc8"]]},{"id":"298b93ae.c6811c","type":"mqtt in","z":"50119c6e.6ff584","name":"","topic":"ESP/Lavadero/Temp/Resp","qos":"2","broker":"e779f8d6.7bc2c8","x":259.2856093815394,"y":505.7143235206604,"wires":[["348adaea.07eaa6","bc935311.bac35"]]},{"id":"7703951a.24f1cc","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"Pedido/Lavadero/Bombas","qos":"2","broker":"c339edbf.39572","x":2726.048553466797,"y":207.48808479309082,"wires":[["1401f851.1605b8","548e67c0.3e82a8"]]},{"id":"214f33ab.64134c","type":"mysql","z":"3ce5b54a.127d6a","mydb":"","name":"","x":698.3571929931641,"y":355.04769584110807,"wires":[["d4c4a735.abe688"]]},{"id":"4739e813.1055b8","type":"delay","z":"50119c6e.6ff584","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":462.14276695251465,"y":150.00002574920654,"wires":[["a1ef6409.4b2178"]]},{"id":"50ea6c9f.750bb4","type":"inject","z":"a89e305a.c50bb","name":"","topic":"","payload":"0","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":748.7500228881836,"y":447.0000114440918,"wires":[["9b492d23.49c49"]]},{"id":"af3d9613.f56998","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"toldo/abrir","qos":"2","broker":"c339edbf.39572","x":1455.6432876586914,"y":377.5595490591867,"wires":[["ae746686.8cad28"]]},{"id":"e7a48f48.bfb8d","type":"comment","z":"f682d492.22a758","name":"PID Control For CPU Temperature of Raspberry PI","info":"","x":230,"y":200,"wires":[]},{"id":"4a96d24b.1f3d5c","type":"debug","z":"a89e305a.c50bb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":544.9999961853027,"y":1299.5000171661377,"wires":[]},{"id":"851a2004.55367","type":"inject","z":"a89e305a.c50bb","name":"","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1215.2380447387695,"y":645.5714297294617,"wires":[["8a747565.3d6dd8","2981ce96.3bf072"]]},{"id":"1a6d9f60.807471","type":"mqtt out","z":"3ce5b54a.127d6a","name":"","topic":"","qos":"","retain":"","broker":"c339edbf.39572","x":463.40482330322266,"y":519.4523970740182,"wires":[]},{"id":"55a52bbf.d92134","type":"mqtt in","z":"1b403a13.0ec8c6","name":"","topic":"ESP/TermoSolar/pedido","qos":"2","broker":"900627dc.76e6a8","x":170,"y":140,"wires":[["34ae7c41.536534"]]},{"id":"d9f5febb.e48e8","type":"blynk-ws-in-write","z":"e6e33852.2495f8","name":"","pin":"76","pin_all":0,"client":"2c18e412.5f5cbc","x":141.8888931274414,"y":195.66666221618652,"wires":[["16b67857.ba97a8"]]},{"id":"caaa0cb2.83a5d","type":"inject","z":"a89e305a.c50bb","name":"Prueba Buzzador","topic":"","payload":"120","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1195.2381210327148,"y":378.428560256958,"wires":[["555ec2f4.286b7c"]]},{"id":"dc1dd4ec.ca48e8","type":"inject","z":"a89e305a.c50bb","name":"Habilitar doble puls","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1135.2380981445312,"y":188.24999260902405,"wires":[["e1819fa7.ce1f7"]]},{"id":"2f08d081.e78bf","type":"debug","z":"a89e305a.c50bb","name":"iluminacionLiving - pedido/iluminacion","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":657.269775390625,"y":139.7777557373047,"wires":[]},{"id":"3c2cd752.2661f8","type":"debug","z":"3ce5b54a.127d6a","name":"salida blynk","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":3275.71435546875,"y":744.2857055664062,"wires":[]},{"id":"f6e6bf8.5b9264","type":"function","z":"3ce5b54a.127d6a","name":"llenado de tanque (Andando)","func":"var dato = JSON.parse(msg.payload);\nvar nivMaximo = 480;\ncontext.estadoAnterior = context.estadoAnterior || 0;\ncontext.avisoTanque = context.avisoTanque || 0;\nif (global.get(\"fallasLavadero\") === undefined)global.set(\"fallasLavadero\", 0);\n\nif (msg.topic == \"blynk/marchaBomba\"){\n\t// context.avisoTanque = 0;\n\tif (msg.payload === 1)global.set(\"bombaPozo\", 1);\n\tif (msg.payload === 0)global.set(\"bombaPozo\", 0);\n\tmsg = {topic: \"ESP/Lavadero/Bombas/Estado/Rele1\", payload: global.get(\"bombaPozo\")}; node.send([msg, null]);\t\n}\n\nif (msg.topic == \"blynk/llenarTanque\"){\n\tcontext.avisoTanque = 0;\n    context.estadoAnterior = msg.payload;\n    global.set(\"llenarTanque\", msg.payload);\n    global.set(\"bombaPozo\",  msg.payload);\n    global.set(\"valvulaTanque\", msg.payload);\n    // if (global.get(\"nivTanque\") < nivMaximo - 10)global.set(\"valvulaTanque\", 1);\n    msg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"most\\\",\\\"payload\\\":\" + msg.payload + \"}\"}; node.send(msg);\n    enviarDatos();\n}\n\nif (dato.topic == \"bombaRF\"){\n\tif (global.get(\"bombaPozo\") === 0){global.set(\"bombaPozo\", 1);}else{global.set(\"bombaPozo\", 0);}\n\tmsg = {pin: 2, payload: global.get(\"bombaPozo\")}; node.send([null,msg]);\n\tmsg = {topic: \"ESP/Lavadero/Bombas/Estado/Rele1\", payload: global.get(\"bombaPozo\")}; node.send([msg, null]);\t\t\n\treturn;\n}\n\nif (dato.topic === \"google/Tanque\") enviarDatos();\n\nif (dato.topic === \"Nivel\"){\n\tglobal.set(\"nivTanque\", parseInt(dato.payload));\n\tmsg = {topic: \"nivel\", payload: global.get(\"nivTanque\") + \"mm\"}; node.send([msg, null]);\n\tmsg = {topic: \"Actualizacion/Baterias\", payload:\"\"}; node.send([msg, null]);\n\tactualizarEstado();}\n\nif (dato.topic === \"Niveles\"){\n\tmsg = {topic: \"nivMinimo\", payload: dato.nivMinimo};\n\tnode.send([msg, null]);\n\tmsg = {topic: \"nivMaximo\", payload: dato.nivMaximo};\n\tnode.send([msg, null]);\n\tmsg = {topic: \"nivel\", payload: dato.nivel}; global.set(\"nivTanque\", parseInt(dato.nivel)); \n\tnode.send([msg, null]);\n\tmsg = {topic: \"altTanque\", payload: dato.altTanque};\n\tnode.send([msg, null]);\n\tmsg = {topic: \"crepuscular\", payload: dato.crepuscular};\n\tnode.send([msg, null]);\n\tactualizarEstado();\n}\t\n\nif (msg.topic === \"configNano\"){\n\tvar item = msg.payload.split(\" \");\n\tif (item[0] === \"altTanque\")msg.payload = \"{\\\"topic\\\":\\\"altTanque\\\",\\\"payload\\\":\" + item[1] + \"\\\"}\";\n\tif (item[0] === \"minTanque\")msg.payload = \"{\\\"topic\\\":\\\"minTanque\\\",\\\"payload\\\":\" + item[1] + \"\\\"}\";\t\n\tif (item[0] === \"maxTanque\")msg.payload = \"{\\\"topic\\\":\\\"maxTanque\\\",\\\"payload\\\":\" + item[1] + \"\\\"}\";\t\n\tmsg = {topic: \"USBout\", payload: msg.payload}; node.send(msg);}\n\n// if (global.get(\"llenarTanque\") === 1 && global.get(\"nivTanque\") >= nivMaximo)\t{\n// \tglobal.set(\"llenarTanque\", 0);\n// \tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"most\\\",\\\"payload\\\":0}\"}; node.send(msg);\n//     context.estadoAnterior = 0;\n//     global.set(\"bombaPozo\", 0);\n//     global.set(\"valvulaTanque\", 0);\n//     enviarDatos();\t\n// }\n\nif (global.get(\"nivTanque\") >= nivMaximo && context.avisoTanque === 0){\n\tglobal.set(\"bombaPozo\", 0);\n\tglobal.set(\"valvulaTanque\", 0);\n\tglobal.set(\"llenarTanque\", 0);\n    msg = {topic: \"ESP/Lavadero/Bombas/Estado/Rele1\", payload: global.get(\"bombaPozo\")}; node.send(msg);\n    msg = {topic: \"ESP/Lavadero/Bombas/Estado/Rele0\", payload: global.get(\"valvulaTanque\")}; node.send(msg);\n    msg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"most\\\",\\\"payload\\\":0}\"}; node.send(msg);\n\tmsg = {topic: \"notifyBlynk\", payload:\"tanque lleno\"}; node.send(msg);\n\tmsg = {pin: 34, payload: global.get(\"llenarTanque\")}; node.send([null,msg]);\n\tmsg = {pin: 2, payload: global.get(\"bombaPozo\")}; node.send([null,msg]);\n\tcontext.avisoTanque = 1;}\n\nif (dato.topic === \"LlenarTanque\"){global.set(\"llenarTanque\", parseInt(dato.payload));}\n\nif (global.get(\"llenarTanque\") === 1 && context.estadoAnterior === 0){\n\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"most\\\",\\\"payload\\\":1}\"}; node.send(msg);\n    context.estadoAnterior = 1;\n    global.set(\"bombaPozo\", 1);\n    if (global.get(\"nivTanque\") < nivMaximo - 10){\tcontext.avisoTanque = 0; global.set(\"valvulaTanque\", 1);}\n    enviarDatos();\n    }\nif (global.get(\"llenarTanque\") === 0 && context.estadoAnterior === 1){\n\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"most\\\",\\\"payload\\\":0}\"}; node.send(msg);\n    context.estadoAnterior = 0;\n    global.set(\"bombaPozo\", 0);\n    global.set(\"valvulaTanque\", 0);\n    context.avisoTanque = 0;\n    enviarDatos();\n    }    \nnode.status({text: \"Bomba: \" + global.get(\"bombaPozo\") + \"  Valvula: \" + global.get(\"valvulaTanque\") + \" - \" + global.get(\"nivTanque\") + \" - \" + global.get(\"llenarTanque\") + \" - \" + context.estadoAnterior});\nif (msg.topic == \"Pedido/Lavadero/Bombas\") {\n\tvar fallasLavadero = global.get(\"fallasLavadero\") + 1;\n\tglobal.set(\"fallasLavadero\", fallasLavadero);\n\tenviarDatos();\n}\n\nfunction enviarDatos(){\n\t// context.avisoTanque = 0;\n\tmsg = {pin: 2, payload: global.get(\"bombaPozo\")}; node.send([null,msg]);\n    msg = {topic: \"ESP/Lavadero/Bombas/Estado/Rele1\", payload: global.get(\"bombaPozo\")}; node.send(msg);\n    msg = {topic: \"ESP/Lavadero/Bombas/Estado/Rele0\", payload: global.get(\"valvulaTanque\")}; node.send(msg);    \n}\n\nfunction actualizarEstado(){\n\tif (global.get(\"estadoToldo\") !== \"Abriendo\" && global.get(\"estadoToldo\") !== \"Cerrando\"){\n\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: \"\"};\n\t\tnode.send(msg);}\t\n}\n","outputs":2,"noerr":0,"x":3057.2220916748047,"y":312.8888854980469,"wires":[[],[]]},{"id":"2981ce96.3bf072","type":"mqtt out","z":"a89e305a.c50bb","name":"","topic":"aviso/Iluminacion","qos":"2","retain":"","broker":"6b36e4a.1d30b1c","x":1400.9525985717773,"y":605.5714421272278,"wires":[]},{"id":"c112e012.ca981","type":"inject","z":"50119c6e.6ff584","name":"","topic":"tomarMedicion","payload":"1","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":162.14280319213867,"y":100.47619724273687,"wires":[["37d229b6.e29ba6"]]},{"id":"15a52b66.87ee45","type":"blynk-ws-in-write","z":"a89e305a.c50bb","name":"","pin":"33","pin_all":false,"client":"2c18e412.5f5cbc","x":1127.7380828857422,"y":254.49999046325684,"wires":[["e1819fa7.ce1f7"]]},{"id":"5250bb5a.8163c4","type":"debug","z":"50119c6e.6ff584","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":304.6428108215332,"y":233.39285945892334,"wires":[]},{"id":"e06c23ee.4ad0f","type":"function","z":"7ac92c99.66ea94","name":"","func":"msg.estado = 1;\nreturn msg;","outputs":1,"noerr":0,"x":322.86900806427,"y":285.5952181816101,"wires":[["817c4eab.44409","448117e8.f264f8"]]},{"id":"e14fbd1c.f372a","type":"function","z":"a89e305a.c50bb","name":"","func":"msg.payload = parseInt(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":377.49999618530273,"y":1302.000018119812,"wires":[["4a96d24b.1f3d5c"]]},{"id":"3368b0c3.9c168","type":"debug","z":"e364a467.07a6a8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":514,"y":545.6388549804688,"wires":[]},{"id":"37b274f1.b85e5c","type":"delay","z":"3ce5b54a.127d6a","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":3210.238105773926,"y":946.8571739196777,"wires":[["3e7b6ed.a686492"]]},{"id":"5005abf8.596614","type":"blynk-ws-out-write","z":"3ce5b54a.127d6a","name":"","pin":0,"pinmode":"1","client":"2c18e412.5f5cbc","x":3277.0236377716064,"y":246.85715198516846,"wires":[]},{"id":"cee63a6d.8910d8","type":"function","z":"3ce5b54a.127d6a","name":"filtro USB","func":"var dato = JSON.parse(msg.payload);\n\nif (dato.topic === \"Alarma/Activacion\" || dato.topic === \"Alarma/Disparo\"){\n    msg = {topic: \"USBin/Alarma\", payload: msg.payload};\n\treturn msg;\n}\nif (dato.topic === \"LlenarTanque\" || dato.topic === \"Nivel\" || dato.topic === \"Niveles\" || dato.topic === \"bombaRF\"){\n    msg = {topic: \"USBin/Tanque\", payload: msg.payload};\n\treturn msg;\n}\nif (dato.topic === \"Toldo\"){\n    msg = {topic: \"USBin/Toldo\", payload: msg.payload};\n\treturn msg;\n}\n\nif (dato.topic === \"tempExtResp\"){\n    msg = {topic: \"USBin/temExterior\", payload: msg.payload}\n\treturn msg;\n}\n\nif (dato.topic === \"Baterias/Est/Pedido/Resp\" ||\n     dato.topic === \"Crep\" || dato.topic === \"Cargador\"){\n\tmsg = {topic: \"USBin/itemCrep\", payload: msg.payload}; node.send(msg);\n    msg = {topic: \"USBin/Baterias\", payload: msg.payload};\n\treturn msg;\n}\n\n","outputs":1,"noerr":0,"x":284.11861419677734,"y":549.9286958830697,"wires":[["ba875d73.41fcf","1a6d9f60.807471"]]},{"id":"29b79419.61cf0c","type":"mysql","z":"a89e305a.c50bb","mydb":"","name":"","x":699.1667137145996,"y":785.2142267227173,"wires":[["f73609e2.4ce548"]]},{"id":"b9be6c79.7a2d3","type":"mqtt out","z":"1b403a13.0ec8c6","name":"","topic":"ESP/TermoSolar/Recibo","qos":"","retain":"","broker":"900627dc.76e6a8","x":850,"y":270,"wires":[]},{"id":"95ec8bcd.b09a48","type":"file in","z":"a89e305a.c50bb","name":"lectura archivo","filename":"/home/gaston/BackUp-Node-Red/estLiving.txt","format":"utf8","chunk":false,"sendError":false,"x":338.75,"y":1249.5000190734863,"wires":[["adf6e177.8c0c4"]]},{"id":"11c3df5.3be1b21","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"toldo/enfriar","qos":"2","broker":"c339edbf.39572","x":1702.2143434797013,"y":580.8808958189828,"wires":[["7dcbb7b3.a73cc8"]]},{"id":"b5b11857.bbf368","type":"debug","z":"3ce5b54a.127d6a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":2730,"y":530,"wires":[]},{"id":"5a958881.fb0918","type":"mqtt in","z":"a89e305a.c50bb","name":"","topic":"aviso/Alarma","qos":"2","broker":"6b36e4a.1d30b1c","x":345.00000762939453,"y":90.75000190734863,"wires":[["fe41774b.fab598","cce091cd.a69e5"]]},{"id":"55ac7d6.b20f384","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg= {topic: \"SensLiving\", payload: global.get(\"tipoFallaSensLiving\")}; \nreturn msg","outputs":1,"noerr":0,"x":3344.523635864258,"y":854.0000286102295,"wires":[["64665ba0.e14754"]]},{"id":"66a6f4e9.4fa68c","type":"template","z":"3ce5b54a.127d6a","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{\"topic\":\"most\",\"payload\":{{payload}}}","output":"str","x":332.6906547546387,"y":826.5951096670968,"wires":[["22061400.194d3c","42bf6e98.eba1a"]]},{"id":"348adaea.07eaa6","type":"function","z":"50119c6e.6ff584","name":"tempLavadero","func":"var temp = parseFloat(msg.payload) + 1.6;\nglobal.set(\"tempLavadero\", temp.toFixed(1));\nmsg= {topic: \"tempLavadero\", payload: global.get(\"tempLavadero\")}; node.send(msg);\nnode.status({text: \"temp: \" + global.get(\"tempLavadero\") + \" -- \" + global.get(\"hsCpu\")});","outputs":1,"noerr":0,"x":502.1427478790283,"y":507.1429090499878,"wires":[["3fde6b72.65b1a4","a5c52eba.0fcbf"]]},{"id":"bc4d7dba.786f4","type":"function","z":"7ac92c99.66ea94","name":"","func":"msg.payload = msg.payload + \"living color \";\nreturn msg;","outputs":1,"noerr":0,"x":348.5238199234009,"y":508.5714039802551,"wires":[["b8f71abc.973838"]]},{"id":"fa1e6676.3dc9e8","type":"inject","z":"50119c6e.6ff584","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":true,"onceDelay":"0.1","x":172.1428108215332,"y":137.14285945892334,"wires":[["37d229b6.e29ba6"]]},{"id":"9dc175d5.17a7e8","type":"file in","z":"e6e33852.2495f8","name":"lectura archivo","filename":"/home/gaston/BackUp-Node-Red/Fibertel.txt","format":"utf8","chunk":false,"sendError":false,"x":596.3333282470703,"y":527.8888940811157,"wires":[["cd0a799.4e81988"]]},{"id":"5a1b2f56.1eef7","type":"inject","z":"e6e33852.2495f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"900","crontab":"","once":false,"onceDelay":0.1,"x":161.8888931274414,"y":121.22223472595215,"wires":[["f0069ce0.a32ee"]]},{"id":"6f7d92a9.1f6a3c","type":"blynk-ws-in-write","z":"3ce5b54a.127d6a","name":"","pin":"7","client":"2c18e412.5f5cbc","x":162.45246124267578,"y":728.5594699042184,"wires":[["479f221d.2c638c","292a597f.5f6ce6"]]},{"id":"c1dd659e.9aa308","type":"ui_gauge","z":"3ce5b54a.127d6a","name":"","group":"ff2252ef.d12aa","order":10,"width":"2","height":"2","gtype":"gage","title":"Temp CPU","label":"units","format":"{{value}}","min":"30","max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":2748.8807258605957,"y":1366.6428856168477,"wires":[]},{"id":"8794c1f0.2f8c1","type":"ui_gauge","z":"3ce5b54a.127d6a","name":"","group":"ff2252ef.d12aa","order":2,"width":"2","height":"2","gtype":"gage","title":"Amb. Baterias","label":"units","format":"{{value}}","min":"0","max":"50","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":2775.023780822754,"y":1181.1666731153218,"wires":[]},{"id":"1401f851.1605b8","type":"function","z":"3ce5b54a.127d6a","name":"llenado de tanque","func":"var dato = JSON.parse(msg.payload);\nif (global.get(\"bombaPozo\") === undefined)global.set(\"bombaPozo\", 0);\nif (global.get(\"valvulaTanque\") === undefined)global.set(\"valvulaTanque\", 0);\n\nvar nivMaximo = 420;\ncontext.estadoAnterior = context.estadoAnterior || 0;\ncontext.avisoTanque = context.avisoTanque || 0;\nif (global.get(\"fallasLavadero\") === undefined)global.set(\"fallasLavadero\", 0);\n\n\nif (msg.topic === \"google/Tanque\") enviarDatos();\n\nif (msg.topic == \"blynk/marchaBomba\"){\n\tif (msg.payload === 1)global.set(\"bombaPozo\", 1);\n\tif (msg.payload === 0)global.set(\"bombaPozo\", 0);\n\tenviarDatos(); //return;\n}\n\nif (msg.topic == \"blynk/llenarTanque\"){\n\tcontext.avisoTanque = 0;\n    context.estadoAnterior = msg.payload;\n    global.set(\"llenarTanque\", msg.payload);\n    global.set(\"bombaPozo\",  msg.payload);\n    global.set(\"valvulaTanque\", msg.payload);\n    enviarDatos(); //return;\n}\n\nif (dato.topic == \"bombaRF\"){\n\tif (global.get(\"bombaPozo\") === 0){global.set(\"bombaPozo\", 1);}else{global.set(\"bombaPozo\", 0);}\n\tenviarDatos(); //return;\n}\n\nif (dato.topic === \"Nivel\"){\n\tglobal.set(\"nivTanque\", parseFloat(dato.payload).toFixed(2));\n\tmsg = {topic: \"nivel\", payload: global.get(\"nivTanque\") + \"mm\"}; node.send([msg, null]);\n\tmsg = {topic: \"Actualizacion/Baterias\", payload:\"\"}; node.send([msg, null]);\n\tactualizarEstado();}\n\nif (dato.topic === \"Niveles\"){\n\tmsg = {topic: \"nivMinimo\", payload: dato.nivMinimo};\n\tnode.send([msg, null]);\n\tmsg = {topic: \"nivMaximo\", payload: dato.nivMaximo};\n\tnode.send([msg, null]);\n\tmsg = {topic: \"nivel\", payload: dato.nivel}; global.set(\"nivTanque\", parseInt(dato.nivel)); \n\tnode.send([msg, null]);\n\tmsg = {topic: \"altTanque\", payload: dato.altTanque};\n\tnode.send([msg, null]);\n\tmsg = {topic: \"crepuscular\", payload: dato.crepuscular};\n\tnode.send([msg, null]);\n\tactualizarEstado();\n}\t\n\nif (msg.topic === \"configNano\"){\n\tvar item = msg.payload.split(\" \");\n\tif (item[0] === \"altTanque\")msg.payload = \"{\\\"topic\\\":\\\"altTanque\\\",\\\"payload\\\":\" + item[1] + \"\\\"}\";\n\tif (item[0] === \"minTanque\")msg.payload = \"{\\\"topic\\\":\\\"minTanque\\\",\\\"payload\\\":\" + item[1] + \"\\\"}\";\t\n\tif (item[0] === \"maxTanque\")msg.payload = \"{\\\"topic\\\":\\\"maxTanque\\\",\\\"payload\\\":\" + item[1] + \"\\\"}\";\t\n\tmsg = {topic: \"USBout\", payload: msg.payload}; node.send(msg); return;}\n\nif (global.get(\"nivTanque\") >= nivMaximo && context.avisoTanque === 0){\n\tcontext.avisoTanque = 1;\n\tglobal.set(\"llenarTanque\", 0); global.set(\"bombaPozo\", 0);\tglobal.set(\"valvulaTanque\", 0);\t\n\tmsg = {topic: \"notifyBlynk\", payload:\"tanque lleno\"}; node.send(msg);\n\tenviarDatos();//return;\n} \n\nif (dato.topic === \"LlenarTanque\"){\n\tvar valor = parseInt(dato.payload);\n\tglobal.set(\"llenarTanque\", valor); global.set(\"bombaPozo\", valor);\tglobal.set(\"valvulaTanque\", valor);\n\tenviarDatos(); //return;\n}\n\nif (msg.topic === \"Pedido/Lavadero/Bombas\") {\n\tvar fallasLavadero = global.get(\"fallasLavadero\") + 1;\n\tglobal.set(\"fallasLavadero\", fallasLavadero); \n\tglobal.set(\"tipoFallaLav\", msg.payload); msg = {topic: \"fallas_MQTT\", payload: 1}; node.send([msg, null]);\n\tenviarDatos(); //return;\n}\n\nfunction enviarDatos(){\n\tif (global.get(\"valvulaTanque\") === 1) {context.avisoTanque = 0;}\n\tmsg = {pin: 2, payload: global.get(\"bombaPozo\")}; node.send([null,msg]);\n\tmsg = {pin: 34, payload: global.get(\"llenarTanque\")}; node.send([null,msg]);\n\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"most\\\",\\\"payload\\\":\" + msg.payload + \"}\"}; node.send(msg);\n    msg = {topic: \"ESP/Lavadero/Bombas/Estado/Rele1\", payload: global.get(\"bombaPozo\")}; node.send(msg);\n    msg = {topic: \"ESP/Lavadero/Bombas/Estado/Rele0\", payload: global.get(\"valvulaTanque\")}; node.send(msg);    \n    node.status({text: \"Bomba: \" + global.get(\"bombaPozo\") + \"  Valvula: \" + global.get(\"valvulaTanque\") + \" - \" + global.get(\"nivTanque\") + \" - \" + global.get(\"llenarTanque\") + \" - \" + context.estadoAnterior});\n}\n\nfunction actualizarEstado(){\n\tnode.status({text: \"Bomba: \" + global.get(\"bombaPozo\") + \"  Valvula: \" + global.get(\"valvulaTanque\") + \" - \" + global.get(\"nivTanque\") + \" - \" + global.get(\"llenarTanque\") + \" - \" + context.estadoAnterior});\n\tif (global.get(\"estadoToldo\") !== \"Abriendo\" && global.get(\"estadoToldo\") !== \"Cerrando\"){\n\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: \"\"};\n\t\tnode.send(msg);}\t\n}\n","outputs":2,"noerr":0,"x":3021.7621459960938,"y":229.45235919952393,"wires":[["cfad27b3.b25498","a3354950.2556c8"],["5005abf8.596614"]]},{"id":"ba875d73.41fcf","type":"debug","z":"3ce5b54a.127d6a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":418.4048271179199,"y":587.0714718954904,"wires":[]},{"id":"d2f7959d.e7cee8","type":"function","z":"3ce5b54a.127d6a","name":"falla lavadero","func":"// context.contadorLavadero = context.contadorLavadero || 0;\n// context.fallasLavadero = context.fallasLavadero || 0;\n// // var status;\n\n// context.contadorLavadero++;\nnode.status({text: \"Fall Lav: \" + parseInt(global.get(\"fallasLavadero\"))});\n\nif (msg.topic === \"Reset\"){global.set(\"fallasLavadero\", 0);}// return;}\n\n// if (msg.topic === \"comprobarConexionLavadero\"){context.contadorLavadero = 0; return;}\n\n// if (context.contadorLavadero >= 5){\n//     context.contadorLavadero = 0;\n//     context.fallasLavadero++;\n//     global.set(\"fallasLavadero\", context.fallasLavadero);\n// }\n\n\n\n","outputs":1,"noerr":0,"x":1682.0725173950195,"y":1086.9221160071238,"wires":[[]]},{"id":"840836b7.f5aab8","type":"debug","z":"e364a467.07a6a8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":814.0277633666992,"y":243.99999809265137,"wires":[]},{"id":"be0dfdbd.fac73","type":"function","z":"3ce5b54a.127d6a","name":"marchaBomba","func":"msg = {topic: \"blynk/marchaBomba\", payload: parseInt(msg.payload)};\nreturn msg;","outputs":1,"noerr":0,"x":2763.9047470092773,"y":119.98810195922852,"wires":[["1401f851.1605b8"]]},{"id":"553e2b0e.e02dc4","type":"ui_text","z":"3ce5b54a.127d6a","group":"ff2252ef.d12aa","order":11,"width":0,"height":0,"name":"","label":"est. bat.: ","format":"{{msg.payload}}","layout":"row-left","x":2768.6428451538086,"y":1314.4999935286387,"wires":[]},{"id":"6e892952.cfc598","type":"inject","z":"1b403a13.0ec8c6","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":1130,"y":500,"wires":[["43b083da.46c06c","179e0cda.eb9203"]]},{"id":"3daaa498.7db34c","type":"blynk-ws-in-write","z":"a89e305a.c50bb","name":"","pin":"31","pin_all":false,"client":"2c18e412.5f5cbc","x":1122.6824035644531,"y":142.88887691497803,"wires":[["dcfa603b.9ecfe"]]},{"id":"aad01191.7f05d","type":"blynk-ws-out-write","z":"e364a467.07a6a8","name":"","pin":"65","pinmode":"1","client":"2c18e412.5f5cbc","x":668.8610763549805,"y":625.7777690887451,"wires":[]},{"id":"d84519d8.0ddd28","type":"function","z":"3ce5b54a.127d6a","name":"v1.0","func":"var topic = msg.topic;\nvar payload = msg.payload;\ncontext.estadoToldo = context.estadoToldo || 0;  // estToldo:  0= parado, 1= abriendo, 2= abierto, 3= cerrando, 4= cerrado\ncontext.estAnt = context.estAnt || 0; // =0 parado, =1 abriendo, = 2 cerrando\nvar tiempoAbrir = 175 * 1000 * 2;\nvar tiempoCerrar = 175 * 1000 * 2;\nvar date = new Date();\nvar hh = date.getHours();\nvar mm = date.getMinutes();\nvar ss = date.getSeconds();\nvar dia = date.getDate();\nvar mes = date.getMonth();\nvar ano = date.getFullYear();\ncontext.tiempoToldo = context.tiempoToldo || date.getTime();\ncontext.datoAmanecer = context.datoAmanecer || date.getTime()+5000;\ncontext.CerrarToldoAuto = context.CerrarToldoAuto || 0;\ncontext.AbrirToldoAuto = context.AbrirToldoAuto || 0;\n\ncontext.avisoAuto = context.avisoAuto || 0;\ncontext.avisoRociador = context.avisoRociador || 0;\n\nvar dato = JSON.parse(msg.payload);\n\n// if (hh === 0 & mm === 0 && ss === 0) context.avisoToldo = 0;\n\nvar tiempo = hh + \":\" + mm + \":\" + ss;\nnode.status({text: tiempo});\nnode.status({text: tiempo});\n \n// if (topic === \"crepMQTT\"){\n//  \tif(payload === 1){\n// \t\tcontext.datoAmanecer = new Date().getTime() + ((1000 * 60 * 60) * 1.5);\t\n// \t\tnode.status({text: context.datoAmanecer + \"   \" + date.getTime()});\n// \t} else{\n// \t\tcontext.avisoAuto = 0;\n// \t}}\nif (global.get(\"Dia\") === 0){context.datoAmanecer = date.getTime() + 5000}\n\tglobal.set(\"datoAmanecer\", context.datoAmanecer);\n\n\nif (topic === \"toldoBlynk\"){\n\tglobal.set(\"estadoToldo\", \"Error Borrado\");\n\tif (payload === 1 && context.estAnt === 0){\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Abriendo Toldo Manual Blynk\\\")\"};\n\t\tnode.send([null, null, null, null, msg]);\t\t\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\";\n\t\tnode.send([null, null, msg, null, null]); \n\t\t// msg = {payload: \"Es de Dia Abriendo Toldo\"}; node.send([null, null, null, msg]);\n\t\treturn;}\n\tif (payload === 1 && context.estAnt === 1){\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Cerrando Toldo Manual Blynk\\\")\"};\n\t\tnode.send([null, null, null, null, msg]);\t\t\t\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\";\n\t\tnode.send([null, null, msg, null, null]); return;}\n\tif (payload === 0 && context.estadoToldo === 2){\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\";\n\t\tnode.send([null, null, msg, null, null]);\n\t\t// msg = {payload: \"Es de Noche Cerrando Toldo\"}; node.send([null, null, null, msg]);\n\t\treturn;\n\t}\n\tif (payload === 0){\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\";\n\t\tnode.send([null, null, msg, null, null]);}}\t\n\nif (topic === \"crepMQTT\" && payload == 0 && 23 > global.get(\"tempPatioLuz\") && global.get(\"tempPatioLuz\") > 18){\n\tif (global.get(\"tempPatioLuz\") > 19)context.CerrarToldoAuto = 0;\n\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"Habriendo toldo por hacerse de noche, rango 21 < (\" + global.get(\"tempPatioLuz\") + \") > 18\\\", \\\"null\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + global.get(\"hsAnochecer\") + \"\\\")\"};\n\tnode.send([null, null, null, null, msg]);\t\t\t\n\tmsg = {payload: \"Habriendo toldo por hacerse de noche\"}; node.send([null, null, null, msg]);\n\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\";\t\t\n\tnode.send([null, null, msg, null, null]); \n}\t\t\n\nif ((global.get(\"tempPatioLuz\") > 24 && global.get(\"Dia\") === 1) || global.get(\"tempPatioLuz\") < 15){\n\tif (context.CerrarToldoAuto === 0){\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"Cerrar Auto por temp, rango 24 < (\" + global.get(\"tempPatioLuz\") + \") < 17\\\", \\\"null\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"null\\\")\"};\n\t\tnode.send([null, null, null, null, msg]);\t\t\t\n\t\tmsg = {payload: \"Cerrando toldo automatico por temperatura de patio de luz= \" + global.get(\"tempPatioLuz\") + \" rango 24 < (\" + global.get(\"tempPatioLuz\") + \") < 17\"}; node.send([null, null, null, msg]);\n\t\tcontext.CerrarToldoAuto = 1;\n\t\tcontext.AbrirToldoAuto = 0;\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\";\n\t\tnode.send([null, null, msg, null, null]); \n\t\treturn;}\t\t\t\n\t}\n\n// if (global.get(\"tempPatioLuz\") < 22 && global.get(\"tempPatioLuz\") > 16){//date.getTime() > context.datoAmanecer\n // global.set(\"dato2\",date.getTime() - context.datoAmanecer);// + \"   \" + context.datoAmanecer; node.send([null, null, null, msg]);\n\nif (global.get(\"tempPatioLuz\") < 21 && global.get(\"tempPatioLuz\") > 18 && context.AbrirToldoAuto === 0){\n\tif (global.get(\"tempPatioLuz\") > 19)context.CerrarToldoAuto = 0;\n\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"Abrir Auto por Temp, rango 21 < (\" + global.get(\"tempPatioLuz\") + \") > 18\\\", \\\"null\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n\tnode.send([null, null, null, null, msg]);\t\t\t\n\tmsg = {payload: \"Abriendo toldo automatico por temperatura de patio de luz= \" + global.get(\"tempPatioLuz\") + \" rango 21 < (\" + global.get(\"tempPatioLuz\") + \") > 18\"}; node.send([null, null, null, msg]);\n\tcontext.AbrirToldoAuto = 1;\n\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\";\n\tnode.send([null, null, msg, null, null]); \n\treturn;\t\n}\n\nif (msg.topic === \"ponele\"){\n\tvar datoAmanecer = global.get(\"hsAmanecer\"); \n\tif (datoAmanecer === undefined)datoAmanecer = null;\n\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"Abrir Auto por Hora, hs= \" + hh + \":\" + mm + \":\" + ss + \"\\\", \\\"null\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n\tnode.send([null, null, null, null, msg]);\t\t\t\n\tmsg = {payload: \"Abriendo toldo automatico por tiempo, hs hsAmanecer= \" + global.get(\"hsAmanecer\") + \"  hs apertura= \" + hh + \":\" + mm + \":\" + ss}; node.send([null, null, null, msg]);\n}\n\nif ((date.getTime() > (context.datoAmanecer + (1000 * 60 * 60 * 1.5))) && global.get(\"tempPatioLuz\") < 23){   //Abrir Auto por Hora, hs= 23:15:25\n\tif (global.get(\"tempPatioLuz\") > 19)context.CerrarToldoAuto = 0;\n\tif(context.AbrirToldoAuto === 0){\n\t\tcontext.AbrirToldoAuto = 1;\t\t\n\t\tvar datoAmanecer = global.get(\"hsAmanecer\"); if (datoAmanecer === undefined)datoAmanecer = null;\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"Abrir Auto por Hora, hs= \" + hh + \":\" + mm + \":\" + ss + \"\\\", \\\"null\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n\t\tnode.send([null, null, null, null, msg]);\t\t\t\n\t\tmsg = {payload: \"Abriendo toldo automatico por tiempo, hs hsAmanecer= \" + global.get(\"hsAmanecer\") + \"  hs apertura= \" + hh + \":\" + mm + \":\" + ss}; node.send([null, null, null, msg]);\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\";\n\t\tnode.send([null, null, msg, null, null]); \n\t\treturn;}\t\n}\n\nif (context.estadoToldo === 1){\n\tif(date.getTime() - context.tiempoToldo > tiempoAbrir){\n\tcontext.estadoToldo = 0;\n\tglobal.set(\"estadoToldo\", \"Error Toldo\");\n\tmsg = {payload: 1, color: \"#D3435C\", onlabel: \"Error\", pin: 3}; node.send([null, msg, null, null, null]);\n\tmsg = {payload: \"Error al cerrar toldo\"}; node.send([null, null, null, msg, null]);\n\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\";\n\tnode.send([null, null, msg, null, null]);\n\treturn;\t\n\t}//error al abrir//error al abrir\n}\nif (context.estadoToldo === 3){\n\tif(date.getTime() - context.tiempoToldo > tiempoCerrar){\n\tcontext.estadoToldo = 0;\n\tglobal.set(\"estadoToldo\", \"Error Toldo\");\n\tmsg = {payload: 1, color: \"#D3435C\", onlabel: \"Error\", pin: 3}; node.send([null, msg, null, null, null]);\n\tmsg = {payload: \"Error al abrir toldo\"}; node.send([null, null, null, msg, null]);\n\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\";\n\tnode.send([null, null, msg, null, null]);\n\treturn;\t\n\t}//error al cerrar\n}\t\n\nif (msg.topic == \"enfriarToldoBlynk\"){global.set(\"enfriarToldo\", msg.apyload);}\nif (global.get(\"tempPatioLuz\") > 25 && global.get(\"estadoToldo\") === \"Cerrado\"){global.set(\"enfriarToldo\", 1);}else{global.set(\"enfriarToldo\", 0);}\n\nif (global.get(\"enfriarToldo\") === 1){\n\tcontext.avisoRociador = 1;\n\tif (context.hsAnterior !== hh && mm === 0 && ss === 0 && global.get(\"mojandoToldo\") === 0){\n\t\t\tglobal.set(\"mojandoToldo\", 1);\n\t\t\tmsg.payload = \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 1}\";\n\t\t\tnode.send([null, null, msg, null, null]);\n\t\t\tcontext.hsAnterior = hh;\n\t\t\tnode.status({text: context.hsAnterior});\n\t}\n\tif (global.get(\"mojandoToldo\") === 1 && mm === global.get(\"tiempoMojadoToldo\") && ss === 0){\t\t\n\t\t\tglobal.set(\"mojandoToldo\", 0);\n\t\t\tmsg.payload = \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 0}\";\n\t\t\tnode.send([null, null, msg, null, null]);\n\t\t}\n\t}\n\tif (global.get(\"enfriarToldo\") === 0 && context.avisoRociador === 1){\t\t\n\t\t\tcontext.avisoRociador = 0;\t\t\n\t\t\tglobal.set(\"mojandoToldo\" , 0);\n\t\t\tmsg.payload = \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 0}\"; \n\t\t\tnode.send([null, null, msg, null, null]);\n\t}\n\nif (dato.topic === \"toldo\"){\n\tif (global.get(\"estadoToldo\") === \"Error Toldo\") return;\n\tswitch (dato.payload){\n\t\tcase 0:\n\t\t\t// if (context.estadoToldo === 0)return;\n\t\t\tglobal.set(\"estadoToldo\", \"Parado\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\")});\t\t\n\t\t\tcontext.estadoToldo = 0;\t\t\t\n\t\t\tif (context.estAnt === 0){context.estAnt = 0; msg = {payload: 0, color: \"#ffbc26\", offlabel: \"Abrir\", pin: 3}; node.send([null, msg, null, null, null]); return;}\n\t\t\tif (context.estAnt === 1){context.estAnt = 1;msg = {payload: 0, color: \"#ffbc26\", offlabel: \"Cerrar\", pin: 3}; node.send([null, msg, null, null, null]); return;}\n\t\tbreak;\n\t\tcase 1:\t\n\t\t\t// if (context.estadoToldo === 1)return;\n\t\t\tcontext.tiempoToldo = new Date().getTime();\n\t\t\tmsg = {payload: 1, color: \"#ffbc26\", onlabel: \"Abriendo\", pin: 3}; node.send([null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Abriendo Toldo\"}; node.send([null, null, null, msg]);\n\t\t\tcontext.estadoToldo = 1;\n\t\t\tcontext.estAnt = 1;\n\t\t\tglobal.set(\"estadoToldo\", \"Abriendo\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\") + \" \" + context.tiempoToldo});\n\t\tbreak;\n\t\tcase 2:\n\t\t\t// if (context.estadoToldo === 2)return;\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"Toldo Abierto\\\",\" + ((date.getTime() - context.tiempoToldo) / 1000) + \",\" + global.get(\"tempPatioLuz\") + \")\"};\n\t\t\tnode.send([null, null, null, null, msg]);\n\t\t\tmsg = {pin: 3, payload: 1, color: \"#23C48E\", onlabel: \"Cerrar\"}; node.send([null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Toldo Abierto, tiempo de apertura= \" + parseInt((date.getTime() - context.tiempoToldo) / 1000)}; node.send([null, null, null, msg]);\n\t\t\tcontext.estadoToldo = 2;\n\t\t\tcontext.estAnt = 1;\n\t\t\tglobal.set(\"estadoToldo\", \"Abierto\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\")});\n\t\t\tglobal.set(\"tiempoAbrir\", (date.getTime() - context.tiempoToldo) / 1000);\n\t\t\treturn;\n\t\tcase 3:\n\t\t\t// if (context.estadoToldo === 3)return;\t\t\t\n\t\t\tcontext.tiempoToldo = new Date().getTime();\n\t\t\tmsg = {payload: 1, color: \"#ffbc26\", onlabel: \"Cerrando\", pin: 3}; node.send([null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Cerrando Toldo\"}; node.send([null, null, null, msg]);\n\t\t\tcontext.estadoToldo = 3;\n\t\t\tcontext.estAnt = 0;\n\t\t\tglobal.set(\"estadoToldo\", \"Cerrando\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\") + \" \" + context.tiempoToldo});\n\t\tbreak;\n\t\tcase 4:\n\t\t\t// if (context.estadoToldo === 4)return;\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"Toldo Cerrado\\\",\" + ((date.getTime() - context.tiempoToldo) / 1000) + \",\" + global.get(\"tempPatioLuz\") + \")\"};\n\t\t\tnode.send([null, null, null, null, msg]);\n\t\t\tmsg = {pin: 3, payload: 0, color: \"#23C48E\", offlabel: \"Abrir\"}; node.send([null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Toldo Cerrado, tiempo de cerrado= \" + parseInt((date.getTime() - context.tiempoToldo) / 1000)}; node.send([null, null, null, msg]);\t\t\n\t\t\tcontext.estadoToldo = 4;\t\t\n\t\t\tcontext.estAnt = 0;\n\t\t\tglobal.set(\"estadoToldo\", \"Cerrado\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\")});\n\t\t\tglobal.set(\"tiempoCerrar\", (date.getTime() - context.tiempoToldo) / 1000);\n\t\t\treturn;\n\t}\n\tmsg = {topic: \"Blynk/actualizar/toldo\", payload: 1}; node.send([msg, null, null, null, null]);\n}\n\n\t// if (global.get(\"estadoToldo\") === \"Abriendo\"  || global.get(\"estadoToldo\") == \"Cerrando\"){\n\t// \t\tif (context.cargarToldo == 0){\n\t// \t\t\tcontext.cargarToldo = 1;\n\t// \t\t\tmsg = {payload: \"{\\\"topic\\\":\\\"rele0\\\",\\\"payload\\\":1}\"};\n\t// \t\t\tnode.send([null, msg, null, null, null, null]);}\n\t// \t}\n\t// \telse{\n\t// \t\tif (context.cargarToldo == 1){\n\t// \t\t\tcontext.cargarToldo = 0;\n\t// \t\t\tmsg = {payload: \"{\\\"topic\\\":\\\"rele0\\\",\\\"payload\\\":0}\"};\n\t// \t\t\tnode.send([null, msg, null, null, null, null]);}\n\t// \t}\n\n\t// if (msg.topic == \"toldoAbrirBlynk\"){\n\t// \tif (msg.payload == 1){msg.payload = 2;} else{msg.payload = 0;}\n\t// \tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":\" + msg.payload + \"}\";\n\t// \tnode.send([null, null, msg]);\n\t// }\n\n\t// if (msg.topic == \"toldoCerrarBlynk\"){\n\t// \tif (msg.payload == 1){msg.payload = 4;} else{msg.payload = 0;}\n\t// \tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":\" + msg.payload + \"}\";\n\t// \tnode.send([null, null, msg]);\n\t// }\n\n\t\t// if (payload === 0 && context.estAnt === 0){\n\t\t// \tmsg = {payload: 0, color: \"#ffbc26\", offlabel: \"Cerrar\", pin: 3}; node.send([null, msg, null]);}\n\t\t// if (payload === 0 && context.estAnt === 1){\n\t\t// \tmsg = {payload: 0, color: \"#ffbc26\", offlabel: \"Abrir\", pin: 3}; node.send([null, msg, null]);}\t\n\n\t\t\t// if (context.estAnt === 0){\n\t\t\t// \tmsg = {payload: 0, color: \"#ffbc26\", offlabel: \"Abrir\", pin: 3}; node.send([null, msg, null]);}\n\t\t\t// if (context.estAnt === 1){\n\t\t\t// \tmsg = {payload: 0, color: \"#ffbc26\", offlabel: \"Cerrar\", pin: 3}; node.send([null, msg, null]);}\t\t\t\n\t\t// if (payload === 1){\n\t\t// \tswitch (context.estAnt){\n\t\t// \t\tcase 0:\n\t\t// \t\t\tmsg = {payload: 1, color: \"#ffbc26\", onlabel: \"Abriendo\", pin: 3}; node.send([null, msg, null]);\n\t\t// \t\t\tmsg = {payload: 2}; node.send([null, null, msg]);\n\t\t// \t\t\tcontext.estAnt = 1;return;\n\t\t// \t\tbreak;\n\t\t// \t\tcase 1:\n\t\t// \t\t\tmsg = {payload: 1, color: \"#ffbc26\", onlabel: \"Cerrando\", pin: 3}; node.send([null, msg, null]);\n\t\t// \t\t\tmsg = {payload: 4}; node.send([null, null, msg]);\n\t\t// \t\t\tcontext.estAnt = 0;return;\t\t\t\n\t\t// \t}\n\t\t// }\n\t\t// else{\n\t\t// \t// if (context.estadoToldo === 4){\n\t\t// \t// \tmsg = {payload: 1, color: \"#ffbc26\", onlabel: \"Abriendo\", pin: 3}; node.send([msg, null]);\n\t\t// \t// \tmsg = {payload: 4}; node.send([null, msg]); context.estAnt = 1;\n\t\t// \t// \treturn;\n\t\t// \t// }\n\t\t// \tif (context.estadoToldo === 2 && context.estAnt !== 0){\n\t\t// \t\tmsg = {payload: 1, color: \"#ffbc26\", onlabel: \"Cerrando\", pin: 3}; node.send([null, msg, null]);\n\t\t// \t\tcontext.estAnt = 0;\tcontext.estadoToldo = 0;\n\t\t// \t\tmsg = {payload: 4}; node.send([null, null, msg]);\n\t\t// \t\treturn;\n\t\t// \t}\t\t\n\t\t// \tif (context.estAnt === 0){\n\t\t// \t\tmsg = {payload: 0, color: \"#ffbc26\", offlabel: \"Abrir\", pin: 3}; node.send([null, msg, null]);}\n\t\t// \tif (context.estAnt === 1){\n\t\t// \t\tmsg = {payload: 0, color: \"#ffbc26\", offlabel: \"Cerrar\", pin: 3}; node.send([null, msg, null]);}\t\t\n\t\t// \t}\n","outputs":5,"noerr":0,"x":1960.0715637207031,"y":391.452354158674,"wires":[[],[],[],[],[]]},{"id":"4374c8c0.3e85f8","type":"function","z":"50119c6e.6ff584","name":"Crepuscular","func":"var dato = JSON.parse(msg.payload);\nglobal.set(\"LDR\", dato.LDR);\nnode.status({text: \"Crep: \" + global.get(\"LDR\") + \" -- \" + global.get(\"hsCpu\")});\nmsg = {topic: \"Crep\", payload: global.get(\"LDR\")};\nreturn msg","outputs":1,"noerr":0,"x":495.79358291625977,"y":602.8571424484253,"wires":[["3fde6b72.65b1a4"]]},{"id":"894d6130.d4b8","type":"e-mail","z":"a89e305a.c50bb","server":"smtp.mail.yahoo.com","port":"465","secure":true,"name":"gdietrich22@yahoo.com.ar","dname":"gd28722563","x":680.4166946411133,"y":843.7856388092041,"wires":[]},{"id":"6ff824b4.40034c","type":"inject","z":"a89e305a.c50bb","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1278.9879875183105,"y":466.999990940094,"wires":[["b05e16fa.df7e78"]]},{"id":"94219c12.04844","type":"debug","z":"e6e33852.2495f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":675.5555038452148,"y":326.88891220092773,"wires":[]},{"id":"c78fc939.967d08","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg = {topic: \"tempBat5\", payload: global.get(\"tempBat5\")}; node.send(msg);\n","outputs":1,"noerr":0,"x":2542.166603088379,"y":1096.8809392111643,"wires":[["743118bd.7d5b08"]]},{"id":"57650f5c.b4ca7","type":"debug","z":"a89e305a.c50bb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":746.9524078369141,"y":386.7857036590576,"wires":[]},{"id":"32d19317.d310ec","type":"function","z":"a89e305a.c50bb","name":"","func":"var datos = msg.payload;\nmsg = {pin: 59, payload: \"Datos Nuevos: \\n\"}; node.send(msg);\nmsg = {pin: 59, payload: datos}; node.send(msg);\n","outputs":1,"noerr":0,"x":676.2500114440918,"y":1003.2500152587891,"wires":[["5c8a00e7.0e915","36a56955.353e26"]]},{"id":"c47e992b.e889b8","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"toldo/cerrar","qos":"2","broker":"c339edbf.39572","x":1447.929054260254,"y":283.5595280783517,"wires":[["ae746686.8cad28"]]},{"id":"771db2a8.1bf0fc","type":"function","z":"7ac92c99.66ea94","name":"Activacion (Nuevo)","func":"if (msg.payload.includes(\"alarma\") && msg.payload.includes(\"casa\")){\n\tif (msg.estado === 0){\n\t\tif(global.get(\"estadoAlarma\") === 1){\n\t\t\tmsg = {topic: \"google/Alarma\", payload: msg.estado}; return msg;\n\t\t}\n\t\tif(global.get(\"estadoAlarma\") === 0){\n\t\t\tmsg = {topic: \"aviso/Alarma\", payload: 1}; return msg;\n\t\t}\n\t}\n    msg = {topic: \"google/Alarma\", payload: msg.estado}; return msg;\n}\n\nif (msg.payload.includes(\"llenado\") && msg.payload.includes(\"tanque\")){\n\tglobal.set(\"llenarTanque\", parseInt(msg.estado));\n\tmsg = {topic: \"google/Tanque\", payload: msg.estado};\n    return msg;\n}","outputs":1,"noerr":0,"x":465.5714159011841,"y":119.61904430389404,"wires":[["895329af.f7c068","97534816.4d4508"]]},{"id":"6e810331.717afc","type":"inject","z":"a89e305a.c50bb","name":"borrar","topic":"DELETE FROM `ilLiving` WHERE 1","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":402.9167060852051,"y":878.9642276763916,"wires":[["29b79419.61cf0c"]]},{"id":"16c661b6.92124e","type":"function","z":"3ce5b54a.127d6a","name":"hs cel","func":"msg.payload = global.get(\"hsCel\");\nreturn msg;","outputs":1,"noerr":0,"x":1606.250072479248,"y":766.6786203384399,"wires":[["4bbcff4e.de9ea"]]},{"id":"69d71644.c47cf8","type":"mqtt out","z":"7ac92c99.66ea94","name":"","topic":"","qos":"","retain":"","broker":"43555c62.30ed34","x":558.2737855911255,"y":635.5476775169373,"wires":[]},{"id":"4603fbcf.274954","type":"http request","z":"e364a467.07a6a8","name":"","method":"GET","ret":"txt","url":"https://blockchain.info/es/ticker","tls":"","x":441.6944007873535,"y":470.4285914301872,"wires":[["b26bb4d4.da8e08"]]},{"id":"b26bb4d4.da8e08","type":"function","z":"e364a467.07a6a8","name":"BTC","func":"var dato = JSON.parse(msg.payload);\n// dato = JSON.parse(dato);\n\nmsg = dato.USD;\nvar datos = msg.buy;\nmsg = {topic: \"BitCoinUSD\", payload: parseFloat(datos)};\nnode.send(msg);\ndatos = datos * global.get(\"DolarOff\");\nmsg = {topic: \"BitCoinPesos\", payload: parseFloat(datos)};\nreturn msg;\n","outputs":1,"noerr":0,"x":578.6944007873535,"y":470.4285914301872,"wires":[["a9f3050a.052758"]]},{"id":"49382fb4.7a524","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg= {topic: \"SensLavadero\", payload: global.get(\"tipoFallaLav\")}; \nreturn msg","outputs":1,"noerr":0,"x":3343.095169067383,"y":809.7143154144287,"wires":[["64665ba0.e14754"]]},{"id":"283c31f.9655ece","type":"debug","z":"3ce5b54a.127d6a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":715.5953979492188,"y":141.23812866210938,"wires":[]},{"id":"257593f1.ccf32c","type":"inject","z":"e6e33852.2495f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":188.5555648803711,"y":375.6666717529297,"wires":[["8f7d1150.7be34"]]},{"id":"b8046fd8.4022b","type":"inject","z":"e6e33852.2495f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":161.33333587646484,"y":321.11111068725586,"wires":[["89e0166f.74bba8"]]},{"id":"ac982b27.6236a8","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"Pedido/Lavadero/Bombas","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":2734.523910522461,"y":56.857139587402344,"wires":[["1401f851.1605b8"]]},{"id":"2e64d84.7903128","type":"debug","z":"a89e305a.c50bb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"topic","x":710.0000114440918,"y":1083.2500190734863,"wires":[]},{"id":"955a8862.016a38","type":"debug","z":"3ce5b54a.127d6a","name":"salida lcd blynk","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1980,"y":890,"wires":[]},{"id":"c7e2b7b5.a98f68","type":"blynk-ws-in-write","z":"a89e305a.c50bb","name":"","pin":"14","pin_all":false,"client":"2c18e412.5f5cbc","x":175.2380828857422,"y":205.5714168548584,"wires":[["dd1ac792.79ebe8"]]},{"id":"f0e53a96.e7e5b8","type":"mqtt out","z":"a89e305a.c50bb","name":"","topic":"ESP/living/Iluminacion/delBuzz","qos":"","retain":"","broker":"6b36e4a.1d30b1c","x":1443.8094749450684,"y":326.9999895095825,"wires":[]},{"id":"d9b317db.4f9568","type":"debug","z":"50119c6e.6ff584","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":916.6785163879395,"y":351.8214178085327,"wires":[]},{"id":"14fcc9d3.57f256","type":"inject","z":"7ac92c99.66ea94","name":"","topic":"","payload":"desactivar alarma casa","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":188.95236682891846,"y":184,"wires":[["5975772b.bee358"]]},{"id":"f62131e9.568df","type":"blynk-ws-in-write","z":"e364a467.07a6a8","name":"","pin":"58","pin_all":0,"client":"2c18e412.5f5cbc","x":244.2777328491211,"y":170.49999904632568,"wires":[["393719e5.4bc726"]]},{"id":"80065b77.186188","type":"debug","z":"e6e33852.2495f8","name":"Fibertel","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":666.3333358764648,"y":294.55553817749023,"wires":[]},{"id":"6f1ac0c9.21d27","type":"debug","z":"e6e33852.2495f8","name":"FastNet","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":670.7777328491211,"y":150.11110591888428,"wires":[]},{"id":"5635a456.618d3c","type":"delay","z":"3ce5b54a.127d6a","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":3208.809638977051,"y":811.1428871154785,"wires":[["49382fb4.7a524"]]},{"id":"e78a000c.10eb7","type":"blynk-ws-in-write","z":"a89e305a.c50bb","name":"","pin":"60","pin_all":false,"client":"2c18e412.5f5cbc","x":109.30558013916016,"y":1112.2778072357178,"wires":[["871f3c66.86677"]]},{"id":"2787a2b2.3f5d5e","type":"debug","z":"3ce5b54a.127d6a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":2092.6903533935547,"y":558.3412663596017,"wires":[]},{"id":"9213ac6d.4cfe2","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"crepMQTT","qos":"2","broker":"c339edbf.39572","x":1608.4051895141602,"y":187.72620269230435,"wires":[[]]},{"id":"8af6ec86.c2889","type":"blynk-ws-out-write","z":"50119c6e.6ff584","name":"","pin":"22","pinmode":0,"client":"2c18e412.5f5cbc","x":771.4285163879395,"y":495.71430110931396,"wires":[]},{"id":"37d229b6.e29ba6","type":"function","z":"50119c6e.6ff584","name":"","func":"var date = new Date();\nvar mm = date.getMinutes();\nvar ss = date.getSeconds();\nvar tiempo = mm%5;\nnode.status({text: global.get(\"hsCpu\")});\nif (tiempo === 0 && ss === 1 || msg.topic == \"tomarMedicion\"){\n    msg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"tempExt\\\",\\\"payload\\\":1}\"}; node.send(msg);\n    msg = {topic: \"ESP/Lavadero/Temp/Pedido\", payload: 1}; node.send(msg);\n    msg = {topic: \"ESP/Pasillo/Sens/Temp/Pedido\", payload: 1}; node.send(msg);\n    msg = {topic: \"ESP/Living/Sens/Temp/Pedido\", payload: 1}; node.send(msg);\n    msg = {topic: \"ESP/TermoSolar/Recibo\", payload: 1}; node.send(msg);\n    \n}\n","outputs":1,"noerr":0,"x":312.14277839660645,"y":137.14286136627197,"wires":[["21296bc1.2ea0d4","4739e813.1055b8","5668c207.79ddec"]]},{"id":"c6c1ec1b.22ba2","type":"blynk-ws-out-write","z":"3ce5b54a.127d6a","name":"","pin":0,"pinmode":"1","client":"2c18e412.5f5cbc","x":2236.381134033203,"y":223.5357119696481,"wires":[]},{"id":"c3f2f383.ad5a7","type":"debug","z":"e6e33852.2495f8","name":"FastNet","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":589.6666488647461,"y":474.55553817749023,"wires":[]},{"id":"fff515b1.3dcc88","type":"function","z":"3ce5b54a.127d6a","name":"toldo andando V2.0","func":"var topic = msg.topic;\nvar payload = parseInt(msg.payload);\ncontext.estadoToldo = context.estadoToldo || 0;  // estToldo:  0= parado, 1= abriendo, 2= abierto, 3= cerrando, 4= cerrado\ncontext.estAnt = context.estAnt || 0; // =0 parado, =1 abriendo, = 2 cerrando\nvar tiempoMover = 180;\nvar date = new Date();\nvar hh = global.get(\"hh\");\nvar mm = global.get(\"mm\");\nvar ss = global.get(\"ss\");\n// context.tiempoToldo = context.tiempoToldo || date.getTime();\ncontext.datoAmanecer = context.datoAmanecer || date.getTime()+5000;\ncontext.CerrarToldoAuto = context.CerrarToldoAuto || 0;\ncontext.AbrirToldoAuto = context.AbrirToldoAuto || 0;\ncontext.hsAnterior =context.hsAnterior || hh-1;\ncontext.ssAnterior = context.ssAnterior || 0;\n\ncontext.avisoAuto = context.avisoAuto || 0;\ncontext.avisoRociador = context.avisoRociador || 0;\ncontext.condicionEstadoToldo = context.condicionEstadoToldo || 0;\ncontext.aperturaAmanecer = context.aperturaAmanecer || 0;\ncontext.cerradoManual = context.cerradoManual || 0;\nvar tiempoMojando = 3;\n\nif (global.get(\"tiempoMoviendo\") === undefined)global.set(\"tiempoMoviendo\", 0);\nif (global.get(\"enfriarToldo\") === undefined)global.set(\"enfriarToldo\", 0);\nif (global.get(\"mojandoToldo\") === undefined)global.set(\"mojandoToldo\", 0);\nif (global.get(\"estadoToldo\") === undefined)global.set(\"estadoToldo\", \"nulo\");\nif (global.get(\"Dia\") === undefined)global.set(\"Dia\", 0);\nif (global.get(\"datoAmanecer\") === undefined)global.set(\"datoAmanecer\", \"nulo\");\nif (global.get(\"tempPatioLuz\") === undefined)global.set(\"tempPatioLuz\", 0);\nif (global.get(\"hsAmanecer\") === undefined)global.set(\"hsAmanecer\", \"nulo\");\nif (global.get(\"hsAnochecer\") === undefined)global.set(\"hsAnochecer\", \"nulo\");\n\nvar dato = JSON.parse(msg.payload);\n\nvar tiempo = hh + \":\" + mm + \":\" + ss;\nif (global.get(\"estadoToldo\") !== \"Abriendo\" && global.get(\"estadoToldo\") !== \"Cerrando\")node.status({text: tiempo + \"  \" + context.CerrarToldoAuto + \" -- \" + hh});\t\t\n\nif (global.get(\"Dia\") === 0){context.aperturaAmanecer = 0; context.datoAmanecer = date.getTime() + 5000;}\n\tglobal.set(\"datoAmanecer\", context.datoAmanecer);\n\nif (hh === 0 && mm === 0 && ss === 0)context.cerradoManual = 0;\n\nif (topic === \"resetAutos\"){\n\tcontext.CerrarToldoAuto = 0;\n\tcontext.AbrirToldoAuto = 0;\t\n\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\treturn;\n}\n\nif (topic === \"toldoBlynk\"){\n\tglobal.set(\"estadoToldo\", \"Error Borrado\");\n\tif (payload === 1 && context.estAnt === 0){\n\t\tcontext.cerradoManual = 0;\n\t\tcontext.condicionEstadoToldo = 0;\n\t\tcontext.CerrarToldoAuto = 0;\n\t\tglobal.set(\"estadoToldoLCD\", \"Abriendo toldo modo manual (Blynk)\");\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Abriendo Toldo Manual Blynk\\\")\"};\n\t\tnode.send([null, null, msg]);\t\t\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\"};\n\t\tnode.send([msg, null, null]); \n\t\treturn;}\n\n\tif (payload === 1 && context.estAnt === 1){\n\t\tcontext.cerradoManual = 1;\n\t\tcontext.condicionEstadoToldo = 0;\n\t\tcontext.AbrirToldoAuto = 0;\n\t\tglobal.set(\"estadoToldoLCD\", \"Cerrando toldo modo manual (Blynk)\");\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Cerrando Toldo Manual Blynk\\\")\"};\n\t\tnode.send([null, null, msg]);\t\t\t\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\"};\n\t\tnode.send([msg, null, null]); \n\t\treturn;}\n\n\tif (payload === 0 && context.estadoToldo === 2){\n\t\tcontext.cerradoManual = 1;\n\t\tcontext.condicionEstadoToldo = 0;\n\t\tglobal.set(\"estadoToldoLCD\", \"Cerrando toldo modo manual (Blynk)\");\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Cerrando Toldo Manual Blynk\\\")\"};\n\t\tnode.send([null, null, msg]);\t\t\t\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\"};\n\t\tnode.send([msg, null, null]); \n\t\treturn;}\n\n\tif (payload === 0){\n\t\tglobal.set(\"estadoToldoLCD\", \"Toldo Parado\");\n\t\tcontext.cerradoManual = 0;\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\"};\n\t\tnode.send([msg, null, null]); \n\t\tglobal.set(\"estadoToldoLCD\", \"Toldo parado de forma manual (Blynk)\");\n\t\treturn;}\n\t}\n\nif (global.get(\"tempPatioLuz\") > 19 && global.get(\"estadoToldo\") === \"Abierto\")context.CerrarToldoAuto = 0;\n\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\nif (global.get(\"tempPatioLuz\") > 24 && global.get(\"Dia\") === 1 || global.get(\"tempPatioLuz\") < 12){\n\tif (context.CerrarToldoAuto === 0 && global.get(\"estadoToldo\") !== \"Cerrado\"){\n\t\tcontext.CerrarToldoAuto = 1;\n\t\tcontext.AbrirToldoAuto = 0;\t\t\n\t\tcontext.cerradoManual = 0;\n\t\tcontext.condicionEstadoToldo = 1;\n\t\tglobal.set(\"estadoToldo\", \"Cerrando\");\n\t\tvar datoMsg = \"Cerrando toldo modo automatico por temperatura de patio de luz (24<\" + global.get(\"tempPatioLuz\") + \"<12)\";\n\t\tglobal.set(\"estadoToldoLCD\", datoMsg);\n\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \")\"};\n\t\tnode.send([null, null, msg]);\t\t\n\n\t\tmsg = {topic: \"notifyBlynk\", payload: datoMsg}; node.send([msg, null, null]);\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\"};\n\t\tnode.send([msg, null, null]);  \n\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\t\treturn;}\t\t\t\n\t}\t\n\nif (topic === \"crepMQTT\" && payload === 0 && global.get(\"tempPatioLuz\") < 23 && global.get(\"tempPatioLuz\") >= 15 && global.get(\"estadoToldo\") !== \"Abierto\" && context.cerradoManual === 0){\n\tcontext.CerrarToldoAuto = 0;\n\tcontext.AbrirToldoAuto = 1;\n\tcontext.condicionEstadoToldo = 2;\n\tvar datoMsg = \"Abriendo toldo por hacerse de noche\";\n\tglobal.set(\"estadoToldoLCD\", datoMsg);\n\n\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"Abriendo toldo por oscurecer\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + global.get(\"hsAnochecer\") + \"\\\")\"};\n\tnode.send([null, null, msg]);\n\n\tmsg = {topic: \"notifyBlynk\", payload: datoMsg}; node.send([msg, null, null]);\n\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\"};\n\tnode.send([msg, null, null]);  \n\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n}\t\t\n\nif (global.get(\"tempPatioLuz\") < 20 && global.get(\"tempPatioLuz\") > 18 && context.AbrirToldoAuto === 0 && global.get(\"estadoToldo\") !== \"Abierto\" && context.cerradoManual === 0){\n\tcontext.condicionEstadoToldo = 1;\n\tcontext.AbrirToldoAuto = 1;\n\tvar datoMsg = \"Abriendo toldo modo automatico por temperatura de patio de luz, \" + \"(20<\" + global.get(\"tempPatioLuz\") + \">18)\";\n\tglobal.set(\"estadoToldoLCD\", datoMsg); \n\n\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n\tnode.send([null, null, msg]);\t\n\n\tmsg = {topic: \"notifyBlynk\", payload: datoMsg}; node.send([msg, null, null]);\n\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\"}; node.send([msg, null, null]); \n\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\treturn;\t\n}\n\n// if (msg.topic === \"ponele\"){\n// \tvar datoAmanecer = global.get(\"hsAmanecer\"); \n// \tif (datoAmanecer === undefined)datoAmanecer = null;\n// \tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"Abrir Auto por Hora, hs= \" + hh + \":\" + mm + \":\" + ss + \"\\\", \\\"null\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n// \tnode.send([null, null, null, null, msg]);\t\t\t\n// \t// msg = {payload: \"Abriendo toldo modo automatico por tiempo, hs hsAmanecer= \" + global.get(\"hsAmanecer\") + \"  hs apertura= \" + hh + \":\" + mm + \":\" + ss}; context.condicionEstadoToldo = 4; global.set(\"estadoToldoLCD\", msg.payload); node.send([null, null, msg]);\n// }\n//60 * 60 * 1.5\nif ((date.getTime() > (context.datoAmanecer + (1000 * 60 * 60 * 1.5))) && global.get(\"tempPatioLuz\") < 23 ){   //Abrir Auto por Hora, hs= 23:15:25\n\tif(context.AbrirToldoAuto === 0  && context.aperturaAmanecer === 0 && global.get(\"estadoToldo\") !== \"Abierto\"){\n\t\tcontext.condicionEstadoToldo = 3;\n\t\tcontext.aperturaAmanecer = 1;\n\t\tcontext.AbrirToldoAuto = 1;\t\t\n\t\tvar datoAmanecer = global.get(\"hsAmanecer\"); if (datoAmanecer === undefined)datoAmanecer = null;\n\t\tvar datoMsg = \"Abriendo toldo modo automatico por Amanecer, hs amanecer: \" + global.get(\"hsAmanecer\");\n\t\tglobal.set(\"estadoToldoLCD\", datoMsg);\n\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n\t\tnode.send([null, null, msg]);\n\n\t\tcontext.condicionEstadoToldo = 1;\n\t\tmsg = {topic: \"notifyBlynk\", payload: datoMsg}; node.send([msg, null, null]);\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\"}; node.send([msg, null, null]); \n\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\t\treturn;}\t\n}\n\nif (msg.topic === \"enfriarToldoBlynk\"){global.set(\"enfriarToldo\", msg.apyload);}\n\nif (global.get(\"tempPatioLuz\") >= 25 && global.get(\"estadoToldo\") === \"Cerrado\"  && global.get(\"enfriarToldo\") === 0){\n\t\tvar datoEnfriador = \"Enfriador habilitado, \" + hh + \":\" + mm + \":\" + ss + \" temp: \" + global.get(\"tempPatioLuz\");\n\t\tmsg = {pin: 9, payload: 1}; node.send([null,msg, null]);\n\t\tglobal.set(\"enfriadorToldo\", datoEnfriador);\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + datoEnfriador + \"\\\")\"}; node.send([null, null, msg]);\t\n\t\tmsg = {topic: \"notifyBlynk\", payload: datoEnfriador}; node.send([msg, null, null]);\n\t\tglobal.set(\"enfriarToldo\", 1);}\n\nif (global.get(\"tempPatioLuz\") < 21 && global.get(\"enfriarToldo\") === 1 || global.get(\"estadoToldo\") !== \"Cerrado\" && global.get(\"enfriarToldo\") === 1){\n\t\tvar datoEnfriador = \"Enfriador deshabilitado, \" + hh + \":\" + mm + \":\" + ss + \" temp: \" + global.get(\"tempPatioLuz\");\n\t\tmsg = {pin: 9, payload: 0}; node.send([null,msg], null);\n\t\tglobal.set(\"enfriadorToldo\", datoEnfriador);\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + datoEnfriador + \"\\\")\"}; node.send([null, null, msg]);\t\n\t\tglobal.set(\"enfriarToldo\", 0);}\n\nif (global.get(\"enfriarToldo\") === 1){\n\tcontext.avisoRociador = 1;\n\tif (context.hsAnterior !== hh && mm === 0 && ss === 1 && global.get(\"mojandoToldo\") === 0){\n\t\tglobal.set(\"mojandoToldo\", 1);\n\t\tcontext.hsAnterior = hh;\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 1}\"};\t\n\t\tnode.send([msg, null, null]); \n\n\t\tmsg = {topic: \"notifyBlynk\", payload: \"Enfriando toldo, hs= \" + tiempo}; node.send([msg, null, null]);\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + msg.payload + \"\\\")\"}; \n\t\tnode.send([null, null, msg]);\t\t\t\n\t}\n\tif (global.get(\"mojandoToldo\") === 1 && mm === tiempoMojando && ss === 1){\t\n\t\tglobal.set(\"mojandoToldo\", 0);\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 0}\"};\t\n\t\tnode.send([msg, null, null]);\t\n\n\t\tmsg = {topic: \"notifyBlynk\", payload: \"Termino de enfriar toldo, hs= \" + tiempo}; node.send([msg, null, null]);\t\t\t\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + msg.payload + \"\\\")\"}; \n\t\tnode.send([null, null, msg]);\t\t\t\n\t\t}\n\t}\nif (global.get(\"enfriarToldo\") === 0 && context.avisoRociador === 1){\t\t\n\tmsg = {topic: \"notifyBlynk\", payload: \"Enfriador deshabilitado\"}; node.send([msg, null, null]);\n\tcontext.avisoRociador = 0;\t\t\n\tglobal.set(\"mojandoToldo\" , 0);\n\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 0}\"};\t\n\tnode.send([msg, null, null]);\t\n}\n\nif (dato.topic === \"Toldo\"){\n\t// if (global.get(\"estadoToldo\") === \"Error Toldo\") return;\n\tswitch (dato.payload){\n\t\tcase 0:\n\t\t\tglobal.set(\"estadoToldo\", \"Parado\");\t\t\n\t\t\tcontext.estadoToldo = 0;\t\n\t\t\tglobal.set(\"estadoToldoLCD\", \"Toldo parado de forma manual (Blynk)\");\n\t\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; node.send([msg, null, null]);\n\t\t\tif (context.estAnt === 0){msg = {payload: 0, color: \"#ffbc26\", label: \"Toldo Parado\", offlabel: \"Abrir\", pin: 3}; node.send([null, msg, null]); return;}\n\t\t\tif (context.estAnt === 1){msg = {payload: 0, color: \"#ffbc26\", label: \"Toldo Parado\", offlabel: \"Cerrar\", pin: 3}; node.send([null, msg, null]); return;}\n\t\tbreak;\n\t\tcase 1:\t\n\t\t    if (global.get(\"estadoToldo\") === \"Abierto\") return;\n\t\t\tif (global.get(\"estadoToldo\") === \"Cerrado\")global.set(\"tiempoMoviendo\", 0);\n\t\t\tmsg = {payload: 1, color: \"#ffbc26\", label: \"Tol. Abriendo\", onlabel: \"Parar\", pin: 3}; node.send([null, msg, null]);\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: \"Abriendo Toldo\"}; node.send([msg, null, null]);\n\t\t\tcontext.estadoToldo = 1;\n\t\t\tcontext.estAnt = 1;\n\t\t\tglobal.set(\"estadoToldo\", \"Abriendo\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\") + \" \" + context.tiempoToldo});//toldo abierto\n\t\tbreak;\n\t\tcase 2:\n\t\t\tglobal.set(\"estadoToldo\", \"Abierto\");\t\t\n\t\t\tif (context.condicionEstadoToldo === 0)global.set(\"estadoToldoLCD\", \"Toldo Abierto de forma manual (Blynk)\" + hh+\":\"+mm+\":\"+ss);\n\t\t\tif (context.condicionEstadoToldo === 1)global.set(\"estadoToldoLCD\", \"Toldo Abierto (\"  + hh+\":\"+mm+\":\"+ss + \")\" + global.get(\"estadoToldoLCD\").substring(30));\n\t\t\tif (context.condicionEstadoToldo === 2)global.set(\"estadoToldoLCD\", \"Toldo Abierto por Oscurecer(\"  + hh+\":\"+mm+\":\"+ss + \")\");\n\t\t\tif (context.condicionEstadoToldo === 3)global.set(\"estadoToldoLCD\", \"Toldo Abierto por Amanecer(\"  + hh+\":\"+mm+\":\"+ss + \") por Amanecer\");\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + global.get(\"estadoToldoLCD\") + \"\\\",\" + global.get(\"tiempoMoviendo\") + \",\" + global.get(\"tempPatioLuz\") + \")\"};\n\t\t\tnode.send([null, null, msg]);\t\n\t\t\tmsg = {pin: 3, payload: 1, color: \"#23C48E\", label: \"Toldo Abierto\", onlabel: \"Cerrar\"}; node.send([null, msg, null]);\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: \"Toldo Abierto\"}; node.send([msg, null, null]);\n\t\t\tcontext.estadoToldo = 2;\n\t\t\tcontext.estAnt = 1;\n\t\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; node.send([msg, null, null]);\n\t\t\treturn;\n\t\tcase 3:\n\t\t\t// if (global.get(\"estadoToldo\") === \"Cerrado\") return;\t\t\t\n\t\t\tglobal.set(\"tiempoMoviendo\", 0);\n\t\t\tmsg = {payload: 1, color: \"#ffbc26\", label: \"Tol. Cerrando\", onlabel: \"Parar\", pin: 3}; node.send([null, msg, null]);\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: \"Cerrando Toldo\"}; node.send([msg, null, null]);\n\t\t\tcontext.estadoToldo = 3;\n\t\t\tcontext.estAnt = 0;\n\t\t\tglobal.set(\"estadoToldo\", \"Cerrando\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\") + \" \" + context.tiempoToldo});\n\t\tbreak;\n\t\tcase 4:\n\t\t\tglobal.set(\"estadoToldo\", \"Cerrado\");\n\t\t\tif (context.condicionEstadoToldo === 0)global.set(\"estadoToldoLCD\", \"Toldo Cerrado de forma manual (Blynk \" + hh+\":\"+mm+\":\"+ss + \")\");\n\t\t\tif (context.condicionEstadoToldo === 1)global.set(\"estadoToldoLCD\", \"Toldo Cerrado (\" + hh+\":\"+mm+\":\"+ss + \")\" + global.get(\"estadoToldoLCD\").substring(30));\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + global.get(\"estadoToldoLCD\") + \"\\\",\" + global.get(\"tiempoMoviendo\") + \",\" + global.get(\"tempPatioLuz\") + \")\"};\n\t\t\tnode.send([null, null, msg]);\n\t\t\tmsg = {pin: 3, payload: 0, color: \"#23C48E\", label: \"Toldo Cerrado\", offlabel: \"Abrir\"}; node.send([null, msg, null]);\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: \"Toldo Cerrado\"}; node.send([msg, null, null]);\t\n\t\t\tcontext.estadoToldo = 4;\t\t\n\t\t\tcontext.estAnt = 0;\n\t\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; node.send([msg, null, null]);\n\t\t\treturn;\n\t}\n\tmsg = {topic: \"Blynk/actualizar/toldo\", payload: 1}; node.send([msg, null, null]);\n}\n\nif (context.ssAnterior !== ss){\n\tcontext.ssAnterior = ss;\n\tif (global.get(\"estadoToldo\") === \"Cerrando\" || global.get(\"estadoToldo\") === \"Abriendo\"){\n\tvar porcentaje;\n\tif (global.get(\"estadoToldo\") === \"Abriendo\"){\n\t\tmsg = {pin: 4, payload: \" Abriendo Toldo \"};\n\t\ttiempoMoviendo = global.get(\"tiempoMoviendo\") - 1; \n\t\tglobal.set(\"tiempoMoviendo\", tiempoMoviendo);}\n\n\tif (global.get(\"estadoToldo\") === \"Cerrando\"){\n\t\tmsg = {pin: 4, payload: \" Cerrando Toldo \"};\n\t\ttiempoMoviendo = global.get(\"tiempoMoviendo\") + 1; \n\t\tglobal.set(\"tiempoMoviendo\", tiempoMoviendo);}\n\tnode.send([null, msg, null]);\n\n\tporcentaje = Math.abs(((parseFloat((tiempoMoviendo * 100)/tiempoMover))).toFixed(1));\n\tif (porcentaje < 10)porcentaje = \"  \" + porcentaje;\n\tif (porcentaje < 100 && porcentaje >= 10)porcentaje = \" \" + porcentaje;\t\n\n\tmsg = {pin: 5, payload: \" Avance= \" + porcentaje + \"% \"};// Avance= 100.1%\n\tnode.send([null, msg, null]); \n\tnode.status({text: tiempoMoviendo + \"  Avance: \" + porcentaje+ \"%\"});\n\t}\n}\n\n// if (global.get(\"estadoToldo\") === \"Abriendo\"){\n// \tif(Math.abs(global.get(\"tiempoMoviendo\")) > tiempoMover * 1.1){\n// \tcontext.estadoToldo = 0;\n// \tglobal.set(\"estadoToldo\", \"Error Toldo\");\n// \tmsg = {payload: 1, color: \"#D3435C\", onlabel: \"Error\", pin: 3}; node.send([null, msg, null, null, null]);\n// \tmsg = {payload: \"Error al abrir toldo\"}; node.send([null, null, null, msg, null]);\n// \tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\";\n// \tnode.send([null, null, msg, null, null]);\n// \tglobal.set(\"estadoToldoLCD\", \"Error al abrir toldo\");\n// \treturn;\t\n// \t}//error al abrir//error al abrir\n// }\n// if (global.get(\"estadoToldo\") === \"Cerrando\"){\n// \tif(Math.abs(global.get(\"tiempoMoviendo\")) > tiempoMover * 1.1){\n// \tcontext.estadoToldo = 0;\n// \tglobal.set(\"estadoToldo\", \"Error Toldo\");\n// \tmsg = {payload: 1, color: \"#D3435C\", onlabel: \"Error\", pin: 3}; node.send([null, msg, null, null, null]);\n// \tmsg = {payload: \"Error al cerrar toldo\"}; node.send([null, null, null, msg, null]);\n// \tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\";\n// \tnode.send([null, null, msg, null, null]);\n// \tglobal.set(\"estadoToldoLCD\", \"Error al cerrar toldo\");\n// \treturn;\t\n// \t}//error al cerrar\n// }([null, null, ])","outputs":3,"noerr":0,"x":1390.3096160888672,"y":202.30952807835172,"wires":[[],[],[]]},{"id":"89e0166f.74bba8","type":"exec","z":"e6e33852.2495f8","command":" speedtest --share --server 18725","addpay":false,"append":"","useSpawn":"true","timer":"","oldrc":true,"name":"Server Bahia (Fibertel)","x":430.7777633666992,"y":315.66665267944336,"wires":[["80065b77.186188","8f6bdb58.8e4158"],[],[]]},{"id":"c2b67b34.07c748","type":"inject","z":"a89e305a.c50bb","name":"","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1215.2380561828613,"y":536.999993801117,"wires":[["34cc6743.777428","2981ce96.3bf072"]]},{"id":"65ba529c.420b9c","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"{\"topic\":\"Baterias/Estado/Completo\",\"payload\":1}","payloadType":"str","repeat":"","crontab":"","once":true,"onceDelay":"65","x":338.4048385620117,"y":861.3572384970529,"wires":[["42bf6e98.eba1a"]]},{"id":"164c686f.fee268","type":"function","z":"f682d492.22a758","name":"","func":"msg.payload = \"Ser reinicio servidor\";\nreturn msg;","outputs":1,"noerr":0,"x":341.5475769042969,"y":265.6666717529297,"wires":[["12fe5170.f844af"]]},{"id":"ac939918.084638","type":"mqtt in","z":"50119c6e.6ff584","name":"","topic":"USBin/itemCrep","qos":"2","broker":"e779f8d6.7bc2c8","x":243.650728225708,"y":606.1904554367065,"wires":[["4374c8c0.3e85f8"]]},{"id":"29f84a02.cd6be6","type":"delay","z":"3ce5b54a.127d6a","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":3210.238105773926,"y":855.4286003112793,"wires":[["55ac7d6.b20f384"]]},{"id":"838dedf0.be8cd","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":2315.547550201416,"y":1279.9761947904317,"wires":[["e1c6ae7.a9dd95"]]},{"id":"55b494c8.fab0dc","type":"blynk-ws-out-write","z":"50119c6e.6ff584","name":"","pin":"20","pinmode":0,"client":"2c18e412.5f5cbc","x":722.8570671081543,"y":360.00000953674316,"wires":[]},{"id":"8eae8835.51cb08","type":"mqtt out","z":"a89e305a.c50bb","name":"","topic":"doblePuls","qos":"","retain":"","broker":"6b36e4a.1d30b1c","x":1482.7381057739258,"y":200.74999237060547,"wires":[]},{"id":"40cbd7ce.d528d8","type":"function","z":"e6e33852.2495f8","name":"","func":"var payload = msg.payload;\nvar resultado;\n\nif(payload == \".\")payload = \"Realizando medicion\";\nnode.status({text: \"Estado actual: \" + msg.payload});\nif (payload.includes(\"Download\")){\n    global.set(\"DescargaFast\", parseFloat(payload.substring(payload.indexOf(\"Download: \")+10, payload.indexOf(\"Mbit/s\"))));\n    // msg = {topic: \"DescargaFast\", payload: context.descarga}; node.send([null, null, msg, null]);\n    // node.status({text: resultado});\n    }\n\nif (payload.includes(\"Upload\")){\n    global.set(\"SubidaFast\", parseFloat(payload.substring(payload.indexOf(\"Upload: \")+8, payload.indexOf(\"Mbit/s\"))));\n    // msg = {topic: \"SubidaFast\", payload: context.subida}; node.send([null, null, msg, null]);\n    // node.status({text: resultado});\n    }    \nif (payload.includes(\"Share results\")){\n    resultado = payload.substring(payload.indexOf(\"Share results\")+15);\n    node.status({text: resultado});\n    msg = {pin: 70, payload: context.descarga + \" -- \" + context.subida}; node.send([null, null, null, msg]);\n    msg.payload = global.get(\"fechaCompleta\") + \" -- \" + resultado; return msg;\n}\nif (payload.includes(\"error\") || payload.includes(\"Error\")){\n    msg.payload = global.get(\"fechaCompleta\") + \" -- \" + \"Falla de conexion\"; \n    node.send([msg, null]);\n    return ([null, msg])\n}\n","outputs":4,"noerr":0,"x":494.1111136542426,"y":204.55555513170032,"wires":[["6f1ac0c9.21d27","89e0166f.74bba8","df0fdba0.2a4e58"],["f0069ce0.a32ee"],[],[]]},{"id":"ac2c785f.fac748","type":"function","z":"3ce5b54a.127d6a","name":"","func":"var dato = JSON.parse(msg.payload);\nif (global.get(\"tiempoEspera\") === undefined)global.set(\"tiempoEspera\", 0);\nif (global.get(\"tiempoCargando\") === undefined)global.set(\"tiempoCargando\", 0);\n// context.cont = context.cont || 0;\n// context.voltaje = context.voltaje || 0;\n// context.nivTanque = context.nivTanque || 0;\n// context.tempAmb = context.tempAmb || 0;\n// context.tempCPU = context.tempCPU || 0;\n// context.PWMCooler = context.PWMCooler || 0;\n// context.Crep = context.Crep || 0;\n\n// context.cont++;\n// context.voltaje += parseFloat(global.get(\"voltajeBaterias\"));\n// context.nivTanque += parseFloat(global.get(\"nivTanque\"));\n// context.tempAmb += parseFloat(global.get(\"tempAmbienteBat\"));\n// context.tempCPU += parseFloat(global.get(\"tempCPU\"));\n// context.PWMCooler += parseFloat(global.get(\"PWM-Cooler\"));\n// context.Crep += parseFloat(global.get(\"LDR\"));\n\n// node.status({text: context.cont});\n// if (context.cont >= 10){\n// \tcontext.voltaje = context.voltaje / context.cont;\n// \tcontext.nivTanque = context.nivTanque / context.cont;\n// \tcontext.tempAmb = context.tempAmb / context.cont;\n// \tcontext.tempCPU = context.tempCPU / context.cont;\n// \tcontext.PWMCooler = context.PWMCooler / context.cont;\n// \tcontext.Crep = context.Crep / context.cont;\nif (dato.topic == \"Baterias/Est/Pedido/Resp\"){\n\n\tmsg= {topic: \"voltajeBat\", payload: global.get(\"voltajeBaterias\")}; node.send(msg);\n\tmsg= {topic: \"corrienteCarga\", payload: global.get(\"corrienteCarga\")}; node.send(msg);\n\tmsg= {topic: \"cargador\", payload: global.get(\"estadoCargador\")}; node.send(msg);\n\tmsg= {topic: \"tiempoCargando\", payload: global.get(\"tiempoCargando\").toFixed(2)}; node.send(msg);\n\tmsg= {topic: \"tiempoEspera\", payload: global.get(\"tiempoEspera\").toFixed(2)}; node.send(msg);\n\tmsg= {topic: \"nivTanque\", payload: global.get(\"nivTanque\")}; node.send(msg);\n\tmsg= {topic: \"tempAmb\", payload: global.get(\"tempAmbienteBat\")}; node.send(msg);\n\tnode.status ({text: global.get(\"tempAmbienteBat\")});\n\tmsg= {topic: \"tempBat1\", payload: global.get(\"tempBat1\")}; node.send(msg);\n}\nif (dato.topic === \"Cargador\"){\n\tglobal.set(\"voltajeBaterias\", dato.volt);\n\tglobal.set(\"voltajeBat\", dato.voltajeBat);\n\tglobal.set(\"cargador\", dato.payload);\n\t\n\tmsg= {topic: \"voltajeBat\", payload: global.get(\"voltajeBaterias\")}; node.send(msg);\n\tmsg= {topic: \"corrienteCarga\", payload: global.get(\"corrienteCarga\")}; node.send(msg);\n\tmsg= {topic: \"cargador\", payload: global.get(\"estadoCargador\")}; node.send(msg);\n\n\t// msg= {topic: \"cargador\", payload: dato.payload}; node.send(msg);\n\t// global.set(\"voltajeBaterias\", dato.volt);\n\t// msg= {topic: \"voltajeBat\", payload: global.get(\"voltajeBaterias\")}; node.send(msg);\n}\n\n\t// msg= {topic: \"voltajeBat\", payload: context.voltaje.toFixed(2)}; node.send(msg);\n\t// msg= {topic: \"nivTanque\", payload: context.nivTanque.toFixed(2)}; node.send(msg);\n\t// msg= {topic: \"tempAmb\", payload: context.tempAmb.toFixed(2)}; node.send(msg);\n\t// msg= {topic: \"tempCPU\", payload: context.tempCPU.toFixed(2)}; node.send(msg);\n\t// msg= {topic: \"PWM-Cooler\", payload: context.PWMCooler.toFixed(2)}; node.send(msg);\n\t// msg= {topic: \"Crep\", payload: context.Crep.toFixed(2)}; node.send(msg);\n\n// \tcontext.cont = 0;\n// \tcontext.voltaje = 0;\n// \tcontext.nivTanque = 0;\n// \tcontext.tempAmb = 0;\n// \tcontext.tempCPU = 0;\n// \tcontext.PWMCooler = 0;\n// \tcontext.Crep = 0;\n// }","outputs":1,"noerr":0,"x":870,"y":800,"wires":[["d16ed06d.66af","4d605608.32c4f8"]]},{"id":"874ef0ca.0d4c8","type":"function","z":"50119c6e.6ff584","name":"tempLiving","func":"var dato = JSON.parse(msg.payload);\nvar temp = parseFloat(JSON.parse(dato.temp)) + 3.6;\nvar hum = parseFloat(JSON.parse(dato.hum)).toFixed(1);\n\nglobal.set(\"tempLiving\", temp.toFixed(1));\nglobal.set(\"humLiving\", hum);\nmsg= {topic: \"tempLiving\", payload: global.get(\"tempLiving\")}; node.send(msg);\nmsg= {topic: \"humLiving\", payload: hum}; node.send(msg);\nmsg = {payload: global.get(\"tempLiving\")}; node.send([null,msg]);\nnode.status({text: \"temp: \" + global.get(\"tempLiving\") + \" hum:\" + hum + \" -- \" + global.get(\"hsCpu\")});","outputs":2,"noerr":0,"x":493.57129859924316,"y":556.9048013687134,"wires":[["3fde6b72.65b1a4"],[]]},{"id":"686adb59.b06ae4","type":"debug","z":"3ce5b54a.127d6a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1799.166706085205,"y":1252.7500185966492,"wires":[]},{"id":"5c8a00e7.0e915","type":"blynk-ws-out-write","z":"a89e305a.c50bb","name":"","pin":0,"pinmode":"1","client":"2c18e412.5f5cbc","x":841.2500114440918,"y":1004.5000162124634,"wires":[]},{"id":"9b7ebb17.3f3c98","type":"debug","z":"3ce5b54a.127d6a","name":"salida blynk","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":2962.6666717529297,"y":544,"wires":[]},{"id":"ad40265f.8ebfc8","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":2597.2975692749023,"y":77.48810291290283,"wires":[["be0dfdbd.fac73"]]},{"id":"9641fbd0.64c858","type":"mqtt out","z":"3ce5b54a.127d6a","name":"","topic":"USBin","qos":"","retain":"","broker":"c339edbf.39572","x":266.976282119751,"y":468.49999972752164,"wires":[]},{"id":"8f356ea8.5ecc6","type":"file in","z":"f682d492.22a758","name":"flows_vps.json","filename":"/home/gaston/.node-red/projects/Node-Red-Mi-Casa/flow.json","format":"utf8","sendError":true,"x":363,"y":66,"wires":[["29c810f2.f893f"]]},{"id":"b31fbc78.d2c28","type":"debug","z":"50119c6e.6ff584","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":544.6428108215332,"y":709.2262029647827,"wires":[]},{"id":"6df38ac8.30d6a4","type":"debug","z":"a89e305a.c50bb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":571.1309204101562,"y":680.7857055664062,"wires":[]},{"id":"2f7f41a7.975cfe","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":2965.0000228881836,"y":374.00001525878906,"wires":[["ea67b4dc.a11d38"]]},{"id":"548e67c0.3e82a8","type":"debug","z":"3ce5b54a.127d6a","name":"pedido/lavadero/bombas","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":3056.6666717529297,"y":73,"wires":[]},{"id":"5cfe80d2.17592","type":"ui_gauge","z":"3ce5b54a.127d6a","name":"","group":"ff2252ef.d12aa","order":4,"width":"2","height":"2","gtype":"gage","title":"Niv Tanque","label":"units","format":"{{value}}","min":"100","max":"550","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":2766.4999389648438,"y":1274.976184027536,"wires":[]},{"id":"85b7a50b.c153d8","type":"inject","z":"a89e305a.c50bb","name":"","topic":"","payload":"1","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":751.2500228881836,"y":482.0000114440918,"wires":[["9b492d23.49c49"]]},{"id":"5ad8f742.dc85e8","type":"delay","z":"7ac92c99.66ea94","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":732.4761323928833,"y":499.85712909698486,"wires":[["9f161dbe.8b3fe"]]},{"id":"7fdf936c.16064c","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":638.4523773193359,"y":608.2857491629464,"wires":[["db53bed6.d24d9"]]},{"id":"f02f5acd.665768","type":"function","z":"a89e305a.c50bb","name":"","func":"dato = msg.payload.split(\"#\");\nvar isla = dato[0];\nvar cielorrazo = dato[1];\nvar rgb = dato[2];\nmsg = {topic: \"INSERT INTO \\`ilLiving\\`(\\`date\\`, \\`isla\\`, \\`cielorrazo\\`, \\`rgb\\`) VALUES (now(),\" + isla + \",\" + cielorrazo + \",\" + rgb + \")\"};\nreturn msg;","outputs":1,"noerr":0,"x":520.0596008300781,"y":753.4285373687744,"wires":[["29b79419.61cf0c","52340124.9497"]]},{"id":"3fde9ea6.1be982","type":"function","z":"3ce5b54a.127d6a","name":"falla living","func":"// context.contadorLiving = context.contadorLiving || 0;\n// context.fallasLiving = context.fallasLiving || 0;\n// // var status;\n\n// context.contadorLiving++;\nif (msg.topic == \"comprobarConexionLiving\"){\n\tvar fallas = global.get(\"fallasLiving\") + 1;\n\tglobal.set(\"fallasLiving\", fallas);\n\tglobal.set(\"tipoFallaSensLiving\", msg.payload); msg = {topic: \"fallas_MQTT\", payload: 1};  node.send(msg);\n}\nnode.status({text: \"Fal Liv: \" + global.get(\"fallasLiving\")});\n\nif (msg.topic === \"Reset\"){global.set(\"fallasLiving\", 0); context.fallasLiving = 0; return;}\n\n// if (msg.topic === \"comprobarConexionLiving\"){context.contadorLiving = 0; return;}\n// if (context.contadorLiving >= 5){\n//     context.contadorLiving = 0;\n//     context.fallasLiving++;\n//     global.set(\"fallasLiving\", context.fallasLiving);\n// }\n","outputs":1,"noerr":0,"x":1675.2380447387695,"y":991.6786448614938,"wires":[["bf15eec9.f42a"]]},{"id":"cf15164b.cd4698","type":"mqtt out","z":"3ce5b54a.127d6a","name":"electrovalvula llenado","topic":"ESP/Lavadero/Bombas/Estado/Rele0","qos":"","retain":"","broker":"c339edbf.39572","x":3189.1666717529297,"y":437.75,"wires":[]},{"id":"2205861b.c2035a","type":"inject","z":"a89e305a.c50bb","name":"Desabilitar doble puls","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1127.7381019592285,"y":221.9999942779541,"wires":[["e1819fa7.ce1f7"]]},{"id":"b5451e86.db728","type":"blynk-ws-in-write","z":"3ce5b54a.127d6a","name":"","pin":"13","client":"2c18e412.5f5cbc","x":1369.5588035583496,"y":1179.5118775367737,"wires":[["1583c20e.1315ee"]]},{"id":"85c6236d.47efd","type":"mqtt out","z":"3ce5b54a.127d6a","name":"","topic":"ESP/Lavadero/Presurizadora","qos":"","retain":"","broker":"c339edbf.39572","x":2133.166793823242,"y":469.45238086155484,"wires":[]},{"id":"378b6dab.cd60f2","type":"blynk-ws-in-write","z":"3ce5b54a.127d6a","name":"","pin":"20","pin_all":false,"client":"2c18e412.5f5cbc","x":1316.25,"y":1041.7776861190796,"wires":[["46a348b2.be9438"]]},{"id":"89eeadd0.e0f45","type":"mqtt in","z":"a89e305a.c50bb","name":"","topic":"aviso/Iluminacion","qos":"2","broker":"6b36e4a.1d30b1c","x":167.73810577392578,"y":167,"wires":[["8bd456c6.07d1e8"]]},{"id":"336ec26f.b3718e","type":"debug","z":"a89e305a.c50bb","name":"iluminacionLiving - google/Living","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":624,"y":578,"wires":[]},{"id":"53a8816f.9a9c5","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"habNivel","qos":"2","broker":"c339edbf.39572","x":138.40489196777344,"y":861.5952317374093,"wires":[["66a6f4e9.4fa68c"]]},{"id":"a9f6f46e.a9bd78","type":"inject","z":"3ce5b54a.127d6a","name":"pulso","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":0.1,"x":2787.833465576172,"y":378.0238723754883,"wires":[["1401f851.1605b8"]]},{"id":"e49e7f05.d89db","type":"function","z":"3ce5b54a.127d6a","name":"toldo andando","func":"\tvar topic = msg.topic;\n\tvar payload = parseInt(msg.payload);\n\tcontext.estadoToldo = context.estadoToldo || 0;  // estToldo:  0= parado, 1= abriendo, 2= abierto, 3= cerrando, 4= cerrado\n\tcontext.estAnt = context.estAnt || 0; // =0 parado, =1 abriendo, = 2 cerrando\n\tvar tiempoMover = 15;\n\tvar diffAmanecer = 1.5;\n\tvar date = new Date();\n\tvar hh = global.get(\"hh\");\n\tvar mm = global.get(\"mm\");\n\tvar ss = global.get(\"ss\");\n\tif (global.get(\"tiempoEsperaRociador\") === undefined)global.set(\"tiempoEsperaRociador\", 30);\n\tif (global.get(\"tiempoMojandoRociador\") === undefined)global.set(\"tiempoMojandoRociador\", 0.8);\n\n\t// context.tiempoToldo = context.tiempoToldo || date.getTime();\n\tcontext.datoAmanecer = context.datoAmanecer || date.getTime()+5000;\n\tcontext.CerrarToldoAuto = context.CerrarToldoAuto || 0; \n\tcontext.AbrirToldoAuto = context.AbrirToldoAuto || 0;\n\tcontext.hsAnterior =context.hsAnterior || hh-1;\n\tcontext.ssAnterior = context.ssAnterior || 0;\n\tcontext.inicio = context.inicio || 0;\n\tcontext.error = context.error || 0;\n\n\tcontext.avisoAuto = context.avisoAuto || 0;\n\tcontext.avisoRociador = context.avisoRociador || 0;\n\tcontext.condicionEstadoToldo = context.condicionEstadoToldo || 0;\n\tcontext.aperturaAmanecer = context.aperturaAmanecer || 0;\n\tcontext.cerradoManual = context.cerradoManual || 0;// =1 lo cerre manual se habilita pone a 0 cuando se cierra de forma automatica\n\tcontext.abiertoManual = context.abiertoManual || 0;// =1 lo habri manual se habilita pone a 0 cuando se habre de forma automatica\n\n\tif (global.get(\"tiempoMoviendo\") === undefined)global.set(\"tiempoMoviendo\", 0);\n\tif (global.get(\"enfriarToldo\") === undefined)global.set(\"enfriarToldo\", 0);\n\tif (global.get(\"mojandoToldo\") === undefined)global.set(\"mojandoToldo\", 0);\n\tif (global.get(\"estadoToldo\") === undefined)global.set(\"estadoToldo\", \"nulo\");\n\tif (global.get(\"Dia\") === undefined)global.set(\"Dia\", 0);\n\tif (global.get(\"datoAmanecer\") === undefined)global.set(\"datoAmanecer\", \"nulo\");\n\tif (global.get(\"tempPatioLuz\") === undefined)global.set(\"tempPatioLuz\", 0);\n\tif (global.get(\"hsAmanecer\") === undefined)global.set(\"hsAmanecer\", \"nulo\");\n\tif (global.get(\"hsAnochecer\") === undefined)global.set(\"hsAnochecer\", \"nulo\");\n\n\tvar dato = JSON.parse(msg.payload);\n\n\tvar tiempo = hh + \":\" + mm + \":\" + ss;\n\n\tif (dato.topic === \"Toldo\")comprobarToldo();\n\n\tif (msg.topic === \"USBin/Toldo\"){\n\t\tif (dato.topic === \"tiempoEsperaRociador\"){global.set(\"tiempoEsperaRociador\", parseFloat(dato.payload).toFixed(1)); return;}\n\t\tif (dato.topic === \"tiempoMojandoRociador\"){global.set(\"tiempoMojandoRociador\", parseFloat(dato.payload).toFixed(1)); return;}\n\t}\n\n\n\tif (global.get(\"estadoToldo\") !== \"Abriendo\" || global.get(\"estadoToldo\") !== \"Cerrando\")node.status({text: global.get(\"hsCpu\") + \"  \" + context.CerrarToldoAuto + \" -- \" + hh});\t\t\n\n\tif(context.inicio === 0){\n\t\tif (global.get(\"Dia\") === 1)context.aperturaAmanecer = 1;\n\n\tcontext.inicio = 1;\t\n\t}\n\n\tif (hh === 0 && mm === 0 && ss === 0){\n\t\tcontext.CerrarToldoAuto = 0;\n\t\tcontext.AbrirToldoAuto = 0;\t\n\t\tcontext.cerradoManual = 0;\n\t}\n\n\tif (topic === \"resetAutos\"){\n\t\tcontext.CerrarToldoAuto = 0;\n\t\tcontext.AbrirToldoAuto = 0;\t\n\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\t\treturn;}\n\n\tif (topic === \"toldoBlynk\"){\n\t\tglobal.set(\"estadoToldo\", \"Error Borrado\");\n\t\tglobal.set(\"toldoManual\", 1);\n\t\tif (payload === 1 && context.estAnt === 0){\n\t\t\t// context.abiertoManual = 0;\n\t\t\tcontext.abiertoManual = 1;\n\t\t\tcontext.condicionEstadoToldo = 0;\n\t\t\tcontext.CerrarToldoAuto = 0;\n\t\t\tglobal.set(\"estadoToldoLCD\", \"Abriendo toldo modo manual (Blynk)\");\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Abriendo Toldo Manual Blynk\\\")\"};\n\t\t\tnode.send([null, null, msg]);\t\t\n\t\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\"};\n\t\t\tnode.send([msg, null, null]); \n\t\t\treturn;}\n\n\t\tif (payload === 1 && context.estAnt === 1){\n\t\t\tcontext.cerradoManual = 1;\n\t\t\t// context.cerradoManual = 0;\n\t\t\tcontext.condicionEstadoToldo = 0;\n\t\t\tcontext.AbrirToldoAuto = 0;\n\t\t\tglobal.set(\"estadoToldoLCD\", \"Cerrando toldo modo manual (Blynk)\");\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Cerrando Toldo Manual Blynk\\\")\"};\n\t\t\tnode.send([null, null, msg]);\t\t\t\n\t\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\"};\n\t\t\tnode.send([msg, null, null]); \n\t\t\treturn;}\n\n\t\tif (payload === 0 && context.estadoToldo === 2){\n\t\t\tcontext.cerradoManual = 1;\n\t\t\t// context.cerradoManual = 0;\n\t\t\tcontext.condicionEstadoToldo = 0;\n\t\t\tglobal.set(\"estadoToldoLCD\", \"Cerrando toldo modo manual (Blynk)\");\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(),\\\"Cerrando Toldo Manual Blynk\\\")\"};\n\t\t\tnode.send([null, null, msg]);\t\t\t\n\t\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\"};\n\t\t\tnode.send([msg, null, null]); \n\t\t\treturn;}\n\n\t\tif (payload === 0){\n\t\t\tcontext.abiertoManual = 0;\n\t\t\tcontext.cerradoManual = 0;\t\t\n\t\t\tglobal.set(\"estadoToldoLCD\", \"Toldo Parado\");\n\t\t\tcontext.cerradoManual = 0;\n\t\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\"};\n\t\t\tnode.send([msg, null, null]); \n\t\t\tglobal.set(\"estadoToldoLCD\", \"Toldo parado de forma manual (Blynk)\");\n\t\t\treturn;}\n\t\t}\n\n\tif (global.get(\"Dia\") === 0){context.aperturaAmanecer = 0; context.datoAmanecer = date.getTime() + 1000;}\n\n\t// global.set(\"datoAmanecer\", context.datoAmanecer);\t\n\tif (global.get(\"tempPatioLuz\") > 19 && global.get(\"estadoToldo\") === \"Abierto\")context.CerrarToldoAuto = 0;\n\tif (topic === \"crepMQTT\" && payload === 0){context.CerrarToldoAuto = 0;}\n\n\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\tglobal.set(\"aperturaAmanecer\", context.aperturaAmanecer);\t\n\tglobal.set(\"diff\", date.getTime() - (context.datoAmanecer + (1000 * 2)));\n\n\tif (global.get(\"mes\") >= 3 && global.get(\"mes\") <= 8 && hh === 22 && mm < 5 && context.CerrarToldoAuto === 0 && global.get(\"estadoToldo\") !== \"Cerrado\"){\n\t\tcontext.abiertoManual = 0;\t\n\t\tcontext.AbrirToldoAuto = 0;\t\n\t\tcontext.condicionEstadoToldo = 1;\n\t\tvar datoMsg = \"Cerrando toldo por oscurcer en invierno\";\n\t\tglobal.set(\"estadoToldoLCD\", datoMsg);\n\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \")\"};\n\t\tnode.send([null, null, msg]);\t\t\n\n\t\tmsg = {topic: \"notifyBlynk\", payload: datoMsg}; node.send([msg, null, null]);\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\"}; node.send([msg, null, null]);  \n\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\t\t// return;\t\n\t}\n\n\t//Cerrar\t\n\tif (global.get(\"tempPatioLuz\") > 24 && global.get(\"Dia\") === 1 || global.get(\"tempPatioLuz\") < 15 && global.get(\"Dia\") === 0  && context.abiertoManual === 0){\n\t\tif (context.CerrarToldoAuto === 0 && global.get(\"estadoToldo\") !== \"Cerrado\"){\n\t\t\tcontext.cerradoManual = 0;\n\t\t\tcontext.AbrirToldoAuto = 0;\t\t\n\t\t\tcontext.condicionEstadoToldo = 2;\n\t\t\t// global.set(\"estadoToldo\", \"Cerrando\");\n\t\t\tvar datoMsg = \"Cerrando toldo por temperatura (24<\" + global.get(\"tempPatioLuz\") + \"<15)\";\n\t\t\tglobal.set(\"estadoToldoLCD\", datoMsg);\n\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \")\"};\n\t\t\tnode.send([null, null, msg]);\t\t\n\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: datoMsg}; node.send([msg, null, null]);\n\t\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":4}\"};\n\t\t\tnode.send([msg, null, null]);  \n\t\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\t\t\treturn;}\t\t\t\n\t\t}\t\n\n\t//Abrir anochecer\n\tif (topic === \"crepMQTT\" && payload === 0){\n\t\tcontext.aperturaAmanecer = 0;\n\t\tif(global.get(\"tempPatioLuz\") < 23 && global.get(\"tempPatioLuz\") >= 18 && global.get(\"estadoToldo\") !== \"Abierto\" && context.cerradoManual === 0){\n\t\t\tcontext.CerrarToldoAuto = 0;\n\t\t\tcontext.abiertoManual = 0\n\t\t\tcontext.condicionEstadoToldo = 2;\n\t\t\tvar datoMsg = \"Abriendo toldo por hacerse de noche\";\n\t\t\tglobal.set(\"estadoToldoLCD\", datoMsg);\n\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"Abriendo toldo por oscurecer\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + global.get(\"hsAnochecer\") + \"\\\")\"};\n\t\t\tnode.send([null, null, msg]);\n\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: datoMsg}; node.send([msg, null, null]);\n\t\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\"};\n\t\t\tnode.send([msg, null, null]);  \n\t\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\t\t}}\t\t\n\n\t//Abrir por temp\n\tif (global.get(\"tempPatioLuz\") < 17 && global.get(\"tempPatioLuz\") > 15 && global.get(\"Dia\") === 1 && context.AbrirToldoAuto === 0 && global.get(\"estadoToldo\") !== \"Abierto\" && context.cerradoManual === 0){\n\t\tcontext.condicionEstadoToldo = 1;\n\t\tcontext.abiertoManual = 0\n\t\tvar datoMsg = \"Abriendo toldo por temperatura (19<\" + global.get(\"tempPatioLuz\") + \">17)\";\n\t\tglobal.set(\"estadoToldoLCD\", datoMsg); \n\n\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n\t\tnode.send([null, null, msg]);\t\n\n\t\tmsg = {topic: \"notifyBlynk\", payload: datoMsg}; node.send([msg, null, null]);\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\"}; node.send([msg, null, null]); \n\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\t\treturn;}\n\n\t//Abrir amanecer     * 60 * diffAmanecer\n\tif (date.getTime() > (context.datoAmanecer + (1000 * 60 * 60 * diffAmanecer)) && global.get(\"tempPatioLuz\") < 23  && context.aperturaAmanecer === 0){   //Abrir Auto por Hora, hs= 23:15:25\n\t\tcontext.aperturaAmanecer = 1;\n\t\tif(context.AbrirToldoAuto === 0 && global.get(\"estadoToldo\") !== \"Abierto\"){\n\t\t\tcontext.condicionEstadoToldo = 3;\n\t\t\tcontext.aperturaAmanecer = 1;\n\t\t\tcontext.abiertoManual = 0;\t\t\n\t\t\tcontext.CerrarToldoAuto = 0;\n\t\t\tvar datoAmanecer = global.get(\"hsAmanecer\"); if (datoAmanecer === undefined)datoAmanecer = null;\n\t\t\tvar datoMsg = \"Abriendo toldo por Amanecer, hs amanecer: \" + global.get(\"hsCpu\");\n\t\t\tglobal.set(\"estadoToldoLCD\", datoMsg);\n\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tempPatioLuz\\`, \\`crepuscular\\`) VALUES (now(),\\\"\" + datoMsg + \"\\\", \" + global.get(\"tempPatioLuz\") + \", \\\"\" + datoAmanecer + \"\\\")\"};\n\t\t\tnode.send([null, null, msg]);\n\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: datoMsg}; node.send([msg, null, null]);\n\t\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":2}\"}; node.send([msg, null, null]); \n\t\t\tglobal.set(\"CerrarToldoAuto\", context.CerrarToldoAuto);\n\t\t\tglobal.set(\"AbrirToldoAuto\", context.AbrirToldoAuto);\n\t\t\treturn;}\t}\n\n\t//60 * 60 * 1.5\n\n\tif (msg.topic === \"enfriarToldoBlynk\"){global.set(\"enfriarToldo\", msg.apyload);}\n\n\tif (global.get(\"tempPatioLuz\") >= 25 && global.get(\"estadoToldo\") === \"Cerrado\"  && global.get(\"enfriarToldo\") === 0){\n\t\t\tcontext.esperaMojando = date.getTime() - 1000; global.set(\"mojandoToldo\",0);\n\t\t\tvar datoEnfriador = \"Enfriador habilitado (\" + global.get(\"hsCel\") + \" temp: \" + global.get(\"tempPatioLuz\") + \")\";\n\t\t\tmsg = {pin: 9, payload: 1}; node.send([null, msg, null]);\n\t\t\tglobal.set(\"enfriadorToldo\", datoEnfriador);\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + datoEnfriador + \"\\\")\"}; node.send([null, null, msg]);\t\n\t\t\t// msg = {topic: \"notifyBlynk\", payload: datoEnfriador}; node.send([msg, null, null]);\n\t\t\tglobal.set(\"enfriarToldo\", 1);\n\t\t\tcontext.avisoRociador = 0;}\n\n\tif (global.get(\"tempPatioLuz\") <= 18 && global.get(\"enfriarToldo\") === 1 || global.get(\"estadoToldo\") !== \"Cerrado\" && global.get(\"enfriarToldo\") === 1){\n\t\t\tvar datoEnfriador = \"Enfriador deshabilitado (\" + global.get(\"hsCel\") + \" temp: \" + global.get(\"tempPatioLuz\") + \")\";\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: datoEnfriador}; node.send([msg, null, null]);\n\t\t\tglobal.set(\"enfriadorToldo\", datoEnfriador);\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + datoEnfriador + \"\\\")\"}; node.send([null, null, msg]);\t\n\t\t\tglobal.set(\"enfriarToldo\", 0);\n\t\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 0}\"};\t\n\t\t\tnode.send([msg, null, null]);\n\t\t\tmsg = {pin: 9, payload: 0}; node.send([null, msg, null]);\n\t\t}\n\n\tif (global.get(\"enfriarToldo\") === 1){\n\t\tif (global.get(\"mojandoToldo\") === 0 && date.getTime() > context.esperaMojando && global.get(\"tempPatioLuz\") >= 22){\n\t\t\tcontext.tiempoMojando = date.getTime() + (1000*60*global.get(\"tiempoMojandoRociador\"));//3'\n\t\t\tglobal.set(\"mojandoToldo\", 1);\n\t\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 1}\"};\t\n\t\t\tnode.send([msg, null, null])\n\t\t\tmsg = {pin: 9, payload: 1}; node.send([null, msg, null]);\n\n\t\t\tvar datoEnfriador = \"rociador mojando desde las \" + global.get(\"hsCel\") ;\n\t\t\tglobal.set(\"rociadorToldo\", datoEnfriador);\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: \"Rociador mojando desde las \" + global.get(\"hsCel\") }; node.send([msg, null, null]);\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + msg.payload + \"\\\")\"}; \n\t\t\tnode.send([null, null, msg]);\n\t\t\tmsg = {topic: \"ESP/Lavadero/Presurizadora\", payload: 1}; node.send([msg, null, null])\t\t\t\t\t\n\t\t}\n\t\tif (global.get(\"mojandoToldo\") === 1 && date.getTime() > context.tiempoMojando){\n\t\t\tcontext.esperaMojando = date.getTime() + (1000*60*global.get(\"tiempoEsperaRociador\"));//30'\n\t\t\tglobal.set(\"mojandoToldo\", 0);\n\t\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 0}\"};\t\n\t\t\tnode.send([msg, null, null]);\n\t\t\tmsg = {pin: 9, payload: 0}; node.send([null, msg, null]);\n\t\t\tvar datoEnfriador = \"rociador en espera desde las \" + global.get(\"hsCel\") ;\n\t\t\tglobal.set(\"rociadorToldo\", datoEnfriador);\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: \"Rociador en espera desde las \" + global.get(\"hsCel\")}; node.send([msg, null, null]);\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`) VALUES (now(), \\\"\" + msg.payload + \"\\\")\"}; \n\t\t\tnode.send([null, null, msg]);\t\t\n\t\t}\n\t}//Cerrando toldo por temperatura (24<\n\tif (global.get(\"enfriarToldo\") === 0 && context.avisoRociador === 0){\t\t\n\t\tvar datoEnfriador = \"Enfriador deshabilitado, \" + global.get(\"hsCel\") + \" temp: \" + global.get(\"tempPatioLuz\");\n\t\tmsg = {topic: \"notifyBlynk\", payload: datoEnfriador}; node.send([msg, null, null]);\n\t\tcontext.avisoRociador = 1;\t\t\n\t\tglobal.set(\"mojandoToldo\" , 0);\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 0}\"};\t\n\t\tnode.send([msg, null, null]);}\t\t\n\n\tfunction comprobarToldo(){\n\tswitch (dato.payload){\n\t\tcase 0:\n\t\t\tglobal.set(\"estadoToldo\", \"Parado\");\t\t\n\t\t\tcontext.estadoToldo = 0;\t\n\t\t\tif (context.error !== 0)global.set(\"estadoToldoLCD\", \"Toldo parado de forma manual (Blynk)\");\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`) VALUES (now(),\\\"\" + global.get(\"estadoToldoLCD\") + \"\\\",\" + global.get(\"tiempoMoviendo\") + \")\"};\t\t\n\t\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; node.send([msg, null, null]);\n\t\t\tif (context.estAnt === 0){msg = {payload: 0, color: \"#ffbc26\", label: \"Toldo Parado\", offlabel: \"Abrir\", pin: 3}; node.send([null, msg, null]); return;}\n\t\t\tif (context.estAnt === 1){msg = {payload: 0, color: \"#ffbc26\", label: \"Toldo Parado\", offlabel: \"Cerrar\", pin: 3}; node.send([null, msg, null]); return;}\n\t\tbreak;\n\t\tcase 1:\t\n\t\t    // if (global.get(\"estadoToldo\") === \"Abierto\") return;\n\t\t\tcontext.AbrirToldoAuto = 1;\n\t\t\tcontext.error = 0;\n\t\t\tif (global.get(\"estadoToldo\") === \"Cerrado\" || global.get(\"estadoToldo\") === \"Error Toldo abriendo\" || global.get(\"estadoToldo\") === \"Error Toldo cerrando\")global.set(\"tiempoMoviendo\", 0);\n\t\t\tmsg = {payload: 1, color: \"#ffbc26\", label: \"Tol. Abriendo\", onlabel: \"Parar\", pin: 3}; node.send([null, msg, null]);\n\t\t\tcontext.estadoToldo = 1;\n\t\t\tcontext.estAnt = 1;\n\t\t\tglobal.set(\"estadoToldo\", \"Abriendo\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\") + \" \" + context.tiempoToldo});//toldo abierto\n\t\tbreak;\n\t\tcase 2:\n\t\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"abiertoOK\\\",\\\"payload\\\":0}\"}; node.send([msg, null, null]);\n\t\t\tif (global.get(\"estadoToldo\") == \"Abierto\")return;\n\t\t\tglobal.set(\"estadoToldo\", \"Abierto\");\t\t\n\t\t\tglobal.set(\"toldoManual\", 0);\n\t\t\tif (context.condicionEstadoToldo === 0)global.set(\"estadoToldoLCD\", \"Toldo Abierto de forma manual (Blynk)\" + global.get(\"hsCpu\"));\n\t\t\tif (context.condicionEstadoToldo === 1)global.set(\"estadoToldoLCD\", \"Toldo Abierto por temp (\" + global.get(\"hsCpu\") + \", temp: \" + global.get(\"tempPatioLuz\") + \")\");\n\t\t\tif (context.condicionEstadoToldo === 2)global.set(\"estadoToldoLCD\", \"Toldo Abierto por Oscurecer(\"  + global.get(\"hsCpu\") + \")\");\n\t\t\tif (context.condicionEstadoToldo === 3)global.set(\"estadoToldoLCD\", \"Toldo Abierto por Amanecer(\"  + global.get(\"hsCpu\") + \")\");\n\t\t\tvar moviendo = Math.abs(tiempoMover - global.get(\"tiempoMoviendo\"));\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + global.get(\"estadoToldoLCD\") + \"\\\",\" + moviendo + \",\" + global.get(\"tempPatioLuz\") + \")\"};\n\t\t\tnode.send([null, null, msg]);\t\n\t\t\tmsg = {pin: 3, payload: 1, color: \"#23C48E\", label: \"Toldo Abierto\", onlabel: \"Cerrar\"}; node.send([null, msg, null]);\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: \"Toldo Abierto\"}; node.send([msg, null, null]);\n\t\t\tcontext.estadoToldo = 2;\n\t\t\tcontext.estAnt = 1;\n\t\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; node.send([msg, null, null]);\n\t\t\treturn;\n\t\tcase 3:\n\t\t\t// if (global.get(\"estadoToldo\") === \"Cerrado\") return;\t\t\n\t\t\tcontext.CerrarToldoAuto = 1;\t\n\t\t\tcontext.error = 0;\n\t\t\tif (global.get(\"estadoToldo\") === \"Abierto\" || global.get(\"estadoToldo\") === \"Error Toldo abriendo\" || global.get(\"estadoToldo\") === \"Error Toldo cerrando\")global.set(\"tiempoMoviendo\", 0);\n\t\t\tmsg = {payload: 1, color: \"#ffbc26\", label: \"Tol. Cerrando\", onlabel: \"Parar\", pin: 3}; node.send([null, msg, null]);\n\t\t\tcontext.estadoToldo = 3;\n\t\t\tcontext.estAnt = 0;\n\t\t\tglobal.set(\"estadoToldo\", \"Cerrando\");\n\t\t\tnode.status({text: global.get(\"estadoToldo\") + \" \" + context.tiempoToldo});\n\t\tbreak;\n\t\tcase 4://Cerrando toldo por temperatura (24<\n\t\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"cerradoOK\\\",\\\"payload\\\":0}\"}; node.send([msg, null, null]);\n\t\t\tif (global.get(\"estadoToldo\") == \"Cerrado\")return;\n\t\t\tglobal.set(\"estadoToldo\", \"Cerrado\");\n\t\t\tglobal.set(\"toldoManual\", 0);\n\t\t\tif (context.condicionEstadoToldo === 0)global.set(\"estadoToldoLCD\", \"Toldo Cerrado de forma manual (Blynk \" + global.get(\"hsCpu\") + \")\");\n\t\t\tif (context.condicionEstadoToldo === 1)global.set(\"estadoToldoLCD\", \"Toldo Cerrado por oscurcer en invierno (\" + global.get(\"hsCpu\") + \", temp: \" + global.get(\"tempPatioLuz\") + \")\");\n\t\t\tif (context.condicionEstadoToldo === 2)global.set(\"estadoToldoLCD\", \"Toldo Cerrado por temp. (\" + global.get(\"hsCpu\") + \", temp: \" + global.get(\"tempPatioLuz\") + \")\");\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + global.get(\"estadoToldoLCD\") + \"\\\",\" + global.get(\"tiempoMoviendo\") + \",\" + global.get(\"tempPatioLuz\") + \")\"};\n\t\t\tnode.send([null, null, msg]);\n\t\t\tmsg = {pin: 3, payload: 0, color: \"#23C48E\", label: \"Toldo Cerrado\", offlabel: \"Abrir\"}; node.send([null, msg, null]);\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: \"Toldo Cerrado\"}; node.send([msg, null, null]);\t\n\t\t\tcontext.estadoToldo = 4;\t\t\n\t\t\tcontext.estAnt = 0;\n\t\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; node.send([msg, null, null]);\n\t\t\treturn;}\n\tmsg = {topic: \"Blynk/actualizar/toldo\", payload: 1}; node.send([msg, null, null]);}\n\n\t//\"Toldo Cerrado (9:11:13)9:11:12)por temperatura (24<14.0<15)\"\n\n\tif (context.ssAnterior !== ss){\n\t\tcontext.ssAnterior = ss;\n\t\tif (global.get(\"estadoToldo\") === \"Cerrando\" || global.get(\"estadoToldo\") === \"Abriendo\"){\n\t\tvar porcentaje;\n\t\tif (global.get(\"estadoToldo\") === \"Abriendo\"){\n\t\t\tmsg = {pin: 4, payload: \" Abriendo Toldo \"};\n\t\t\ttiempoMoviendo = global.get(\"tiempoMoviendo\") - 1; \n\t\t\tglobal.set(\"tiempoMoviendo\", tiempoMoviendo);}\n\n\t\tif (global.get(\"estadoToldo\") === \"Cerrando\"){\n\t\t\tmsg = {pin: 4, payload: \" Cerrando Toldo \"};\n\t\t\ttiempoMoviendo = global.get(\"tiempoMoviendo\") + 1; \n\t\t\tglobal.set(\"tiempoMoviendo\", tiempoMoviendo);}\n\t\tnode.send([null, msg, null]);\n\n\t\tporcentaje = Math.abs(((parseFloat((tiempoMoviendo * 100)/tiempoMover))).toFixed(1));\n\t\tif (global.get(\"estadoToldo\") === \"Cerrando\")porcentaje = (Math.abs(100 - porcentaje)).toFixed(1);\n\t\tif (porcentaje < 10)porcentaje = \"  \" + porcentaje;\n\t\tif (porcentaje < 100 && porcentaje >= 10)porcentaje = \" \" + porcentaje;\t\n\n\t\tmsg = {pin: 5, payload: \" Avance= \" + porcentaje + \"% \"};// Avance= 100.1%\n\t\tnode.send([null, msg, null]); \n\t\tnode.status({text: tiempoMoviendo + \"  Avance: \" + porcentaje+ \"%\"});\n\t\t}}\n\n\tif (global.get(\"estadoToldo\") === \"Abriendo\" && global.get(\"toldoManual\") === 0){\n\t\tif(Math.abs(global.get(\"tiempoMoviendo\")) > tiempoMover * 1.2){\n\t\t\tcontext.estadoToldo = 0;\n\t\t\tcontext.error = 1;\n\t\t\tglobal.set(\"estadoToldo\", \"Error Toldo abriendo\");\n\t\t\tglobal.set(\"estadoToldoLCD\", \"Error al abrir toldo\");\n\t\t\tvar moviendo = Math.abs(tiempoMover - global.get(\"tiempoMoviendo\"))/2;\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + global.get(\"estadoToldoLCD\") + \"\\\",\" + moviendo + \",\" + global.get(\"tempPatioLuz\") + \")\"};\n\t\t\tnode.send([null, null, msg]);\t\t\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: global.get(\"estadoToldoLCD\")}; node.send([msg, null, null]);\n\t\t\tmsg = {payload: 1, color: \"#D3435C\", onlabel: \"Error\", pin: 3}; node.send([null, msg, null]);\n\t\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\"};node.send([msg, null, null]);\n\t\t\treturn;\t\n\t\t}//error al abrir//error al abrir\n\t}\n\tif (global.get(\"estadoToldo\") === \"Cerrando\" && global.get(\"toldoManual\") === 0){\n\t\tif(Math.abs(global.get(\"tiempoMoviendo\")) > tiempoMover * 1.2){\n\t\t\tcontext.estadoToldo = 0;\n\t\t\tcontext.error = 1;\n\t\t\tglobal.set(\"estadoToldo\", \"Error Toldo cerrando\");\n\t\t\tglobal.set(\"estadoToldoLCD\", \"Error al cerrar toldo\");\n\t\t\tvar moviendo = Math.abs(global.get(\"tiempoMoviendo\"));\n\t\t\tmsg = {topic: \"INSERT INTO \\`toldo\\`(\\`fecha\\`, \\`estado\\`, \\`tiempoMov\\`, \\`tempPatioLuz\\`) VALUES (now(),\\\"\" + global.get(\"estadoToldoLCD\") + \"\\\",\" + moviendo + \",\" + global.get(\"tempPatioLuz\") + \")\"};\n\t\t\tnode.send([null, null, msg]);\t\t\n\t\t\tmsg = {topic: \"notifyBlynk\", payload: global.get(\"estadoToldoLCD\")}; node.send([msg, null, null]);\n\t\t\tmsg = {payload: 1, color: \"#D3435C\", onlabel: \"Error\", pin: 3}; node.send([null, msg, null]);\n\t\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":0}\"};node.send([msg, null, null]);\n\t\t\treturn;\t\n\t\t}//error al cerrar\n\t}\n\n\n","outputs":3,"noerr":0,"x":1816.2620086669922,"y":224.25000735691617,"wires":[[],[],[]]},{"id":"41ab1fab.3b2fb","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"mandarMail","payload":"1","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":262.2619285583496,"y":205.16664954594205,"wires":[["f1697d45.0cc3b"]]},{"id":"1d79b378.01fa4d","type":"blynk-ws-out-write","z":"50119c6e.6ff584","name":"","pin":"10","pinmode":0,"client":"2c18e412.5f5cbc","x":792.1426162719727,"y":185.23814569200795,"wires":[]},{"id":"dcb0f7e3.c95e08","type":"blynk-ws-in-write","z":"a89e305a.c50bb","name":"","pin":"61","pin_all":false,"client":"2c18e412.5f5cbc","x":290.00001525878906,"y":1150.7499647140503,"wires":[["ada34632.0efde8","7afba1dc.2c28","7140c1c9.bedec"]]},{"id":"237f4d2a.446662","type":"mysql","z":"3ce5b54a.127d6a","mydb":"","name":"","x":2051.5002975463867,"y":278.1190278189523,"wires":[["d21e848f.240af8"]]},{"id":"9f161dbe.8b3fe","type":"mqtt out","z":"7ac92c99.66ea94","name":"","topic":"ESP/living/Iluminacion/beep","qos":"","retain":"","broker":"43555c62.30ed34","x":941.0475816726685,"y":499.8572053909302,"wires":[]},{"id":"813dc6d4.867e68","type":"file in","z":"a89e305a.c50bb","name":"lectura archivo","filename":"/home/gaston/BackUp-Node-Red/estLiving.txt","format":"utf8","chunk":false,"sendError":false,"x":523.7500076293945,"y":1000.7500152587891,"wires":[["32d19317.d310ec"]]},{"id":"3512364.5d54eca","type":"delay","z":"e364a467.07a6a8","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":292.6944007873535,"y":467.4285914301872,"wires":[["4603fbcf.274954"]]},{"id":"5668c207.79ddec","type":"debug","z":"50119c6e.6ff584","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":473.8094774881997,"y":63.80952612559008,"wires":[]},{"id":"3e7b6ed.a686492","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg= {topic: \"IluminacionLiving\", payload: global.get(\"tipoFallaIlLiving\")}; \nreturn msg\n","outputs":1,"noerr":0,"x":3344.523635864258,"y":945.4286022186279,"wires":[["64665ba0.e14754"]]},{"id":"b8f71abc.973838","type":"function","z":"7ac92c99.66ea94","name":"Cambiar color (Nuevo)","func":"var payload = msg.payload;\n\n// if (global.get(\"estIslaRGB\") === 0)return;\nif (payload.includes(\"living\") && payload.includes(\"color\")){\n\tglobal.set(\"estIslaRGB\", 1);\n\n\tif ((payload.includes(\"azul\") && payload.includes(\"muy\") && payload.includes(\"oscuro\")) || payload.includes(\"1\")){\n\t\tglobal.set(\"IslaR\",  0); global.set(\"IslaG\", 0);\tglobal.set(\"IslaB\", 102);\n\t\tmsg.payload = \"1\"; node.send([null, msg]);\n\t}\n\tif ((payload.includes(\"azul\") && payload.includes(\"oscuro\")) || payload.includes(\"2\")){\n\t\tglobal.set(\"IslaR\", 0);\tglobal.set(\"IslaG\", 0);\tglobal.set(\"IslaB\", 150);\n\t\tmsg.payload = \"2\"; node.send([null, msg]);\n\t}\n\tif (payload.includes(\"azul\")  || payload.includes(\"3\")){\n\t\tglobal.set(\"IslaR\", 0);\tglobal.set(\"IslaG\", 0);\tglobal.set(\"IslaB\", 255);\n\t\tmsg.payload = \"3\"; node.send([null, msg]);\n\t}\n\tif (payload.includes(\"rojo\")  || payload.includes(\"4\")){\n\t\tglobal.set(\"IslaR\", 255); global.set(\"IslaG\", 0); global.set(\"IslaB\", 0);\n\t\tmsg.payload = \"4\"; node.send([null, msg]);\n\t}\n\tif (payload.includes(\"verde\")  || payload.includes(\"5\")){\n\t\tglobal.set(\"IslaR\", 0);\tglobal.set(\"IslaG\", 255); global.set(\"IslaB\", 0);\n\t\tmsg.payload = \"5\"; node.send([null, msg]);\n\t}\n\tif (payload.includes(\"blanco\") || payload.includes(\"6\")){\n\t\tglobal.set(\"IslaR\", 255); global.set(\"IslaG\", 255);\tglobal.set(\"IslaB\", 255);\n\t\tmsg.payload = \"6\"; node.send([null, msg]);\n\t}\n\tif (payload.includes(\"amarillo\")  || payload.includes(\"7\")){\n\t\tglobal.set(\"IslaR\", 255); global.set(\"IslaG\", 255);\tglobal.set(\"IslaB\", 0);\n\t\tmsg.payload = \"7\"; node.send([null, msg]);\n\t}\n\tif (payload.includes(\"lila\") || payload.includes(\"8\")){\n\t\tglobal.set(\"IslaR\", 153); global.set(\"IslaG\", 0);\tglobal.set(\"IslaB\", 204);\n\t\tmsg.payload = \"8\"; node.send([null, msg]);\n\t}\n\tif (payload.includes(\"gris\") || payload.includes(\"9\")){\n\t\tglobal.set(\"IslaR\", 90); global.set(\"IslaG\", 90);\tglobal.set(\"IslaB\", 90);\n\t\tmsg.payload = \"9\"; node.send([null, msg]);\n\t}\t\n\tif ((payload.includes(\"gris\") && payload.includes(\"claro\")) || payload.includes(\"10\")){\n\t\tglobal.set(\"IslaR\", 50); global.set(\"IslaG\", 50);\tglobal.set(\"IslaB\", 50);\n\t\tmsg.payload = \"10\"; node.send([null, msg]);\n\t}\n\tif ((payload.includes(\"gris\") && payload.includes(\"oscuro\")) || payload.includes(\"11\")){\n\t\tglobal.set(\"IslaR\", 15); global.set(\"IslaG\", 15);\tglobal.set(\"IslaB\", 15);\n\t\tmsg.payload = \"11\"; node.send([null, msg]);\n\t}\n\tmsg = {topic: \"google/Living\", payload: \"blanco\"}; return msg;\t\t\n}","outputs":2,"noerr":0,"x":525.8096628189087,"y":469.85718393325806,"wires":[["651c6da5.a31dd4","5ad8f742.dc85e8","b2dcf0c4.a8898"],[]]},{"id":"7e2dc0ad.e7129","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg = {topic: \"tempAmbiente\", payload: global.get(\"tempAmbienteBat\")}; node.send(msg);","outputs":1,"noerr":0,"x":2545.023780822754,"y":1178.3095280783518,"wires":[["8794c1f0.2f8c1"]]},{"id":"f44ca450.93b578","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"{\"topic\":\"most\",\"payload\":\"0\"}","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":350.55555725097656,"y":966.22216796875,"wires":[[]]},{"id":"8a747565.3d6dd8","type":"function","z":"a89e305a.c50bb","name":"Alarma","func":"global.set(\"estadoAlarma\", msg.payload);\nnode.status({text: global.get(\"estadoAlarma\")})","outputs":1,"noerr":0,"x":1363.8094177246094,"y":664.1428093910217,"wires":[[]]},{"id":"66a0838f.15ccac","type":"debug","z":"e364a467.07a6a8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":406.2221927642822,"y":594.6666412353516,"wires":[]},{"id":"92181c24.986ae","type":"blynk-ws-in-write","z":"e364a467.07a6a8","name":"","pin":"52","pin_all":0,"client":"2c18e412.5f5cbc","x":244.27776336669922,"y":220.49999809265137,"wires":[["e9640668.b315e8"]]},{"id":"5d564dc5.6720d4","type":"blynk-ws-in-write","z":"3ce5b54a.127d6a","name":"","pin":"9","client":"2c18e412.5f5cbc","x":1671.4523162841797,"y":500.83327075413297,"wires":[["7dcbb7b3.a73cc8"]]},{"id":"7dcbb7b3.a73cc8","type":"function","z":"3ce5b54a.127d6a","name":"rele rociador","func":"msg.payload = \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\":\" + msg.payload + \"}\";\nnode.send(msg);\n","outputs":1,"noerr":0,"x":1876.440773010254,"y":513.2617699759347,"wires":[["2787a2b2.3f5d5e","85c6236d.47efd"]]},{"id":"95ff630c.c1ed8","type":"ui_gauge","z":"3ce5b54a.127d6a","name":"","group":"ff2252ef.d12aa","order":6,"width":"2","height":"2","gtype":"gage","title":"Temp Bat2","label":"units","format":"{{value}}","min":"0","max":"50","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":2750,"y":970,"wires":[]},{"id":"4a3045c9.61c37c","type":"function","z":"50119c6e.6ff584","name":"rele rociador","func":"if (msg.payload == 1){\n    msg = {topic: \"ESP/Living/Sens/Temp/Pedido\",payload: 1};\n    return msg}\n","outputs":1,"noerr":0,"x":306.42847633361816,"y":187.1428623199463,"wires":[["a1ef6409.4b2178"]]},{"id":"c6b4ec2a.3659c","type":"blynk-ws-out-write","z":"3ce5b54a.127d6a","name":"","pin":0,"pinmode":"1","client":"2c18e412.5f5cbc","x":1811.8810844421387,"y":1203.0830454826355,"wires":[]},{"id":"4cd7e210.9d6efc","type":"delay","z":"a89e305a.c50bb","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":551.9047495524087,"y":96.99999046325684,"wires":[["4a3e8292.4d0e8c"]]},{"id":"7d2e1271.afd57c","type":"blynk-ws-out-write","z":"3ce5b54a.127d6a","name":"","pin":0,"pinmode":"1","client":"2c18e412.5f5cbc","x":3149.7374954223633,"y":680.8214833395822,"wires":[]},{"id":"4a46a6ec.1d9e38","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"{\"topic\":\"Crep\",\"payload\":\"1\"}","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":55.00000508626317,"y":424,"wires":[["9641fbd0.64c858"]]},{"id":"bc158034.05b6","type":"ui_text","z":"3ce5b54a.127d6a","group":"ff2252ef.d12aa","order":13,"width":0,"height":0,"name":"","label":"info arduino","format":"{{msg.payload}}","layout":"row-spread","x":288.6906204223633,"y":607.0000207083566,"wires":[]},{"id":"483d3434.43ff8c","type":"function","z":"3ce5b54a.127d6a","name":"Alarma","func":"var dato = JSON.parse(msg.payload);\npayload = parseInt(dato.payload);\n\n\nif (msg.topic === \"google/Alarma\" || msg.topic === \"alarmaBlynk\"){\n\tmsg = {topic: \"USBout\", payload:\"{\\\"topic\\\":\\\"Alarma\\\",\\\"payload\\\":\" + msg.payload + \"}\"};\n\tnode.send([null, msg]);\n}\n\n// if (msg.topic === \"google/Alarma\" || msg.topic === \"alarmaBlynk\"){\n// \tif (parseInt(msg.payload) === 1 && global.get(\"estadoAlarma\") === 0){msg = {topic: \"USBout\", payload:\"{\\\"topic\\\":\\\"Alarma\\\",\\\"payload\\\": 1}\"}; return([null, msg]);}\n// \tif (parseInt(msg.payload) === 0 && global.get(\"estadoAlarma\") === 1){msg = {topic: \"USBout\", payload:\"{\\\"topic\\\":\\\"Alarma\\\",\\\"payload\\\": 0}\"}; return([null, msg]);}\n\t\n// }\n\nif (dato.topic === \"Alarma/Activacion\"){\n\tglobal.set(\"estadoAlarma\", payload); \n\tmsg = {topic: \"aviso/Alarma\", payload: 1}; node.send([null, msg]);\n\tif (global.get(\"estadoAlarma\") === 1){\n\t    msg = {payload: 1, color: \"#f5d86b\", pin: 1}; node.send([msg, null]);\t    \n\t    // msg = {payload: 140, color: \"#f5d86b\", pin: 0}; node.send([null, null, msg, null, null, null]);\n\t\t}\n    if (global.get(\"estadoAlarma\") === 0){\n\t    msg = {payload: 0, color: \"#23C48E\", pin: 1}; node.send([msg, null]);\n\t    // msg = {payload: 128, color: \"#23C48E\", pin: 0}; node.send([null, null, msg,null, null, null]);\n\t    }\n}\n\nif (dato.topic === \"Alarma/Disparo\"){\n\tif (payload === 1){\n\t\tmsg = {payload: 1, color: \"#cc0000\", pin: 1}; node.send([msg, null]);\n\t\tglobal.set(\"disparoAlarma\", 1);\n\t\tmsg = {topic: \"notifyBlynk\", payload: \"Se disparo Alarma en casa\"};\n\n\t}\n\tif (payload === 0){\n\t\tglobal.set(\"disparoAlarma\", 0);\n\t\tmsg = {payload: 0, color: \"#23C48E\", pin: 1}; node.send([msg, null]);\t\t\n\t\t// msg = {payload: 0, pin: 10}; node.send([null, null, msg, null, null, null]);\n\t\tmsg = {topic: \"notifyBlynk\", payload: \"Se normalizo Alarma en casa\"};\n\t}\n\tnode.send([null, msg]);\n}","outputs":2,"noerr":0,"x":2787.951156616211,"y":697.7857501166208,"wires":[["7b8f8d35.3a0bc4","312bb425.81a66c","6d819ac.55df264"],["a9ae9e1e.01ed5","b251bc31.c6c1a"]]},{"id":"cd0a799.4e81988","type":"debug","z":"e6e33852.2495f8","name":"Fibertel","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":772.9999618530273,"y":533.4444236755371,"wires":[]},{"id":"610597ee.3b4568","type":"function","z":"a89e305a.c50bb","name":"","func":"msg.filename = \"/home/gaston/BackUp-Node-Red/estLiving.txt\";\nreturn msg;\n","outputs":1,"noerr":0,"x":438.7500114440918,"y":959.5000143051147,"wires":[["8cb8672f.9c0e68"]]},{"id":"52340124.9497","type":"debug","z":"a89e305a.c50bb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"topic","x":679.5237846374512,"y":749.4999413490295,"wires":[]},{"id":"785d7d1d.673d94","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"google/Alarma","qos":"2","broker":"c339edbf.39572","x":2529.6666717529297,"y":573,"wires":[["483d3434.43ff8c"]]},{"id":"9711e57b.764b18","type":"mqtt out","z":"a89e305a.c50bb","name":"","topic":"aviso/Alarma","qos":"","retain":"","broker":"6b36e4a.1d30b1c","x":1025.000015258789,"y":457.0000057220459,"wires":[]},{"id":"4dc0dae4.50ccb4","type":"delay","z":"a89e305a.c50bb","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":763.0952224731445,"y":345.2142400741577,"wires":[["a3832c3f.01897"]]},{"id":"893a6b3c.fdb088","type":"function","z":"3ce5b54a.127d6a","name":"","func":"if (global.get(\"estadoAlarma\") === 1)msg = {topic: \"alarmaBlynk\", payload: 0};\nif (global.get(\"estadoAlarma\") === 0)msg = {topic: \"alarmaBlynk\", payload: 1};\n// msg = {topic: \"alarmaBlynk\", payload: msg.payload};\n\nreturn msg;","outputs":1,"noerr":0,"x":2561.714286804199,"y":648.9999952316284,"wires":[["483d3434.43ff8c","b5b11857.bbf368","9b7ebb17.3f3c98"]]},{"id":"28a7bb8d.a92714","type":"function","z":"a89e305a.c50bb","name":"estIsla","func":"msg = {topic: \"Blink/estIsla\", payload: msg.payload};\nreturn msg;","outputs":1,"noerr":0,"x":379.04762268066406,"y":247.63490104675293,"wires":[["cce091cd.a69e5","4f93da66.796464"]]},{"id":"3fbe64dd.c7a68c","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"comprobarConexionPasillo","qos":"2","broker":"c339edbf.39572","x":3001.666488647461,"y":902.571455001831,"wires":[["ea934310.46852"]]},{"id":"adf6e177.8c0c4","type":"debug","z":"a89e305a.c50bb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":510.00000381469727,"y":1248.250018119812,"wires":[]},{"id":"be4bba1b.4d9d28","type":"mqtt out","z":"e364a467.07a6a8","name":"","topic":"","qos":"","retain":"","broker":"637ff0bd.3c84b","x":754.1943969726562,"y":471.6785936355591,"wires":[]},{"id":"d6fb78fe.613a98","type":"inject","z":"e364a467.07a6a8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":115.05157852172852,"y":601.3333368301392,"wires":[["57099265.b5d4fc"]]},{"id":"ddd8882e.f587d8","type":"debug","z":"7ac92c99.66ea94","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":670.511830329895,"y":366.64282608032227,"wires":[]},{"id":"3773d6a9.9717ca","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"2","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1404.3216400146484,"y":782.6070652008057,"wires":[["c8be9ca.b68de6"]]},{"id":"1c00a8ed.d8b847","type":"debug","z":"3ce5b54a.127d6a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":285.5952339172363,"y":508.2857014792306,"wires":[]},{"id":"e4201820.2ea728","type":"function","z":"a89e305a.c50bb","name":"","func":"context.isla = context.isla || 0;\ncontext.cielorrazo = context.cielorrazo || 0;\ncontext.rgb = context.rgb || 0;\ncontext.antIsla = context.antIsla || 0;\ncontext.antCielorrazo = context.antCielorrazo || 0;\ncontext.antRgb = context.antRgb || 0;\n\nif (msg.topic == \"Reset\"){\n\tcontext.antCielorrazo = 0;\n\tcontext.antIsla = 0;\n\tcontext.antRgb = 0;\n\treturn;\n}\n\nif (msg.topic != \"Blynk\"){\n\tdato = msg.payload.split(\"#\");\n\tvar isla = dato[0];\n\tvar cielorrazo = dato[1];\n\tvar rgb = dato[2];\n\n\tif (isla != context.antIsla){context.antIsla = isla; context.isla++; global.set(\"cambiosIsla\", context.isla);}\n\n\tif (cielorrazo != context.antCielorrazo){context.antCielorrazo = cielorrazo; context.cielorrazo++; global.set(\"cambiosCielorrazo\", context.cielorrazo);}\n\n\tif (rgb != context.antRgb){context.antRgb = rgb; context.rgb++;global.set(\"cambiosRGB\", context.rgb);}\n}\n\n// msg = {topic: \"notifyBlynk\", payload: \"Cambio estado de Pulsadores de iluminacion living: \\n Isla: \" + context.isla + \"\\n Cielorrazo: \" + context.cielorrazo + \"\\n RGB: \" + context.rgb};\n// return msg;","outputs":1,"noerr":0,"x":544.1666259765625,"y":618.3928833007812,"wires":[["2b2d90d9.6b9ae","530c2928.537068"]]},{"id":"bcac061b.f97bd8","type":"blynk-ws-out-notify","z":"3ce5b54a.127d6a","name":"","client":"2c18e412.5f5cbc","queue":false,"rate":1,"x":2239.309440612793,"y":362.9999901907785,"wires":[]},{"id":"bf15eec9.f42a","type":"mqtt out","z":"3ce5b54a.127d6a","name":"","topic":"","qos":"","retain":"","broker":"c339edbf.39572","x":1877.202465057373,"y":1052.5714263916016,"wires":[]},{"id":"205dbd65.81add2","type":"inject","z":"3ce5b54a.127d6a","name":"Borrar todo","topic":"DELETE FROM `toldo` WHERE 1","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1857.214527130127,"y":330.0238406317575,"wires":[["237f4d2a.446662"]]},{"id":"7a97404c.8809e","type":"blynk-ws-in-write","z":"e364a467.07a6a8","name":"","pin":"57","pin_all":0,"client":"2c18e412.5f5cbc","x":244.27777862548828,"y":54.25,"wires":[["435e80ad.e17c8"]]},{"id":"37d15e3c.0a1382","type":"debug","z":"3ce5b54a.127d6a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1759.1430206298828,"y":747.6072113854544,"wires":[]},{"id":"57099265.b5d4fc","type":"http request","z":"e364a467.07a6a8","name":"","method":"GET","ret":"txt","url":"https://ebankpersonas.bancopatagonia.com.ar/eBanking/usuarios/cotizacionMonedaExtranjera.htm","tls":"","x":193.44442749023438,"y":540.0832986831665,"wires":[["290cd25a.fc6afe","66a0838f.15ccac"]]},{"id":"ae3ecdc3.32e0a","type":"inject","z":"a89e305a.c50bb","name":"consulta","topic":"SELECT * FROM `ilLiving` WHERE 1","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":412.9167060852051,"y":841.4642276763916,"wires":[["29b79419.61cf0c"]]},{"id":"e17205ac.325498","type":"debug","z":"a89e305a.c50bb","name":"iluminacionLiving - ESP/iluminacion/envio","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":651,"y":539,"wires":[]},{"id":"829179ac.7a1158","type":"comment","z":"50119c6e.6ff584","name":"Blynk privado","info":"wss://192.168.6.40:9443/websockets\n5e076af9bf8d46abb21c1e29066899b7","x":749.9999536786759,"y":52.85714517320912,"wires":[]},{"id":"169a443b.7a749c","type":"blynk-ws-out-write","z":"e364a467.07a6a8","name":"","pin":"55","pinmode":"1","client":"2c18e412.5f5cbc","x":798.2777633666992,"y":575.4999980926514,"wires":[]},{"id":"d16ed06d.66af","type":"thingspeak42","z":"3ce5b54a.127d6a","name":"YJCFSNIEZMNH6U0G","delay":"15","topic1":"voltajeBat","topic2":"corrienteCarga","topic3":"cargador","topic4":"tiempoCargando","topic5":"tiempoEspera","topic6":"nivTanque","topic7":"tempAmb","topic8":"tempBat1","endpoint":"https://thingspeak.com","x":1051.118863242013,"y":778.738067626953,"wires":[]},{"id":"48a3829c.87478c","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"[]","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":2531.130844116211,"y":771.1428572790963,"wires":[["13adbc11.4ab694"]]},{"id":"a912aad4.45fd28","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg = {topic: \"tempBat4\", payload: global.get(\"tempBat4\")}; node.send(msg);\n","outputs":1,"noerr":0,"x":2542.166603088379,"y":1054.0237919943675,"wires":[["6dca668e.bbafc8"]]},{"id":"9db1d0a2.a6978","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":2322.2141761779785,"y":1324.9761947904317,"wires":[["6b8f267f.3678e8"]]},{"id":"88336c7c.fb758","type":"inject","z":"e6e33852.2495f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":133,"y":582.3333549499512,"wires":[["a5dff34f.89fa6","41de7b73.054844"]]},{"id":"702341e5.2cb2e","type":"function","z":"50119c6e.6ff584","name":"","func":"node.status({text: \"niv: \" + global.get(\"nivTanque\") + \" -- \" + \"volt: \" + global.get(\"voltajeBaterias\") + \" -- \" + global.get(\"hsCpu\")});\nmsg = {pin: 26, payload: global.get(\"nivTanque\")}; node.send(msg);\nmsg = {pin: 27, payload: parseFloat(global.get(\"voltajeBaterias\"))}; node.send(msg);\nreturn \n\n","outputs":1,"noerr":0,"x":513.1745529174805,"y":651.7460603713989,"wires":[["355077e0.49f888"]]},{"id":"ea934310.46852","type":"delay","z":"3ce5b54a.127d6a","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":3210.238105773926,"y":902.5714530944824,"wires":[["a5a5e9c9.c35e08"]]},{"id":"d1094e09.0048f","type":"file","z":"e6e33852.2495f8","name":"","filename":"/home/gaston/BackUp-Node-Red/Fibertel.txt","appendNewline":true,"createDir":true,"overwriteFile":"false","x":758.5555038452148,"y":354.55553817749023,"wires":[[]]},{"id":"e20d3556.e3bf28","type":"debug","z":"a89e305a.c50bb","name":"iluminacionLiving - aviso/iluminacion","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":657.8095092773438,"y":172.8571319580078,"wires":[]},{"id":"8e7565eb.e1bfd8","type":"inject","z":"a89e305a.c50bb","name":"delay Buzzador","topic":"","payload":"80","payloadType":"num","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":1196.6666946411133,"y":329.8571367263794,"wires":[["f0e53a96.e7e5b8"]]},{"id":"67684865.9d0948","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"USBin/Baterias","qos":"2","broker":"c339edbf.39572","x":580,"y":800,"wires":[["a594e6b.0d98718","bdbd6b84.b74708","207fc406.e8ac0c"]]},{"id":"4f93da66.796464","type":"debug","z":"a89e305a.c50bb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":568.7301445007324,"y":241.78570365905762,"wires":[]},{"id":"cb8f6d45.36121","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"USBin/Tanque","qos":"2","broker":"c339edbf.39572","x":2766.0480575561523,"y":285.70234966278076,"wires":[["1401f851.1605b8","e810dd56.3b733"]]},{"id":"cce091cd.a69e5","type":"function","z":"a89e305a.c50bb","name":"recibo2","func":" var timerLuces = 12000;\nif (global.get(\"estLiving\") === undefined)global.set(\"estLiving\", 0);\nif (global.get(\"estIsla\") === undefined)global.set(\"estIsla\", 0);\nif (global.get(\"estCielorrazo\") === undefined)global.set(\"estCielorrazo\", 0);\nif (global.get(\"potLiving\") === undefined)global.set(\"potLiving\", 0);\nif (global.get(\"estIslaRGB\") === undefined)global.set(\"estIslaRGB\", 0);\nif (global.get(\"potIsla\") === undefined)global.set(\"potIsla\", 255);\nif (global.get(\"potCielorrazo\") === undefined)global.set(\"potCielorrazo\", 128);\nif (global.get(\"IslaR\") === undefined)global.set(\"IslaR\", 255);\nif (global.get(\"IslaG\") === undefined)global.set(\"IslaG\", 255);\nif (global.get(\"IslaB\") === undefined)global.set(\"IslaB\", 255);\nif (global.get(\"dimmerLeds\") === undefined)global.set(\"dimmerLeds\", 200);\nif (global.get(\"minTeclas\") === undefined)global.set(\"minTeclas\", 15);\nif (global.get(\"maxTeclas\") === undefined)global.set(\"maxTeclas\", 600);\nif (global.get(\"doblePuls\") === undefined)global.set(\"doblePuls\", 1);\nif (global.get(\"fallasLivingIluminacion\") === undefined)global.set(\"fallasLivingIluminacion\", 0);\nif (global.get(\"pwmPatioLuz\") === undefined)global.set(\"pwmPatioLuz\", 33);\ncontext.item = context.item || 0;\n\nvar topic = msg.topic;\nvar payload = parseInt(msg.payload);\n// msg = {topic: \" \", payload: topic}; node.send(msg);\nvar dato;\nif (global.get(\"Dia\") === 1)global.set(\"dimmerLeds\", 200);\nif (global.get(\"Dia\") === 0)global.set(\"dimmerLeds\", 50);\n\nif (topic == \"Pedido/Living/Iluminacion\"){  \n    var fallasLivingIluminacion = global.get(\"fallasLivingIluminacion\") + 1;\n    global.set(\"fallasLivingIluminacion\", fallasLivingIluminacion);\n    global.set(\"tipoFallaIlLiving\", payload); msg = {topic: \"fallas_MQTT\", payload: 1}; node.send([msg, null]);\n    enviarMQTT();\n//  msg = {topic: \"minTeclas\", payload: global.get(\"minTeclas\")}; node.send(msg);\n//     msg = {topic: \"maxTeclas\", payload: global.get(\"maxTeclas\")}; node.send(msg);\n    return;\n}\n\nif (topic == \"aviso/Alarma\"){\n    if (global.get(\"estadoAlarma\") === 0 && global.get(\"Dia\") === 0){\n    msg = {topic: \"USBout\", payload: \"Noche\" + global.get(\"pwmPatioLuz\")}; node.send([msg, null]);\n    global.set(\"estLiving\", 1); \n    global.set(\"estIslaRGB\", 1);\n    enviarMQTT();\n    return;\n    }\n    if (global.get(\"estadoAlarma\") === 1 && global.get(\"estLiving\") === 1){setTimeout(apagadoLuces, timerLuces);}\n    if (global.get(\"estadoAlarma\") === 1 && global.get(\"Dia\") === 1){\n        msg = {topic: \"USBout\", payload: \"Dia\"}; node.send([msg, null]);\n        apagadoLuces();}\n    }\n\n\nif (topic == \"aviso/Iluminacion\"){\n    if (global.get(\"Dia\") === 1) {msg = {topic: \"USBout\", payload: \"Dia\"}; node.send([msg, null]);}\n    if (global.get(\"Dia\") === 0) {msg = {topic: \"USBout\", payload: \"Noche\" + global.get(\"pwmPatioLuz\")}; node.send([msg, null]);}\n}\n\n\nif (topic == \"google/Living\") {enviarMQTT(); return;}\n\nif (topic == \"ESP/living/Iluminacion/Envio\" && !topic.includes(\"Recibo de ESP\")){\n    dato = payload.split(\"#\");\n    global.set(\"estIsla\", dato[0]); \n    global.set(\"estCielorrazo\", dato[1]); \n    global.set(\"estIslaRGB\", dato[2]); \n    enviarMQTT();\n    return;\n}\n\nif (topic == \"Blink/potItem\"){\n    context.item = parseInt(msg.payload);\n    switch(parseInt(msg.payload)){\n        case 1:\n            msg = {pin: 19, min: 4, max: 255, label: \"Living\", payload: global.get(\"potLiving\")};\n        break;\n        case 2:\n            msg = {pin: 19, min: 4, max: 255, label: \"Isla\", payload: global.get(\"potIsla\")};\n        break;\n        case 3:\n            msg = {pin: 19, min: 4, max: 255, label: \"Cielorrazo\", payload: global.get(\"potCielorrazo\")};\n        break;\n        case 4:\n            msg = {pin: 19, min: 1, max: 100, label: \"Patio Luz\", payload: global.get(\"pwmPatioLuz\")};\n        break;\n    }\n    node.send([null, msg]);\n}\n\nif (topic == \"Blink/potencia\"){\n    var valor = parseInt(msg.payload);\n    switch(context.item){\n        case 1:\n            if (global.get(\"estLiving\") === 0)return;\n            global.set(\"potLiving\", valor);\n            global.set(\"potIsla\", valor);\n            global.set(\"potCielorrazo\", valor);\n        break;\n        case 2:\n            if (global.get(\"estIsla\") === 0)return;\n            global.set(\"potIsla\", valor);\n        break;\n        case 3:\n            if (global.get(\"estCielorrazo\") === 0)return;\n            global.set(\"potCielorrazo\", valor);\n        break;\n        case 4:\n            if (global.get(\"Dia\") === 1)return;\n            global.set(\"pwmPatioLuz\", valor);\n            msg = {topic: \"USBout\", payload: \"Noche\" + global.get(\"pwmPatioLuz\")}; node.send([msg, null]); return;\n    }\n    enviarMQTT();\n}\n\nif (topic == \"Blink/estLiving\"){\n    global.set(\"estLiving\", payload);  \n    global.set(\"estIslaRGB\", payload);\n    // global.set(\"estIsla\", parseInt(msg.payload)); \n    // global.set(\"estCielorrazo\", parseInt(msg.payload));\n\n    // if (msg.payload === 1) global.set(\"estIslaRGB\", 1);\n    // global.set(\"estIslaRGB\", parseInt(msg.payload));\n    // if (msg.payload === 0) global.set(\"estIslaRGB\", parseInt(msg.payload));\n    enviarMQTT();}\n\nif (topic == \"Blink/estIsla\"){\n    // global.set(\"estIslaRGB\", payload);\n    global.set(\"estIsla\", payload);\n    enviarMQTT();}\n\nif (topic == \"Blink/estCielorrazo\"){\n    // global.set(\"estIslaRGB\", payload);\n    global.set(\"estCielorrazo\", payload); \n    enviarMQTT();}\n\nif (topic == \"Blink/estRGB\"){global.set(\"estIslaRGB\", payload); enviarMQTT();}\n\nif (topic == \"Blink/colorRGB\"){\n    global.set(\"IslaR\", msg.arrayOfValues[0]);\n    global.set(\"IslaG\", msg.arrayOfValues[1]);\n    global.set(\"IslaB\", msg.arrayOfValues[2]);\n    msg = {pin: 32, payload: \"12\"}; node.send([null, msg]);\n    global.set(\"estIslaRGB\", 1);\n    enviarMQTT();\n}\n\nreturn;\n\nfunction apagadoLuces(){\n    // if (global.get(\"estadoAlarma\") === 1 || global.get(\"Dia\") === 1){\n    //  // global.set(\"estLiving\", 0); \n    //  // global.set(\"estIsla\", 0); \n    //  // global.set(\"estCielorrazo\", 0);\n    //  // global.set(\"estIslaRGB\", 0);\n    // }\n    msg = {topic: \"USBout\", payload: \"Dia\"}; node.send([msg, null]);\n    global.set(\"estLiving\", \"0\");\n    global.set(\"estIslaRGB\", \"0\");\n    msg.topic = \"apagadoAuto\";\n    enviarMQTT();\n}\n\nfunction enviarMQTT(){\n    var topicNuevo = msg.topic;\n    // if (global.get(\"estIsla\") === 0 && global.get(\"estCielorrazo\") === 0 && global.get(\"estIslaRGB\") === 0)global.set(\"estLiving\", 0);\n    if (global.get(\"estIsla\") === 1 || global.get(\"estCielorrazo\") === 1){\n        if(topic !== \"Blink/estLiving\" && msg.topic !== \"fallas_MQTT\")global.set(\"estLiving\", 1);\n        }\n    if (msg.topic == \"apagadoAuto\") global.set(\"estLiving\", 0); \n\n    if (msg.topic !== \"fallas_MQTT\"){\n    msg = {pin: 14, payload: global.get(\"estLiving\")}; node.send([null, msg]);\n    msg = {pin: 16, payload: global.get(\"estIsla\")}; node.send([null, msg]);\n    msg = {pin: 17, payload: global.get(\"estCielorrazo\")}; node.send([null, msg]);\n    msg = {pin: 29, payload: global.get(\"estIslaRGB\")}; node.send([null, msg]);}\n    if(topic == \"ESP/living/Iluminacion/Envio\")return;\n    \n    if (global.get(\"estLiving\") === 0) {\n            msg = {pin: 16, payload: \"0\"}; node.send([null, msg]);\n            dato = \"0,\"}\n        else{\n            dato = global.get(\"estIsla\") + \",\";}\n    dato += global.get(\"potIsla\") + \"#\";\n\n    if (global.get(\"estLiving\") === 0) {\n            msg = {pin: 17, payload: \"0\"}; node.send([null, msg]);\n            dato += \"0,\"}\n        else{\n            dato += global.get(\"estCielorrazo\") + \",\";}\n    dato += global.get(\"potCielorrazo\") + \"#\";  \n    dato += global.get(\"estIslaRGB\") + \",\";\n    dato += global.get(\"IslaR\") + \",\";\n    dato += global.get(\"IslaG\") + \",\";      \n    dato += global.get(\"IslaB\") + \"#\";\n    dato += global.get(\"dimmerLeds\") + \"#\";\n    dato += global.get(\"minTeclas\") + \"#\";\n    dato += global.get(\"maxTeclas\") + \"#\";\n    dato += global.get(\"doblePuls\");\n//  msg = {topic: \"ESP/living/Iluminacion/Recibo2\", payload: topicNuevo + \"&\" + global.get(\"estadoAlarma\") + \"&\" + global.get(\"Dia\") + \"\\n\" + dato};    node.send([msg, null]);\n    msg = {topic: \"ESP/living/Iluminacion/Recibo\", payload: dato};\n    node.send([msg, null]);     \n}","outputs":2,"noerr":0,"x":605.9524154663086,"y":303.78568840026855,"wires":[["9059c158.93b98","c2a0d286.2ba8f"],["4dc0dae4.50ccb4","d6c2fdea.31e4e","57650f5c.b4ca7"]]},{"id":"929f47d2.7de2f8","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"Blynk/actualizar/estado","qos":"2","broker":"c339edbf.39572","x":1342.6315383911133,"y":670.4880659920829,"wires":[["29c9ac88.41f9b4","37d15e3c.0a1382","389a6415.87bb6c"]]},{"id":"215c7fb5.b5bae","type":"inject","z":"a89e305a.c50bb","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":580.2380828857422,"y":416.99999046325684,"wires":[["d6c2fdea.31e4e"]]},{"id":"aab58d9c.e9111","type":"debug","z":"a89e305a.c50bb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":858.7500114440918,"y":1177.0000190734863,"wires":[]},{"id":"1583c20e.1315ee","type":"function","z":"3ce5b54a.127d6a","name":"","func":"if (global.get(\"estadoCargador\") === undefined || isNaN(global.get(\"estadoCargador\")))global.set(\"estadoCargador\", 0);\nif (global.get(\"fallasLiving\") === undefined || isNaN(global.get(\"fallasLiving\")))global.set(\"fallasLiving\", 0);\nif (global.get(\"fallasPasillo\") === undefined || isNaN(global.get(\"fallasPasillo\")))global.set(\"fallasPasillo\", 0);\nif (global.get(\"fallasLavadero\") === undefined || isNaN(global.get(\"fallasLavadero\")))global.set(\"fallasLavadero\", 0);\nif (global.get(\"fallasLivingIluminacion\") === undefined || isNaN(global.get(\"fallasLivingIluminacion\")))global.set(\"fallasLivingIluminacion\", 0);\n\nmsg.payload = \"Fallas Living: \" + global.get(\"fallasLiving\") + \"\\n\";\nmsg.payload += \"Fallas Pasillo: \" + global.get(\"fallasPasillo\") + \"\\n\";\nmsg.payload += \"Fallas Pasillo: \" + global.get(\"fallasLavadero\") + \"\\n\";\nmsg.payload += \"Fallas LivingIluminacion: \" + global.get(\"fallasLivingIluminacion\") + \"\\n\";\nvar i;\nfor (i = 0; i < 16; i++) {msg.payload += \"\\n\";}\nmsg.pin = 100;\nreturn msg;","outputs":1,"noerr":0,"x":1634.1666984558105,"y":1222.7500185966492,"wires":[["c6b4ec2a.3659c","686adb59.b06ae4"]]},{"id":"5ffca406.112c7c","type":"function","z":"3ce5b54a.127d6a","name":"","func":"node.status({text: global.get(\"voltajeBaterias\")})","outputs":1,"noerr":0,"x":660,"y":90,"wires":[[]]},{"id":"ec2023ef.f347f","type":"blynk-ws-out-set-property","z":"3ce5b54a.127d6a","name":"","pin":0,"pinmode":"1","prop":"bycode","client":"2c18e412.5f5cbc","x":920.3096618652344,"y":305.5237834112985,"wires":[]},{"id":"9e3144d0.d75738","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"comprobarConexionLiving","qos":"2","broker":"c339edbf.39572","x":3001.666488647461,"y":855.4286022186279,"wires":[["29f84a02.cd6be6"]]},{"id":"ba4a1cc3.21282","type":"inject","z":"a89e305a.c50bb","name":"","topic":"Pedido/Living/Iluminacion","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":201.11111450195312,"y":79.77777862548828,"wires":[["cce091cd.a69e5"]]},{"id":"e7016801.01fa68","type":"blynk-ws-out-write","z":"50119c6e.6ff584","name":"","pin":"21","pinmode":0,"client":"2c18e412.5f5cbc","x":742.857105255127,"y":404.28571224212646,"wires":[]},{"id":"eaaae07.822762","type":"debug","z":"e364a467.07a6a8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":625.6467971801758,"y":264.6666895747185,"wires":[]},{"id":"73985425.8391fc","type":"function","z":"50119c6e.6ff584","name":"","func":"node.status({text: global.get(\"tempMaxExtAnt\") + \" - \" + global.get(\"tempMinExtAnt\") + \" - \" + global.get(\"tempMinExt\") + \" - \" + global.get(\"tempMaxExt\")});\n","outputs":1,"noerr":0,"x":815.7143096923828,"y":270.0000114440918,"wires":[[]]},{"id":"7986f9fc.710748","type":"blynk-ws-in-write","z":"a89e305a.c50bb","name":"","pin":"30","pin_all":false,"client":"2c18e412.5f5cbc","x":1119.4124794006348,"y":81.3491849899292,"wires":[["af10f8a0.316f08"]]},{"id":"a1241ef3.88c86","type":"blynk-ws-in-write","z":"a89e305a.c50bb","name":"","pin":"56","pin_all":0,"client":"2c18e412.5f5cbc","x":187.49999618530273,"y":1297.000018119812,"wires":[["e14fbd1c.f372a"]]},{"id":"f159e61d.36bee8","type":"function","z":"a89e305a.c50bb","name":"potItem","func":"msg = {topic: \"Blink/potItem\", payload: msg.payload};\nglobal.set(\"itemPotencia\", msg.payload);\nif (parseInt(global.get(\"itemPotencia\")) > 0 && parseInt(global.get(\"itemPotencia\")) <= 4)return msg;","outputs":1,"noerr":0,"x":357.1429214477539,"y":397.1468496322632,"wires":[["4f93da66.796464","cce091cd.a69e5","36ec712b.3b77de"]]},{"id":"afe4dc5b.fc5bd","type":"delay","z":"3ce5b54a.127d6a","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2038.1667404174805,"y":223.64285346439908,"wires":[["c6c1ec1b.22ba2"]]},{"id":"8bd456c6.07d1e8","type":"delay","z":"a89e305a.c50bb","name":"","pauseType":"delay","timeout":"20","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":351.4881057739258,"y":168.25000190734863,"wires":[["cce091cd.a69e5","e20d3556.e3bf28"]]},{"id":"6d624e18.6a373","type":"function","z":"a89e305a.c50bb","name":"","func":"var date = new Date();\nvar nombre = date.getTime();// msg.payload = nombre; node.send([msg])\nvar directorio = \"/home/gaston/BackUp-Node-Red/\";\nmsg = {topic : \"SELECT * FROM ilLiving ORDER BY date Asc\"};\nnode.send([msg, null]);\nmsg = {topic : \"SELECT \\\"date\\\", \\\"isla\\\", \\\"cielorrazo\\\", \\\"rgb\\\" UNION  SELECT \\`date\\`, \\`isla\\`, \\`cielorrazo\\`, \\`rgb\\` INTO OUTFILE \\'\" + directorio + nombre + \".csv\\' FIELDS TERMINATED BY \\';\\' OPTIONALLY ENCLOSED BY '\\\"' LINES TERMINATED BY '\\r\\n' FROM \\`ilLiving\\`\"};\nnode.send([msg, null]);\n\nmsg.topic = \"iluminacion living\";\nmsg.payload = \"iluminacion living\";\nmsg.attachments = [{\n    filename: nombre + '.csv',\n    path: directorio + nombre + '.csv',\n    content: msg.payload\n}];\nreturn ([null, msg])","outputs":2,"noerr":0,"x":372.91670989990234,"y":795.2142291069031,"wires":[["29b79419.61cf0c"],["894d6130.d4b8","1c16b3e7.db684c"]]},{"id":"4a3e8292.4d0e8c","type":"function","z":"a89e305a.c50bb","name":"","func":"msg = {topic: \"minTeclas\", payload: global.get(\"minTeclas\")}; node.send(msg);\nmsg = {topic: \"maxTeclas\", payload: global.get(\"maxTeclas\")}; node.send(msg);\nreturn ","outputs":1,"noerr":0,"x":685.2380752563477,"y":95.88888263702393,"wires":[["a63faef1.a5598"]]},{"id":"97534488.115728","type":"inject","z":"3ce5b54a.127d6a","name":"most no","topic":"","payload":"0","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":141.73822021484375,"y":907.30947022211,"wires":[["66a6f4e9.4fa68c"]]},{"id":"e2e5e6f6.429198","type":"inject","z":"e364a467.07a6a8","name":"","topic":"prueba","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":207.44440841674805,"y":398.42859172821045,"wires":[["458559fe.24ae48"]]},{"id":"e810dd56.3b733","type":"debug","z":"3ce5b54a.127d6a","name":"usbIn/tanque","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":3018.6666717529297,"y":142,"wires":[]},{"id":"6d819ac.55df264","type":"debug","z":"3ce5b54a.127d6a","name":"salida blynk","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":3212.7131156921387,"y":577.7857799530029,"wires":[]},{"id":"f9541629.663dc8","type":"blynk-ws-in-write","z":"a89e305a.c50bb","name":"","pin":"29","pin_all":false,"client":"2c18e412.5f5cbc","x":171.08728790283203,"y":335.4365692138672,"wires":[["b0881f8d.2af13"]]},{"id":"3b30e656.644aca","type":"function","z":"f682d492.22a758","name":"","func":"msg.payload = \"{\\\"topic\\\":\\\"corrMinima\\\",\\\"payload\\\":2.5}\";\nnode.send(msg);\nmsg.payload = \"{\\\"topic\\\":\\\"vMin\\\",\\\"payload\\\":10.2}\";\nreturn msg;","outputs":1,"noerr":0,"x":587.5475769042969,"y":208.6666717529297,"wires":[["c6ce670d.77b0d8"]]},{"id":"8f7d1150.7be34","type":"file in","z":"e6e33852.2495f8","name":"lectura archivo","filename":"/home/gaston/BackUp-Node-Red/FastNet.txt","format":"utf8","chunk":false,"sendError":false,"x":391.88888931274414,"y":472.33331298828125,"wires":[["9dc175d5.17a7e8","c3f2f383.ad5a7"]]},{"id":"312bb425.81a66c","type":"blynk-ws-out-set-property","z":"3ce5b54a.127d6a","name":"","pin":0,"pinmode":"1","prop":"bycode","client":"2c18e412.5f5cbc","x":3017.951431274414,"y":642.0714795248849,"wires":[]},{"id":"a295c51.e493e38","type":"file","z":"f682d492.22a758","name":"","filename":"","appendNewline":false,"createDir":true,"overwriteFile":"true","x":743.5000915527344,"y":58,"wires":[[]]},{"id":"1232267d.1dfd9a","type":"debug","z":"3ce5b54a.127d6a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":704.6549606323242,"y":454.988149370466,"wires":[]},{"id":"bea906dd.514758","type":"mqtt out","z":"3ce5b54a.127d6a","name":"","topic":"","qos":"","retain":"","broker":"c339edbf.39572","x":695.1191596984863,"y":206.90479728153775,"wires":[]},{"id":"479f221d.2c638c","type":"function","z":"3ce5b54a.127d6a","name":"estado","func":"msg.payload = \"{\\\"topic\\\":\\\"Baterias/Est/Pedido\\\",\\\"payload\\\":1}\"\nreturn msg;","outputs":1,"noerr":0,"x":332.3334655761719,"y":695.5832812445504,"wires":[["42bf6e98.eba1a"]]},{"id":"300d9a91.71b0b6","type":"inject","z":"7ac92c99.66ea94","name":"","topic":"","payload":" gris muy oscuro","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":207.09521961212158,"y":437.1428442001343,"wires":[["b8f71abc.973838"]]},{"id":"3320628c.cb4c1e","type":"inject","z":"a89e305a.c50bb","name":"","topic":"ESP/living/Iluminacion/Envio","payload":"0#0#1","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":873.9880981445312,"y":626.5556640625,"wires":[["6d3158ca.fee558"]]},{"id":"adcdcc.ef00c238","type":"inject","z":"f682d492.22a758","name":"","topic":"","payload":"restarted","payloadType":"str","repeat":"","crontab":"","once":true,"x":153,"y":66,"wires":[["8f356ea8.5ecc6","ae138e5d.50e71"]]},{"id":"540adc68.85f1a4","type":"thingspeak42","z":"1b403a13.0ec8c6","name":"4EICHLJL446HHU1Z","delay":"15","topic1":"temperaturaTermo","topic2":"temperaturaExterior","topic3":"crepuscular","topic4":"estBomba","topic5":"tiempoLlenado","topic6":"estResistencia","topic7":"tiempoEncResis","topic8":"potResistencia","endpoint":"https://thingspeak.com","x":660.5,"y":62,"wires":[]},{"id":"43459861.0f6aa8","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"Actualizacion/Baterias","qos":"2","broker":"c339edbf.39572","x":2313.594997406006,"y":1034.0238041196553,"wires":[["8ac2932b.0cf64","13d24f97.6f3b5","bbcc7f70.46ebd","d9044cfd.00888","a912aad4.45fd28","c78fc939.967d08","f05099a2.864658","7e2dc0ad.e7129","86b7f194.f79ea","e1c6ae7.a9dd95","6b8f267f.3678e8","7bb3c4b2.0914ac","7eab163e.6214c8"]]},{"id":"ae746686.8cad28","type":"function","z":"3ce5b54a.127d6a","name":"toldoBlynk","func":"msg = {topic: \"toldoBlynk\", payload: parseInt(msg.payload)};\nreturn msg;","outputs":1,"noerr":0,"x":1622.4529495239258,"y":276.53572055271695,"wires":[[]]},{"id":"f1697d45.0cc3b","type":"function","z":"3ce5b54a.127d6a","name":"Baterias y Crep","func":"context.pruebas = context.pruebas || 0;\nvar haciendoPruebas;\n\nvar frecuenciaDatos = 5;\nvar vEmergMax = 17;\nvar vEmergMin = 9.6;\n// {\"topic\":\"Baterias/Est/Pedido/Resp\",\"bat1\":-127.00,\"bat2\":-127.00,\"bat3\":-127.00,\"bat4\":-127.00,\"bat5\":38.50,\"ambBat\":38.92,\"nivTanque\":0,\"volt\":3.72}\n//{\"topic\":\"Crep\",\"payload\":1}.\n//{\"topic\":\"Alarma/Disparo\",\"payload\":0}\n//{\"topic\":\"{\"topic\":\"Baterias/Est/Pedido/Resp\",\"bat1\":-127.00,\"bat2\":-127.00,\"bat3\":-127.00,\"bat4\":-127.00,\"bat5\":38.50,\"ambBat\":38.92,\"nivTanque\":0,\"volt\":3.72}\n//{\"topic\":\"Crep\",\"payload\":1}.\n//{\"topic\":\"Alarma/Disparo\",\"payload\":0}\n//{\"topic\":\"Toldo\",\"payload\":0}\n//{\"topic\":\"Alarma/Activacion\",\"payload\":1}\n// salida 1 serial\n// salida 2 blynk  pin = 0 notificaciones  --  pin 1= led alarma  --  pin2= boton alarma  --  pin3= linea 1 LCD -- pin4= linea 2 LCD\n// salida 3 mysql\nvar dato = JSON.parse(msg.payload);\ncontext.inicioCrep = context.inicioCrep || 0;\ncontext.inicioCargador = context.inicioCargador || 0;\n\nvar difTempEmergencia = 25;\nvar avisoBat = [];\nvar date = new Date();\nvar hh = date.getHours(); global.set(\"hh\", hh);\nvar mm = date.getMinutes(); global.set(\"mm\", mm);\nvar ss = date.getSeconds(); global.set(\"ss\", ss);\nvar dia = date.getDate();\nvar mes = date.getMonth(); global.set(\"mes\", mes);\nvar ano = date.getFullYear();\nglobal.set(\"fechaCompleta\", dia + \"/\" + mes + \"/\" + ano + \" \" + hh + \":\" + mm);\ncontext.hsAnterior = context.hsAnterior || 0;\ncontext.enviado = context.enviado || 0;\n\ncontext.Voltaje = context.Voltaje || null;\ncontext.Bat1 = context.Bat1 || null;\ncontext.Bat2 = context.Bat2 || null;\ncontext.Bat3 = context.Bat3 || null;\ncontext.Bat4 = context.Bat4 || null;\ncontext.Bat5 = context.Bat5 || null;\ncontext.Bat6 = context.Bat6 || null;\ncontext.tempAmbienteBat = context.tempAmbienteBat || null;\ncontext.nivelTanque = context.nivelTanque || null;\ncontext.contador = context.contador ||0;\ncontext.avisoMail = context.avisoMail ||0;\ncontext.avisoTanque = context.avisoTanque ||0;\ncontext.minAnt = context.minAnt || 0;\ncontext.mesAnt = context.mesAnt || mes - 1;\ncontext.diaAnt = context.diaAnt || dia;\ncontext.estadoCargador = context.estadoCargador || 0;\ncontext.cargarToldo = context.cargarToldo || 0;\ncontext.tiempoCarga = context.tiempoCarga || 0;\n\nvar dateCel = new Date(date.getTime() + 960000); \nvar hhCel = dateCel.getHours(); \nvar mmCel = dateCel.getMinutes();\nvar ssCel = dateCel.getSeconds();\nif (hh < 10)(hh = \"0\" + hh); if (mm < 10)(mm = \"0\" + mm); if (ss < 10)(ss = \"0\" + ss);\nglobal.set(\"hsCpu\", hh + \":\" + mm + \":\" + ss);\nif (hhCel < 10)(hhCel = \"0\" + hhCel); if (mmCel < 10)(mmCel = \"0\" + mmCel); if (ssCel < 10)(ssCel = \"0\" + ssCel);\nglobal.set(\"hsCel\", hhCel + \":\" + mmCel + \":\" + ssCel);\n\nvar tiempo = mm % frecuenciaDatos;\nnode.status({text: hh + \":\" + mm + \":\" + ss + \"   \"  + hhCel + \":\" + mmCel + \":\" + ss + \" || \" + context.mesAnt  + \" || \" + mes  + \" || \" +  context.avisoMail});\n\nif (dato.topic === \"Alarma\"){\n\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"Alarma\\\",\\\"payload\\\":\" + dato.payload + \"\\\"}\"}; \n\tnode.send([msg, null, null, null])}\n\nif (msg.topic === \"mandarMail\")mandarBackUpMail();\n\nif (ss === 2){\n\tif (context.mesAnt !== mes && hh === 0 && mm === 0  && context.avisoMail === 0){mandarBackUpMail(); context.mesAnt = mes;}\n}else{context.avisoMail = 0;}\n\n\nif (parseInt(ss) === 0){\n\t// msg = {pin: 6, payload: global.get(\"hsCel\")}; node.send(msg);\n\t// global.set(\"hsGlobal\", hh + \":\" + mm);\n\t// if (context.minAnt !== mm){\n\t// \tcontext.minAnt = mm;\n\t// \tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; \n\t// \tactualizarEstado();\n\t// }\tavio\n\tif (parseInt(tiempo) === 0 && context.enviado === 0){\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"Baterias/Est/Pedido\\\",\\\"payload\\\":1}\"}; \n\t\tnode.send([msg, null, null, null]); \n\t\tcontext.enviado = 1;}\n\t\t// return;}\n}\nelse{\n\tcontext.enviado = 0;\n}\n\nif (msg.topic === \"consultaCrep\"){msg = {topic : \"SELECT * FROM crepuscular ORDER BY hora Asc\"}; return ([null, null, msg, null]);}\nif (msg.topic === \"borrarCrep\"){msg = {topic : \"DELETE FROM `crepuscular` WHERE 1\"}; return ([null, null, msg, null]);}\n\nif (msg.topic === \"alarmaBlynk\"){\n\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"Alarma\\\",\\\"payload\\\":\" + msg.payload + \"}\"};\n\tnode.send([msg, null, null, null]);\n}\n\nif (dato.topic === \"Baterias/Est/Pedido/Resp\"){\n\tcontext.contador++;\t\n\tglobal.set(\"tempBat1\", dato.bat1.toFixed(1)); context.Bat1 += dato.bat1; if (global.get(\"tempBat1\") > difTempEmergencia + dato.tempAmb){avisoBat[1] = 1; avisoBaterias(1);}\n\tglobal.set(\"tempBat2\", dato.bat2.toFixed(1)); context.Bat2 += dato.bat2; if (global.get(\"tempBat2\") > difTempEmergencia + dato.tempAmb){avisoBat[2] = 1; avisoBaterias(2);}\n\t// global.set(\"tempBat3\", dato.bat3.toFixed(1)); context.Bat3 += dato.bat3; if (global.get(\"tempBat3\") > difTempEmergencia + dato.tempAmb){avisoBat[3] = 1; avisoBaterias(3);}\n\t// global.set(\"tempBat4\", dato.bat4.toFixed(1)); context.Bat4 += dato.bat4; if (global.get(\"tempBat4\") > difTempEmergencia + dato.tempAmb){avisoBat[4] = 1; avisoBaterias(4);}\n\t// global.set(\"tempBat5\", dato.bat5.toFixed(1)); context.Bat5 += dato.bat5; if (global.get(\"tempBat5\") > difTempEmergencia + dato.tempAmb){avisoBat[5] = 1; avisoBaterias(5);}\n\tglobal.set(\"tempAmbienteBat\", dato.ambBat.toFixed(1)); context.tempAmbienteBat += dato.ambBat; \n\tnode.status({text: global.get(\"tempAmbienteBat\")});\n\tglobal.set(\"voltajeBaterias\", dato.volt.toFixed(2)); context.Voltaje += dato.volt;// controlarVoltaje(global.get(\"voltajeBaterias\")); \n\tglobal.set(\"corrienteCarga\", dato.corriente.toFixed(2));\n\n\tif (global.get(\"voltajeBaterias\") > vEmergMax) {avisoBat[6] = 1; avisoBaterias(6);}\t\n\tif (global.get(\"voltajeBaterias\") < vEmergMin) { avisoBat[6] = 1; avisoBaterias(6);}\n\tactualizarEstado();\n\t// mostrarLcd();\n\n\tif (context.contador === 6){\n\t\tvar mysql = \"INSERT INTO \\`Baterias\\`(\\`Fecha\\`, \\`Voltaje\\`, \\`tempBat1\\`, \\`tempBat2\\`, \\`tempBat3\\`, \\`tempBat4\\`, \\`tempBat5\\`, \\`tempBat6\\`, \\`tempAmbienteBaterias\\`)\"; \n\t\tmysql += \"VALUES (now() ,\" + context.Voltaje / context.contador + \",\" + context.Bat1 / context.contador + \",\" + context.Bat2 / context.contador + \",\";\n\t\tmysql += context.Bat3 / context.contador + \",\" + context.Bat4 / context.contador + \",\";\n\t\tmysql += context.Bat5 / context.contador + \", \" + context.Bat6 / context.contador + \", \";\n\t\tmysql += context.tempAmbienteBat / context.contador + \")\";\n\t\tmsg.topic = mysql;\n\t\tnode.send([ null, null, msg, null]);\n\t\tcontext.Voltaje = 0; context.Bat1 = 0; context.Bat2 = 0; context.Bat3 = 0; context.Bat4 = 0; context.Bat5 = 0;\n\t\tcontext.tempAmbienteBat = 0; context.nivTanque = 0; context.contador = 0;\n\t}\n\tmsg = {topic: \"Actualizacion/Baterias\", payload:\"\"}; node.send([msg, null, null, null]);\n}\n\nif (dato.topic === \"Cargador\"){\n\tglobal.set(\"estadoCargador\", dato.payload);\n\tglobal.set(\"voltajeBaterias\", dato.volt);\n\tglobal.set(\"corrienteCarga\", dato.corriente.toFixed(2));\n\t\n\tif (dato.payload === 1 && context.estadoCargador === 0) {\n\t\tcontext.estadoCargador = 1;\n\t\tvar date1 = new Date(date.getTime() - context.tiempoCarga); \n\t\tglobal.set(\"tiempoEspera\", (date.getTime() - context.tiempoCarga)/(60*1000));\n\n\t\t// if (context.inicioCargador === 1)global.set(\"tiempoEspera\", (date.getTime() - context.tiempoCarga)/(60*1000));\n\t\t// if (context.inicioCargador === 0)context.inicioCargador = 1;\n\n\t\tvar minCarg = date1.getMinutes(); var segCarg = date1.getSeconds();\n\t\tif (minCarg < 10)(minCarg = \"0\" + minCarg); if (segCarg < 10)(segCarg = \"0\" + segCarg);\n\t\tvar mostrarTiempoCarga = minCarg + \":\" + segCarg;\t\n\t\tcontext.tiempoCarga = date.getTime();\n\n\t\tmsg = {topic: \"estadoFallas\", payload: 1}; node.send(msg);\n\t\t// msg = {topic: \"notifyBlynk\", payload: \"Iniciando carga baterias (tiempo espera= \" + mostrarTiempoCarga + \")\"}; node.send(msg); \n\n\t\tglobal.set(\"estadocargadorTexto\", \"cargando desde \" + dia + \"/\" + (mes+1) + \"/\" + ano + \" \" + hh + \":\" + mm + \":\" + ss);}\n\n\tif (dato.payload === 0 && context.estadoCargador === 1) {\n\t\tcontext.estadoCargador = 0;\n\t\tvar date1 = new Date(date.getTime() - context.tiempoCarga); \n\t\tglobal.set(\"tiempoCargando\", (date.getTime() - context.tiempoCarga)/(60*1000));\n\t\t\n\t\t// if (context.inicioCargador === 1)global.set(\"tiempoCargando\", (date.getTime() - context.tiempoCarga)/(60*1000));\n\t\t// if (context.inicioCargador === 0)context.inicioCargador = 1;\n\n\t\tvar minCarg = date1.getMinutes(); var segCarg = date1.getSeconds();\n\t\tif (minCarg < 10)(minCarg = \"0\" + minCarg); if (segCarg < 10)(segCarg = \"0\" + segCarg);\n\t\tvar mostrarTiempoCarga = minCarg + \":\" + segCarg;\t\n\t\tcontext.tiempoCarga = date.getTime();\n\t\tmsg = {topic: \"estadoFallas\", payload: 1}; node.send(msg);\n\t\t// msg = {topic: \"notifyBlynk\", payload: \"Terminando carga baterias (tiempo cargando= \" + mostrarTiempoCarga + \")\"}; node.send(msg);\n\n\t\tglobal.set(\"estadocargadorTexto\", \"OK desde \" + dia + \"/\" + (mes+1) + \"/\" + ano + \" \" + hh + \":\" + mm + \":\" + ss);\n\t}\n\tmsg = {topic: \"Blynk/actualizar/estado\", payload: \"\"}; node.send([msg, null, null, null, null]);\n}\n\nfunction avisoBaterias(numBat){\n\tif (numBat > 0 && numBat <= 5){\n\t\tmsg = {topic: \"notifyBlynk\", payload: \"Atencion baterias numero: \" + numBat + \" sobrecalentada\"};//, pin: 0};\n\t\tnode.send([msg, null, null, null]);\n\t}\n\tif (numBat === 6){\n\t\tmsg = {topic: \"notifyBlynk\", payload: \"Atencion voltaje de baterias fuera de rango, voltaje: \" + dato.volt + \"V\"};//, pin: 0};\n\t\tnode.send([msg, null, null, null]);\n\t}\n}\n\nfunction mandarBackUpMail(){\n\tvar nombre = mes + \"_\" + ano;\n\tvar directorio = \"/home/gaston/BackUp-Node-Red/\";\n\tmsg = {topic : \"SELECT * FROM crepuscular ORDER BY hora Asc\"};\n\tnode.send([null, null, msg, null]);\n\tmsg = {topic : \"SELECT \\\"hora\\\", \\\"valor\\\" UNION  SELECT \\`hora\\`, \\`valor\\` INTO OUTFILE \\'\" + directorio + nombre + \".csv\\' FIELDS TERMINATED BY \\';\\' OPTIONALLY ENCLOSED BY '\\\"' LINES TERMINATED BY '\\r\\n' FROM \\`crepuscular\\`\"};\n\tnode.send([null, null, msg, null]);\n\tmsg = {topic : \"DELETE FROM \\`crepuscular\\` WHERE 1\"};\n\tnode.send([null, null, msg, null]);\n\n\tmsg.topic = \"BackUp crepuscular\";\n\tmsg.payload = \"BackUp crepuscular\";\n\tmsg.attachments = [{\n\t    filename: nombre + '.csv',\n\t    path: directorio + nombre + '.csv',\n\t    content: msg.payload\n\t}];\n\tnode.send([null, null, null, msg]);\n\tcontext.avisoMail = 1;\n}\n\nfunction actualizarEstado(){\n\tif (global.get(\"estadoToldo\") !== \"Abriendo\" && global.get(\"estadoToldo\") !== \"Cerrando\"){\n\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1};\n\t\tnode.send([msg, null, null, null, null]);}\t\n}","outputs":4,"noerr":0,"x":469.1666717529297,"y":300.42857142857144,"wires":[["bea906dd.514758","283c31f.9655ece"],["cfe7da5b.0b0058","ec2023ef.f347f","4a51d0e8.24515"],["214f33ab.64134c"],["2428a89d.746c48","1232267d.1dfd9a"]]},{"id":"a1ef6409.4b2178","type":"function","z":"50119c6e.6ff584","name":"","func":"var caso = 0;\nif (msg.topic != \"ESP/Living/Sens/Temp/Pedido\")return;\n// msg.payload  =\"Living= \" + global.get(\"tempLiving\"); node.send(msg);  \nvar timer = setInterval(saltos, 1400);\nfunction saltos(){\n    caso++;\n    switch (caso){\n        case 1:\n            msg.payload  =\"Pasillo= \" + global.get(\"tempPasillo\");\n        break;\n        case 2:\n            msg.payload  =\"Lavadero= \" + global.get(\"tempLavadero\");\n        break;\n        case 3:\n            msg.payload  =\"Exterior= \" + global.get(\"tempExterior\");\n        break;\n        case 4:\n            msg.payload  =\"PatioLuz= \" + global.get(\"tempPatioLuz\");\n        break;             \n        case 5:\n            msg.payload  =\"LDR= \" + global.get(\"LDR\");\n        break; \n        case 6:\n            msg.payload  =\"Living H= \" + global.get(\"humLiving\");    \n        break;          \n        case 7:\n            msg.payload  =\"Living T= \" + global.get(\"tempLiving\");    \n        break;         \n        // case 6:\n        //     msg.payload  =\"Living= \" + global.get(\"tempLiving\");  \n        // break;         \n    }\n    node.send(msg);\n    if (caso >= 7)clearInterval(timer);\n}","outputs":1,"noerr":0,"x":590.7141666412354,"y":188.57143878936768,"wires":[["1d79b378.01fa4d"]]},{"id":"389a6415.87bb6c","type":"debug","z":"3ce5b54a.127d6a","name":"salida2 lcd blynk","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1650.4166717529297,"y":705.4285917282104,"wires":[]},{"id":"7bb3c4b2.0914ac","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg = {topic: \"nivTanque\", payload: global.get(\"nivTanque\")}; node.send(msg);\nreturn;","outputs":1,"noerr":0,"x":2531.1310119628906,"y":847.035699571882,"wires":[["13adbc11.4ab694"]]},{"id":"355077e0.49f888","type":"blynk-ws-out-write","z":"50119c6e.6ff584","name":"","pin":"26","pinmode":"1","client":"2c18e412.5f5cbc","x":742.2222099304199,"y":613.3333339691162,"wires":[]},{"id":"a1d62969.c9d1f8","type":"blynk-ws-in-write","z":"a89e305a.c50bb","name":"","pin":"17","pin_all":false,"client":"2c18e412.5f5cbc","x":170.0952377319336,"y":289.96823501586914,"wires":[["cfa04e60.45c03"]]},{"id":"871f3c66.86677","type":"function","z":"a89e305a.c50bb","name":"","func":"if (msg.payload == \"0\")return;\nreturn msg;","outputs":1,"noerr":0,"x":283.33331298828125,"y":1112,"wires":[["7140c1c9.bedec","813dc6d4.867e68","23547dec.5e1192","c971c023.98bae"]]},{"id":"eb85b399.7743b","type":"function","z":"3ce5b54a.127d6a","name":"falla pasillo","func":"// context.contadorLiving = context.contadorLiving || 0;\n// context.fallasLiving = context.fallasLiving || 0;\n// // var status;\n\n// context.contadorLiving++;\nif (msg.topic == \"comprobarConexionPasillo\"){\n\tvar fallas = global.get(\"fallasPasillo\") + 1;\n\tglobal.set(\"fallasPasillo\", fallas);\n\tglobal.set(\"tipoFallaPasillo\", msg.payload); msg = {topic: \"fallas_MQTT\", payload: 1}; node.send(msg);\n}\nnode.status({text: \"Fal Pas: \" + global.get(\"fallasPasillo\")});\n\nif (msg.topic === \"Reset\"){global.set(\"fallasPasillo\", 0); context.fallasLiving = 0; return;}\n\n// if (msg.topic === \"comprobarConexionLiving\"){context.contadorLiving = 0; return;}\n// if (context.contadorLiving >= 5){\n//     context.contadorLiving = 0;\n//     context.fallasLiving++;\n//     global.set(\"fallasLiving\", context.fallasLiving);\n// }\n\n\n\n","outputs":1,"noerr":0,"x":1680.6503982543945,"y":1042.0119578497752,"wires":[["bf15eec9.f42a"]]},{"id":"c38ce237.8b4e","type":"inject","z":"a89e305a.c50bb","name":"consulta","topic":"SELECT * FROM `ilLiving` WHERE 1","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":165.4167022705078,"y":837.7142181396484,"wires":[["6d624e18.6a373"]]},{"id":"f05099a2.864658","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg = {topic: \"tempBat6\", payload: global.get(\"tempBat6\")}; node.send(msg);\n","outputs":1,"noerr":0,"x":2542.166603088379,"y":1138.3095280783518,"wires":[[]]},{"id":"8128ec7e.a598a","type":"inject","z":"1b403a13.0ec8c6","name":"bomba manual","topic":"","payload":"0","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":260,"wires":[["d63b04d.1a1ddf8"]]},{"id":"35b5038b.76c79c","type":"ui_chart","z":"3ce5b54a.127d6a","name":"","group":"177e0064.22348","order":1,"width":"16","height":"10","label":"Temperaturas","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"bezier","nodata":"","dot":false,"ymin":"-10","ymax":"30","removeOlder":"3","removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":true,"x":2765.0238723754883,"y":891.1665837424142,"wires":[[],[]]},{"id":"3c0f64c7.dcf05c","type":"function","z":"50119c6e.6ff584","name":"tempExterior","func":"if (global.get(\"tempMaxExtValor\") === undefined)global.set(\"tempMaxExtValor\", -255);\nif (global.get(\"tempMinExtValor\") === undefined)global.set(\"tempMinExtValor\", 255);\nif (global.get(\"tempMaxExtAnt\") === undefined)global.set(\"tempMaxExtAnt\", -255);\nif (global.get(\"tempMinExtAnt\") === undefined)global.set(\"tempMinExtAnt\", 255);\nvar temp;\nvar date = new Date();\nvar dia = date.getDate();\ncontext.temp = context.temp || 0;//hola\ncontext.diaAnt = context.diaAnt || dia - 1;\n\n\nif (context.diaAnt !== dia){\ncontext.diaAnt = dia;\n\tglobal.set(\"tempMaxExtAnt\", global.get(\"tempMaxExt\"));\n\tglobal.set(\"tempMinExtAnt\", global.get(\"tempMinExt\"));\n\tglobal.set(\"tempMinExtValor\", 255);\n\tglobal.set(\"tempMaxExtValor\", -255);\n}\n\n// msg.payload = global.get(\"tempExterior\"); node.send(msg);\n\nvar tempExterior = parseFloat(global.get(\"tempExterior\"));\nvar tempmax = parseFloat(global.get(\"tempMaxExtValor\"));\nvar tempmin = parseFloat(global.get(\"tempMinExtValor\"));\n\n\nif (parseFloat(tempExterior) > parseFloat(tempmax)){\n\tglobal.set(\"tempMaxExt\", parseFloat(tempExterior).toFixed(1) + \" (\" + global.get(\"hsCpu\") + \")\");\n\tglobal.set(\"tempMaxExtValor\", global.get(\"tempExterior\"));\n}\nif (parseFloat(tempExterior) < parseFloat(tempmin)){\n\tglobal.set(\"tempMinExt\", parseFloat(tempExterior).toFixed(1) + \" (\" + global.get(\"hsCpu\") + \")\");\n\tglobal.set(\"tempMinExtValor\", global.get(\"tempExterior\"));\n}\n\nnode.status({text: \"temp: \" + parseFloat(tempExterior).toFixed(1) + \" -- \" + global.get(\"hsCpu\")});\t\nmsg = {topic: \"tempExterior\", payload: parseFloat(tempExterior).toFixed(1)}; \t\nreturn msg;\n\n","outputs":1,"noerr":0,"x":489.2856864929199,"y":351.42857694625854,"wires":[["3fde6b72.65b1a4","55b494c8.fab0dc","ef327ef2.6c0f6"]]},{"id":"1ab89d06.27fd03","type":"inject","z":"7ac92c99.66ea94","name":"","topic":"","payload":"color living gris muy oscuro","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":182.47614002227783,"y":504.1428232192993,"wires":[["b8f71abc.973838"]]},{"id":"426f4797.676a48","type":"inject","z":"e364a467.07a6a8","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":0.1,"x":123.6229476928711,"y":342.7024116516113,"wires":[["2d13b22d.35e53e"]]},{"id":"6dca668e.bbafc8","type":"ui_gauge","z":"3ce5b54a.127d6a","name":"","group":"ff2252ef.d12aa","order":8,"width":"2","height":"2","gtype":"gage","title":"Temp Bat4","label":"units","format":"{{value}}","min":"20","max":"70","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":2762.166603088379,"y":1056.8809370313375,"wires":[]},{"id":"8d26d38b.32374","type":"mqtt in","z":"50119c6e.6ff584","name":"tempExterior","topic":"ESP/TermoSolar/Envio","qos":"2","broker":"e779f8d6.7bc2c8","x":200,"y":350,"wires":[["f78b60b2.43ccc","958c3f89.0f016"]]},{"id":"a46e1d7a.3a479","type":"mqtt in","z":"a89e305a.c50bb","name":"","topic":"ESP/living/Iluminacion/Recibo2","qos":"2","broker":"6b36e4a.1d30b1c","x":147.36109924316406,"y":1009.5000114440918,"wires":[["610597ee.3b4568","b9762c5c.53da"]]},{"id":"4bbcff4e.de9ea","type":"blynk-ws-out-write","z":"3ce5b54a.127d6a","name":"","pin":"6","pinmode":0,"client":"2c18e412.5f5cbc","x":1774.5833282470703,"y":791.6786003112793,"wires":[]},{"id":"86b7f194.f79ea","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg = {topic: \"voltajeBaterias\", payload: global.get(\"voltajeBaterias\")}; node.send(msg);","outputs":1,"noerr":0,"x":2547.880958557129,"y":1219.7381147657125,"wires":[["2ff411a2.ce3fce"]]},{"id":"c135bb3f.7eae98","type":"function","z":"50119c6e.6ff584","name":"tempPasillo","func":"var temp = parseFloat(msg.payload) + (-1.5);\nglobal.set(\"tempPasillo\", temp.toFixed(1));\nmsg= {topic: \"tempPasillo\", payload: global.get(\"tempPasillo\")}; node.send(msg);\nnode.status({text: \"temp: \" + global.get(\"tempPasillo\") + \" -- \" + global.get(\"hsCpu\")});","outputs":1,"noerr":0,"x":494.9999027252197,"y":457.1428556442261,"wires":[["3fde6b72.65b1a4","8af6ec86.c2889"]]},{"id":"ca93e748.b2afe8","type":"debug","z":"3ce5b54a.127d6a","name":"USB/Alarma","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":2826.5226516723633,"y":750.6429268973214,"wires":[]},{"id":"2ed5a328.d7416c","type":"function","z":"a89e305a.c50bb","name":"colorRGB","func":"msg.topic = \"Blink/colorRGB\";//, payload: msg.arrayOfValues};\nreturn msg;","outputs":1,"noerr":0,"x":365.5793914794922,"y":479.5634968280792,"wires":[["cce091cd.a69e5","4f93da66.796464"]]},{"id":"dda6ed4.6b72d1","type":"inject","z":"7ac92c99.66ea94","name":"","topic":"","payload":"activar alarma casa","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":154.95236682891846,"y":67,"wires":[["f80091fc.1ea"]]},{"id":"7b57bbf2.a205a4","type":"inject","z":"7ac92c99.66ea94","name":"","topic":"","payload":"luces del living","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":161.04754734039307,"y":244.6785340309143,"wires":[["e06c23ee.4ad0f"]]},{"id":"7c69f59.6ded20c","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1409.1666984558105,"y":1224.0000185966492,"wires":[["1583c20e.1315ee"]]},{"id":"e1c6ae7.a9dd95","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg = {topic: \"nivTanque\", payload: global.get(\"nivTanque\")}; node.send(msg);","outputs":1,"noerr":0,"x":2546.4999389648438,"y":1272.119038990566,"wires":[["5cfe80d2.17592"]]},{"id":"79efeffd.7ecea","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":2597.6776962280273,"y":289.7261710166931,"wires":[["7385d352.01625c"]]},{"id":"f682d5fc.df5b28","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"USBin/Toldo","qos":"2","broker":"c339edbf.39572","x":1602.1194381713867,"y":236.01189204624723,"wires":[[]]},{"id":"338fa6cc.48bf2a","type":"debug","z":"e364a467.07a6a8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":766.6944007873535,"y":428.4285914301872,"wires":[]},{"id":"a5dff34f.89fa6","type":"file","z":"e6e33852.2495f8","name":"borrar archivo","filename":"/home/gaston/BackUp-Node-Red/FastNet.txt","appendNewline":true,"createDir":false,"overwriteFile":"delete","x":359.66665267944336,"y":560.111123085022,"wires":[[]]},{"id":"34cc6743.777428","type":"function","z":"a89e305a.c50bb","name":"Dia","func":"global.set(\"Dia\", msg.payload);\nnode.status({text: global.get(\"Dia\")})","outputs":1,"noerr":0,"x":1353.8094291687012,"y":555.571373462677,"wires":[[]]},{"id":"29c9ac88.41f9b4","type":"function","z":"3ce5b54a.127d6a","name":"LCD Blynk","func":"var velocidadTexto = 191;\nvar velocidadTexto1 = 140;\nvar payload = msg.payload;\nvar largo;\nvar estadoCarg;\nvar cont = -1;\nvar timer1;\nvar timer2;\nvar timer3;\nvar Baterias;\nvar Toldo;\nvar datosTemp;\nvar crepuscular;\nvar tempMaxMinAyer;\nvar tempMaxMinHoy;\n\nif (global.get (\"estadoCargador\") === 1) {estadoCarg = \"V Carg\";} else {estadoCarg = \"V OK\";}\n\nBaterias = global.get(\"estadocargadorTexto\") + \"   Volt=\" + global.get(\"voltajeBaterias\");// + estadoCarg + \" Tanque=\" + global.get(\"nivTanque\") + \"mm\" + \" Temp. Alt=\" + global.get(\"tempAmbienteBat\"); \n// Baterias += \" Bat1=\" + global.get(\"tempBat1\") + \" Bat2=\" + global.get(\"tempBat2\") + \" Bat3=\" + global.get(\"tempBat3\");\n// Baterias +=  \" Bat4=\" + global.get(\"tempBat4\") + \" Bat5=\" + global.get(\"tempBat5\");\n\n\nToldo = \"   \" + global.get(\"estadoToldoLCD\") + \", \" + global.get(\"enfriadorToldo\");// + global.get(\"enfriadorToldo\");\nif (global.get(\"enfriarToldo\") === 1){Toldo = Toldo + \", \" + global.get(\"rociadorToldo\");}\n\ndatosTemp = \"   Living=\" + parseFloat(global.get(\"tempLiving\")).toFixed(1) + \" Hum. Living=\" + parseFloat(global.get(\"humLiving\")).toFixed(1);\ndatosTemp += \"% Pasillo=\" + parseFloat(global.get(\"tempPasillo\")).toFixed(1) + \" PatioLuz=\" + parseFloat(global.get(\"tempPatioLuz\")).toFixed(1);\ndatosTemp += \" Exterior=\" + parseFloat(global.get(\"tempExterior\")).toFixed(1);\ndatosTemp +=\" Lavadero=\" + parseFloat(global.get(\"tempLavadero\")).toFixed(1) + \" Tanque=\" + global.get(\"nivTanque\") + \"mm\";\n\ntempMaxMinAyer = \"   Min ayer \" + global.get(\"tempMinExtAnt\") + \", Max ayer \" + global.get(\"tempMaxExtAnt\");\n \ntempMaxMinHoy =  \"   Min hoy \" + global.get(\"tempMinExt\") + \", Max hoy \" + global.get(\"tempMaxExt\") + \", actual \" + global.get(\"tempExterior\");\n\nif (global.get(\"Dia\") === 0){\n\tcrepuscular = \"   Oscurecio a las \" + global.get(\"hsAnochecer\") +  \", Amanecio a las \" + global.get(\"hsAmanecer\") + \", LDR \" + global.get(\"LDR\");}\n\telse{\n\tcrepuscular = \"   Amanecio a las \" + global.get(\"hsAmanecer\") + \", Oscurecio a las \" + global.get(\"hsAnochecer\") + \", LDR \" + global.get(\"LDR\");}\n\n\n\nmsg.payload = Baterias; node.send([null,msg]);\nmsg.payload = datosTemp; node.send([null,msg]);\nmsg.payload = Toldo; node.send([null,msg]);\nmsg.payload = crepuscular; node.send([null,msg]);\nmsg.payload = tempMaxMinAyer; node.send([null,msg]);\nmsg.payload = tempMaxMinHoy; node.send([null,msg]);\n\ncontext.mostrando = context.mostrando || 0;\ncontext.pedido = context.pedido || 0;\n\n\n// var largoTemperaturas = Temperaturas.length;\nvar largoBaterias = Baterias.length;\nvar largoToldo = Toldo.length;\nvar largoDatosTemp = datosTemp.length;\nvar largoCrepuscular = crepuscular.length;\nvar largotempMaxMinAyer = tempMaxMinAyer.length;\nvar largotempMaxMinHoy = tempMaxMinHoy.length;\n// node.status({text: context.mostrando});\nif (context.mostrando === 1)return;\n\n// if (msg.topic === \"pedidoActualizacion\")payload = context.pedido;\n\nif (msg.topic === \"Blynk/actualizar/estado\")actualizarEstado();\nif (global.get(\"estadoToldo\") !== \"Abriendo\" || global.get(\"estadoToldo\") !== \"Cerrando\"){\n\tif (payload === \"2\") velocidadTexto = velocidadTexto1;\n\tif (msg.topic === \"Blynk/actualizar/infos\"){\n\t\tpayload = context.pedido; \n\t\t// if (payload === \"1\") velocidadTexto = 190;\n\t\ttimer1 = setInterval(infoCompleta, velocidadTexto1);}\n\t\t\t\t\t//timer2 = setInterval(mostrarDatosTemp, velocidadTexto2);\n\tif (msg.topic === \"Blynk/mostrar/infos\")timer1 = setInterval(infoCompleta, velocidadTexto);\n\t// if (msg.topic === \"Blynk\")var timer1 = setInterval(datosTemp, velocidadTexto2);\n}\n\nreturn;\nfunction infoCompleta(){\n\tcontext.mostrando = 1;\n\tcont++;\n\tswitch (parseInt(payload)){\n\t\tcase 1:\n\t\t\tcontext.pedido = \"1\";\n\t\t\tlargo = largoDatosTemp;\n\t\t\tmsg = {pin: 4, payload: \" Temp Ambientes \"}; node.send(msg);\n\t\t\tif (cont < largoDatosTemp-15){msg = {pin: 5, payload: datosTemp.substring(cont)}; node.send(msg);}\n\t\tbreak;\n\n\t\tcase 2:\n\t\t\tcontext.pedido = \"2\";\n\t\t\tlargo = largoBaterias;\n\t\t\tmsg = {pin: 4, payload: \"Info de Baterias\"}; node.send(msg);\n\t\t\tif (cont < largoBaterias-15){msg = {pin: 5, payload: Baterias.substring(cont)}; node.send(msg);}\n\t\tbreak;\n\n\t\tcase 3:\n\t\t\tcontext.pedido = \"3\";\n\t\t\tlargo = largoToldo;\n\t\t\tmsg = {pin: 4, payload: \" Info del Toldo \"}; node.send(msg);\n\t\t\tif (cont < largoToldo-15){msg = {pin: 5, payload: Toldo.substring(cont)}; node.send(msg);}\n\t\tbreak;\n\t\tcase 4:\n\t\t\tcontext.pedido = \"4\";\n\t\t\tlargo = largoCrepuscular;\n\t\t\tmsg = {pin: 4, payload: \"Info crepuscular\"}; node.send(msg);\n\t\t\tif (cont < largoCrepuscular-15){msg = {pin: 5, payload: crepuscular.substring(cont)}; node.send(msg);}\n\t\tbreak;\t\n\t\tcase 5:\n\t\t\tcontext.pedido = \"5\";\n\t\t\tlargo = largotempMaxMinAyer;\n\t\t\tmsg = {pin: 4, payload: \"  Temp Max/Min  \"}; node.send(msg);\n\t\t\tif (cont < largotempMaxMinAyer-15){msg = {pin: 5, payload: tempMaxMinAyer.substring(cont)}; node.send(msg);}\n\t\tbreak;\n\t\tcase 6:\n\t\t\tcontext.pedido = \"6\";\n\t\t\tlargo = largotempMaxMinHoy;\n\t\t\tmsg = {pin: 4, payload: \"  Temp Max/Min  \"}; node.send(msg);\n\t\t\tif (cont < largotempMaxMinHoy-15){msg = {pin: 5, payload: tempMaxMinHoy.substring(cont)}; node.send(msg);}\n\t\tbreak;\t\t\n\t}\n\tif (cont > largo-16){clearInterval(timer1); timer3 = setInterval(pantallaPrincipal, 1000);}\n}\n\n// function mostrarDatosTemp(){\n// \tcontext.mostrando = 1;\n// \t// cont++;\n// \tlargo = largoDatosTemp;\n// \tmsg = {pin: 4, payload: \" Temp Ambientes \"}; node.send(msg);\n// \tif (cont < largoDatosTemp-15){msg = {pin: 5, payload: datosTemp.substring(cont)}; node.send(msg);}\n// \tif (cont > largo-16){clearInterval(timer2); timer3 = setInterval(pantallaPrincipal, 1000);}\n// }\n\nfunction pantallaPrincipal(){\n\tcontext.mostrando = 0;\n\tactualizarEstado();\n\tclearInterval(timer3);\t\t\n}\n\nfunction actualizarEstado(){\n\tnode.status({text: global.get(\"hsCel\")}); \n\t// msg = {pin: 6, payload: global.get(\"hsCel\")}; node.send(msg);\n\tif (global.get(\"estadoToldo\") !== \"Abriendo\" || global.get(\"estadoToldo\") !== \"Cerrando\"){\n\t\tif (global.get(\"estadoCargador\") == \"1\"){msg = {pin: 15, color: \"#fcaf17\", payload: parseFloat(global.get(\"voltajeBaterias\")).toFixed(2) + \"v\"}; node.send(msg);}\n\t\tif (global.get(\"estadoCargador\") == \"0\"){msg = {pin: 15, color: \"#23C48E\", payload: parseFloat(global.get(\"voltajeBaterias\")).toFixed(2) + \"v\"}; node.send(msg);}\t\t\n\t\tmsg = {pin: 4, payload: \"Temp= \" + global.get(\"tempExterior\")}; node.send(msg);\n\t\tmsg = {pin: 5, payload: \"Tq= \" + global.get(\"nivTanque\") + \"mm T=\" + global.get(\"tempPatioLuz\")}; node.send(msg);\n\t}\nreturn;}\n\n\n//temp= 21.5  ll55\n//Mi=10.5  Ma=21.5\n//Act=15.2 Tq=365mm","outputs":2,"noerr":0,"x":1794.1824226379395,"y":850.4047212600708,"wires":[["955a8862.016a38","e4bbd9b5.cf9f18","29b9e573.32e7ca"],["288336d4.991aaa"]]},{"id":"83cef311.b8fbd","type":"inject","z":"50119c6e.6ff584","name":"","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":144.92058944702148,"y":230.47618579864502,"wires":[["4a3045c9.61c37c"]]},{"id":"34ae7c41.536534","type":"function","z":"1b403a13.0ec8c6","name":"","func":"// Sal1  thingspeak\n// Sal2  mqtt\n// Sal3  blynk\n// Sal4  mysql\n\ncontext.llenandoTermo = context.llenandoTermo || 0;\ncontext.encendidoResistencia = context.encendidoResistencia || 0;\ncontext.estAnteriorResistencia = context.estAnteriorResistencia || 0;\ncontext.tiempoInicioResistencia = context.tiempoInicioResistencia || 0;\ncontext.bombaAutoAnulada = context.bombaAutoAnulada || 1;\n\nvar topic = msg.topic;\nvar payload = msg.payload;\nvar comienzoLlenado;\nvar terminoLlenado;\nvar valorDia = global.get(\"valorDia\");\nvar valorNoche = global.get(\"valorNoche\");\n\nif (topic == \"crepMQTT\" && payload == \"1\"){\n\tglobal.set(\"millisDia\", new Date().getTime() + 1000 * 60 * 60); \n\tmsg = {pin: 127, payload: global.get(\"hsCpu\") + \", se hizo de dia defasaje 1hs \\n\"};\n\treturn([null, null, msg, null]);\n}\n// if (topic == \"timer\"){\n// \tif (global.get(\"hh\") >= 22 && global.get(\"mm\") === 0 && global.get(\"ss\") >= 5 && global.get(\"autoBomba\") === 1){\n// \t\tmsg = {pin: 127, payload: global.get(\"hsCpu\") + \", paso a manual bomba termo \\n\"}; node.send([null, null, msg, null]);\n// \t\tglobal.set(\"autoBomba\", 0);\n// \t\tglobal.set(\"pedBomba\", 0);\n// \t\tenviarDatos();\n// \t}\n// \tif (new Date().getTime() > global.get(\"millisDia\") && global.get(\"Dia\") === 1 && global.get(\"autoBomba\") === 0){\n// \t\tmsg = {pin: 127, payload: global.get(\"hsCpu\") + \", paso a automatico bomba termo por offset dia \\n\"}; node.send([null, null, msg, null]);\n// \t\tglobal.set(\"autoBomba\", 1); \n// \t\tenviarDatos();\n// \t}\n// \tif (global.get(\"hh\") === 9 && global.get(\"mm\") === 0 && global.get(\"ss\") >= 5 && global.get(\"autoBomba\") === 0){\n// \t\tmsg = {pin: 127, payload: global.get(\"hsCpu\") + \", paso a automatico bomba termo por hora \\n\"}; node.send([null, null, msg, null]);\n// \t\tcontext.bombaAutoAnulada = 0;\n// \t\tglobal.set(\"autoBomba\", 1); \n// \t\tenviarDatos();\n// \t}\t\n// \treturn;\n// }\n\n\nif (topic == \"bombaAuto\"){\n\tif (payload === 0){global.set(\"pedBomba\", 0); context.bombaAutoAnulada = 1;} \n\tif (payload === 1){context.bombaAutoAnulada = 0;}\n\tglobal.set(\"autoBomba\", payload); enviarDatos();}\n\nif (topic == \"marchaBomba\" && global.get(\"autoBomba\") === 0){\n\tglobal.set(\"pedBomba\", payload); enviarDatos();}\n\t\nif (topic == \"resistenciaAuto\"){\n\tif (payload === 0)global.set(\"pedResistencia\", 0);\n\tglobal.set(\"autoResistencia\", payload); enviarDatos();}//encendidoResistencia\n\nif (topic == \"encendidoResistencia\" && global.get(\"autoResistencia\") === 0){\n\tglobal.set(\"pedResistencia\", payload); enviarDatos();}\n\nif (topic == \"ESP/TermoSolar/Envio\"){\n\t//0#0#0#15.55#25.55#1020\n\tvar dato = payload.split(\"#\");\n\tglobal.set(\"estBomba\", dato[0]); \n\tglobal.set(\"estResistencia\", dato[1]); \n\tglobal.set(\"estToldo\", dato[2]); \t\n\tglobal.set(\"tempTermoFin\", dato[3]); \n\tglobal.set(\"tempExterior\", dato[4]); \n\tglobal.set(\"sensorCrep\", parseInt(dato[5])); //msg.payload = dato[5]; node.send(msg);\n\n\tmsg = {pin: 102, payload: global.get(\"estBomba\")}; node.send([null, null, msg, null]);\n\tmsg = {pin: 104, payload: global.get(\"estResistencia\")}; node.send([null, null, msg, null]);\n\t// msg = {pin: 110, payload: global.get(\"tempTermoFin\")}; node.send([null, null, msg, null]);\n\t// msg = {pin: 111, payload: global.get(\"sensorCrep\")}; node.send([null, null, msg, null]);\n\t// msg = {pin: 112, payload: global.get(\"tempExterior\")}; node.send([null, null, msg, null]);\n\n\n\tmsg= {topic: \"temperaturaTermo\", payload: global.get(\"tempTermoFin\")}; node.send([msg, null, null, null]);\n\tmsg = {pin: 113, payload: global.get(\"tempTermoFin\")}; node.send([null, null, msg, null]);\n\tmsg = {pin: 110, payload: global.get(\"tempTermoFin\") + \"  --  \" + global.get(\"tempExterior\")}; node.send([null, null, msg, null]);\n\n\tmsg= {topic: \"crepuscular\", payload: global.get(\"sensorCrep\")}; node.send([msg, null, null, null]);\n\tmsg = {pin: 111, payload: global.get(\"sensorCrep\")}; node.send([null, null, msg, null]);\n\n\tmsg= {topic: \"temperaturaExterior\", payload: global.get(\"tempExterior\")}; node.send([msg, null, null, null]);\n\tmsg = {pin: 112, payload: global.get(\"tempExterior\")}; node.send([null, null, msg, null]);\t//estBomba\n\n\tmsg= {topic: \"estBomba\", payload: global.get(\"estBomba\")}; node.send([msg, null, null, null]);\n\tmsg= {topic: \"estResistencia\", payload: global.get(\"estResistencia\")}; node.send([msg, null, null, null]);\n\n\tcontrolCrepuscular();\n\tcontrolBomba();\n\n\tif(global.get(\"estResistencia\") === 1){\n\t\tif (context.estAnteriorResistencia === 0){\n\t\t\tcontext.encendidoResistencia = 1;\n\t\t\tcontext.estAnteriorResistencia = 1;\n\t\t\t// global.set(\"resistenciaEncendida\", new Date().getTime());\n\t\t\tcontext.tiempoInicioResistencia = new Date().getTime();}\n\n\t\tvar tiempo = (new Date().getTime() - context.tiempoInicioResistencia) / 60000;\n\t\tvar potencia = ((1.5/60) * tiempo).toFixed(5);\n\t\tglobal.set(\"potenciaResistencia\", potencia);\n\t\t// msg = {topic: \"potResistencia\", payload: global.get(\"potenciaResistencia\")}; node.send([msg, null, null, null]);\n\t}\n\n\tif (global.get(\"estResistencia\") === 0 && context.encendidoResistencia === 1){\n\t\tcontext.estAnteriorResistencia = 0;\n\t\tcontext.encendidoResistencia = 0;\n\t\tvar tiempo = (new Date().getTime() - context.tiempoInicioResistencia) / 60000;\n\t\tvar potencia = ((1.5/60) * tiempo).toFixed(5);\n\t\ttiempo = parseFloat(tiempo).toFixed(2);\n\t\tglobal.set(\"tiempoEncResis\", tiempo);\n\t\tglobal.set(\"potenciaResistencia\", potencia);\n\n\t\t// msg = {topic: \"tiempoEncResis\", payload: global.get(\"tiempoEncResis\")}; node.send([msg, null, null, null]);\n\t\t// msg = {topic: \"potResistencia\", payload: global.get(\"potenciaResistencia\")}; node.send([msg, null, null, null]);\n\t\t// global.set(\"potenciaResistencia\",0);\n\t}\n\t// if (global.get(\"estResistencia\") === \"0\" && context.encendidoResistencia == \"0\"){\n\t// \tmsg = {topic: \"potResistencia\", payload: global.get(\"potenciaResistencia\")}; \n\t// \tnode.send([msg, null, null, null]);}\n\n}\n\nif (topic == \"ESP/TermoSolar/Bomba\"){\n\tif (payload.substring(0, 9) == \"bombaAuto\"){\n\t\tglobal.set(\"autoBomba\", parseInt(payload.substring(9)));\n\t\tmsg = {pin: 101, payload: global.get(\"estBomba\")}; node.send([null, null, msg, null]);\t\t\n\t}\n\tif (payload.substring(0, 11) == \"bombaMarcha\"){\n\t\tglobal.set(\"estBomba\", parseInt(payload.substring(11)));\n\t\tmsg = {pin: 102, payload: global.get(\"estBomba\")}; node.send([null, null, msg, null]);\n\t}\n\t// global.set(\"estBomba\", parseInt(payload));\n\t// msg = {pin: 102, payload: global.get(\"estBomba\")}; node.send([null, null, msg, null]);\n\tcontrolBomba();\n}\n\nif (topic == \"ESP/TermoSolar/pedido\"){\n    var fallasLivingIluminacion = global.get(\"fallasLivingIluminacion\") + 1;\n    global.set(\"fallasLivingIluminacion\", fallasLivingIluminacion);\n    global.set(\"tipoFallaIlLiving\", msg.payload); \n    enviarDatos();}\n\nfunction controlBomba(){\n\tif (global.get(\"estBomba\") === 1 && context.llenandoTermo == 0){\n\t\tcontext.llenandoTermo = 1;\n\t\tglobal.set(\"comienzoLlenado\", new Date().getTime());}\n\tif (global.get(\"estBomba\") === 0 && context.llenandoTermo === 1){\n\t\tcontext.llenandoTermo = 0;\n\t\tvar tiempo = new Date().getTime() - global.get(\"comienzoLlenado\");\n\t\ttiempo = parseFloat(tiempo / 1000).toFixed(2);\n\t\tglobal.set(\"tiempoLlenado\", tiempo);\n\t\tmsg = {topic: \"tiempoLlenado\", payload: global.get(\"tiempoLlenado\")}; node.send([msg, null, null, null]);\n\t\tmsg = {pin: 114, payload: global.get(\"tiempoLlenado\")}; node.send([null, null, msg, null]);\n\t\tmsg = {pin: 105, payload: global.get(\"tiempoLlenado\")}; node.send([null, null, msg, null]);\n\t}\t\n}    \n\nfunction controlCrepuscular(){\n\tif (global.get(\"sensorCrep\") > valorDia && global.get(\"Dia\") === 0){global.set(\"Dia\", 1); msg = {topic: \"ESP/TermoSolar/Crepuscular\", payload: global.get(\"Dia\")}; node.send([null, msg, null, null]);}\n\tif (global.get(\"sensorCrep\") < valorNoche && global.get(\"Dia\") === 1){global.set(\"Dia\", 0); msg = {topic: \"ESP/TermoSolar/Crepuscular\", payload: global.get(\"Dia\")}; node.send([null, msg, null, null]);}\n\t// msg = {topic: \"ESP/TermoSolar/Crepuscular\", payload: global.get(\"Dia\")}; node.send([null, msg, null, null]);\n}\n\nfunction enviarDatos(){   \n\tmsg = {pin: 101, payload: global.get(\"autoBomba\")}; node.send([null, null, msg, null]);\n\tmsg = {pin: 102, payload: global.get(\"pedBomba\")}; node.send([null, null, msg, null]);\n\tmsg = {pin: 104, payload: global.get(\"pedResistencia\")}; node.send([null, null, msg, null]);\n    // msg.payload = topic; node.send([null, msg, null, null]); \n    payload = global.get(\"autoBomba\") + \"#\"; payload += global.get(\"autoResistencia\") + \"#\"; payload += global.get(\"autoToldo\") + \"#\"; \n    payload += global.get(\"pedBomba\") + \"#\"; payload += global.get(\"pedResistencia\") + \"#\"; payload += global.get(\"pedToldo\") + \"#\"; \n    payload += global.get(\"tempMaximaTermo\") + \"#\"; payload += global.get(\"tempMaxResistencia\") + \"#\"; \n    payload += global.get(\"tempMaxResistenciaManual\") + \"#\"; payload += global.get(\"tempMinimaResistencia\") + \"#\";\n    payload += global.get(\"valorDia\")  + \"#\"; payload += global.get(\"valorNoche\") + \"#\" + global.get(\"segundosMarchaBomba\") + \"#\";\n    payload += global.get(\"offsetDia\")  + \"#\"; payload += global.get(\"offsetNoche\");\n    msg.payload = payload;  \n    msg.topic = \"ESP/TermoSolar/Config\";\n    node.send([null, msg, null, null]);}","outputs":4,"noerr":0,"x":455,"y":120,"wires":[["540adc68.85f1a4","43e727a2.f0f9e8"],["405016a2.5b5178","2ef0894a.4f29a6"],["c2e9aa8f.549168","fc135b52.7e6988"],[]]},{"id":"9cbc0b2c.31d848","type":"mqtt in","z":"50119c6e.6ff584","name":"","topic":"ESP/Pasillo/Sens/Temp/Resp","qos":"2","broker":"e779f8d6.7bc2c8","x":269.2856197357178,"y":457.1428384780884,"wires":[["c135bb3f.7eae98"]]},{"id":"5bd7492f.2e1e38","type":"inject","z":"a89e305a.c50bb","name":"","topic":"ESP/living/Iluminacion/Envio","payload":"1#1#1","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":873.3730163574219,"y":592.15087890625,"wires":[["6d3158ca.fee558"]]},{"id":"5fae0180.0724f","type":"function","z":"f682d492.22a758","name":"","func":"msg.filename = \"/home/gaston/BackUp-Node-Red/flow_cred.json\";\nreturn msg;\n","outputs":1,"noerr":0,"x":593,"y":126,"wires":[["9e25b334.c4563"]]},{"id":"458559fe.24ae48","type":"http request","z":"e364a467.07a6a8","name":"","method":"GET","ret":"txt","url":"https://banco.santanderrio.com.ar/exec/cotizacion/index.jsp","tls":"","x":415.7896270751953,"y":345.66669434309006,"wires":[["eaaae07.822762","ab59ea94.49c4f8","3512364.5d54eca","57099265.b5d4fc"]]},{"id":"482b7a57.e2a944","type":"blynk-ws-out-set-property","z":"3ce5b54a.127d6a","name":"","pin":0,"pinmode":"1","prop":"bycode","client":"2c18e412.5f5cbc","x":2087.4522857666016,"y":177.64284678867887,"wires":[]},{"id":"ea323d6b.c8d47","type":"function","z":"a89e305a.c50bb","name":"","func":"if (global.get(\"cambiosIsla\") === undefined)global.set(\"cambiosIsla\", 0);\nif (global.get(\"cambiosCielorrazo\") === undefined)global.set(\"cambiosCielorrazo\", 0);\nif (global.get(\"cambiosRGB\") === undefined)global.set(\"cambiosRGB\", 0);\n\nif (msg.topic === \"consulta\"){enviar();}\n\nif (msg.topic === \"borrar\"){\n\tglobal.set(\"cambiosIsla\", 0);\n\tglobal.set(\"cambiosCielorrazo\", 0);\n\tglobal.set(\"cambiosRGB\", 0);\n\tenviar();\n}\n\n\nfunction enviar(){\n    msg = {pin: 62, payload: global.get(\"cambiosIsla\")}; node.send(msg);\n    msg = {pin: 63, payload: global.get(\"cambiosCielorrazo\")}; node.send(msg);\n    msg = {pin: 64, payload: global.get(\"cambiosRGB\")}; node.send(msg);\n    return;\n\n}","outputs":1,"noerr":0,"x":703.7500114440918,"y":1128.2500174045563,"wires":[["dc6474be.3fcdc8","aab58d9c.e9111"]]},{"id":"ad32a3ef.f9497","type":"blynk-ws-in-write","z":"3ce5b54a.127d6a","name":"llenar tanque","pin":"34","pin_all":false,"client":"2c18e412.5f5cbc","x":2593.6310653686523,"y":335.6071529388428,"wires":[["7385d352.01625c"]]},{"id":"ade9be8d.171c7","type":"http in","z":"7ac92c99.66ea94","name":"Request","url":"/activar","method":"post","upload":false,"swaggerDoc":"","x":144.95236682891846,"y":101.66666412353516,"wires":[["f80091fc.1ea"]]},{"id":"8f6bdb58.8e4158","type":"function","z":"e6e33852.2495f8","name":"","func":"var payload = msg.payload;\nvar resultado;\ncontext.descarga = context.descarga || 0;\ncontext.subida = context.subida || 0;\n\nif(payload == \".\")payload = \"Realizando medicion\";\nnode.status({text: \"Estado actual: \" + msg.payload});\nif (payload.includes(\"Download\")){\n    context.descarga = parseFloat(payload.substring(payload.indexOf(\"Download: \")+10, payload.indexOf(\"Mbit/s\")));\n    // msg = {topic: \"DescargaFast\", payload: context.descarga}; node.send([null, null, msg, null]);\n    // node.status({text: resultado});\n    }\n\nif (payload.includes(\"Upload\")){\n    context.subida = parseFloat(payload.substring(payload.indexOf(\"Upload: \")+8, payload.indexOf(\"Mbit/s\")));\n    // msg = {topic: \"SubidaFast\", payload: context.subida}; node.send([null, null, msg, null]);\n    // node.status({text: resultado});\n    }    \nif (payload.includes(\"Share results\")){\n    resultado = payload.substring(payload.indexOf(\"Share results\")+15);\n    node.status({text: resultado});\n    msg = {pin: 70, payload: global.get(\"DescargaFast\") + \" -- \" + global.get(\"SubidaFast\")}; node.send([null, null, null, msg]);\n    msg = {pin: 71, payload: context.descarga + \" -- \" + context.subida}; node.send([null, null, null, msg]);\n    msg = {pin: 72, payload: global.get(\"DescargaFast\")}; node.send([null, null, null, msg]);\n    msg = {pin: 73, payload: global.get(\"SubidaFast\")}; node.send([null, null, null, msg]);\n    msg = {pin: 74, payload: context.descarga}; node.send([null, null, null, msg]);\n    msg = {pin: 75, payload: context.subida}; node.send([null, null, null, msg]);\n    msg = {topic: \"DescargaFast\", payload: global.get(\"DescargaFast\")}; node.send([null, null, msg, null]);\n    msg = {topic: \"SubidaFast\", payload: global.get(\"SubidaFast\")}; node.send([null, null, msg, null]);\n    msg = {topic: \"DescargaFiber\", payload: context.descarga}; node.send([null, null, msg, null]);\n    msg = {topic: \"SubidaFiber\", payload: context.subida}; node.send([null, null, msg, null]);\n    msg.payload = global.get(\"fechaCompleta\") + \" -- \" + resultado; return msg;\n}\nif (payload.includes(\"error\") || payload.includes(\"Error\")){\n    msg.payload = global.get(\"fechaCompleta\") + \" -- \" + \"Falla de conexion\"; \n    node.send([msg, null]);\n    return ([null, msg])\n}// return msg;","outputs":4,"noerr":0,"x":497.44441986083984,"y":383.4444236755371,"wires":[["d1094e09.0048f","94219c12.04844"],["89e0166f.74bba8"],["6e949be8.c70644"],["cfe8aa20.5a0e18","ba239006.7d4a6"]]},{"id":"c6ce670d.77b0d8","type":"delay","z":"f682d492.22a758","name":"","pauseType":"delay","timeout":"15","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":731.6666946411133,"y":210.00000953674316,"wires":[["eef57e3.f227e8"]]},{"id":"67f8c992.eca988","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1690.9049677167618,"y":460.99995061329435,"wires":[["7dcbb7b3.a73cc8"]]},{"id":"895329af.f7c068","type":"mqtt out","z":"7ac92c99.66ea94","name":"","topic":"","qos":"","retain":"","broker":"43555c62.30ed34","x":654.6190614700317,"y":121.99999570846558,"wires":[]},{"id":"12fe5170.f844af","type":"blynk-ws-out-notify","z":"f682d492.22a758","name":"","client":"2c18e412.5f5cbc","queue":false,"rate":15,"x":508.5475769042969,"y":263.6666717529297,"wires":[]},{"id":"3c3e448b.d778bc","type":"debug","z":"e364a467.07a6a8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":756.5277633666992,"y":528.9999980926514,"wires":[]},{"id":"91f72a58.95b0d8","type":"blynk-ws-in-write","z":"3ce5b54a.127d6a","name":"","pin":"35","pin_all":0,"client":"2c18e412.5f5cbc","x":2892.9166717529297,"y":436.5,"wires":[["cf15164b.cd4698"]]},{"id":"e0c7593f.c89d28","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"","payloadType":"str","repeat":"1","crontab":"","once":false,"onceDelay":0.1,"x":1400.8333206176758,"y":712.0953057152884,"wires":[["16c661b6.92124e"]]},{"id":"cdcb7476.bfa268","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"USBout","qos":"2","broker":"c339edbf.39572","x":335.92857360839844,"y":741.0476684570312,"wires":[["22061400.194d3c","d595988a.3e9458","42bf6e98.eba1a"]]},{"id":"a5c52eba.0fcbf","type":"blynk-ws-out-write","z":"50119c6e.6ff584","name":"","pin":"23","pinmode":0,"client":"2c18e412.5f5cbc","x":731.4285163879395,"y":560.0000371932983,"wires":[]},{"id":"fef1bdab.7dba","type":"function","z":"7ac92c99.66ea94","name":"regula potencia (Nuevo)","func":"var payload = msg.payload;\nvar estado = msg.estado;\nvar minimo = 6;\nvar maximo = 255;\n\n// if (!payload.includes(\"living\")) return;\nif (payload.includes(\"luces\") || payload.includes(\"luz\")){\n\tif (payload.includes(\"living\")){\n\t\tvar potencia;\n\t\tpotencia = payload.replace(/\\D/g,'');\n\t\tpotencia = parseInt(potencia * 255 / 100);\n\t\tif (payload.includes(\"minimo\") || payload.includes(\"mÃ­nimo\"))var potencia = minimo;\n\t\tif (payload.includes(\"maximo\") || payload.includes(\"mÃ¡ximo\"))var potencia = maximo;\n\t\tif (payload.includes(\"isla\")){\n\t\t\tglobal.set(\"potIsla\", potencia);\n\t\t\tmsg = {topic: \"google/Living\", payload: \"estIsla= \" + global.get(\"estIsla\")};\n\t\t\treturn msg;\n\t\t}\n\t\tif (payload.includes(\"cielo raso\")){\n\t\t\tglobal.set(\"potCielorrazo\", potencia);\n\t\t\tmsg = {topic: \"google/Living\", payload: \"estCielorrazo= \" + global.get(\"estCielorrazo\")};\n\t\t\treturn msg;\n\t\t}\n\t\tglobal.set(\"potLiving\", potencia);\n\t\tglobal.set(\"potIsla\", potencia);\n\t\tglobal.set(\"potCielorrazo\", potencia);\n\t\tmsg = {topic: \"google/Living\", payload: \"estCielorrazo= \" + global.get(\"estCielorrazo\")};\n\t\treturn msg;\n\t}\n}\n","outputs":1,"noerr":0,"x":354.5239067077637,"y":637.869119644165,"wires":[["69d71644.c47cf8","9600b95a.280848"]]},{"id":"555ec2f4.286b7c","type":"mqtt out","z":"a89e305a.c50bb","name":"","topic":"ESP/living/Iluminacion/beep","qos":"","retain":"","broker":"6b36e4a.1d30b1c","x":1438.0952758789062,"y":379.8571262359619,"wires":[]},{"id":"11066e30.40f7a2","type":"inject","z":"3ce5b54a.127d6a","name":"pulso","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":true,"onceDelay":"2","x":1617.4528427124023,"y":154.2975823538644,"wires":[[]]},{"id":"6b8f267f.3678e8","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg.payload = global.get(\"estadocargadorTexto\");\nreturn msg;","outputs":1,"noerr":0,"x":2549.8331909179688,"y":1323.7856649671285,"wires":[["553e2b0e.e02dc4"]]},{"id":"76b52647.aa3998","type":"blynk-ws-in-write","z":"50119c6e.6ff584","name":"","pin":0,"pin_all":false,"client":"2c18e412.5f5cbc","x":139.28562355041504,"y":184.28571796417236,"wires":[["4a3045c9.61c37c","5250bb5a.8163c4"]]},{"id":"bd6b96af.2bd918","type":"blynk-ws-out-write","z":"3ce5b54a.127d6a","name":"","pin":0,"pinmode":"1","client":"2c18e412.5f5cbc","x":888.5951385498047,"y":254.57141753605435,"wires":[]},{"id":"4d17c91.04f5338","type":"delay","z":"7ac92c99.66ea94","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":437.95236682891846,"y":165,"wires":[["e06c23ee.4ad0f"]]},{"id":"ba239006.7d4a6","type":"debug","z":"e6e33852.2495f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":680.2222518920898,"y":425.11111068725586,"wires":[]},{"id":"7afba1dc.2c28","type":"file","z":"a89e305a.c50bb","name":"borrar archivo","filename":"/home/gaston/BackUp-Node-Red/estLiving.txt","appendNewline":true,"createDir":false,"overwriteFile":"delete","x":541.2500076293945,"y":1179.5000171661377,"wires":[[]]},{"id":"b2dcf0c4.a8898","type":"debug","z":"7ac92c99.66ea94","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":736.4047136306763,"y":414.5000057220459,"wires":[]},{"id":"653c1297.2d7cbc","type":"http in","z":"7ac92c99.66ea94","name":"Request","url":"/desactivar","method":"post","upload":false,"swaggerDoc":"","x":149.6190309524536,"y":150.33331871032715,"wires":[["5975772b.bee358"]]},{"id":"154aa712.21f669","type":"function","z":"a89e305a.c50bb","name":"potencia","func":"msg = {topic: \"Blink/potencia\", payload: msg.payload};\nif (parseInt(global.get(\"itemPotencia\")) > 0 && parseInt(global.get(\"itemPotencia\")) <= 4)return msg;","outputs":1,"noerr":0,"x":358.1865234375,"y":437.9206552505493,"wires":[["cce091cd.a69e5","4f93da66.796464"]]},{"id":"8512c42f.121218","type":"http in","z":"7ac92c99.66ea94","name":"regular luces","url":"/regularluces","method":"post","upload":false,"swaggerDoc":"","x":112,"y":639.8571300506592,"wires":[["fef1bdab.7dba","b9da22c6.5cd6f"]]},{"id":"2d13b22d.35e53e","type":"function","z":"e364a467.07a6a8","name":"root","func":"var date = new Date();\nvar frecuencia = 5;\nvar dia = date.getDay();\nvar hh = date.getHours();\nvar mm = date.getMinutes();\nvar ss = date.getSeconds();\nvar tiempo = mm % frecuencia;\nnode.status({text: hh + \":\" + mm + \":\" + ss + \" - \" + tiempo + \" - \" + dia});\nif (dia !== 0 && dia !== 6 && ss === 0 && tiempo === 0){\n\tif (hh > 9 && hh < 18) return msg;\n} \n// if (ss === 0 && tiempo === 0) return msg;\n//){//hh > 9 && hh < 17 && \n //   if (ss === 0 && tiempo === 0) return msg;\n    // if (ss === 0 && tiempo === 0) return msg;\n// }","outputs":1,"noerr":0,"x":262.194393157959,"y":343.17859172821045,"wires":[["458559fe.24ae48"]]},{"id":"8b70f289.5be5e","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":2606.5124130249023,"y":162.02380752563477,"wires":[["be0dfdbd.fac73"]]},{"id":"342a27c4.449eb8","type":"inject","z":"1b403a13.0ec8c6","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":"10","x":640,"y":270,"wires":[["b9be6c79.7a2d3"]]},{"id":"a9ae9e1e.01ed5","type":"mqtt out","z":"3ce5b54a.127d6a","name":"","topic":"","qos":"","retain":"","broker":"c339edbf.39572","x":2995.094249725342,"y":736.357154573713,"wires":[]},{"id":"530c2928.537068","type":"debug","z":"a89e305a.c50bb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":919.202392578125,"y":542.6071472167969,"wires":[]},{"id":"d9044cfd.00888","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg = {topic: \"tempBat2\", payload: global.get(\"tempBat2\")}; node.send(msg);\n","outputs":1,"noerr":0,"x":2539.3095474243164,"y":968.3094975607736,"wires":[["95ff630c.c1ed8"]]},{"id":"dc1874f6.726c08","type":"mqtt in","z":"50119c6e.6ff584","name":"","topic":"USBin/temExterior","qos":"2","broker":"e779f8d6.7bc2c8","x":259.8412208557129,"y":654.4444723129272,"wires":[["702341e5.2cb2e","b31fbc78.d2c28"]]},{"id":"f22de0a2.1bb7f","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1467.119529724121,"y":416.44044085911344,"wires":[["ae746686.8cad28"]]},{"id":"b9da22c6.5cd6f","type":"debug","z":"7ac92c99.66ea94","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":337.45236682891846,"y":682.5,"wires":[]},{"id":"dd1ac792.79ebe8","type":"function","z":"a89e305a.c50bb","name":"estLiving","func":"// if (msg.payload === \"false\"){msg.payload = 0;}else{msg.payload = 1;}\nmsg = {topic: \"Blink/estLiving\", payload: msg.payload};\nreturn msg;","outputs":1,"noerr":0,"x":365.23807525634766,"y":205.57143306732178,"wires":[["cce091cd.a69e5","4f93da66.796464"]]},{"id":"2b2d90d9.6b9ae","type":"mqtt out","z":"a89e305a.c50bb","name":"","topic":"","qos":"","retain":"","broker":"6b36e4a.1d30b1c","x":697.2023429870605,"y":619.1071515083313,"wires":[]},{"id":"2aaab111.aa444e","type":"debug","z":"1b403a13.0ec8c6","name":"fallas mqtt termo","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":784,"y":239,"wires":[]},{"id":"cfa04e60.45c03","type":"function","z":"a89e305a.c50bb","name":"estCielorrazo","func":"msg = {topic: \"Blink/estCielorrazo\", payload: msg.payload};\nreturn msg;","outputs":1,"noerr":0,"x":362.49208068847656,"y":286.2063388824463,"wires":[["cce091cd.a69e5","4f93da66.796464"]]},{"id":"bc69938b.7eab8","type":"inject","z":"1b403a13.0ec8c6","name":"","topic":"ESP/TermoSolar/pedido","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":210,"y":20,"wires":[["34ae7c41.536534"]]},{"id":"639261cf.d4e65","type":"function","z":"3ce5b54a.127d6a","name":"Original (No Borrar)","func":"context.pruebas = context.pruebas || 0;\nvar haciendoPruebas;\n\nvar frecuenciaDatos = 5;\n// var vMin = 11.0;\n// var vMax = 13.8;\nvar vEmerg = 15.5;\n// {\"topic\":\"Baterias/Est/Pedido/Resp\",\"bat1\":-127.00,\"bat2\":-127.00,\"bat3\":-127.00,\"bat4\":-127.00,\"bat5\":38.50,\"ambBat\":38.92,\"nivTanque\":0,\"volt\":3.72}\n//{\"topic\":\"Crep\",\"payload\":1}.\n//{\"topic\":\"Alarma/Disparo\",\"payload\":0}\n//{\"topic\":\"{\"topic\":\"Baterias/Est/Pedido/Resp\",\"bat1\":-127.00,\"bat2\":-127.00,\"bat3\":-127.00,\"bat4\":-127.00,\"bat5\":38.50,\"ambBat\":38.92,\"nivTanque\":0,\"volt\":3.72}\n//{\"topic\":\"Crep\",\"payload\":1}.\n//{\"topic\":\"Alarma/Disparo\",\"payload\":0}\n//{\"topic\":\"Toldo\",\"payload\":0}\n//{\"topic\":\"Alarma/Activacion\",\"payload\":1}\n// salida 1 serial\n// salida 2 blynk  pin = 0 notificaciones  --  pin 1= led alarma  --  pin2= boton alarma  --  pin3= linea 1 LCD -- pin4= linea 2 LCD\n// salida 3 mysql\nvar dato = JSON.parse(msg.payload);\ncontext.inicioCrep = context.inicioCrep || 0;\nvar difTempEmergencia = 25;\nvar avisoBat = [];\nvar date = new Date();\nvar hh = date.getHours();\nvar mm = date.getMinutes();\nvar ss = date.getSeconds();\nvar dia = date.getDate();\nvar mes = date.getMonth();\nvar ano = date.getFullYear();\ncontext.hsAnterior = context.hsAnterior || 0;\ncontext.enviado = context.enviado || 0;\n\ncontext.Voltaje = context.Voltaje || null;\ncontext.Bat1 = context.Bat1 || null;\ncontext.Bat2 = context.Bat2 || null;\ncontext.Bat3 = context.Bat3 || null;\ncontext.Bat4 = context.Bat4 || null;\ncontext.Bat5 = context.Bat5 || null;\ncontext.Bat6 = context.Bat6 || null;\ncontext.tempAmbienteBat = context.tempAmbienteBat || null;\ncontext.nivelTanque = context.nivelTanque || null;\ncontext.contador = context.contador ||0;\ncontext.avisoMail = context.avisoMail ||0;\ncontext.avisoTanque = context.avisoTanque ||0;\ncontext.minAnt = context.minAnt || 0;\ncontext.mesAnt = context.mesAnt || mes;\ncontext.diaAnt = context.diaAnt || dia;\ncontext.estadoCargador = context.estadoCargador || 0\ncontext.cargarToldo = context.cargarToldo || 0\n\n// node.status({text: hh+\":\"+mm+\":\"+ss+\"  -  \" + context.hsAnterior})\nvar tiempo = mm % frecuenciaDatos;\nnode.status({text: hh + \":\"+ mm +\":\" + ss + \"  -  \" + context.contador + \"  --  \" + context.tempAmbienteBat});\n\nif (dato.topic == \"most\"){msg.payload = \"{\\\"topic\\\":\\\"most\\\",\\\"payload\\\":\" + dato.payload + \"\\\"}\"; node.send([null, msg, null, null, null, null])}\nif (dato.topic == \"rele0\"){msg.payload = \"{\\\"topic\\\":\\\"rele0\\\",\\\"payload\\\":\" + dato.payload + \"\\\"}\"; node.send([null, msg, null, null, null, null])}\nif (dato.topic == \"rele1\"){msg.payload = \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\":\" + dato.payload + \"\\\"}\"; node.send([null, msg, null, null, null, null])}\nif (dato.topic == \"Alarma\"){msg.payload = \"{\\\"topic\\\":\\\"Alarma\\\",\\\"payload\\\":\" + dato.payload + \"\\\"}\"; node.send([null, msg, null, null, null, null])}\nif (dato.topic == \"info\"){msg.payload = \"{\\\"topic\\\":\\\"info\\\",\\\"payload\\\":\" + dato.payload + \"\\\"}\"; node.send([null, msg, null, null, null, null])}\n\nif (dato.topic == \"altTanque\"){msg.payload = \"{\\\"topic\\\":\\\"altTanque\\\",\\\"payload\\\":\" + dato.payload + \"\\\"}\"; node.send([null, msg, null, null, null, null])}\nif (dato.topic == \"minTanque\"){msg.payload = \"{\\\"topic\\\":\\\"minTanque\\\",\\\"payload\\\":\" + dato.payload + \"\\\"}\"; node.send([null, msg, null, null, null, null])}\nif (dato.topic == \"maxTanque\"){msg.payload = \"{\\\"topic\\\":\\\"maxTanque\\\",\\\"payload\\\":\" + dato.payload + \"\\\"}\"; node.send([null, msg, null, null, null, null])}\n\nif (dato.topic == \"infoArduino\"){msg = {topic: \"infoArduino\", payload: msg.payload}; node.send([msg, null, null, null, null, null])}\n\nif (dato.nivel < 90 && context.avisoTanque === 1) context.avisoTanque = 0;\n\nif (ss === 0){\n\tglobal.set(\"hsGlobal\", hh + \":\" + mm);\n\tif (context.minAnt !== mm){\n\t\tcontext.minAnt = mm;\n\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; node.send([msg, null, null, null, null, null, null]);\n\t\t// mostrarLcd();\n\t}\n\tif (context.mesAnt !== mes && hh === 0 && mm === 0 && context.avisoMail === 0){mandarBackUpMail(); context.mesAnt = 0;}\n\tif (tiempo === 0 && context.enviado === 0){\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"Baterias/Est/Pedido\\\",\\\"payload\\\":1}\"; \n\t\tnode.send([null, msg, null, null, null, null, null]); \n\t\tcontext.enviado = 1;\n\t\treturn;}\n}\nelse{\n\tcontext.enviado = 0;\n\tcontext.avisoMail= 0;\n}\n\n// if (global.get(\"estadoToldo\") === \"Abriendo\"  || global.get(\"estadoToldo\") == \"Cerrando\"){\n// \t\tif (context.cargarToldo == 0){\n// \t\t\tcontext.cargarToldo = 1;\n// \t\t\tmsg = {payload: \"{\\\"topic\\\":\\\"rele0\\\",\\\"payload\\\":1}\"};\n// \t\t\tnode.send([null, msg, null, null, null, null]);}\n// \t}\n// \telse{\n// \t\tif (context.cargarToldo == 1){\n// \t\t\tcontext.cargarToldo = 0;\n// \t\t\tmsg = {payload: \"{\\\"topic\\\":\\\"rele0\\\",\\\"payload\\\":0}\"};\n// \t\t\tnode.send([null, msg, null, null, null, null]);}\n// \t}\n\n\nif (msg.topic == \"consultaCrep\"){msg = {topic : \"SELECT * FROM crepuscular ORDER BY hora Asc\"}; return ([null, null, null, null, msg, null]);}\nif (msg.topic == \"borrarCrep\"){msg = {topic : \"DELETE FROM `crepuscular` WHERE 1\"}; return ([null, null, null, null, msg, null]);}\n\nif (msg.topic == \"actualizarDisplay\"){\n\tmsg = {topic: \"Blynk/actualizar/Baterias\", payload: 1}; \n\tnode.send([msg, null, null, null, null, null, null]);}\n\nif (msg.topic == \"toldoAbrirBlynk\"){\n\tif (msg.payload == 1){msg.payload = 2;} else{msg.payload = 0;}\n\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":\" + msg.payload + \"}\";\n\tnode.send([null, msg, null, null, null, null]);\n}\n\nif (msg.topic == \"toldoCerrarBlynk\"){\n\tif (msg.payload == 1){msg.payload = 4;} else{msg.payload = 0;}\n\tmsg.payload = \"{\\\"topic\\\":\\\"toldo\\\",\\\"payload\\\":\" + msg.payload + \"}\";\n\tnode.send([null, msg, null, null, null, null]);\n}\n\nif (msg.topic == \"enfriarToldoBlynk\"){global.set(enfriarToldo, msg.apyload);}\n\nif (global.get(\"enfriarToldo\") === 1){\n\tif (context.hsAnterior !== hh && mm === 0 && ss === 0 && global.get(\"mojandoToldo\") === 0){\n\t\tglobal.set(\"mojandoToldo\", 1);\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 1}\";\n\t\tnode.send([null, msg, null, null, null, null]);\n\t\tcontext.hsAnterior = hh;\n\t\tnode.status({text: context.hsAnterior});\n\t}\n\tif (global.get(\"mojandoToldo\") === 1 && mm === global.get(\"tiempoMojadoToldo\") && ss === 0){\n\t\tglobal.set(\"mojandoToldo\", 0);\n\t\tmsg.payload = \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 0}\";\n\t\tnode.send([null, msg, null, null, null, null]);\n\t}\n}\nif (global.get(\"enfriarToldo\") === 0){\n\tglobal.set(\"mojandoToldo\" , 0);\n\tmsg.payload = \"{\\\"topic\\\":\\\"rele1\\\",\\\"payload\\\": 0}\"; \n\tnode.send([null, msg, null, null, null, null]);\n}\n\nif (dato.topic == \"Toldo\"){\n\tswitch (dato.payload){\n\t\tcase 0:\n\t\t\t// msg = {pin: 2, payload: \"Parado\"}; node.send([null, null, msg, null, null, null]);\n\t\t\t// msg = {pin: 3, payload: \"Parado\"}; node.send([null, null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Parado\", pin: 4};\n\t\tbreak;\n\t\tcase 1:\t\n\t\t\t// msg = {pin: 2, payload: \"Abriendo\"}; node.send([null, null, msg, null, null, null]);\t\n\t\t\tmsg = {payload: \"Abriendo\", pin: 4};\n\t\tbreak;\n\t\tcase 2:\n\t\t\tmsg = {pin: 2, payload: 0}; node.send([null, null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Abierto\", pin: 4};\n\t\tbreak;\n\t\tcase 3:\n\t\t\t\t\t// msg = {pin: 2, payload: \"Abriendo\"}; node.send([null, null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Cerrando\", pin: 4};\n\t\tbreak;\n\t\tcase 4:\n\t\t\tmsg = {pin: 3, payload: 0}; node.send([null, null, msg, null, null, null]);\n\t\t\tmsg = {payload: \"Cerrado\", pin: 4};\n\t\tbreak;\n\t}\n\tglobal.set(\"estadoToldo\", msg.payload);\n\tmsg = {topic: \"Blynk/actualizar/toldo\", payload: 1}; node.send([msg, null, null, null, null, null, null]);\n}\n\n\nif (msg.topic == \"infCompleta\"){\n\t\tmsg = {topic: \"Blynk/actualizar/Baterias\", payload: 1}\n\t\tnode.send([msg, null, null, null, null, null]);}\n\nif (msg.topic == \"mandarMail\")mandarBackUpMail();\n\nif (msg.topic == \"alarmaBlynk\"){\n\tmsg.payload = \"{\\\"topic\\\":\\\"Alarma\\\",\\\"payload\\\":\" + msg.payload + \"}\";\n\tnode.send([null, msg, null, null, null, null]);\n}\n\nif (dato.topic === \"niveles\"){\n\tmsg = {topic: \"distancia\", payload: dato.dist};\n\tnode.send(msg, null, null, null, null, null);\n\tmsg = {topic: \"altAgua\", payload: dato.altAgua};\n\tnode.send(msg, null, null, null, null, null);\n\tmsg = {topic: \"nivMinimo\", payload: dato.nivMinimo};\n\tnode.send(msg, null, null, null, null, null);\n\tmsg = {topic: \"nivMaximo\", payload: dato.nivMaximo};\n\tnode.send(msg, null, null, null, null, null);\n\tmsg = {topic: \"nivel\", payload: dato.nivel + \"%\"};\n\tnode.send(msg, null, null, null, null, null);\n\tglobal.set(\"nivTanque\", dato.nivel); \n\tmsg = {topic: \"altTanque\", payload: dato.altTanque};\n\tnode.send(msg, null, null, null, null, null);\n\tmsg = {topic: \"crepuscular\", payload: dato.crepuscular};\n\tnode.send(msg, null, null, null, null, null);\n\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; node.send([msg, null, null, null, null, null, null]);\n}\n\nif (dato.topic == \"Baterias/Est/Pedido/Resp\"){\n\tcontext.contador++;\t\n\tglobal.set(\"tempBat1\", dato.bat1.toFixed(1)); context.Bat1 += dato.bat1; if (global.get(\"tempBat1\") > difTempEmergencia + dato.tempAmb){avisoBat[1] = 1; avisoBaterias(1);}\n\tglobal.set(\"tempBat2\", dato.bat2.toFixed(1)); context.Bat2 += dato.bat2; if (global.get(\"tempBat2\") > difTempEmergencia + dato.tempAmb){avisoBat[2] = 1; avisoBaterias(2);}\n\tglobal.set(\"tempBat3\", dato.bat3.toFixed(1)); context.Bat3 += dato.bat3; if (global.get(\"tempBat3\") > difTempEmergencia + dato.tempAmb){avisoBat[3] = 1; avisoBaterias(3);}\n\tglobal.set(\"tempBat4\", dato.bat4.toFixed(1)); context.Bat4 += dato.bat4; if (global.get(\"tempBat4\") > difTempEmergencia + dato.tempAmb){avisoBat[4] = 1; avisoBaterias(4);}\n\tglobal.set(\"tempBat5\", dato.bat5.toFixed(1)); context.Bat5 += dato.bat5; if (global.get(\"tempBat5\") > difTempEmergencia + dato.tempAmb){avisoBat[5] = 1; avisoBaterias(5);}\n\tglobal.set(\"tempAmbienteBat\", dato.ambBat.toFixed(1)); context.tempAmbienteBat += dato.ambBat; \n\tglobal.set(\"nivTanque\", dato.nivTanque);  context.nivTanque += dato.nivTanque;\n\tglobal.set(\"voltajeBaterias\", dato.volt.toFixed(1)); context.Voltaje += dato.volt;// controlarVoltaje(global.get(\"voltajeBaterias\")); \n\tif (global.get(\"voltajeBaterias\") > vEmerg) {avisoBat[6] = 1; avisoBaterias(6);}\t\n\tif (global.get(\"voltajeBaterias\") < 10) {avisoBat[6] = 1; avisoBaterias(6);}\n\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; node.send([msg, null, null, null, null, null, null]);\n\t// mostrarLcd();\n\n\tif (context.contador === 6){\n\t\tvar mysql = \"INSERT INTO \\`Baterias\\`(\\`Fecha\\`, \\`Voltaje\\`, \\`tempBat1\\`, \\`tempBat2\\`, \\`tempBat3\\`, \\`tempBat4\\`, \\`tempBat5\\`, \\`tempBat6\\`, \\`tempAmbienteBaterias\\`)\"; \n\t\tmysql += \"VALUES (now() ,\" + context.Voltaje / context.contador + \",\" + context.Bat1 / context.contador + \",\" + context.Bat2 / context.contador + \",\";\n\t\tmysql += context.Bat3 / context.contador + \",\" + context.Bat4 / context.contador + \",\";\n\t\tmysql += context.Bat5 / context.contador + \", \" + context.Bat6 / context.contador + \", \";\n\t\tmysql += context.tempAmbienteBat / context.contador + \")\";\n\t\tmsg.topic = mysql;\n\t\tnode.send([null, null, null, null, msg, null]);\n\t\tcontext.Voltaje = 0; context.Bat1 = 0; context.Bat2 = 0; context.Bat3 = 0; context.Bat4 = 0; context.Bat5 = 0;\n\t\tcontext.tempAmbienteBat = 0; context.nivTanque = 0; context.contador = 0;\n\t}\n\tmsg = {topic: \"Actualizacion/Baterias\", payload:\"\"}; node.send([msg, null, null, null, null, null]);\n}\n\nif (dato.topic == \"Crep\"){// payload == valor analogico dia/noche\n\tif (context.pruebas == 1) {context.pruebas = 0; return;}\n\tif (dato.payload === 1) {\n\t\tglobal.set(\"hsAmanecer\",  hh + \":\" + mm + \":\" + ss);\n\t\tmsg = {payload: \"Se hizo de dia \" + global.get(\"hsAmanecer\")}; node.send([null, null, null, msg, null, null]);\n\t}\n\tif (dato.payload === 0) {\n\t\tglobal.set(\"hsAnochecer\",  hh + \":\" + mm + \":\" + ss);\n\t\tmsg = {payload: \"Se hizo de noche \" + global.get(\"hsAnochecer\")}; node.send([null, null, null, msg, null, null]);\n\t}\n\tglobal.set(\"estadoCrepuscular\", dato.payload);\n\tmsg = {topic: \"INSERT INTO \\`crepuscular\\`(\\`hora\\`, \\`valor\\`) VALUES (now(),\" + dato.payload + \")\"};\n\tnode.send ([null,null,null, null, msg, null]);\n}\n\nif (dato.topic === \"nivel\"){\n\tglobal.set(\"nivTanque\", dato.nivTanque);\n\tmsg = {topic: \"Actualizacion/Baterias\", payload:\"\"}; node.send([msg, null, null, null, null, null]);\n\tmsg = {topic: \"Blynk/actualizar/estado\", payload:\"\"}; node.send([msg, null, null, null, null, null]);}\n\nif (dato.nivel >= 100 && context.avisoTanque === 0){\n\tmsg = {payload:\"tanque lleno\"};//, pin: 0};\n\tnode.send([null, null, null, msg, null, null]);\n\tcontext.avisoTanque = 1;}\n\nif (dato.topic === \"llenarTanque\"){global.set(\"llenarTanque\", msg.payload);}\n\nif (dato.topic == \"Alarma/Activacion\"){\n\tglobal.set(\"estadoAlarma\", dato.payload); \n\tif (global.get(\"estadoAlarma\") == 1){\n\t    msg = {payload: 1, color: \"#f5d86b\", pin: 1}; node.send([null, null, msg, null, null, null]);\n\t    // msg = {payload: 140, color: \"#f5d86b\", pin: 0}; node.send([null, null, msg, null, null, null]);\n\t}\n    else{\n\t    msg = {payload: 0, color: \"#23C48E\", pin: 1}; node.send([null, null, msg,null, null, null]);\n\t    // msg = {payload: 128, color: \"#23C48E\", pin: 0}; node.send([null, null, msg,null, null, null]);\n\t    }\n}\n\nif (dato.topic == \"Alarma/Disparo\"){\n\tif (dato.payload === 1){\n\t\tmsg = {payload: 1, color: \"#cc0000\", pin: 1}; node.send([null, null, msg, null, null, null]);\n\t\tglobal.set(\"disparoAlarma\", 1);\n\t\tmsg = {payload: \"Se disparo Alarma en casa\"};//, pin: 0}\n\t}\n\tif (dato.payload === 0){\n\t\tglobal.set(\"disparoAlarma\", 0);\n\t\tmsg = {payload: 0, color: \"#23C48E\", pin: 1}; node.send([null, null, msg, null, null, null]);\t\t\n\t\t// msg = {payload: 0, pin: 10}; node.send([null, null, msg, null, null, null]);\n\t\tmsg = {payload: \"Se normalizo Alarma en casa\"};//, pin: 0}\n\t}\n\tnode.send([null, null, null, msg, null, null]);\n}\n\nif (dato.topic == \"Cargador\"){\n\tglobal.set(\"estadoCargador\", dato.payload);\n\tglobal.set(\"voltajeBaterias\", dato.volt);\n\tcontext.estadoCargador = dato.payload;\n\tif (dato.payload === 1) {\n\t\tmsg = {pin: 8, payload: 1}; node.send([null, null, msg, null, null, null]);\n\t\tglobal.set(\"estadocargadorTexto\", \"cargando desde \" + dia + \"/\" + (mes+1) + \"/\" + ano + \" \" + hh + \":\" + mm + \":\" + ss);}\n\telse{\n\t\tmsg = {pin: 8, payload: 0}; node.send([null, null, msg, null, null, null]);\n\t\tglobal.set(\"estadocargadorTexto\", \"OK desde \" + dia + \"/\" + (mes+1) + \"/\" + ano + \" \" + hh + \":\" + mm + \":\" + ss);\n\t}\n\tmsg = {topic: \"Blynk/actualizar/estado\", payload: \"\"}; node.send([msg, null, null, null, null, null, null]);\n}\n\nfunction avisoBaterias(numBat){\n\tif (numBat > 0 && numBat <= 5){\n\t\tmsg = {payload:\"Atencion baterias numero: \" + numBat + \" sobrecalentada\"};//, pin: 0};\n\t\tnode.send([null, null, null, msg, null, null]);\n\t}\n\tif (numBat == 6){\n\t\tmsg = {payload:\"Atencion voltaje de baterias fuera de rango, voltaje: \" + dato.volt + \"V\"};//, pin: 0};\n\t\tnode.send([null, null, null, msg, null, null]);\n\t}\n}\n\nfunction mandarBackUpMail(){\n\tvar nombre = mes + \"_\" + ano;\n\tmsg = {topic : \"SELECT * FROM crepuscular ORDER BY hora Asc\"};\n\tnode.send([null, null, null, null, msg, null]);\n\tmsg = {topic : \"SELECT \\\"hora\\\", \\\"valor\\\" UNION  SELECT \\`hora\\`, \\`valor\\` INTO OUTFILE \\'/var/tmp/\" + nombre + \".csv\\' FIELDS TERMINATED BY \\';\\' OPTIONALLY ENCLOSED BY '\\\"' LINES TERMINATED BY '\\r\\n' FROM \\`crepuscular\\`\"};\n\tnode.send([null, null, null, null, msg, null]);\n\tmsg = {topic : \"DELETE FROM \\`crepuscular\\` WHERE 1\"};\n\tnode.send([null, null, null, null, msg, null]);\n\n\tmsg.topic = \"BackUp crepuscular\";\n\tmsg.payload = \"BackUp crepuscular\";\n\tmsg.attachments = [{\n\t    filename: nombre + '.csv',\n\t    path: '/var/tmp/' + nombre + '.csv',\n\t    content: msg.payload\n\t}];\n\tnode.send([null, null, null, null, null, msg]);\n\tcontext.avisoMail = 1;\n}\n","outputs":6,"noerr":0,"x":481.59527587890625,"y":173.6904675619943,"wires":[[],[],[],[],[],[]]},{"id":"702d90f7.a39cd","type":"blynk-ws-in-write","z":"a89e305a.c50bb","name":"","pin":"8","pin_all":false,"client":"2c18e412.5f5cbc","x":163.46824645996094,"y":481.8968753814697,"wires":[["2ed5a328.d7416c"]]},{"id":"36a56955.353e26","type":"debug","z":"a89e305a.c50bb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":864.4443969726562,"y":944.22216796875,"wires":[]},{"id":"525b92db.7e668c","type":"mqtt in","z":"50119c6e.6ff584","name":"","topic":"ESP/Living/Sens/Temp/Resp","qos":"2","broker":"e779f8d6.7bc2c8","x":266.42845344543457,"y":556.9047832489014,"wires":[["874ef0ca.0d4c8"]]},{"id":"879ba33.ca0c96","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"USBin/Alarma","qos":"2","broker":"c339edbf.39572","x":2560.808090209961,"y":700.6428582327707,"wires":[["483d3434.43ff8c","ca93e748.b2afe8"]]},{"id":"b331a173.04cab","type":"function","z":"3ce5b54a.127d6a","name":"","func":"global.set(\"tiempoEspera\", 0);\nglobal.set(\"tiempoCargando\", 0);\n","outputs":1,"noerr":0,"x":858.4523860386439,"y":503.99999999999994,"wires":[[]]},{"id":"1c16b3e7.db684c","type":"debug","z":"a89e305a.c50bb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":689.5238952636719,"y":903.7855930328369,"wires":[]},{"id":"50a5dfd4.f72c4","type":"inject","z":"a89e305a.c50bb","name":"prueba mail","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":392.91670989990234,"y":915.2142295837402,"wires":[["894d6130.d4b8"]]},{"id":"435e80ad.e17c8","type":"function","z":"e364a467.07a6a8","name":"","func":"msg.payload = msg.payload.replace(\",\", \".\");\nglobal.set(\"MinimoComprar\", parseFloat(msg.payload).toFixed(2));\nnode.status({text: \"MinimoComprar:\" + global.get(\"MinimoComprar\")});\nreturn msg;","outputs":1,"noerr":0,"x":445.5277404785156,"y":53,"wires":[[]]},{"id":"a6cbb8c8.d910d8","type":"inject","z":"a89e305a.c50bb","name":"Reset cont. pulsadores","topic":"Reset","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":326.630916595459,"y":670.7857675552368,"wires":[["e4201820.2ea728"]]},{"id":"c2e9aa8f.549168","type":"blynk-ws-out-write","z":"1b403a13.0ec8c6","name":"","pin":0,"pinmode":"1","client":"2c18e412.5f5cbc","x":664,"y":134,"wires":[]},{"id":"22061400.194d3c","type":"debug","z":"3ce5b54a.127d6a","name":"Serial out","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":520,"y":730,"wires":[]},{"id":"16b67857.ba97a8","type":"function","z":"e6e33852.2495f8","name":"","func":"if (msg.payload == \"1\")return msg;","outputs":1,"noerr":0,"x":323.0000025431316,"y":193.44444402058923,"wires":[["f0069ce0.a32ee"]]},{"id":"a9f3050a.052758","type":"thingspeak42","z":"e364a467.07a6a8","name":"NBKVMGLFCL4MD6XC","delay":"5","topic1":"DolarVenta","topic2":"DolarCompra","topic3":"BitCoinUSD","topic4":"BitCoinPesos","topic5":"","topic6":"","topic7":"","topic8":"","endpoint":"https://thingspeak.com","x":771.6467247009277,"y":304.4285838007927,"wires":[]},{"id":"ab4c9a86.d13818","type":"inject","z":"3ce5b54a.127d6a","name":"pulso","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":0.1,"x":282.6429634094238,"y":290.2738253729684,"wires":[["f1697d45.0cc3b"]]},{"id":"48dfbc88.6a6a34","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"Pedido/Lavadero/Bombas","qos":"2","broker":"c339edbf.39572","x":3000.238021850586,"y":811.1428890228271,"wires":[["5635a456.618d3c"]]},{"id":"a110d805.3e0758","type":"mqtt out","z":"7ac92c99.66ea94","name":"","topic":"","qos":"","retain":"","broker":"43555c62.30ed34","x":708.4285173416138,"y":309.1428027153015,"wires":[]},{"id":"e28387af.a79b98","type":"blynk-ws-in-write","z":"a89e305a.c50bb","name":"","pin":"32","pin_all":false,"client":"2c18e412.5f5cbc","x":160.41671752929688,"y":788.9642267227173,"wires":[["6d624e18.6a373"]]},{"id":"3508a681.35fb2a","type":"ui_gauge","z":"3ce5b54a.127d6a","name":"","group":"ff2252ef.d12aa","order":7,"width":"2","height":"2","gtype":"gage","title":"Temp Bat3","label":"units","format":"{{value}}","min":"20","max":"70","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":2759.3095474243164,"y":1015.4523786817279,"wires":[]},{"id":"d21e848f.240af8","type":"debug","z":"3ce5b54a.127d6a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":2198.6429748535156,"y":279.07141658238004,"wires":[]},{"id":"203f8498.dffb6c","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"notifyBlynk","qos":"2","broker":"c339edbf.39572","x":2109.3095675877157,"y":364.428562436785,"wires":[["bcac061b.f97bd8","2db2797c.372886"]]},{"id":"810bcbed.14fc78","type":"blynk-ws-in-write","z":"a89e305a.c50bb","name":"","pin":"18","pin_all":false,"client":"2c18e412.5f5cbc","x":174.30160903930664,"y":397.8016014099121,"wires":[["f159e61d.36bee8","36ec712b.3b77de"]]},{"id":"41de7b73.054844","type":"file","z":"e6e33852.2495f8","name":"borrar archivo","filename":"/home/gaston/BackUp-Node-Red/Fibertel.txt","appendNewline":true,"createDir":false,"overwriteFile":"delete","x":359.6666717529297,"y":597.888861656189,"wires":[[]]},{"id":"5526636a.dd6fdc","type":"mqtt in","z":"a89e305a.c50bb","name":"","topic":"ESP/living/Iluminacion/Envio","qos":"2","broker":"6b36e4a.1d30b1c","x":252.38093948364258,"y":752.3570861816406,"wires":[["f02f5acd.665768"]]},{"id":"7140c1c9.bedec","type":"function","z":"a89e305a.c50bb","name":"","func":"msg = {pin: 59, payload: \"\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\"}; node.send(msg);\nreturn msg;","outputs":1,"noerr":0,"x":517.5000076293945,"y":1042.000015258789,"wires":[["fccb22de.242ec"]]},{"id":"a2ae1c14.e354a","type":"e-mail","z":"e364a467.07a6a8","server":"smtp.mail.yahoo.com","port":"465","secure":true,"name":"gdietrich22@yahoo.com.ar","dname":"gd28722563","x":765.6944007873535,"y":389.92859172821045,"wires":[]},{"id":"998c6159.ea054","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"pedidoActualizacion","qos":"2","broker":"c339edbf.39572","x":159.97625732421875,"y":675.785627092634,"wires":[["479f221d.2c638c"]]},{"id":"37becc30.948424","type":"function","z":"f682d492.22a758","name":"","func":"var date = new Date();\nvar hh = date.getHours(); global.set(\"hh\", hh);\nvar mm = date.getMinutes(); global.set(\"mm\", mm);\nvar ss = date.getSeconds(); global.set(\"ss\", ss);\nvar dia = date.getDate(); \nvar mes = date.getMonth()+1;\nvar ano = date.getFullYear(); \n\nvar reinicio = hh + \":\" +mm + \":\" + ss + \" -- \"+ dia + \"/\"+mes+ \"\\n\";\n\n\nmsg.payload = reinicio;\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":300,"wires":[["3a857b5b.2a0b94","1a3dc3d4.31786c"]]},{"id":"3a857b5b.2a0b94","type":"file","z":"f682d492.22a758","name":"reinicios","filename":"/home/gaston/BackUp-Node-Red/reinicios.txt","appendNewline":true,"createDir":false,"overwriteFile":"true","x":500,"y":320,"wires":[["1a3dc3d4.31786c"]]},{"id":"124331f2.10cbfe","type":"blynk-ws-out-write","z":"f682d492.22a758","name":"","pin":"127","pinmode":0,"client":"2c18e412.5f5cbc","x":760,"y":380,"wires":[]},{"id":"6a44740a.f0167c","type":"blynk-ws-in-write","z":"f682d492.22a758","name":"","pin":"126","pin_all":0,"client":"2c18e412.5f5cbc","x":140,"y":380,"wires":[["ea8bd52.644c928"]]},{"id":"1a3dc3d4.31786c","type":"debug","z":"f682d492.22a758","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":710,"y":300,"wires":[]},{"id":"402ed674.49be08","type":"inject","z":"f682d492.22a758","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":320,"wires":[["37becc30.948424"]]},{"id":"394001b5.1d53be","type":"file in","z":"f682d492.22a758","name":"consulta","filename":"/home/gaston/BackUp-Node-Red/reinicios.txt","format":"utf8","chunk":false,"sendError":false,"x":480,"y":380,"wires":[["9803d70e.360758"]]},{"id":"689f5cf4.b07454","type":"file","z":"f682d492.22a758","name":"reinicios","filename":"/home/gaston/BackUp-Node-Red/reinicios.txt","appendNewline":true,"createDir":false,"overwriteFile":"delete","x":780,"y":340,"wires":[[]]},{"id":"39345523.b1936a","type":"inject","z":"f682d492.22a758","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":700,"y":260,"wires":[["689f5cf4.b07454"]]},{"id":"9803d70e.360758","type":"function","z":"f682d492.22a758","name":"","func":"msg.payload = \"Reinicios: \\n\" + msg.payload;\n\n// node.send(msg.payload);\n// for (i = 0; i < 18; i++) {msg.payload += \"\\n\";}\n\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":380,"wires":[["124331f2.10cbfe","81b48d30.ab2b5"]]},{"id":"190846f5.56b989","type":"blynk-ws-in-write","z":"f682d492.22a758","name":"","pin":"125","pin_all":0,"client":"2c18e412.5f5cbc","x":140,"y":420,"wires":[["e6582073.df041"]]},{"id":"542275be.eb086c","type":"function","z":"f682d492.22a758","name":"","func":"// msg.payload = \"Reinicios: \\n\" + msg.payload;\n\n// node.send(msg.payload);\nfor (i = 0; i < 25; i++) {msg.payload += \"\\n\";}\n\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":420,"wires":[["73d29a7b.22bb54"]]},{"id":"73d29a7b.22bb54","type":"blynk-ws-out-write","z":"f682d492.22a758","name":"","pin":"127","pinmode":0,"client":"2c18e412.5f5cbc","x":760,"y":420,"wires":[]},{"id":"ea8bd52.644c928","type":"function","z":"f682d492.22a758","name":"","func":"if (msg.payload == 1)return msg;","outputs":1,"noerr":0,"x":320,"y":380,"wires":[["394001b5.1d53be"]]},{"id":"e6582073.df041","type":"function","z":"f682d492.22a758","name":"","func":"if (msg.payload == 1)return msg;","outputs":1,"noerr":0,"x":330,"y":420,"wires":[["542275be.eb086c"]]},{"id":"30f98307.22ba9c","type":"blynk-ws-in-write","z":"f682d492.22a758","name":"","pin":"124","pin_all":0,"client":"2c18e412.5f5cbc","x":520,"y":470,"wires":[["689f5cf4.b07454"]]},{"id":"a594e6b.0d98718","type":"delay","z":"3ce5b54a.127d6a","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":740,"y":800,"wires":[["ac2c785f.fac748"]]},{"id":"bdbd6b84.b74708","type":"exec","z":"3ce5b54a.127d6a","command":"acpi -t","addpay":true,"append":"","useSpawn":"true","timer":"","oldrc":true,"name":"","x":750,"y":860,"wires":[["34c194e1.df57ac"],[],[]]},{"id":"34c194e1.df57ac","type":"function","z":"3ce5b54a.127d6a","name":"","func":"var temp = msg.payload;\ntemp = temp.substring(temp.indexOf(\"ok\")+4);\ntemp = temp.substring(0, temp.indexOf(\"degrees \"));\ntemp = parseFloat(temp).toFixed(1);\nglobal.set(\"tempCPU\", temp);\nnode.status({text: \"Temp CPU: \" + global.get(\"tempCPU\")});\nmsg= {topic: \"tempCPU\", payload: global.get(\"tempCPU\")}; node.send([msg, null]);\nif (global.get(\"tempCPU\") > 80){\n    msg = {topic: \"notifyBlynk\", payload: \"Atencion, Servidor muy caliente\"};\n    node.send([null, msg]);\n}\n","outputs":2,"noerr":0,"x":870,"y":850,"wires":[["d16ed06d.66af"],["6f2a559f.704f9c"]]},{"id":"38b4b89a.0d7d18","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"Baterias/Est/Pedido/Resp","payload":"","payloadType":"date","repeat":"300","crontab":"","once":true,"onceDelay":0.1,"x":600,"y":860,"wires":[["bdbd6b84.b74708"]]},{"id":"6f2a559f.704f9c","type":"mqtt out","z":"3ce5b54a.127d6a","name":"","topic":"","qos":"","retain":"","broker":"e779f8d6.7bc2c8","x":1010,"y":860,"wires":[]},{"id":"7eab163e.6214c8","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg.payload = global.get(\"tempCPU\");\nreturn msg;","outputs":1,"noerr":0,"x":2550,"y":1370,"wires":[["c1dd659e.9aa308"]]},{"id":"9dd426e8.23c508","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"","payloadType":"date","repeat":"5","crontab":"","once":true,"onceDelay":"1","x":2340,"y":1370,"wires":[["7eab163e.6214c8"]]},{"id":"83ad7853.380cc8","type":"mqtt in","z":"a89e305a.c50bb","name":"Debug esp","topic":"Debug/ESP/Living/Iluminacion","qos":"2","broker":"e779f8d6.7bc2c8","x":200,"y":30,"wires":[["830705e1.f38088"]]},{"id":"830705e1.f38088","type":"debug","z":"a89e305a.c50bb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":360,"y":30,"wires":[]},{"id":"d9e58002.9fc1c","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":1210,"y":1430,"wires":[["3170a08f.1813b"]]},{"id":"88d7a18f.f34ef","type":"http request","z":"deff4396.4722a","name":"770523","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=770523","tls":"","x":605.1428833007812,"y":1532.0000305175781,"wires":[["e6127662.487908"]]},{"id":"690fa2ad.6e899c","type":"http request","z":"deff4396.4722a","name":"227142","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=227142","tls":"","x":615.0000038146973,"y":837.8572373390198,"wires":[["cb65d1fd.cb53f"]]},{"id":"53abf513.752d6c","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 2;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":778.1429176330566,"y":385.00007009506226,"wires":[["3170a08f.1813b"]]},{"id":"16efb32e.155fed","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":763.8572120666504,"y":1459.2857298851013,"wires":[["3170a08f.1813b"]]},{"id":"4099b57f.38846c","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":781.1428871154785,"y":53.42862033843994,"wires":[["3170a08f.1813b"]]},{"id":"55c124d2.62ee1c","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":781.0000953674316,"y":202.14290761947632,"wires":[["3170a08f.1813b"]]},{"id":"34f3b0c2.8833c","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":779.428653717041,"y":506.5715045928955,"wires":[["3170a08f.1813b"]]},{"id":"458d00b4.bb81a","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":775.1429481506348,"y":799.4286670684814,"wires":[["3170a08f.1813b"]]},{"id":"44e592ad.9a6ddc","type":"debug","z":"deff4396.4722a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1529.4286346435547,"y":607.7143774032593,"wires":[]},{"id":"fee2fc02.661cb","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 3;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":768.0001258850098,"y":1222.2858142852783,"wires":[["3170a08f.1813b"]]},{"id":"171b314a.622d6f","type":"http request","z":"deff4396.4722a","name":"234231","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=243231","tls":"","x":1054.1428489685059,"y":1319.8571381568909,"wires":[["7dea07a4.eb3178"]]},{"id":"c24bc84a.594568","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 2;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno + \"B\", payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":1210,"y":1501.4285888671875,"wires":[["3170a08f.1813b","5bf1036e.b90b1c"]]},{"id":"4ff7c4b4.6171dc","type":"http request","z":"deff4396.4722a","name":"243236","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=243236","tls":"","x":613.5715026855469,"y":1003.5715107917786,"wires":[["6002d625.d89ac8"]]},{"id":"4986495d.c7ee08","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 2;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":768.1429176330566,"y":1310.7143034934998,"wires":[["3170a08f.1813b"]]},{"id":"1b6d2ac5.036c35","type":"http request","z":"deff4396.4722a","name":"231583","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=231583","tls":"","x":1055.571376800537,"y":1282.7142853736877,"wires":[["1a443eaf.be41f1"]]},{"id":"2313909a.a4c4d","type":"http request","z":"deff4396.4722a","name":"222387","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=222387","tls":"","x":616.4286193847656,"y":729.2857899665833,"wires":[["b86bd3da.92551"]]},{"id":"f772061b.e1cad8","type":"http request","z":"deff4396.4722a","name":"256659","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=256659","tls":"","x":1051.2856712341309,"y":1502.7143006324768,"wires":[["c24bc84a.594568"]]},{"id":"9677ee79.5bdcc","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":1214.1429138183594,"y":1155.8572010993958,"wires":[["3170a08f.1813b"]]},{"id":"76e899ab.f8ae08","type":"http request","z":"deff4396.4722a","name":"700558","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=700558","tls":"","x":608.0000610351562,"y":1349.1428680419922,"wires":[["8667b91f.fdc0b8"]]},{"id":"e0f6cdfd.a62bf","type":"http request","z":"deff4396.4722a","name":"215557","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=215557","tls":"","x":617.9999732971191,"y":423.4286403656006,"wires":[["f81f56b3.959ef8"]]},{"id":"def30510.94f998","type":"http request","z":"deff4396.4722a","name":"920550","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=920550","tls":"","x":603.7142677307129,"y":1569.1428890228271,"wires":[["149647c7.c11978"]]},{"id":"7e85e10b.d1b0b","type":"debug","z":"deff4396.4722a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1046.5714460100446,"y":1062.0000501360212,"wires":[]},{"id":"9a5d1616.d83a58","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 0.5;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":778.1429176330566,"y":467.85721731185913,"wires":[["3170a08f.1813b"]]},{"id":"22131597.af008a","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":775.1429481506348,"y":762.2857837677002,"wires":[["3170a08f.1813b"]]},{"id":"dfd3ea5e.dff698","type":"http response","z":"deff4396.4722a","name":"","statusCode":"","headers":{},"x":1505.214370727539,"y":695.333384513855,"wires":[]},{"id":"b42376a.e111f88","type":"http request","z":"deff4396.4722a","name":"700019","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=700019","tls":"","x":609.4285888671875,"y":1312.000015258789,"wires":[["4986495d.c7ee08"]]},{"id":"2b5dc58.8b2eb3a","type":"inject","z":"deff4396.4722a","name":"reset contador","topic":"reset","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1218.0002746582031,"y":673.4286546707153,"wires":[["6581ffca.63a8d"]]},{"id":"8667b91f.fdc0b8","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 5;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":766.7143898010254,"y":1347.8571562767029,"wires":[["3170a08f.1813b"]]},{"id":"3b210264.5f0bee","type":"http request","z":"deff4396.4722a","name":"244498","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=244498","tls":"","x":1052.7142601013184,"y":1391.2857117652893,"wires":[["1b708a40.bc22e6"]]},{"id":"b3a7fbf3.922e48","type":"http request","z":"deff4396.4722a","name":"234812","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=234812","tls":"","x":613.5715026855469,"y":930.7143635749817,"wires":[["7e267bbe.156c74"]]},{"id":"4cbcbf45.90a3e","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":1212.714298248291,"y":1230.142942905426,"wires":[["3170a08f.1813b"]]},{"id":"9fff4fff.b3553","type":"http request","z":"deff4396.4722a","name":"244227","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=244227","tls":"","x":614.642951965332,"y":1072.5001525878906,"wires":[["fdec048a.e11958"]]},{"id":"d1f7dd08.140b9","type":"http request","z":"deff4396.4722a","name":"175408","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=175408","tls":"","x":619.4285888671875,"y":349.1428985595703,"wires":[["ee6afd61.4e7cf"]]},{"id":"9130ce49.eaa87","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":778.0001258850098,"y":616.5715045928955,"wires":[["3170a08f.1813b"]]},{"id":"cb65d1fd.cb53f","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":773.7143325805664,"y":836.5715255737305,"wires":[["3170a08f.1813b"]]},{"id":"4ae8fbed.dbc814","type":"http request","z":"deff4396.4722a","name":"216449","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=216449","tls":"","x":620.7143249511719,"y":507.8572163581848,"wires":[["34f3b0c2.8833c"]]},{"id":"5bf1036e.b90b1c","type":"debug","z":"deff4396.4722a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1403.7143031529017,"y":1507.7143358503067,"wires":[]},{"id":"bc0ed3c2.0b241","type":"http request","z":"deff4396.4722a","name":"214145","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=214145","tls":"","x":619.4285888671875,"y":386.28578186035156,"wires":[["53abf513.752d6c"]]},{"id":"59a29fe5.2caf4","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":1212.857177734375,"y":1352.8571472167969,"wires":[["3170a08f.1813b"]]},{"id":"1145a554.3866db","type":"http request","z":"deff4396.4722a","name":"256659","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=256659","tls":"","x":607.8571815490723,"y":1260.7143845558167,"wires":[["ee1898c6.e49f28"]]},{"id":"a8012455.e32078","type":"http request","z":"deff4396.4722a","name":"253486","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=253486","tls":"","x":609.2857971191406,"y":1223.5715260505676,"wires":[["fee2fc02.661cb"]]},{"id":"98a4cda.2e0543","type":"thingspeak42","z":"deff4396.4722a","name":"5RA8YTAP1AURPAKD","delay":"2","topic1":"caja","topic2":"boucher","topic3":"total","topic4":"","topic5":"","topic6":"","topic7":"","topic8":"","endpoint":"https://thingspeak.com","x":1581.839412689209,"y":768.6071662902832,"wires":[]},{"id":"c9edb946.55d838","type":"http request","z":"deff4396.4722a","name":"135003","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=135003","tls":"","x":623.7142944335938,"y":127.71434020996094,"wires":[["7df23347.bffebc"]]},{"id":"6581ffca.63a8d","type":"function","z":"deff4396.4722a","name":"","func":"var payload;\nvar dato;\nvar valor = 0;\nvar valor1;\nvar valor2;\n\nif (msg.topic == \"reset\"){\n    global.set(\"cont_coop\", 0);\n    node.status({text: \"consultas: \" + global.get(\"cont_coop\")});\n    msg.payload = global.get(\"cont_coop\"); \n    return([null, null, msg]);\n}\n\nmsg.payload = \"<table align=\\\"center\\\" border=\\\"1\\\" style=\\\"width:auto; height:20px;\\\" class=\\\"table table-condensed table-bordered table-hover\\\">\";\nmsg.payload +=   \"<tr align=\\\"center\\\" class=\\\"active\\\" bgcolor= \\\"#00FFFF\\\" >\";\n// msg.payload +=  \" <tr  bgcolor= \\\"#00FFFF\\\" >\";\nmsg.payload +=   \"<td colspan=\\\"6\\\">Articulos Caja (resaltados en <b><big>AMARILLO</b></big> estan en <b><big>OFERTA</b></big>)</td>\";\n// msg.payload +=  \" <tr  bgcolor= \\\"#00FFFF\\\" >\";\nmsg.payload +=   \"<tr align=\\\"center\\\" class=\\\"active\\\" bgcolor= \\\"#00FFFF\\\" >\";\nmsg.payload +=    \" <td width=\\\"50\\\">Codigo</td>\";\n\nmsg.payload +=    \" <td width=\\\"200\\\">Descripcion</td>\";\n// msg.payload +=    \" <td width=\\\"80\\\">Gramaje</td>\";\nmsg.payload +=    \" <td width=\\\"50\\\">Cantidad</td>\";\nmsg.payload +=    \" <td width=\\\"80\\\">Precio Lista</td>\";\nmsg.payload +=    \" <td width=\\\"80\\\">Precio Final</td>\";\nmsg.payload +=    \" <td width=\\\"80\\\">Total</td>\";\nmsg.payload +=  \" </tr>\";\n\n\ntabla(flow.get(\"105113\"));\ntabla(flow.get(\"131067\"));\ntabla(flow.get(\"135003\"));\ntabla(flow.get(\"140220\"));\ntabla(flow.get(\"151793\"));\ntabla(flow.get(\"152999\"));\ntabla(flow.get(\"169188\"));\ntabla(flow.get(\"170872\"));\ntabla(flow.get(\"175408\"));\ntabla(flow.get(\"214145\"));\ntabla(flow.get(\"215557\"));\ntabla(flow.get(\"216172\"));\ntabla(flow.get(\"216449\"));\ntabla(flow.get(\"216450\"));\ntabla(flow.get(\"216677\"));\ntabla(flow.get(\"216699\"));\ntabla(flow.get(\"217334\"));\ntabla(flow.get(\"218136\"));\ntabla(flow.get(\"222387\"));\ntabla(flow.get(\"224097\"));\ntabla(flow.get(\"224363\"));\ntabla(flow.get(\"227142\"));\ntabla(flow.get(\"230515\"));\ntabla(flow.get(\"234812\"));\ntabla(flow.get(\"242835\"));\ntabla(flow.get(\"243236\"));\ntabla(flow.get(\"243905\"));\ntabla(flow.get(\"244227\"));\ntabla(flow.get(\"244495\"));\n\ntabla(flow.get(\"248167\"));\ntabla(flow.get(\"250602\"));\ntabla(flow.get(\"253486\"));\n\ntabla(flow.get(\"256659C\"));\ntabla(flow.get(\"700019\"));\ntabla(flow.get(\"700558\"));\ntabla(flow.get(\"705207\"));\ntabla(flow.get(\"730467\"));\ntabla(flow.get(\"740390\"));\ntabla(flow.get(\"756687\"));\ntabla(flow.get(\"770523\"));\ntabla(flow.get(\"920550\"));\n\nvar valor_caja = parseFloat(valor).toFixed(2);\n\nmsg.payload +=  \" </tr>\";\nmsg.payload +=  \" <tr align=\\\"right\\\" bgcolor= \\\"#00FFFF\\\">\";\nmsg.payload +=   \"<td colspan=\\\"5\\\"><b><big>Total= </b></big/td>\";\nmsg.payload +=    \" <td><b><big>\" + valor_caja + \"</b></big>\";\nmsg.payload += \"</table>\";\nvar caja = msg.payload;\n\nmsg.payload = \"</br></br><table align=\\\"center\\\" border=\\\"1\\\" style=\\\"width:auto; height:20px;\\\" class=\\\"table table-condensed table-bordered table-hover\\\">\";\nmsg.payload +=   \"<tr align=\\\"center\\\" class=\\\"active\\\" bgcolor= \\\"#00FFFF\\\" >\";\n// msg.payload +=  \" <tr  bgcolor= \\\"#00FFFF\\\" >\";\nmsg.payload +=   \"<td colspan=\\\"6\\\">Articulos Boucher (resaltados en <b><big>AMARILLO</b></big> estan en <b><big>OFERTA</b></big>)</td>\";\n// msg.payload +=  \" <tr  bgcolor= \\\"#00FFFF\\\" >\";\nmsg.payload +=   \"<tr align=\\\"center\\\" class=\\\"active\\\" bgcolor= \\\"#00FFFF\\\" >\";\nmsg.payload +=    \" <td width=\\\"50\\\">Codigo</td>\";\nmsg.payload +=    \" <td width=\\\"200\\\">Descripcion</td>\";\n// msg.payload +=    \" <td width=\\\"80\\\">Gramaje</td>\";\nmsg.payload +=    \" <td width=\\\"50\\\">Cantidad</td>\";\nmsg.payload +=    \" <td width=\\\"80\\\">Precio Lista</td>\";\nmsg.payload +=    \" <td width=\\\"80\\\">Precio Final</td>\";\nmsg.payload +=    \" <td width=\\\"80\\\">Total</td>\";\nmsg.payload +=  \" </tr>\";\n\nvalor = 0;\ntabla(flow.get(\"166508\"));\ntabla(flow.get(\"198119\"));\ntabla(flow.get(\"224363\"));\ntabla(flow.get(\"224744\"));\ntabla(flow.get(\"231583\"));\ntabla(flow.get(\"243231\"));\ntabla(flow.get(\"243239\"));\ntabla(flow.get(\"244498\"));\ntabla(flow.get(\"245287\"));\ntabla(flow.get(\"252411\"));\ntabla(flow.get(\"256659B\"));\n\nvar valor_boucher = parseFloat(valor).toFixed(2);\nmsg.payload +=  \" </tr>\";\nmsg.payload +=  \" <tr align=\\\"right\\\" bgcolor= \\\"#00FFFF\\\">\";\nmsg.payload +=   \"<td colspan=\\\"5\\\"><b><big>Total= </b></big/td>\";\nmsg.payload +=    \" <td><b><big>\" + valor_boucher + \"</b></big>\";\nmsg.payload += \"</table>\";\nvar boucher = msg.payload;\nvar valor_total = parseFloat(valor_caja) + parseFloat(valor_boucher); valor_total = parseFloat(valor_total).toFixed(2); \n\nvar date = new Date();\nvar fecha = date.getDate() + \"/\" + parseInt(1+date.getMonth()) + \"/\" + date.getUTCFullYear() + \"  --  \" + global.get(\"hsCpu\");\nmsg.payload = \"<table align=\\\"center\\\" border=\\\"1\\\" style=\\\"width:auto; height:20px;\\\" class=\\\"table table-condensed table-bordered table-hover\\\">\";\nmsg.payload += \"<tr align=\\\"center\\\" class=\\\"active\\\" bgcolor= \\\"#00FFFF\\\" >\";\nmsg.payload +=   \"<td colspan=\\\"2\\\" align=\\\"center\\\">\" + fecha + \"</td></tr>\";\nmsg.payload +=   \"<td colspan=\\\"2\\\" align=\\\"center\\\">Valores extraidos de <a href= https://www.lacoopeencasa.coop> www.lacoopeencasa.coop </a> <p style=\\\"color:red;\\\"><b><big>Sucursal BAHIA BLANCA!!!</p></b></big> </td></tr>\";\nmsg.payload += \"<td width=\\\"100\\\"><b><big></b></big></td>\";\nmsg.payload += \"<td width=\\\"100\\\"><b><big>Valor</b></big></td></tr>\";\n\nmsg.payload += \"<td><b><big>Caja</b></big><td>\" + valor_caja + \"</td></tr>\";\nmsg.payload += \"<td><b><big>Boucher</b></big><td>\" + valor_boucher + \"</td></tr>\";\nmsg.payload += \"<td><b><big>Total<td><b><big>\" + valor_total + \"</b></big></td></tr>\";\nmsg.payload += \"</table></tr>\";\nvar encabezado = msg.payload;\n\n\nif (msg.pedido != \"automatico\"){\n    if (global.get(\"cont_coop\") === undefined)global.set(\"cont_coop\", 0);\n    var cont_coop = global.get(\"cont_coop\");\n    cont_coop = cont_coop + 1;\n    global.set(\"cont_coop\", cont_coop);\n    msg.payload = encabezado + caja + boucher + \"<H6>consultas: \" + global.get(\"cont_coop\") + \"</H6>\";\n    node.status({text: \"consultas: \" + global.get(\"cont_coop\")});\n    vaciar();\n    node.send ([msg, null]);\n    msg.payload = global.get(\"cont_coop\"); return([null, null, msg]);\n}\n\n\nmsg = {topic: \"caja\", payload: valor_caja}; node.send([null, msg]);\nmsg = {topic: \"boucher\", payload: valor_boucher}; node.send([null, msg]);\nmsg = {topic: \"total\", payload: valor_total}; node.send([null, msg]);\nvaciar();\n// return;\n\nfunction tabla(dato){\n    dato = JSON.parse(dato);\n    valor = parseFloat(valor) + parseFloat(dato.total);\n    msg.payload +=  \" </tr>\";\n    if (dato.precio_promo != null) msg.payload +=  \" <tr align=\\\"center\\\" bgcolor= \\\"#FFFF00\\\" >\";\n    if (dato.precio_promo == null) msg.payload +=  \" <tr align=\\\"center\\\">\";\n    // msg.payload +=  \" <tr align=\\\"center\\\">\";\n    msg.payload +=    \" <td>\" + dato.cod_interno + \"</td>\";\n    msg.payload +=    \" <td>\" + dato.descripcion + \"</td>\";\n    // msg.payload +=    \" <td>\" + dato.gramaje + \"</td>\";\n    msg.payload +=    \" <td>\" + dato.cantidad + \"</td>\";    \n    msg.payload +=    \" <td>\" + dato.precio_anterior + \"</td>\";    \n    msg.payload +=    \" <td>\" + dato.precio + \"</td>\";\n    msg.payload +=    \" <td>\" + parseFloat(dato.total).toFixed(2) + \"</td>\";\n    msg.payload +=  \" </tr>\"\n}\n\nfunction vaciar(){\n\nflow.set(\"105113\",\"\");\nflow.set(\"131067\",\"\");\nflow.set(\"135003\",\"\");\nflow.set(\"140220\",\"\");\nflow.set(\"151793\",\"\");\nflow.set(\"152999\",\"\");\nflow.set(\"169188\",\"\");\nflow.set(\"170872\",\"\");\nflow.set(\"175408\",\"\");\nflow.set(\"214145\",\"\");\nflow.set(\"215557\",\"\");\nflow.set(\"216172\",\"\");\nflow.set(\"216449\",\"\");\nflow.set(\"216450\",\"\");\nflow.set(\"216677\",\"\");\nflow.set(\"216699\",\"\");\nflow.set(\"217334\",\"\");\nflow.set(\"218136\",\"\");\nflow.set(\"222387\",\"\");\nflow.set(\"224097\",\"\");\nflow.set(\"224363\",\"\");\nflow.set(\"227142\",\"\");\nflow.set(\"230515\",\"\");\nflow.set(\"234812\",\"\");\nflow.set(\"242835\",\"\");\nflow.set(\"243236\",\"\");\nflow.set(\"243905\",\"\");\nflow.set(\"244227\",\"\");\nflow.set(\"244495\",\"\");\n\nflow.set(\"248167\",\"\");\nflow.set(\"250602\",\"\");\nflow.set(\"253486C\",\"\");\n\nflow.set(\"256659\",\"\");\nflow.set(\"700019\",\"\");\nflow.set(\"700558\",\"\");\nflow.set(\"705207\",\"\");\nflow.set(\"730467\",\"\");\nflow.set(\"740390\",\"\");\nflow.set(\"756687\",\"\");\nflow.set(\"770523\",\"\");\nflow.set(\"920550\",\"\");\nflow.set(\"166508\",\"\");\nflow.set(\"198119\",\"\");\nflow.set(\"224363\",\"\");\nflow.set(\"224744\",\"\");\nflow.set(\"231583\",\"\");\nflow.set(\"700558\",\"\");\nflow.set(\"705207\",\"\");\nflow.set(\"244498\",\"\");\nflow.set(\"245287\",\"\");\nflow.set(\"252411\",\"\");\nflow.set(\"256659B\",\"\");\n}\n\n\n","outputs":3,"noerr":0,"x":1348.0000648498535,"y":743.1905460357666,"wires":[["dfd3ea5e.dff698","f1a94e7f.56c71"],["98a4cda.2e0543","fe18dcf8.29813"],["7a2cbbe6.736ef4","5dfb8412.6299fc"]]},{"id":"641eea95.956894","type":"http request","z":"deff4396.4722a","name":"169188","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=169188","tls":"","x":620.857177734375,"y":274.85719299316406,"wires":[["5f1ae42d.23f84c"]]},{"id":"ef95bde3.c855a","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":1214.1429138183594,"y":1121.5714955329895,"wires":[["3170a08f.1813b"]]},{"id":"c98bdd84.bfad9","type":"http request","z":"deff4396.4722a","name":"243905","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=243905","tls":"","x":608.392951965332,"y":1036.9643859863281,"wires":[["396caf50.b129a"]]},{"id":"ca1cb623.491768","type":"inject","z":"deff4396.4722a","name":"comprobar","topic":"comprobar","payload":"ll","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110.53970336914062,"y":831.5238571166992,"wires":[["9a794d21.ff36e"]]},{"id":"57143856.e8f2e8","type":"http request","z":"deff4396.4722a","name":"105113","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=105113","tls":"","x":622.4285583496094,"y":54.71433210372925,"wires":[["4099b57f.38846c"]]},{"id":"d9442c12.5d71c","type":"http request","z":"deff4396.4722a","name":"151793","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=151793","tls":"","x":622.2857666015625,"y":203.42861938476562,"wires":[["55c124d2.62ee1c"]]},{"id":"d6d0da5d.b2e428","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":771.0000953674316,"y":890.714364528656,"wires":[["3170a08f.1813b"]]},{"id":"f180d7aa.a01048","type":"http request","z":"deff4396.4722a","name":"244495","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=244495","tls":"","x":610.7143859863281,"y":1112.1429371833801,"wires":[["76da8650.357888"]]},{"id":"90062b1c.b307f8","type":"http request","z":"deff4396.4722a","name":"250602","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=250602","tls":"","x":609.2857971191406,"y":1186.4286427497864,"wires":[["7ca5b1e6.483b9"]]},{"id":"b54733d3.6a724","type":"function","z":"deff4396.4722a","name":"","func":"\tvar dato;\n\tvar valor;\n\tvar cant;\n\n\tdato = flow.get(\"105113\"); payload = dato + \"</br>\"; valor = parseFloat(dato.substring(dato.indexOf(\"precio: precio: $\")+9));\n\tdato = flow.get(\"131067\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"135003\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"140220\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"151793\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"152999\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"169188\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"170872\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"175408\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"214145\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"215557\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\n\tdato = flow.get(\"216172\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"216449\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"216450\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"216677\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"216699\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"217334\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"218136\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"222387\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"224097\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"224363\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"227142\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\n\tdato = flow.get(\"230515\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"234812\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"242835\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"243236\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"243905\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"244227\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"244495\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\n\tdato = flow.get(\"248167\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"250602\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"253486\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\n\tdato = flow.get(\"256659\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"700019\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"700558\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"705207\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\n\tdato = flow.get(\"730467\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"740390\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"756687\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"770523\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\tdato = flow.get(\"920550\"); payload += dato + \"</br>\"; valor += parseFloat( parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)));\n\n\n\t// msg.payload = parseFloat(dato.substring(dato.indexOf(\"precio: $\")+9)) * parseInt(dato.substring(dato.indexOf(\"cant:\")+1), dato.indexOf(\"cant:\")+3);\n\tmsg.payload = payload +  \"</br>\" + \"Valor Caja: precio: $\" + valor.toFixed(2);\n\treturn msg;","outputs":1,"noerr":0,"x":1352.8572883605957,"y":816.0715026855469,"wires":[[]]},{"id":"cadea8ce.25e388","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":779.428653717041,"y":579.4286518096924,"wires":[["3170a08f.1813b"]]},{"id":"4d3f888a.443b08","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":781.0000953674316,"y":236.42862844467163,"wires":[["3170a08f.1813b"]]},{"id":"fe18dcf8.29813","type":"debug","z":"deff4396.4722a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1521.750108718872,"y":732.7143449783325,"wires":[]},{"id":"6575aa91.007b84","type":"debug","z":"deff4396.4722a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1422.2858307361603,"y":466.28575134277344,"wires":[]},{"id":"b86bd3da.92551","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 2;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":775.1429481506348,"y":728.000078201294,"wires":[["3170a08f.1813b"]]},{"id":"5dfb8412.6299fc","type":"debug","z":"deff4396.4722a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1523.7143621444702,"y":850.5715265274048,"wires":[]},{"id":"396caf50.b129a","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":770.8573036193848,"y":1039.4286518096924,"wires":[["3170a08f.1813b"]]},{"id":"28817a7e.db5e46","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":1214.1429138183594,"y":1193.000084400177,"wires":[["3170a08f.1813b"]]},{"id":"73fa44dc.96d24c","type":"http request","z":"deff4396.4722a","name":"152999","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=152999","tls":"","x":622.2857666015625,"y":237.71434020996094,"wires":[["4d3f888a.443b08"]]},{"id":"a5daacc0.adaa6","type":"http request","z":"deff4396.4722a","name":"198119","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=198119","tls":"","x":1055.4285850524902,"y":1157.142912864685,"wires":[["9677ee79.5bdcc"]]},{"id":"a63f9ad.d1fce68","type":"http request","z":"deff4396.4722a","name":"224363","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=224363","tls":"","x":1055.4285850524902,"y":1194.2857961654663,"wires":[["28817a7e.db5e46"]]},{"id":"e6e19c04.028c2","type":"http request","z":"deff4396.4722a","name":"224363","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=224363","tls":"","x":616.4286193847656,"y":800.7143788337708,"wires":[["458d00b4.bb81a"]]},{"id":"5f1ae42d.23f84c","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":779.5715065002441,"y":273.57148122787476,"wires":[["3170a08f.1813b"]]},{"id":"a931ef28.863ad","type":"http request","z":"deff4396.4722a","name":"216450","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=216450","tls":"","x":620.7143249511719,"y":542.1429371833801,"wires":[["f8eb0173.2252d"]]},{"id":"6002d625.d89ac8","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":772.285831451416,"y":1002.2857990264893,"wires":[["3170a08f.1813b"]]},{"id":"b90017fb.9ffbe8","type":"http request","z":"deff4396.4722a","name":"131067","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=131067","tls":"","x":623.7142944335938,"y":93.42861938476562,"wires":[["5c0e05ce.6a04ac"]]},{"id":"ee9595b0.139958","type":"http request","z":"deff4396.4722a","name":"216677","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=216677","tls":"","x":620.7143249511719,"y":580.7143635749817,"wires":[["cadea8ce.25e388"]]},{"id":"8d1e731c.cb342","type":"http request","z":"deff4396.4722a","name":"170872","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=170872","tls":"","x":619.4285888671875,"y":314.85719299316406,"wires":[["337ddd2c.8be9c2"]]},{"id":"e93d30a3.b32fd","type":"inject","z":"deff4396.4722a","name":"","topic":"","payload":"","payloadType":"date","repeat":"1","crontab":"","once":false,"onceDelay":0.1,"x":103.35716247558594,"y":869.5000019073486,"wires":[["9a794d21.ff36e"]]},{"id":"1adaaa83.06a925","type":"http request","z":"deff4396.4722a","name":"245287","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=245287","tls":"","x":1051.2856712341309,"y":1431.2857117652893,"wires":[["d9e58002.9fc1c"]]},{"id":"6c476b82.940064","type":"http request","z":"deff4396.4722a","name":"140220","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=140220","tls":"","x":623.7142944335938,"y":166.2857666015625,"wires":[["eaf4f40f.e8ed28"]]},{"id":"f8eb0173.2252d","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":779.428653717041,"y":540.8572254180908,"wires":[["3170a08f.1813b"]]},{"id":"76da8650.357888","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":769.4287147521973,"y":1110.8572254180908,"wires":[["3170a08f.1813b"]]},{"id":"3170a08f.1813b","type":"join","z":"deff4396.4722a","name":"","mode":"custom","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"52","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1219.7143859863281,"y":741.9048280715942,"wires":[["6581ffca.63a8d","44e592ad.9a6ddc"]]},{"id":"469227b5.c6eef8","type":"http request","z":"deff4396.4722a","name":"166508","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=166508","tls":"","x":1055.4285850524902,"y":1122.8572072982788,"wires":[["ef95bde3.c855a"]]},{"id":"b4f9a545.f63e08","type":"http request","z":"deff4396.4722a","name":"756687","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=756687","tls":"","x":605.1428833007812,"y":1494.8571472167969,"wires":[["7a6e8007.870a7"]]},{"id":"54ce4819.408ba8","type":"http request","z":"deff4396.4722a","name":"216699","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=216699","tls":"","x":619.2857971191406,"y":617.8572163581848,"wires":[["9130ce49.eaa87"]]},{"id":"7e267bbe.156c74","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":772.285831451416,"y":929.4286518096924,"wires":[["3170a08f.1813b"]]},{"id":"7df23347.bffebc","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":782.4286231994629,"y":126.42862844467163,"wires":[["3170a08f.1813b"]]},{"id":"149647c7.c11978","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":762.428596496582,"y":1567.8571772575378,"wires":[["3170a08f.1813b"]]},{"id":"d903a785.ff03e8","type":"http request","z":"deff4396.4722a","name":"224097","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=224097","tls":"","x":616.4286193847656,"y":763.5714955329895,"wires":[["22131597.af008a"]]},{"id":"fdec048a.e11958","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":770.8573036193848,"y":1073.7143726348877,"wires":[["3170a08f.1813b"]]},{"id":"b68336d4.054558","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":776.5715370178223,"y":688.000078201294,"wires":[["3170a08f.1813b"]]},{"id":"f1a94e7f.56c71","type":"debug","z":"deff4396.4722a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1526.4643745422363,"y":644.1905612945557,"wires":[]},{"id":"1b708a40.bc22e6","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":1211.4285888671875,"y":1390,"wires":[["3170a08f.1813b"]]},{"id":"4e54c0b4.4add2","type":"http request","z":"deff4396.4722a","name":"242835","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=242835","tls":"","x":613.5715026855469,"y":965.000084400177,"wires":[["37e5b062.80bce"]]},{"id":"7dea07a4.eb3178","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":1212.857177734375,"y":1318.5714263916016,"wires":[["3170a08f.1813b"]]},{"id":"aba61f04.d6b4","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":1210,"y":1464.2857055664062,"wires":[["3170a08f.1813b"]]},{"id":"337ddd2c.8be9c2","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 2;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":778.1429176330566,"y":313.57148122787476,"wires":[["3170a08f.1813b"]]},{"id":"561abb64.a6d934","type":"http request","z":"deff4396.4722a","name":"224744","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=224744","tls":"","x":1053.9999694824219,"y":1231.4286546707153,"wires":[["4cbcbf45.90a3e"]]},{"id":"7c37c98.f823d38","type":"http request","z":"deff4396.4722a","name":"740390","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=740390","tls":"","x":605.1428833007812,"y":1460.5714416503906,"wires":[["16efb32e.155fed"]]},{"id":"20a2e4e0.3be61c","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":766.7143898010254,"y":1382.1428771018982,"wires":[["3170a08f.1813b"]]},{"id":"e6127662.487908","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 4;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":763.8572120666504,"y":1530.7143187522888,"wires":[["3170a08f.1813b"]]},{"id":"eaf4f40f.e8ed28","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 2;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":782.4286231994629,"y":165.0000548362732,"wires":[["3170a08f.1813b"]]},{"id":"37e5b062.80bce","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":772.285831451416,"y":963.7143726348877,"wires":[["3170a08f.1813b"]]},{"id":"ee1898c6.e49f28","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno + \"C\", payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":766.5715103149414,"y":1259.4286727905273,"wires":[["3170a08f.1813b","7e85e10b.d1b0b"]]},{"id":"30b152ff.b14d9e","type":"http request","z":"deff4396.4722a","name":"252411","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=252411","tls":"","x":1051.2856712341309,"y":1465.5714173316956,"wires":[["aba61f04.d6b4"]]},{"id":"7f508c8f.f2e924","type":"inject","z":"deff4396.4722a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1202.2857317243302,"y":372.0000501360212,"wires":[["bdf0878d.29af48"]]},{"id":"f81f56b3.959ef8","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":776.7143020629883,"y":422.1429286003113,"wires":[["3170a08f.1813b"]]},{"id":"bdf0878d.29af48","type":"function","z":"deff4396.4722a","name":"","func":"msg.payload = flow.get(\"243236\");\nreturn msg;","outputs":1,"noerr":0,"x":1358.000017438616,"y":414.85719299316406,"wires":[["6575aa91.007b84"]]},{"id":"92396b62.ba1558","type":"http request","z":"deff4396.4722a","name":"230515","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=230515","tls":"","x":612.2857666015625,"y":892.0000762939453,"wires":[["d6d0da5d.b2e428"]]},{"id":"109f5d7f.231ff3","type":"http request","z":"deff4396.4722a","name":"730467","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=730467","tls":"","x":606.5714721679688,"y":1420.5714416503906,"wires":[["a70365be.8b2f78"]]},{"id":"7a6e8007.870a7","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":763.8572120666504,"y":1493.5714354515076,"wires":[["3170a08f.1813b"]]},{"id":"7ca5b1e6.483b9","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":768.0001258850098,"y":1185.142930984497,"wires":[["3170a08f.1813b"]]},{"id":"e1637849.f99568","type":"http request","z":"deff4396.4722a","name":"216172","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=216172","tls":"","x":619.4285888671875,"y":469.14292907714844,"wires":[["9a5d1616.d83a58"]]},{"id":"ee6afd61.4e7cf","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 2;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":778.1429176330566,"y":347.857186794281,"wires":[["3170a08f.1813b"]]},{"id":"9a794d21.ff36e","type":"function","z":"deff4396.4722a","name":"","func":"var date = new Date();\nnode.status({text: \"consultas: \" + global.get(\"cont_coop\")});\n\nif (msg.topic == \"comprobar\"){\n    msg = {pedido: \"automatico\", payload: \"comprobar\"};\n    return msg;\n}\n\nif (global.get(\"hh\") === 22 && global.get(\"mm\") === 0 && global.get(\"ss\") === 0) {\n    msg = {pedido: \"automatico\", payload: \"comprobar\"};\n    return msg;\n}\n","outputs":1,"noerr":0,"x":252.2857208251953,"y":869.1428413391113,"wires":[["690fa2ad.6e899c","e6e19c04.028c2","d903a785.ff03e8","2313909a.a4c4d","5ad760ff.99fd8","576569dc.1f60c8","54ce4819.408ba8","ee9595b0.139958","a931ef28.863ad","4ae8fbed.dbc814","e1637849.f99568","e0f6cdfd.a62bf","bc0ed3c2.0b241","d1f7dd08.140b9","8d1e731c.cb342","641eea95.956894","73fa44dc.96d24c","d9442c12.5d71c","c9edb946.55d838","b90017fb.9ffbe8","57143856.e8f2e8","92396b62.ba1558","b3a7fbf3.922e48","4e54c0b4.4add2","4ff7c4b4.6171dc","c98bdd84.bfad9","9fff4fff.b3553","f180d7aa.a01048","32359295.b3048e","90062b1c.b307f8","a8012455.e32078","1145a554.3866db","b42376a.e111f88","76e899ab.f8ae08","46937669.1307c8","109f5d7f.231ff3","7c37c98.f823d38","b4f9a545.f63e08","88d7a18f.f34ef","def30510.94f998","6c476b82.940064","469227b5.c6eef8","a5daacc0.adaa6","a63f9ad.d1fce68","561abb64.a6d934","1b6d2ac5.036c35","171b314a.622d6f","b645b943.501e88","3b210264.5f0bee","1adaaa83.06a925","30b152ff.b14d9e","f772061b.e1cad8"]]},{"id":"7a2cbbe6.736ef4","type":"blynk-ws-out-write","z":"deff4396.4722a","name":"","pin":"100","pinmode":0,"client":"1cdea439.a354ec","x":1553.7144165039062,"y":812.0000038146973,"wires":[]},{"id":"5ad760ff.99fd8","type":"http request","z":"deff4396.4722a","name":"218136","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=218136","tls":"","x":617.8572082519531,"y":689.2857899665833,"wires":[["b68336d4.054558"]]},{"id":"c313a7b1.5f0fd8","type":"http in","z":"deff4396.4722a","name":"Request","url":"/cope","method":"get","upload":false,"swaggerDoc":"","x":252.2857551574707,"y":955.1429014205933,"wires":[["57143856.e8f2e8","b90017fb.9ffbe8","c9edb946.55d838","6c476b82.940064","d9442c12.5d71c","73fa44dc.96d24c","641eea95.956894","8d1e731c.cb342","d1f7dd08.140b9","bc0ed3c2.0b241","e0f6cdfd.a62bf","e1637849.f99568","4ae8fbed.dbc814","a931ef28.863ad","ee9595b0.139958","54ce4819.408ba8","576569dc.1f60c8","5ad760ff.99fd8","2313909a.a4c4d","d903a785.ff03e8","e6e19c04.028c2","690fa2ad.6e899c","92396b62.ba1558","b3a7fbf3.922e48","4e54c0b4.4add2","4ff7c4b4.6171dc","c98bdd84.bfad9","9fff4fff.b3553","f180d7aa.a01048","32359295.b3048e","90062b1c.b307f8","a8012455.e32078","1145a554.3866db","b42376a.e111f88","76e899ab.f8ae08","46937669.1307c8","109f5d7f.231ff3","7c37c98.f823d38","b4f9a545.f63e08","88d7a18f.f34ef","def30510.94f998","f772061b.e1cad8","30b152ff.b14d9e","1adaaa83.06a925","3b210264.5f0bee","b645b943.501e88","171b314a.622d6f","1b6d2ac5.036c35","561abb64.a6d934","a63f9ad.d1fce68","a5daacc0.adaa6","469227b5.c6eef8"]]},{"id":"576569dc.1f60c8","type":"http request","z":"deff4396.4722a","name":"217334","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=217334","tls":"","x":619.2857971191406,"y":652.1429371833801,"wires":[["d633738.179be9"]]},{"id":"46937669.1307c8","type":"http request","z":"deff4396.4722a","name":"705207","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=705207","tls":"","x":608.0000610351562,"y":1383.4285888671875,"wires":[["20a2e4e0.3be61c"]]},{"id":"d633738.179be9","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":778.0001258850098,"y":650.8572254180908,"wires":[["3170a08f.1813b"]]},{"id":"a70365be.8b2f78","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 4;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":765.2858009338379,"y":1419.2857298851013,"wires":[["3170a08f.1813b"]]},{"id":"5c0e05ce.6a04ac","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":782.4286231994629,"y":92.14290761947632,"wires":[["3170a08f.1813b"]]},{"id":"1a443eaf.be41f1","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n\n","outputs":1,"noerr":0,"x":1214.2857055664062,"y":1281.4285736083984,"wires":[["3170a08f.1813b"]]},{"id":"32359295.b3048e","type":"http request","z":"deff4396.4722a","name":"248167","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=248167","tls":"","x":609.2857971191406,"y":1152.1429371833801,"wires":[["b546b13.ef12a5"]]},{"id":"b645b943.501e88","type":"http request","z":"deff4396.4722a","name":"243239","method":"GET","ret":"txt","url":"https://www.lacoopeencasa.coop/ws/index.php/articulo/articuloController/articulo_detalle?cod_interno=243239","tls":"","x":1054.1428489685059,"y":1354.1428589820862,"wires":[["59a29fe5.2caf4"]]},{"id":"b546b13.ef12a5","type":"function","z":"deff4396.4722a","name":"","func":"var cantidad = 1;\nvar payload = msg.payload;\npayload = \"{\" + payload.substring(payload.indexOf(\"cod_interno\")-1, payload.indexOf(\"uxc\")-2) + \"}\";\nvar dato = JSON.parse(payload);\npayload = payload.substring(0, payload.length - 1); \npayload += \",\\\"total\\\": \\\"\" + dato.precio * cantidad;\npayload += \"\\\",\\\"cantidad\\\": \\\"\" + cantidad + \"\\\"}\";\nflow.set(dato.cod_interno, payload); \nmsg.payload = flow.get(dato.cod_interno);\nreturn msg;\n","outputs":1,"noerr":0,"x":768.0001258850098,"y":1150.8572254180908,"wires":[["3170a08f.1813b"]]},{"id":"a053da1e.84bfe8","type":"function","z":"3ce5b54a.127d6a","name":"Baterias y Crep","func":"context.pruebas = context.pruebas || 0;\nvar haciendoPruebas;\n\nvar frecuenciaDatos = 5;\nvar vEmergMax = 15.4;\nvar vEmergMin = 9.6;\n// {\"topic\":\"Baterias/Est/Pedido/Resp\",\"bat1\":-127.00,\"bat2\":-127.00,\"bat3\":-127.00,\"bat4\":-127.00,\"bat5\":38.50,\"ambBat\":38.92,\"nivTanque\":0,\"volt\":3.72}\n//{\"topic\":\"Crep\",\"payload\":1}.\n//{\"topic\":\"Alarma/Disparo\",\"payload\":0}\n//{\"topic\":\"{\"topic\":\"Baterias/Est/Pedido/Resp\",\"bat1\":-127.00,\"bat2\":-127.00,\"bat3\":-127.00,\"bat4\":-127.00,\"bat5\":38.50,\"ambBat\":38.92,\"nivTanque\":0,\"volt\":3.72}\n//{\"topic\":\"Crep\",\"payload\":1}.\n//{\"topic\":\"Alarma/Disparo\",\"payload\":0}\n//{\"topic\":\"Toldo\",\"payload\":0}\n//{\"topic\":\"Alarma/Activacion\",\"payload\":1}\n// salida 1 serial\n// salida 2 blynk  pin = 0 notificaciones  --  pin 1= led alarma  --  pin2= boton alarma  --  pin3= linea 1 LCD -- pin4= linea 2 LCD\n// salida 3 mysql\nvar dato = JSON.parse(msg.payload);\ncontext.inicioCrep = context.inicioCrep || 0;\ncontext.inicioCargador = context.inicioCargador || 0;\n\nvar difTempEmergencia = 25;\nvar avisoBat = [];\nvar date = new Date();\nvar hh = date.getHours(); global.set(\"hh\", hh);\nvar mm = date.getMinutes(); global.set(\"mm\", mm);\nvar ss = date.getSeconds(); global.set(\"ss\", ss);\nvar dia = date.getDate();\nvar mes = date.getMonth(); global.set(\"mes\", mes);\nvar ano = date.getFullYear();\nglobal.set(\"fechaCompleta\", dia + \"/\" + mes + \"/\" + ano + \" \" + hh + \":\" + mm);\ncontext.hsAnterior = context.hsAnterior || 0;\ncontext.enviado = context.enviado || 0;\n\ncontext.Voltaje = context.Voltaje || null;\ncontext.Bat1 = context.Bat1 || null;\ncontext.Bat2 = context.Bat2 || null;\ncontext.Bat3 = context.Bat3 || null;\ncontext.Bat4 = context.Bat4 || null;\ncontext.Bat5 = context.Bat5 || null;\ncontext.Bat6 = context.Bat6 || null;\ncontext.tempAmbienteBat = context.tempAmbienteBat || null;\ncontext.nivelTanque = context.nivelTanque || null;\ncontext.contador = context.contador ||0;\ncontext.avisoMail = context.avisoMail ||0;\ncontext.avisoTanque = context.avisoTanque ||0;\ncontext.minAnt = context.minAnt || 0;\ncontext.mesAnt = context.mesAnt || mes - 1;\ncontext.diaAnt = context.diaAnt || dia;\ncontext.estadoCargador = context.estadoCargador || 0;\ncontext.cargarToldo = context.cargarToldo || 0;\ncontext.tiempoCarga = context.tiempoCarga || 0;\n\nvar dateCel = new Date(date.getTime() + 960000); \nvar hhCel = dateCel.getHours(); \nvar mmCel = dateCel.getMinutes();\nvar ssCel = dateCel.getSeconds();\nif (hh < 10)(hh = \"0\" + hh); if (mm < 10)(mm = \"0\" + mm); if (ss < 10)(ss = \"0\" + ss);\nglobal.set(\"hsCpu\", hh + \":\" + mm + \":\" + ss);\nif (hhCel < 10)(hhCel = \"0\" + hhCel); if (mmCel < 10)(mmCel = \"0\" + mmCel); if (ssCel < 10)(ssCel = \"0\" + ssCel);\nglobal.set(\"hsCel\", hhCel + \":\" + mmCel + \":\" + ssCel);\n\nvar tiempo = mm % frecuenciaDatos;\nnode.status({text: hh + \":\" + mm + \":\" + ss + \"   \"  + hhCel + \":\" + mmCel + \":\" + ss + \" || \" + context.mesAnt  + \" || \" + mes  + \" || \" +  context.avisoMail});\n\nif (dato.topic === \"Alarma\"){\n\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"Alarma\\\",\\\"payload\\\":\" + dato.payload + \"\\\"}\"}; \n\tnode.send([msg, null, null, null])}\n\nif (msg.topic === \"mandarMail\")mandarBackUpMail();\n\nif (ss === 2){\n\tif (context.mesAnt !== mes && hh === 0 && mm === 0  && context.avisoMail === 0){mandarBackUpMail(); context.mesAnt = mes;}\n}else{context.avisoMail = 0;}\n\n\nif (parseInt(ss) === 0){\n\t// msg = {pin: 6, payload: global.get(\"hsCel\")}; node.send(msg);\n\t// global.set(\"hsGlobal\", hh + \":\" + mm);\n\t// if (context.minAnt !== mm){\n\t// \tcontext.minAnt = mm;\n\t// \tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1}; \n\t// \tactualizarEstado();\n\t// }\tavio\n\tif (parseInt(tiempo) === 0 && context.enviado === 0){\n\t\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"Baterias/Est/Pedido\\\",\\\"payload\\\":1}\"}; \n\t\tnode.send([msg, null, null, null]); \n\t\tcontext.enviado = 1;}\n\t\t// return;}\n}\nelse{\n\tcontext.enviado = 0;\n}\n\nif (msg.topic === \"consultaCrep\"){msg = {topic : \"SELECT * FROM crepuscular ORDER BY hora Asc\"}; return ([null, null, msg, null]);}\nif (msg.topic === \"borrarCrep\"){msg = {topic : \"DELETE FROM `crepuscular` WHERE 1\"}; return ([null, null, msg, null]);}\n\nif (msg.topic === \"alarmaBlynk\"){\n\tmsg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"Alarma\\\",\\\"payload\\\":\" + msg.payload + \"}\"};\n\tnode.send([msg, null, null, null]);\n}\n\nif (dato.topic === \"Baterias/Est/Pedido/Resp\"){\n\tcontext.contador++;\t\n\tglobal.set(\"tempBat1\", dato.bat1.toFixed(1)); context.Bat1 += dato.bat1; if (global.get(\"tempBat1\") > difTempEmergencia + dato.tempAmb){avisoBat[1] = 1; avisoBaterias(1);}\n\tglobal.set(\"tempBat2\", dato.bat2.toFixed(1)); context.Bat2 += dato.bat2; if (global.get(\"tempBat2\") > difTempEmergencia + dato.tempAmb){avisoBat[2] = 1; avisoBaterias(2);}\n\tglobal.set(\"tempBat3\", dato.bat3.toFixed(1)); context.Bat3 += dato.bat3; if (global.get(\"tempBat3\") > difTempEmergencia + dato.tempAmb){avisoBat[3] = 1; avisoBaterias(3);}\n\tglobal.set(\"tempBat4\", dato.bat4.toFixed(1)); context.Bat4 += dato.bat4; if (global.get(\"tempBat4\") > difTempEmergencia + dato.tempAmb){avisoBat[4] = 1; avisoBaterias(4);}\n\tglobal.set(\"tempBat5\", dato.bat5.toFixed(1)); context.Bat5 += dato.bat5; if (global.get(\"tempBat5\") > difTempEmergencia + dato.tempAmb){avisoBat[5] = 1; avisoBaterias(5);}\n\tglobal.set(\"tempAmbienteBat\", dato.ambBat.toFixed(1)); context.tempAmbienteBat += dato.ambBat; \n\tglobal.set(\"voltajeBaterias\", dato.volt.toFixed(2)); context.Voltaje += dato.volt;// controlarVoltaje(global.get(\"voltajeBaterias\")); \n\tglobal.set(\"corrienteCarga\", dato.corriente.toFixed(2));\n\n\tif (global.get(\"voltajeBaterias\") > vEmergMax) {avisoBat[6] = 1; avisoBaterias(6);}\t\n\tif (global.get(\"voltajeBaterias\") < vEmergMin) { avisoBat[6] = 1; avisoBaterias(6);}\n\tactualizarEstado();\n\t// mostrarLcd();\n\n\tif (context.contador === 6){\n\t\tvar mysql = \"INSERT INTO \\`Baterias\\`(\\`Fecha\\`, \\`Voltaje\\`, \\`tempBat1\\`, \\`tempBat2\\`, \\`tempBat3\\`, \\`tempBat4\\`, \\`tempBat5\\`, \\`tempBat6\\`, \\`tempAmbienteBaterias\\`)\"; \n\t\tmysql += \"VALUES (now() ,\" + context.Voltaje / context.contador + \",\" + context.Bat1 / context.contador + \",\" + context.Bat2 / context.contador + \",\";\n\t\tmysql += context.Bat3 / context.contador + \",\" + context.Bat4 / context.contador + \",\";\n\t\tmysql += context.Bat5 / context.contador + \", \" + context.Bat6 / context.contador + \", \";\n\t\tmysql += context.tempAmbienteBat / context.contador + \")\";\n\t\tmsg.topic = mysql;\n\t\tnode.send([ null, null, msg, null]);\n\t\tcontext.Voltaje = 0; context.Bat1 = 0; context.Bat2 = 0; context.Bat3 = 0; context.Bat4 = 0; context.Bat5 = 0;\n\t\tcontext.tempAmbienteBat = 0; context.nivTanque = 0; context.contador = 0;\n\t}\n\tmsg = {topic: \"Actualizacion/Baterias\", payload:\"\"}; node.send([msg, null, null, null]);\n}\n\nif (dato.topic === \"Crep\"){// payload == valor analogico dia/noche\n\tif (context.pruebas === 1) {context.pruebas = 0; return;}\n\tif (dato.payload === 1) {\n\t\tglobal.set(\"Dia\", 1);\n\t\tglobal.set(\"hsAmanecer\",  hh + \":\" + mm + \":\" + ss);\n\t\tmsg = {topic: \"notifyBlynk\", payload: \"Se hizo de dia \" + global.get(\"hsAmanecer\")}; node.send([msg, null, null, null]);\n\t\tmsg = {topic: \"crepMQTT\", payload: 1}; node.send([msg, null, null, null]);\n\t}\n\tif (dato.payload === 0) {\n\t\tglobal.set(\"Dia\", 0);\n\t\tglobal.set(\"hsAnochecer\",  hh + \":\" + mm + \":\" + ss);\n\t\tmsg = {topic: \"notifyBlynk\", payload: \"Se hizo de noche \" + global.get(\"hsAnochecer\")}; node.send([msg, null, null, null]);\n\t\tmsg = {topic: \"crepMQTT\", payload: 0}; node.send([msg, null, null, null]);\t\n\t\tmsg = {topic: \"aviso/Iluminacion\", payload: 0}; node.send([msg, null, null, null]);\n\t}\n\tglobal.set(\"estadoCrepuscular\", dato.payload);\n\tmsg = {topic: \"INSERT INTO \\`crepuscular\\`(\\`hora\\`, \\`valor\\`) VALUES (now(),\" + dato.payload + \")\"};\n\tnode.send([null,null, msg, null]);\n}\n\nif (dato.topic === \"Cargador\"){\n\tglobal.set(\"estadoCargador\", dato.payload);\n\tglobal.set(\"voltajeBaterias\", dato.volt);\n\tglobal.set(\"corrienteCarga\", dato.corriente.toFixed(2));\n\tcontext.estadoCargador = dato.payload;\n\tif (dato.payload === 1) {\n\t\tvar date1 = new Date(date.getTime() - context.tiempoCarga); \n\t\tif (context.inicioCargador === 1)global.set(\"tiempoEspera\", (date.getTime() - context.tiempoCarga)/(60*1000));\n\t\tif (context.inicioCargador === 0)context.inicioCargador = 1;\n\n\t\tvar minCarg = date1.getMinutes(); var segCarg = date1.getSeconds();\n\t\tif (minCarg < 10)(minCarg = \"0\" + minCarg); if (segCarg < 10)(segCarg = \"0\" + segCarg);\n\t\tvar mostrarTiempoCarga = minCarg + \":\" + segCarg;\t\n\t\tcontext.tiempoCarga = date.getTime();\n\n\t\tmsg = {topic: \"estadoFallas\", payload: 1}; node.send(msg);\n\t\t// msg = {topic: \"notifyBlynk\", payload: \"Iniciando carga baterias (tiempo espera= \" + mostrarTiempoCarga + \")\"}; node.send(msg); \n\n\t\tglobal.set(\"estadocargadorTexto\", \"cargando desde \" + dia + \"/\" + (mes+1) + \"/\" + ano + \" \" + hh + \":\" + mm + \":\" + ss);}\n\telse{\n\t\tvar date1 = new Date(date.getTime() - context.tiempoCarga); \n\t\tif (context.inicioCargador === 1)global.set(\"tiempoCargando\", (date.getTime() - context.tiempoCarga)/(60*1000));\n\t\tif (context.inicioCargador === 0)context.inicioCargador = 1;\n\n\t\tvar minCarg = date1.getMinutes(); var segCarg = date1.getSeconds();\n\t\tif (minCarg < 10)(minCarg = \"0\" + minCarg); if (segCarg < 10)(segCarg = \"0\" + segCarg);\n\t\tvar mostrarTiempoCarga = minCarg + \":\" + segCarg;\t\n\t\tcontext.tiempoCarga = date.getTime();\n\t\tmsg = {topic: \"estadoFallas\", payload: 1}; node.send(msg);\n\t\t// msg = {topic: \"notifyBlynk\", payload: \"Terminando carga baterias (tiempo cargando= \" + mostrarTiempoCarga + \")\"}; node.send(msg);\n\n\t\tglobal.set(\"estadocargadorTexto\", \"OK desde \" + dia + \"/\" + (mes+1) + \"/\" + ano + \" \" + hh + \":\" + mm + \":\" + ss);\n\t}\n\tmsg = {topic: \"Blynk/actualizar/estado\", payload: \"\"}; node.send([msg, null, null, null, null]);\n}\n\nfunction avisoBaterias(numBat){\n\tif (numBat > 0 && numBat <= 5){\n\t\tmsg = {topic: \"notifyBlynk\", payload: \"Atencion baterias numero: \" + numBat + \" sobrecalentada\"};//, pin: 0};\n\t\tnode.send([msg, null, null, null]);\n\t}\n\tif (numBat === 6){\n\t\tmsg = {topic: \"notifyBlynk\", payload: \"Atencion voltaje de baterias fuera de rango, voltaje: \" + dato.volt + \"V\"};//, pin: 0};\n\t\tnode.send([msg, null, null, null]);\n\t}\n}\n\nfunction mandarBackUpMail(){\n\tvar nombre = mes + \"_\" + ano;\n\tvar directorio = \"/home/gaston/BackUp-Node-Red/\";\n\tmsg = {topic : \"SELECT * FROM crepuscular ORDER BY hora Asc\"};\n\tnode.send([null, null, msg, null]);\n\tmsg = {topic : \"SELECT \\\"hora\\\", \\\"valor\\\" UNION  SELECT \\`hora\\`, \\`valor\\` INTO OUTFILE \\'\" + directorio + nombre + \".csv\\' FIELDS TERMINATED BY \\';\\' OPTIONALLY ENCLOSED BY '\\\"' LINES TERMINATED BY '\\r\\n' FROM \\`crepuscular\\`\"};\n\tnode.send([null, null, msg, null]);\n\tmsg = {topic : \"DELETE FROM \\`crepuscular\\` WHERE 1\"};\n\tnode.send([null, null, msg, null]);\n\n\tmsg.topic = \"BackUp crepuscular\";\n\tmsg.payload = \"BackUp crepuscular\";\n\tmsg.attachments = [{\n\t    filename: nombre + '.csv',\n\t    path: directorio + nombre + '.csv',\n\t    content: msg.payload\n\t}];\n\tnode.send([null, null, null, msg]);\n\tcontext.avisoMail = 1;\n}\n\nfunction actualizarEstado(){\n\tif (global.get(\"estadoToldo\") !== \"Abriendo\" && global.get(\"estadoToldo\") !== \"Cerrando\"){\n\t\tmsg = {topic: \"Blynk/actualizar/estado\", payload: 1};\n\t\tnode.send([msg, null, null, null, null]);}\t\n}","outputs":4,"noerr":0,"x":200,"y":150,"wires":[[],[],[],[]]},{"id":"4e2ebfc7.e86fe","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":340,"y":30,"wires":[["52be30c0.8080e"]]},{"id":"52be30c0.8080e","type":"function","z":"3ce5b54a.127d6a","name":"","func":"msg.payload = \"espera: \" + global.get(\"tiempoEspera\"); node.send(msg);\nmsg.payload = \"tiempoCargando: \" + global.get(\"tiempoCargando\"); return msg;","outputs":1,"noerr":0,"x":520,"y":30,"wires":[["c201d764.96d7b8"]]},{"id":"c201d764.96d7b8","type":"debug","z":"3ce5b54a.127d6a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":670,"y":40,"wires":[]},{"id":"47d18bfc.1896e4","type":"debug","z":"3ce5b54a.127d6a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":480,"y":250,"wires":[]},{"id":"405016a2.5b5178","type":"debug","z":"1b403a13.0ec8c6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":680,"y":200,"wires":[]},{"id":"738fdb7.03ae024","type":"blynk-ws-in-write","z":"1b403a13.0ec8c6","name":"bomba man/auto","pin":"101","pin_all":0,"client":"2c18e412.5f5cbc","x":104,"y":289,"wires":[["d63b04d.1a1ddf8"]]},{"id":"ab29cf9.0abc23","type":"blynk-ws-in-write","z":"1b403a13.0ec8c6","name":"marcha bomba","pin":"102","pin_all":0,"client":"2c18e412.5f5cbc","x":104,"y":329,"wires":[["e4441881.826028"]]},{"id":"ad455046.6f0f4","type":"blynk-ws-in-write","z":"1b403a13.0ec8c6","name":"resistencia man/auto","pin":"103","pin_all":0,"client":"2c18e412.5f5cbc","x":114,"y":369,"wires":[["ec45c5b3.e74b68"]]},{"id":"411433a9.c1b67c","type":"blynk-ws-in-write","z":"1b403a13.0ec8c6","name":"encendido resistencia","pin":"104","pin_all":0,"client":"2c18e412.5f5cbc","x":124,"y":409,"wires":[["16604fe9.f82d5"]]},{"id":"d63b04d.1a1ddf8","type":"function","z":"1b403a13.0ec8c6","name":"","func":"msg = {topic: \"bombaAuto\", payload: parseInt(msg.payload)};\nreturn msg;","outputs":1,"noerr":0,"x":284,"y":289,"wires":[["bb10115b.490fc","34ae7c41.536534"]]},{"id":"bb10115b.490fc","type":"debug","z":"1b403a13.0ec8c6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":464,"y":309,"wires":[]},{"id":"e4441881.826028","type":"function","z":"1b403a13.0ec8c6","name":"","func":"msg = {topic: \"marchaBomba\", payload: parseInt(msg.payload)};\nreturn msg;\n","outputs":1,"noerr":0,"x":284,"y":329,"wires":[["eff3238d.918dc","34ae7c41.536534"]]},{"id":"eff3238d.918dc","type":"debug","z":"1b403a13.0ec8c6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":484,"y":349,"wires":[]},{"id":"ec45c5b3.e74b68","type":"function","z":"1b403a13.0ec8c6","name":"","func":"msg = {topic: \"resistenciaAuto\", payload: parseInt(msg.payload)};\nreturn msg;","outputs":1,"noerr":0,"x":284,"y":369,"wires":[["941cf72d.c10af8","34ae7c41.536534"]]},{"id":"941cf72d.c10af8","type":"debug","z":"1b403a13.0ec8c6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":484,"y":389,"wires":[]},{"id":"16604fe9.f82d5","type":"function","z":"1b403a13.0ec8c6","name":"","func":"msg = {topic: \"encendidoResistencia\", payload: parseInt(msg.payload)};\nreturn msg;","outputs":1,"noerr":0,"x":304,"y":409,"wires":[["65e720c0.1f08","34ae7c41.536534"]]},{"id":"65e720c0.1f08","type":"debug","z":"1b403a13.0ec8c6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":504,"y":429,"wires":[]},{"id":"840a50b6.4a71e","type":"inject","z":"f682d492.22a758","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":240,"y":230,"wires":[["3b30e656.644aca"]]},{"id":"fc135b52.7e6988","type":"debug","z":"1b403a13.0ec8c6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":710,"y":170,"wires":[]},{"id":"257acfc3.b3265","type":"mqtt in","z":"3ce5b54a.127d6a","name":"","topic":"USBin/Baterias","qos":"2","broker":"c339edbf.39572","x":250,"y":420,"wires":[["97d91f4a.eea84"]]},{"id":"97d91f4a.eea84","type":"function","z":"3ce5b54a.127d6a","name":"","func":"var dato = JSON.parse(msg.payload);\nif (dato.topic === \"Cargador\")return msg;","outputs":1,"noerr":0,"x":410,"y":430,"wires":[["82c1e55f.ffbcf8"]]},{"id":"82c1e55f.ffbcf8","type":"debug","z":"3ce5b54a.127d6a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":450,"y":470,"wires":[]},{"id":"4a0fa28d.1c1a9c","type":"mqtt in","z":"1b403a13.0ec8c6","name":"","topic":"ESP/TermoSolar/Recibo","qos":"2","broker":"e779f8d6.7bc2c8","x":710,"y":350,"wires":[["59ad7b91.7b7c34"]]},{"id":"59ad7b91.7b7c34","type":"debug","z":"1b403a13.0ec8c6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":910,"y":350,"wires":[]},{"id":"9b903a22.b94888","type":"inject","z":"1b403a13.0ec8c6","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":690,"y":410,"wires":[["d50b586e.4e8088"]]},{"id":"d50b586e.4e8088","type":"function","z":"1b403a13.0ec8c6","name":"","func":"node.status({text: global.get(\"estResistencia\") + \" -- \"+ global.get(\"estBomba\")});\nglobal.set(\"valorDia\", 680);","outputs":1,"noerr":0,"x":830,"y":410,"wires":[[]]},{"id":"93406c91.0eb21","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"33","payloadType":"num","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":120,"y":80,"wires":[["1e933d8e.6df622"]]},{"id":"1e933d8e.6df622","type":"function","z":"3ce5b54a.127d6a","name":"pwmPatioLuz","func":"global.set(\"pwmPatioLuz\", msg.payload)\nnode.status({text: global.get(\"pwmPatioLuz\")})","outputs":1,"noerr":0,"x":300,"y":80,"wires":[[]]},{"id":"d595988a.3e9458","type":"debug","z":"3ce5b54a.127d6a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":560,"y":920,"wires":[]},{"id":"36ec712b.3b77de","type":"debug","z":"a89e305a.c50bb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":580,"y":470,"wires":[]},{"id":"9059c158.93b98","type":"debug","z":"a89e305a.c50bb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":730,"y":230,"wires":[]},{"id":"cdf4c19a.6558e","type":"inject","z":"f682d492.22a758","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":790,"wires":[["b264716b.7dee"]]},{"id":"b264716b.7dee","type":"function","z":"f682d492.22a758","name":"","func":"msg = {pin: 19, label: \"Patio Luz\", min: 10, max: 100, payload: global.get(\"pwmPatioLuz\")};\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":800,"wires":[["38a8832e.5af48c","8f73534c.3cd4e"]]},{"id":"38a8832e.5af48c","type":"blynk-ws-out-set-property","z":"f682d492.22a758","name":"","pin":0,"pinmode":"1","prop":"bycode","client":"2c18e412.5f5cbc","x":580,"y":790,"wires":[]},{"id":"ee93f6d.0b60308","type":"blynk-ws-out-write","z":"f682d492.22a758","name":"","pin":0,"pinmode":"1","client":"2c18e412.5f5cbc","x":570,"y":850,"wires":[]},{"id":"8f73534c.3cd4e","type":"delay","z":"f682d492.22a758","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":390,"y":900,"wires":[["ee93f6d.0b60308"]]},{"id":"250c3ae7.c25d26","type":"inject","z":"1b403a13.0ec8c6","name":"prueba","topic":"","payload":"1","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":460,"wires":[["bb45cfec.5bba7"]]},{"id":"b542c7c6.822fe8","type":"mqtt in","z":"1b403a13.0ec8c6","name":"Crepuscular","topic":"ESP/TermoSolar/Crepuscular","qos":"2","broker":"e779f8d6.7bc2c8","x":110,"y":500,"wires":[["9a4e037f.7547e","bb45cfec.5bba7"]]},{"id":"9dae04ec.3604a8","type":"inject","z":"1b403a13.0ec8c6","name":"noche","topic":"ESP/TermoSolar/Crepuscular","payload":"0","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":540,"wires":[["bb45cfec.5bba7"]]},{"id":"bb45cfec.5bba7","type":"function","z":"1b403a13.0ec8c6","name":"","func":"var payload = parseInt(msg.payload);\nif (payload === 1){// payload == valor analogico dia/noche\n\tglobal.set(\"Dia\", 1);\n\tglobal.set(\"hsAmanecer\",  global.get(\"hsCpu\"));\n\tmsg = {topic: \"aviso/Iluminacion\", payload: 1}; node.send(msg);\n\tmsg = {topic: \"notifyBlynk\", payload: \"Se hizo de dia \" + global.get(\"hsAmanecer\")}; node.send(msg);\n\tmsg = {topic: \"crepMQTT\", payload: 1}; node.send(msg);\n\tglobal.set(\"avisoMail\", \" se hizo de dia:  \" + global.get(\"hsAmanecer\"));\n}\nif (payload === 0){\n\tglobal.set(\"Dia\", 0);\n\tglobal.set(\"hsAnochecer\",  global.get(\"hsCpu\"));\n\tmsg = {topic: \"aviso/Iluminacion\", payload: 1}; node.send(msg);\n\tmsg = {topic: \"notifyBlynk\", payload: \"Se hizo de noche \" + global.get(\"hsAnochecer\")}; node.send(msg);\n\tmsg = {topic: \"crepMQTT\", payload: 0}; node.send(msg);\t\n\tmsg = {topic: \"aviso/Iluminacion\", payload: 0}; node.send(msg);\n\tglobal.set(\"avisoMail\", \" se hizo de noche:  \" + global.get(\"hsAnochecer\"));\n}\nif (global.get(\"Dia\") === 1)node.status({text: \"amanecio: \" + global.get(\"hsAmanecer\")})\nif (global.get(\"Dia\") === 0)node.status({text: \"Oscurecio: \" + global.get(\"hsAnochecer\")})\n","outputs":1,"noerr":0,"x":314,"y":489,"wires":[["5054de74.d7ab1","e47cf739.f64318"]]},{"id":"5054de74.d7ab1","type":"mqtt out","z":"1b403a13.0ec8c6","name":"","topic":"","qos":"2","retain":"","broker":"e779f8d6.7bc2c8","x":480,"y":490,"wires":[]},{"id":"81b26807.0eb538","type":"inject","z":"1b403a13.0ec8c6","name":"dia","topic":"ESP/TermoSolar/Crepuscular","payload":"1","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":580,"wires":[["bb45cfec.5bba7"]]},{"id":"84c16a28.780968","type":"debug","z":"1b403a13.0ec8c6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":430,"y":740,"wires":[]},{"id":"f4934c37.87d5f","type":"blynk-ws-out-notify","z":"1b403a13.0ec8c6","name":"","client":"2c18e412.5f5cbc","queue":false,"rate":15,"x":400,"y":780,"wires":[]},{"id":"9ec61b42.3ba538","type":"mqtt in","z":"1b403a13.0ec8c6","name":"","topic":"ESP/TermoSolar/Bomba","qos":"2","broker":"900627dc.76e6a8","x":160,"y":100,"wires":[["34ae7c41.536534","b3d13945.b960d8"]]},{"id":"6553e305.a06fac","type":"debug","z":"1b403a13.0ec8c6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":480,"y":190,"wires":[]},{"id":"f2b879b7.06d858","type":"e-mail","z":"1b403a13.0ec8c6","server":"smtp.mail.yahoo.com","port":"465","secure":true,"name":"gdietrich22@yahoo.com.ar","dname":"gd28722563","x":420,"y":700,"wires":[]},{"id":"75970444.b3e18c","type":"mqtt in","z":"1b403a13.0ec8c6","name":"","topic":"crepMQTT","qos":"2","broker":"e779f8d6.7bc2c8","x":130,"y":740,"wires":[["a8b86121.02df6","4036110a.2a78c"]]},{"id":"ec863cce.8366f","type":"inject","z":"1b403a13.0ec8c6","name":"","topic":"","payload":"2","payloadType":"global","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":790,"wires":[["a8b86121.02df6"]]},{"id":"a8b86121.02df6","type":"function","z":"1b403a13.0ec8c6","name":"","func":"msg.payload = \"cambio en sensor crepuscular\" + global.get(\"avisoMail\") + \" valor sensor: \" + global.get(\"sensorCrep\");\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":740,"wires":[["f2b879b7.06d858","84c16a28.780968"]]},{"id":"4036110a.2a78c","type":"debug","z":"1b403a13.0ec8c6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":340,"y":820,"wires":[]},{"id":"bc78c9b1.093fa8","type":"mqtt out","z":"3ce5b54a.127d6a","name":"","topic":"","qos":"","retain":"","broker":"c339edbf.39572","x":2004.166919708252,"y":132.7857052939279,"wires":[]},{"id":"9a4e037f.7547e","type":"debug","z":"1b403a13.0ec8c6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":310,"y":560,"wires":[]},{"id":"207fc406.e8ac0c","type":"debug","z":"3ce5b54a.127d6a","name":"USBin/Baterias","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":760,"y":760,"wires":[]},{"id":"caebb9ed.2da8f8","type":"inject","z":"1b403a13.0ec8c6","name":"reset nano termo","topic":"","payload":"Reset","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":"10","x":1080,"y":170,"wires":[["2612313.71f70ce"]]},{"id":"2612313.71f70ce","type":"mqtt out","z":"1b403a13.0ec8c6","name":"","topic":"ESP/TermoSolar/Config","qos":"","retain":"","broker":"900627dc.76e6a8","x":1130,"y":210,"wires":[]},{"id":"e47cf739.f64318","type":"debug","z":"1b403a13.0ec8c6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":450,"y":530,"wires":[]},{"id":"7b9c509e.eef1d","type":"delay","z":"1b403a13.0ec8c6","name":"100mS","pauseType":"delay","timeout":"100","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":300,"y":180,"wires":[["34ae7c41.536534"]]},{"id":"57276dfa.dfd984","type":"inject","z":"1b403a13.0ec8c6","name":"dia","topic":"ESP/TermoSolar/Envio","payload":"datos0#0#0#57.69#5.81#980","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":290,"y":220,"wires":[["34ae7c41.536534"]]},{"id":"b997565d.3f9938","type":"inject","z":"f682d492.22a758","name":"","topic":"","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":90,"y":480,"wires":[["ea8bd52.644c928"]]},{"id":"81b48d30.ab2b5","type":"debug","z":"f682d492.22a758","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":720,"y":480,"wires":[]},{"id":"958c3f89.0f016","type":"delay","z":"50119c6e.6ff584","name":"50","pauseType":"delay","timeout":"200","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":350,"y":350,"wires":[["3c0f64c7.dcf05c"]]},{"id":"8fd47f48.1875","type":"inject","z":"50119c6e.6ff584","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":320,"wires":[["958c3f89.0f016"]]},{"id":"6f887f0c.714be","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":2410,"y":620,"wires":[["893a6b3c.fdb088"]]},{"id":"3b9e25a.6c6a3da","type":"inject","z":"a89e305a.c50bb","name":"","topic":"","payload":"1","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":130,"wires":[["dd1ac792.79ebe8"]]},{"id":"3566b9e0.20ff26","type":"inject","z":"a89e305a.c50bb","name":"","topic":"","payload":"0","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":170,"wires":[["dd1ac792.79ebe8"]]},{"id":"95d9f2e3.f7382","type":"inject","z":"3ce5b54a.127d6a","name":"alarma si","topic":"USBin","payload":"{\"topic\":\"Alarma/Activacion\",\"payload\":1}","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":2350,"y":460,"wires":[["fa0c555d.841dd8"]]},{"id":"5e009460.76037c","type":"inject","z":"3ce5b54a.127d6a","name":"alarma no","topic":"USBin","payload":"{\"topic\":\"Alarma/Activacion\",\"payload\":0}","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":2350,"y":500,"wires":[["fa0c555d.841dd8"]]},{"id":"fa0c555d.841dd8","type":"mqtt out","z":"3ce5b54a.127d6a","name":"","topic":"","qos":"","retain":"","broker":"c339edbf.39572","x":2520,"y":460,"wires":[]},{"id":"e050d93b.8bbe28","type":"mqtt in","z":"1b403a13.0ec8c6","name":"tempExterior","topic":"ESP/TermoSolar/Envio","qos":"2","broker":"e779f8d6.7bc2c8","x":580,"y":560,"wires":[["9f6a9fb9.ed5ea","c80c5837.302ed8"]]},{"id":"c80c5837.302ed8","type":"file","z":"1b403a13.0ec8c6","name":"datos_termo","filename":"/home/gaston/BackUp-Node-Red/datos_termo.txt","appendNewline":true,"createDir":false,"overwriteFile":"false","x":880,"y":560,"wires":[[]]},{"id":"3d3f137b.74844c","type":"inject","z":"1b403a13.0ec8c6","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":520,"y":610,"wires":[["5b3184e0.79b21c"]]},{"id":"802a24e6.0536f8","type":"debug","z":"1b403a13.0ec8c6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":830,"y":610,"wires":[]},{"id":"5b3184e0.79b21c","type":"file in","z":"1b403a13.0ec8c6","name":"datos","filename":"/home/gaston/BackUp-Node-Red/datos_termo.txt","format":"utf8","chunk":false,"sendError":false,"x":670,"y":610,"wires":[["802a24e6.0536f8"]]},{"id":"41675572.3f0abc","type":"inject","z":"1b403a13.0ec8c6","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":520,"y":650,"wires":[["b0d46a43.4a8448"]]},{"id":"b0d46a43.4a8448","type":"file","z":"1b403a13.0ec8c6","name":"datos_termo","filename":"/home/gaston/BackUp-Node-Red/datos_termo.txt","appendNewline":true,"createDir":false,"overwriteFile":"delete","x":680,"y":650,"wires":[[]]},{"id":"9f6a9fb9.ed5ea","type":"function","z":"1b403a13.0ec8c6","name":"","func":"msg.payload = msg.payload + \"\\n\";\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":560,"wires":[[]]},{"id":"94b03f1c.aefa4","type":"inject","z":"3ce5b54a.127d6a","name":"","topic":"","payload":"inicio","payloadType":"str","repeat":"","crontab":"","once":true,"onceDelay":"5","x":2710,"y":580,"wires":[["22b6af56.2caa3"]]},{"id":"22b6af56.2caa3","type":"function","z":"3ce5b54a.127d6a","name":"","func":"if (global.get(\"estadoAlarma\") === undefined)global.set(\"estadoAlarma\", 0);","outputs":1,"noerr":0,"x":2830,"y":580,"wires":[[]]},{"id":"6cb809d6.6cdd88","type":"ping","z":"f682d492.22a758","name":"","host":"www.google.com","timer":"15","x":1160,"y":70,"wires":[["62bfbe22.257cd","74dde7f7.025908"]]},{"id":"62bfbe22.257cd","type":"function","z":"f682d492.22a758","name":"reinicio por falta de internet","func":"var hh = new Date().getHours();\nvar payload = msg.payload;\ncontext.contador = context.contador || 0;\ncontext.hh = context.hh || 25;\nnode.status({text: context.contador + \" -- \" + hh + \"  --  \" + context.hh});\n\nif (payload === false && context.hh != hh ){\n    context.contador = context.contador + 1;\n    if (context.contador === 4){\n        context.hh = hh;\n        context.contador = 0;\n        msg = {topic: \"reiniciar\", payload: 1};\n        return msg;\n    }\n    return;\n}\nif (payload !== false){context.contador = 0; context.hh = 25;}\n","outputs":1,"noerr":0,"x":1200,"y":105,"wires":[["e2d0535c.d2c9d","fd732d20.9aba"]]},{"id":"db675f86.7f662","type":"mqtt out","z":"f682d492.22a758","name":"","topic":"","qos":"","retain":"","broker":"af08803a.808f4","x":1680,"y":140,"wires":[]},{"id":"74dde7f7.025908","type":"debug","z":"f682d492.22a758","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1360,"y":70,"wires":[]},{"id":"e2d0535c.d2c9d","type":"debug","z":"f682d492.22a758","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1420,"y":105,"wires":[]},{"id":"fd732d20.9aba","type":"function","z":"f682d492.22a758","name":"reinicio auto lunes (02:03:08)","func":"context.reset = context.reset || 0;\nif (msg.topic == \"reiniciar\"){\n    msg = {topic: \"USBout\", payload: \"resetAntenas\"};\n    node.send(msg);}\n\nif (global.get(\"fechaDia\") === 1 && global.get(\"hh\") === 2 && global.get(\"mm\") === 4 && context.reset === 1)context.reset = 0;\n\nif (global.get(\"fechaDia\") === 1 && global.get(\"hh\") === 2 && global.get(\"mm\") === 3 && global.get(\"ss\") >= 8 && context.reset === 0){\n    context.reset = 1; msg = {topic: \"USBout\", payload: \"resetAntenas\"}; node.send(msg);}","outputs":1,"noerr":0,"x":1470,"y":140,"wires":[["db675f86.7f662","cc37a35f.53da"]]},{"id":"4019a8f5.184778","type":"inject","z":"f682d492.22a758","name":"","topic":"","payload":"","payloadType":"date","repeat":"14","crontab":"","once":false,"onceDelay":0.1,"x":1155,"y":145,"wires":[["fd732d20.9aba"]]},{"id":"5f5b955a.1cdf7c","type":"inject","z":"f682d492.22a758","name":"reinicio manual","topic":"reiniciar","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1150,"y":180,"wires":[["fd732d20.9aba"]]},{"id":"cc37a35f.53da","type":"debug","z":"f682d492.22a758","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1495,"y":190,"wires":[]},{"id":"6d8cc839.564468","type":"blynk-ws-in-write","z":"f682d492.22a758","name":"reset router","pin":"117","pin_all":0,"client":"2c18e412.5f5cbc","x":1120,"y":220,"wires":[["7127a9af.d9a888"]]},{"id":"7127a9af.d9a888","type":"function","z":"f682d492.22a758","name":"","func":"if (msg.payload != \"1\")return;\nmsg = {topic: \"reiniciar\", payload: 1};\nreturn msg;","outputs":1,"noerr":0,"x":1260,"y":220,"wires":[["fd732d20.9aba"]]},{"id":"29b9e573.32e7ca","type":"blynk-ws-out-set-property","z":"3ce5b54a.127d6a","name":"","pin":0,"pinmode":"1","prop":"bycode","client":"2c18e412.5f5cbc","x":2040,"y":850,"wires":[]},{"id":"e4bbd9b5.cf9f18","type":"delay","z":"3ce5b54a.127d6a","name":"100mS","pauseType":"delay","timeout":"100","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1980,"y":810,"wires":[["73837d68.7c6a34"]]},{"id":"db983362.870db","type":"blynk-ws-in-write","z":"f682d492.22a758","name":"","pin":"120","pin_all":0,"client":"2c18e412.5f5cbc","x":110,"y":570,"wires":[["36dab983.4ca676"]]},{"id":"14516ebf.8edc71","type":"blynk-ws-out-write","z":"f682d492.22a758","name":"","pin":0,"pinmode":"1","client":"2c18e412.5f5cbc","x":420,"y":630,"wires":[]},{"id":"36dab983.4ca676","type":"function","z":"f682d492.22a758","name":"","func":"if (msg.payload == \"1\"){\n    msg = {topic: \"USBout\", payload: \"{\\\"topic\\\":\\\"Baterias/Est/Pedido\\\",\\\"payload\\\":1}\"};\n    return msg;\n}","outputs":1,"noerr":0,"x":310,"y":570,"wires":[["24dd8dd.df60972"]]},{"id":"24dd8dd.df60972","type":"mqtt out","z":"f682d492.22a758","name":"","topic":"","qos":"","retain":"","broker":"e779f8d6.7bc2c8","x":470,"y":570,"wires":[]},{"id":"db2fa94a.90a4d8","type":"mqtt in","z":"f682d492.22a758","name":"","topic":"USBin","qos":"2","broker":"e779f8d6.7bc2c8","x":90,"y":630,"wires":[["8b826d8e.67c3c","b4b25a28.e285b8"]]},{"id":"8b826d8e.67c3c","type":"function","z":"f682d492.22a758","name":"","func":"if (msg.payload.includes(\"Resultados\")  || msg.payload.includes(\"Cargador\")){\n    msg = {pin: 127, payload: global.get(\"hsCpu\") + \" -- \" + msg.payload + \"\\n\"};\n    return msg;\n}\n","outputs":1,"noerr":0,"x":230,"y":630,"wires":[[]]},{"id":"b4b25a28.e285b8","type":"debug","z":"f682d492.22a758","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":250,"y":670,"wires":[]},{"id":"dbca9704.86fae8","type":"inject","z":"1b403a13.0ec8c6","name":"timer","topic":"timer","payload":"1","payloadType":"str","repeat":"25","crontab":"","once":false,"onceDelay":0.1,"x":390,"y":20,"wires":[["34ae7c41.536534"]]},{"id":"504fa5d9.30bf1c","type":"function","z":"1b403a13.0ec8c6","name":"","func":"msg = {pin: 127, payload: global.get(\"hsCpu\") + \" -- \" + msg.payload + \"\\n\"};\n// if (msg.payload.includes(\"bomba\") )return msg;\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":70,"wires":[["25daaf68.5e6d4"]]},{"id":"25daaf68.5e6d4","type":"blynk-ws-out-write","z":"1b403a13.0ec8c6","name":"","pin":0,"pinmode":"1","client":"2c18e412.5f5cbc","x":1320,"y":70,"wires":[]},{"id":"de83fcd4.80e64","type":"blynk-ws-in-write","z":"f682d492.22a758","name":"","pin":"127","pin_all":0,"client":"2c18e412.5f5cbc","x":240,"y":710,"wires":[["c6cb6e5c.73fe3","68acb366.3d18bc"]]},{"id":"c6cb6e5c.73fe3","type":"debug","z":"f682d492.22a758","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":460,"y":710,"wires":[]},{"id":"68acb366.3d18bc","type":"mqtt out","z":"f682d492.22a758","name":"","topic":"USBout","qos":"","retain":"","broker":"e779f8d6.7bc2c8","x":440,"y":670,"wires":[]},{"id":"432db8d6.9c50e8","type":"serial in","z":"3ce5b54a.127d6a","name":"USBin","serial":"b86d561e.834378","x":90,"y":460,"wires":[["9641fbd0.64c858"]]},{"id":"42bf6e98.eba1a","type":"serial out","z":"3ce5b54a.127d6a","name":"USBout","serial":"b86d561e.834378","x":550,"y":770,"wires":[]},{"id":"7eb15376.c14e5c","type":"mqtt in","z":"1b403a13.0ec8c6","name":"","topic":"ESP/TermoSolar/Bomba","qos":"2","broker":"900627dc.76e6a8","x":930,"y":80,"wires":[["504fa5d9.30bf1c","2f9c07a5.d12e38"]]},{"id":"1fc3f648.3d3c9a","type":"inject","z":"1b403a13.0ec8c6","name":"sin debug","topic":"ESP/TermoSolar/Recibo","payload":"debug0","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1110,"y":280,"wires":[["6b84ff87.25f1f"]]},{"id":"43d32cfa.9c0c44","type":"inject","z":"1b403a13.0ec8c6","name":"con debug","topic":"ESP/TermoSolar/Recibo","payload":"debug1","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1110,"y":320,"wires":[["6b84ff87.25f1f"]]},{"id":"6b84ff87.25f1f","type":"mqtt out","z":"1b403a13.0ec8c6","name":"","topic":"","qos":"","retain":"","broker":"e779f8d6.7bc2c8","x":1250,"y":300,"wires":[]},{"id":"3e95000f.427c6","type":"mqtt in","z":"1b403a13.0ec8c6","name":"","topic":"crepMQTT","qos":"2","broker":"900627dc.76e6a8","x":210,"y":70,"wires":[["34ae7c41.536534","b3d13945.b960d8"]]},{"id":"b3d13945.b960d8","type":"debug","z":"1b403a13.0ec8c6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":380,"y":70,"wires":[]},{"id":"43e727a2.f0f9e8","type":"debug","z":"1b403a13.0ec8c6","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":630,"y":30,"wires":[]},{"id":"3fd16520.fa514a","type":"inject","z":"1b403a13.0ec8c6","name":"pruea timer","topic":"ESP/TermoSolar/Recibo","payload":"prueba45","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1100,"y":360,"wires":[["6b84ff87.25f1f"]]},{"id":"9ac4a3ca.adf2f","type":"mqtt out","z":"1b403a13.0ec8c6","name":"pedido","topic":"","qos":"","retain":"","broker":"e779f8d6.7bc2c8","x":1580,"y":470,"wires":[]},{"id":"2f9c07a5.d12e38","type":"debug","z":"1b403a13.0ec8c6","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1280,"y":110,"wires":[]},{"id":"4925f5fb.a7fa3c","type":"debug","z":"1b403a13.0ec8c6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1080,"y":30,"wires":[]},{"id":"10f2739.582f28c","type":"function","z":"1b403a13.0ec8c6","name":"","func":"msg = {topic: \"ESP/TermoSolar/Recibo\", payload: \"prueba10\"}; node.send(msg);","outputs":1,"noerr":0,"x":1400,"y":470,"wires":[["9ac4a3ca.adf2f"]]},{"id":"43b083da.46c06c","type":"delay","z":"1b403a13.0ec8c6","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1290,"y":470,"wires":[["10f2739.582f28c"]]},{"id":"1cfe2f00.c9dec1","type":"mqtt in","z":"1b403a13.0ec8c6","name":"","topic":"ESP/TermoSolar/Config","qos":"2","broker":"e779f8d6.7bc2c8","x":1150,"y":540,"wires":[["b4af68b9.58d648"]]},{"id":"179e0cda.eb9203","type":"file in","z":"1b403a13.0ec8c6","name":"recover datos termo","filename":"/home/gaston/BackUp-Node-Red/DatosTermo.txt","format":"utf8","chunk":false,"sendError":false,"x":1340,"y":500,"wires":[["4810a44c.b2412c","7f41c912.6882e8"]]},{"id":"b4af68b9.58d648","type":"file","z":"1b403a13.0ec8c6","name":"back datos termo","filename":"/home/gaston/BackUp-Node-Red/DatosTermo.txt","appendNewline":false,"createDir":false,"overwriteFile":"true","x":1360,"y":540,"wires":[[]]},{"id":"69952cc0.bc9f34","type":"inject","z":"1b403a13.0ec8c6","name":"","topic":"","payload":"0#0#0#0#0#0#80#55#50#40#650#500#120#1#3","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1190,"y":580,"wires":[["b4af68b9.58d648"]]},{"id":"4810a44c.b2412c","type":"debug","z":"1b403a13.0ec8c6","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1550,"y":530,"wires":[]}]